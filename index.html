<!doctype html>
<html lang="en">
  <head>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta charset="UTF-8" />
    <title>Block Over It</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
      body {
        background: #111;
        color: #fff;
        font-family: "Courier New", Courier, monospace;
        margin: 0;
        padding: 0;
        overflow: hidden;
        height: 100vh;
        width: 100vw;
      }

      /* --- Game Grid Styles --- */
      .background {
        table-layout: fixed;
        border-spacing: 0;
        border-collapse: collapse;
        margin-top: auto;
      }

      .background td {
        padding: 0;
        box-sizing: border-box;
      }

      .lava {
        background: #e55;
      }
      .wall {
        background: #444;
        border: solid 3px #333;
        box-sizing: border-box;
      }
      .visual-wall {
        background: #444;
        border: solid 3px #333;
        box-sizing: border-box;
      }

      .actor {
        position: absolute;
      }

      .coin {
        background: #e2e838;
        border-radius: 50%;
        border: 1px solid #c2c828;
      }

      /* Bonus Coin Style - Flattened as requested */
      .bonus-coin {
        background: #335699;
        border-radius: 50%;
        z-index: 5;
      }
      /* Alternate visuals for Bonus Coin (from blockoverit(1).html) */
      .bonus-coin-alt-visuals {
        border: 2px solid #fff;
        box-shadow: 0 0 8px #33f;
      }

      .player {
        background: #335699;
        box-shadow: none;
      }

      .lost .player {
        background: #a04040;
      }
      .won .player {
        background: #2ecc71;
      }

      .moving-block {
        background: #777;
        border: 3px solid #555;
        box-sizing: border-box;
        color: #fff;
        font-weight: bold;
      }

      .falling-block {
        background: #444;
        border: 3px solid #333;
        box-sizing: border-box;
      }

      .breakable-block {
        background-image: url("data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iOCIgaGVpZ2h0PSI4IiB2aWV3Qm94PSIwIDAgOCA4IiBmaWxsPSJub25lIiB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciPjxyZWN0IHdpZHRoPSI4IiBoZWlnaHQ9IjgiIGZpbGw9IiM2NDY0NjQiLz48Y2lyY2xlIGN4PSI2LjUiIGN5PSI1LjUiIHI9IjAuNSIgZmlsbD0iIzQ0NDQ0NCIvPjxjaXJjbGUgY3g9IjIuNSIgY3k9IjYuNSIgcj0iMC41IiBmaWxsPSIjNDQ0NDQ0Ii8+PGNpcmNsZSBjeD0iNC41IiBjeT0iMy41IiByPSIwLjUiIGZpbGw9IiM0NDQ0NDQiLz48Y2lyY2xlIGN4PSIxLjUiIGN5PSIyLjUiIHI9IjAuNSIgZmlsbD0iIzQ0NDQ0NCIvPjxjaXJjbGUgY3g9IjUuNSIgY3k9IjAuNSIgcj0iMC41IiBmaWxsPSIjNDQ0NDQ0Ii8+PC9zdmc+");
        border: 3px solid #555;
        box-sizing: border-box;
      }

      .spike-block,
      .wall-block,
      .spike-block-u {
        background: #444;
        border: 3px solid #333;
        box-sizing: border-box;
      }
      /* Hide text content for these in game if any */
      .spike-block,
      .wall-block,
      .spike-block-u {
        color: transparent;
      }

      .breakable-block.triggered {
        animation: shake 0.4s infinite;
      }

      .jump-pad {
        background: #590059;
        border: 2px solid #d946ef;
        box-sizing: border-box;
        border-radius: 4px;
        position: relative;
        box-shadow: inset 0 0 10px #d946ef;
      }
      .jump-pad::after {
        content: "";
        position: absolute;
        top: 20%;
        left: 20%;
        right: 20%;
        bottom: 20%;
        background: #d946ef;
        border-radius: 50%;
        box-shadow: 0 0 5px #f0abfc;
      }
      .grinder {
        background-color: #333;
        background-image:
          linear-gradient(
            90deg,
            transparent 30%,
            #888 30%,
            #888 70%,
            transparent 70%
          ),
          repeating-linear-gradient(
            0deg,
            #222 0px,
            #222 4px,
            #aaa 4px,
            #aaa 8px
          );
        background-size:
          100% 100%,
          40% 100%;
        background-position:
          center center,
          center 0;
        background-repeat: no-repeat;
        border: none;
        z-index: 5;
        animation: sawSpin 0.05s linear infinite;
      }
      .grinder.grinding {
        animation: shake 0.1s infinite;
      }

      @keyframes sawSpin {
        0% {
          background-position:
            center center,
            center 0px;
        }
        100% {
          background-position:
            center center,
            center 8px;
        }
      }

      @keyframes shake {
        0%,
        100% {
          transform: translate(0, 0);
        }
        50% {
          transform: translate(1px, 1px);
        }
      }

      .rising-lava {
        background: #d32f2f;
        box-sizing: border-box;
        box-shadow: 0 0 20px #d32f2f;
        background: repeating-linear-gradient(
          45deg,
          #d32f2f,
          #d32f2f 10px,
          #b71c1c 10px,
          #b71c1c 20px
        );
        animation: rising-lava-anim 0.8s linear infinite;
      }

      @keyframes rising-lava-anim {
        from {
          background-position: 0 0;
        }
        to {
          background-position: 0 20px;
        }
      }

      .spike-visual {
        width: 0;
        height: 0;
        border-style: solid;
        border-color: transparent;
        border-bottom-color: #aaa;
      }
      .spike-visual.spike-u {
        border-bottom-color: transparent;
        border-top-color: #aaa;
        border-top-style: solid;
      }

      .game {
        position: relative;
        overflow: auto;
        width: 100vw;
        min-height: 100vh;
        height: 100vh;
        background: #222;
        display: flex;
        flex-direction: column;
        justify-content: flex-end;
        align-items: center;
        /* Camera Fix: Hide overflow so we can use transform for camera */
        overflow: hidden;
      }

      /* Zoomed out state */
      .game.zoomed-out .world {
        /* Transform is handled in JS, but we ensure origin */
        transform-origin: center center;
        transition: transform 0.2s ease-out;
      }

      /* --- Custom Popup Styles --- */
      .popup-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.7);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 1000;
      }

      .popup {
        position: relative;
        background: linear-gradient(135deg, #1a1a1a 0%, #222 100%);
        border: 3px solid #335699;
        border-radius: 8px;
        padding: 40px;
        max-width: 500px;
        text-align: center;
        box-shadow: 0 10px 40px rgba(51, 86, 153, 0.3);
        animation: popupSlide 0.3s ease-out;
      }

      @keyframes popupSlide {
        from {
          opacity: 0;
          transform: scale(0.8);
        }
        to {
          opacity: 1;
          transform: scale(1);
        }
      }

      .popup-title {
        font-size: 1.8rem;
        color: #335699;
        margin-bottom: 15px;
        text-transform: uppercase;
        font-weight: bold;
        letter-spacing: 2px;
      }

      .popup-message {
        font-size: 1.1rem;
        color: #ccc;
        margin-bottom: 30px;
        line-height: 1.5;
      }

      .popup-buttons {
        display: flex;
        gap: 15px;
        justify-content: center;
        flex-wrap: wrap;
      }

      .popup-btn {
        background: #335699;
        border: 2px solid #2a4a7a;
        color: #fff;
        padding: 12px 30px;
        font-size: 1rem;
        cursor: pointer;
        border-radius: 4px;
        text-transform: uppercase;
        font-weight: bold;
        transition: all 0.2s;
        font-family: inherit;
      }

      .popup-btn:hover {
        background: #3d6ab8;
        transform: translateY(-2px);
        box-shadow: 0 5px 15px rgba(51, 86, 153, 0.4);
      }

      .popup-btn.secondary {
        background: #555;
        border-color: #777;
      }

      .popup-btn.secondary:hover {
        background: #666;
      }

      .popup-close {
        position: absolute;
        top: 10px;
        right: 10px;
        background: transparent;
        border: none;
        color: #666;
        font-size: 1.5rem;
        cursor: pointer;
        line-height: 1;
      }
      .popup-close:hover {
        color: #fff;
      }

      /* --- Main Menu Styles --- */
      #main-menu {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(17, 17, 17, 0.98);
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: flex-start;
        padding-top: 150px;
        overflow: hidden;
        box-sizing: border-box;
        z-index: 100;
      }

      h1 {
        font-size: clamp(2.5rem, 5vw, 4rem);
        margin-bottom: 20px;
        color: #fff;
        text-transform: uppercase;
        letter-spacing: 5px;
        text-shadow: 4px 4px 0px #335699;
        text-align: center;
      }

      h2 {
        font-size: clamp(1.5rem, 3vw, 2rem);
        margin-bottom: 30px;
        color: #ccc;
        text-transform: uppercase;
      }

      .menu-container {
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 15px;
        width: 100%;
        max-width: 800px;
        flex: 1;
        min-height: 0;
        margin-bottom: 20px;
        padding-bottom: 80px;
        overflow-y: auto;
        overflow-x: hidden;
        padding: 10px;
      }

      /* Custom Scrollbar for Menu Container */
      .menu-container::-webkit-scrollbar {
        width: 8px;
      }
      .menu-container::-webkit-scrollbar-track {
        background: #111;
      }
      .menu-container::-webkit-scrollbar-thumb {
        background: #333;
        border: 1px solid #555;
        border-radius: 4px;
      }

      .level-grid {
        display: flex;
        flex-wrap: wrap;
        gap: 20px;
        justify-content: center;
        margin-bottom: 20px;
      }

      /* Generic Button Style */
      .btn {
        background: #333;
        border: 2px solid #555;
        color: white;
        font-family: inherit;
        font-size: clamp(1rem, 1.5vw, 1.5rem);
        cursor: pointer;
        padding: clamp(10px, 1.5vw, 15px) clamp(20px, 3vw, 30px);
        min-width: clamp(150px, 20vw, 200px);
        text-transform: uppercase;
        transition: all 0.2s;
      }

      .btn:hover:not(:disabled) {
        background: #444;
        border-color: #335699;
        transform: translateY(-2px);
      }

      .btn:disabled {
        opacity: 0.5;
        cursor: not-allowed;
      }

      /* Level Select Button specific */
      .level-btn {
        width: 80px;
        height: 80px;
        font-size: 2rem;
        padding: 0;
        display: flex;
        align-items: center;
        justify-content: center;
        position: relative;
      }

      .coin-badge {
        position: absolute;
        bottom: 5px;
        right: 5px;
        width: 12px;
        height: 12px;
        background: #335699;
        border-radius: 50%;
        display: none;
      }

      .controls-hint {
        position: absolute;
        bottom: 30px;
        color: #666;
        font-size: 0.9rem;
      }

      .hud {
        position: absolute;
        top: 20px;
        left: 20px;
        z-index: 50;
        background: rgba(0, 0, 0, 0.6);
        color: #fff;
        padding: 10px 15px;
        border-radius: 4px;
        display: none;
        font-size: 14px;
        pointer-events: auto;
        cursor: pointer;
        user-select: none;
        -webkit-user-select: none;
      }

      /* File Input styling */
      #file-input {
        display: none;
      }
      .file-label {
        display: inline-block;
        background: #335699;
        padding: 10px 20px;
        cursor: pointer;
        margin-top: 20px;
        border: 2px solid #fff;
      }
      .delete-btn {
        background: #a44;
        border: 1px solid #f66;
        font-size: 0.8rem;
        padding: 5px;
        min-width: auto;
        margin-left: 10px;
      }

      .custom-level-row {
        display: flex;
        align-items: center;
        gap: 15px;
        background: #1a1a1a;
        padding: 15px;
        border: 2px solid #333;
        width: 100%;
        max-width: 700px;
        justify-content: space-between;
        border-radius: 4px;
        transition: all 0.2s;
      }

      .custom-level-row:hover {
        border-color: #555;
        background: #222;
      }

      .custom-level-info {
        flex: 1;
        display: flex;
        flex-direction: column;
        gap: 5px;
      }

      .custom-level-name {
        font-size: 1.2rem;
        font-weight: bold;
        color: #fff;
      }

      .custom-level-details {
        display: flex;
        gap: 15px;
        font-size: 0.9rem;
        color: #aaa;
      }

      .custom-level-detail-item {
        display: flex;
        align-items: center;
        gap: 5px;
      }

      .custom-level-status {
        display: flex;
        gap: 8px;
        align-items: center;
      }

      .status-badge {
        padding: 3px 8px;
        border-radius: 3px;
        font-size: 0.8rem;
        font-weight: bold;
        text-transform: uppercase;
      }

      .status-beaten {
        background: #2ecc71;
        color: #000;
      }

      .status-blue-coin {
        background: #335699;
        color: #fff;
      }

      .custom-level-actions {
        display: flex;
        gap: 8px;
      }

      #timer-display {
        position: absolute;
        top: 50px;
        left: 20px;
        font-family: monospace;
        font-size: 1.5rem;
        color: #ffd700;
        display: none;
        z-index: 50;
      }

      #highscore-display {
        position: absolute;
        top: 80px;
        left: 20px;
        font-family: monospace;
        font-size: 1rem;
        color: #aaa;
        display: none;
        z-index: 50;
      }

      #confetti-canvas {
        position: fixed;
        top: 0;
        left: 0;
        pointer-events: none;
        z-index: 200;
      }

      #restart-btn {
        position: absolute;
        top: 20px;
        right: 20px;
        z-index: 60;
        display: none;
        padding: 10px 20px;
        padding: 0;
        font-size: 1rem;
        min-width: auto;
        width: 44px;
        height: 44px;
        align-items: center;
        justify-content: center;
      }

      /* Settings Button */
      .settings-btn {
        position: absolute;
        bottom: 20px;
        right: 20px;
        background: #333;
        border: 2px solid #555;
        color: white;
        font-family: inherit;
        font-size: 1rem;
        cursor: pointer;
        padding: 10px 20px;
        text-transform: uppercase;
        transition: all 0.2s;
        z-index: 110;
      }
      .settings-btn:hover {
        background: #444;
        border-color: #335699;
        transform: scale(1.05);
      }

      /* Editor Button */
      .editor-btn {
        position: absolute;
        bottom: 20px;
        left: 20px;
        background: #333;
        border: 2px solid #555;
        color: white;
        font-family: inherit;
        font-size: 1rem;
        cursor: pointer;
        padding: 10px 20px;
        text-transform: uppercase;
        transition: all 0.2s;
        z-index: 110;
      }
      .editor-btn:hover {
        background: #444;
        border-color: #335699;
        transform: scale(1.05);
      }

      /* Notification Dot */
      .notif-dot {
        position: absolute;
        top: -5px;
        right: -5px;
        width: 12px;
        height: 12px;
        background: #3b82f6;
        border-radius: 50%;
        border: 2px solid #333;
        display: none;
      }

      /* Top Left Controls */
      .top-left-controls {
        position: absolute;
        top: 20px;
        left: 20px;
        display: flex;
        gap: 15px;
        z-index: 110;
      }

      /* Leaderboard Button */
      .leaderboard-btn {
        position: relative;
        top: auto;
        left: auto;
        background: #333;
        border: 2px solid #555;
        color: white;
        font-family: inherit;
        font-size: 1rem;
        cursor: pointer;
        padding: 10px 20px;
        text-transform: uppercase;
        transition: all 0.2s;
        z-index: 110;
      }
      .leaderboard-btn:hover {
        background: #444;
        border-color: #335699;
        transform: scale(1.05);
      }

      /* Awards Button */
      .awards-btn {
        background: #333;
        border: 2px solid #555;
        color: white;
        font-family: inherit;
        font-size: 1rem;
        cursor: pointer;
        padding: 10px 20px;
        text-transform: uppercase;
        transition: all 0.2s;
      }
      .awards-btn:hover {
        background: #444;
        border-color: #335699;
        transform: scale(1.05);
      }

      /* Login Button */
      .login-btn {
        position: absolute;
        top: 20px;
        right: 20px;
        background: #333;
        border: 2px solid #555;
        color: white;
        font-family: inherit;
        font-size: 1rem;
        cursor: pointer;
        padding: 0;
        width: auto;
        width: 44px;
        height: 44px;
        display: flex;
        align-items: center;
        overflow: hidden;
        white-space: nowrap;
        max-width: 44px;
        text-transform: uppercase;
        justify-content: center;
        transition:
          max-width 0.4s ease,
          background 0.2s,
          border-color 0.2s;
        z-index: 110;
      }
      .login-btn:hover {
        background: #444;
        border-color: #335699;
        max-width: 300px;
        padding-right: 20px;
      }
      .login-icon {
        width: 44px;
        height: 44px;
        display: flex;
        align-items: center;
        justify-content: center;
        flex-shrink: 0;
      }
      .login-text {
        opacity: 0;
        transition: opacity 0.3s ease 0.1s;
        margin-left: 5px;
      }
      .login-btn:hover .login-text {
        opacity: 1;
      }

      .feedback-btn {
        position: absolute;
        top: 20px;
        right: 75px;
        width: 44px;
        height: 44px;
        background: #333;
        border: 2px solid #555;
        color: white;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: all 0.2s;
        z-index: 110;
      }
      .feedback-btn:hover {
        background: #444;
        border-color: #335699;
      }

      .bottom-controls {
        position: absolute;
        bottom: 20px;
        right: 20px;
        display: flex;
        gap: 15px;
        align-items: center;
        z-index: 110;
      }

      /* Toggle Switch */
      .toggle-btn {
        width: 60px;
        height: 30px;
        background: #333;
        border: 2px solid #555;
        position: relative;
        cursor: pointer;
        transition: all 0.2s;
        display: inline-block;
        vertical-align: middle;
        margin-left: 10px;
      }
      .toggle-btn.active {
        background: #335699;
        border-color: #5588cc;
      }
      .toggle-slider {
        width: 20px;
        height: 20px;
        background: #fff;
        position: absolute;
        top: 3px;
        left: 3px;
        transition: all 0.2s;
        box-shadow: 2px 2px 0 #000;
      }
      .toggle-btn.active .toggle-slider {
        left: 33px;
      }

      /* Settings Close Button */
      .settings-close-btn {
        position: absolute;
        top: 40px;
        right: 40px;
        background: transparent;
        border: none;
        color: #fff;
        font-size: 3rem;
        cursor: pointer;
        line-height: 1;
        z-index: 120;
        transition:
          transform 0.2s,
          color 0.2s;
      }
      .settings-close-btn:hover {
        color: #335699;
        transform: scale(1.1);
      }

      /* Custom Level Popup */
      .cl-popup-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.85);
        z-index: 2000;
        display: flex;
        align-items: center;
        justify-content: center;
        backdrop-filter: blur(5px);
        -webkit-backdrop-filter: blur(5px);
      }
      .cl-popup {
        background: #1a1a1a;
        border: 2px solid #333;
        width: 90%;
        max-width: 600px;
        border-radius: 8px;
        overflow: hidden;
        box-shadow: 0 20px 50px rgba(0, 0, 0, 0.5);
        display: flex;
        flex-direction: column;
        animation: popupSlide 0.3s ease-out;
      }
      .cl-header {
        background: #222;
        padding: 20px;
        border-bottom: 1px solid #333;
        display: flex;
        justify-content: space-between;
        align-items: center;
      }
      .cl-title {
        font-size: 1.5rem;
        font-weight: bold;
        color: #fff;
      }
      .cl-close {
        background: none;
        border: none;
        color: #666;
        font-size: 2rem;
        cursor: pointer;
        line-height: 1;
      }
      .cl-close:hover {
        color: #fff;
      }
      .cl-body {
        padding: 20px;
        color: #ccc;
      }
      .cl-meta {
        display: flex;
        gap: 20px;
        margin-bottom: 20px;
        flex-wrap: wrap;
        align-items: center;
      }
      .cl-desc {
        background: #111;
        padding: 15px;
        border-radius: 4px;
        margin-bottom: 20px;
        line-height: 1.5;
        font-size: 0.95rem;
        color: #aaa;
        min-height: 60px;
      }
      .cl-stats {
        display: grid;
        grid-template-columns: 1fr 1fr 1fr;
        gap: 10px;
        margin-bottom: 20px;
      }
      .cl-stat-box {
        background: #222;
        padding: 10px;
        border-radius: 4px;
        text-align: center;
      }
      .cl-stat-label {
        font-size: 0.7rem;
        text-transform: uppercase;
        color: #666;
        margin-bottom: 4px;
      }
      .cl-stat-value {
        font-size: 1rem;
        font-weight: bold;
        color: #fff;
      }
      .cl-actions {
        padding: 20px;
        background: #222;
        border-top: 1px solid #333;
        display: flex;
        justify-content: flex-end;
        gap: 10px;
      }
      .difficulty-bar {
        display: flex;
        gap: 3px;
      }
      .diff-seg {
        width: 8px;
        height: 14px;
        background: #333;
        border-radius: 2px;
      }
      .diff-seg.active {
        background: #e55;
        box-shadow: 0 0 5px #e55;
      }

      /* Blocky Volume Slider */
      input[type="range"] {
        -webkit-appearance: none;
        appearance: none;
        width: 100%;
        background: transparent;
      }
      input[type="range"]::-webkit-slider-thumb {
        -webkit-appearance: none;
        height: 20px;
        width: 20px;
        background: #335699;
        border: 2px solid #fff;
        border-radius: 0;
        cursor: pointer;
        margin-top: -6px; /* Centered on 12px track */
        box-shadow: 4px 4px 0 #000;
      }
      input[type="range"]::-webkit-slider-runnable-track {
        width: 100%;
        height: 12px;
        cursor: pointer;
        background: #555;
        border: 2px solid #999;
      }
      /* Firefox Support */
      input[type="range"]::-moz-range-thumb {
        height: 20px;
        width: 20px;
        background: #335699;
        border: 2px solid #fff;
        border-radius: 0;
        cursor: pointer;
        box-shadow: 4px 4px 0 #000;
      }
      input[type="range"]::-moz-range-track {
        width: 100%;
        height: 12px;
        cursor: pointer;
        background: #555;
        border: 2px solid #999;
      }

      /* Practice Marker */
      .practice-marker {
        background: rgba(46, 204, 113, 0.5);
        border: 2px solid #2ecc71;
        border-radius: 50%;
        position: absolute;
        z-index: 4;
      }

      /* Beats Button */
      .beats-btn {
        position: absolute;
        bottom: 20px;
        right: 160px;
        background: #333;
        border: 2px solid #555;
        color: white;
        font-family: inherit;
        font-size: 1rem;
        cursor: pointer;
        padding: 10px 20px;
        text-transform: uppercase;
        transition: all 0.2s;
        z-index: 110;
      }
      .beats-btn:hover {
        background: #444;
        border-color: #335699;
        transform: scale(1.05);
      }

      /* Credits Button */
      .credits-btn {
        position: absolute;
        bottom: 20px;
        right: 300px; /* Positioned between Beats and News */
        background: #333;
        border: 2px solid #555;
        color: white;
        font-family: inherit;
        font-size: 1rem;
        cursor: pointer;
        padding: 10px 20px;
        text-transform: uppercase;
        transition: all 0.2s;
        z-index: 110;
      }
      .credits-btn:hover {
        background: #444;
        border-color: #335699;
        transform: scale(1.05);
      }

      /* News Button */
      .news-btn {
        position: absolute;
        bottom: 20px;
        right: 440px;
        background: #333;
        border: 2px solid #555;
        color: white;
        font-family: inherit;
        font-size: 1rem;
        cursor: pointer;
        padding: 10px 20px;
        text-transform: uppercase;
        transition: all 0.2s;
        z-index: 110;
      }
      .news-btn:hover {
        background: #444;
        border-color: #335699;
        transform: scale(1.05);
      }

      .track-row {
        display: flex;
        align-items: center;
        justify-content: space-between;
        background: #222;
        border: 1px solid #444;
        padding: 15px;
        width: 100%;
        max-width: 600px;
        cursor: pointer;
        transition: all 0.2s;
        border-radius: 4px;
      }
      .track-row:hover {
        background: #333;
        border-color: #666;
      }
      .track-row.active {
        border-color: #335699;
        background: #1a2a40;
      }

      /* Music Notification */
      .music-notification {
        position: fixed;
        bottom: 20px;
        left: -400px;
        background: rgba(15, 20, 30, 0.95);
        border-left: 4px solid #335699;
        padding: 15px 25px;
        color: #fff;
        z-index: 9999;
        transition: left 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
        display: flex;
        flex-direction: column;
        pointer-events: none;
      }
      .music-notification.show {
        left: 20px;
      }
      .music-notif-title {
        font-weight: bold;
        font-size: 1.1rem;
        color: #335699;
        margin-bottom: 4px;
      }
      .music-notif-artist {
        font-size: 0.8rem;
        color: #aaa;
      }

      .track-info {
        display: flex;
        flex-direction: column;
      }
      .track-title {
        font-weight: bold;
        color: #fff;
        font-size: 1.1rem;
      }
      .track-artist {
        font-size: 0.8rem;
        color: #aaa;
        margin-top: 4px;
      }

      /* Beats Menu Specifics */
      .beats-controls {
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 20px;
        margin-bottom: 10px;
        width: 100%;
      }
      .icon-btn {
        background: transparent;
        border: none;
        color: #fff;
        cursor: pointer;
        padding: 8px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: all 0.2s;
      }
      .icon-btn:hover {
        background: rgba(255, 255, 255, 0.1);
        color: #335699;
        transform: scale(1.1);
      }
      .icon-btn.active {
        color: #335699;
      }
      .icon-btn svg {
        width: 24px;
        height: 24px;
        fill: currentColor;
      }

      .progress-container {
        width: 100%;
        display: flex;
        align-items: center;
        gap: 10px;
        margin-bottom: 15px;
      }
      .progress-bar-bg {
        flex-grow: 1;
        height: 6px;
        background: #333;
        border-radius: 3px;
        cursor: pointer;
        position: relative;
        overflow: hidden;
      }
      .progress-bar-fill {
        height: 100%;
        background: #335699;
        width: 0%;
        transition: width 0.1s linear;
      }
      .time-display {
        font-family: monospace;
        font-size: 0.8rem;
        color: #aaa;
        min-width: 40px;
        text-align: center;
      }

      /* --- Cheat Animation Styles --- */
      #cheat-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: #000;
        z-index: 3000;
        display: none;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        font-family: "Courier New", monospace;
      }

      .cheat-text {
        font-size: 3rem;
        color: #0f0;
        text-shadow: 0 0 10px #0f0;
        margin-bottom: 30px;
        text-align: center;
        font-weight: bold;
        letter-spacing: 5px;
      }

      .cheat-progress-container {
        width: 60%;
        max-width: 600px;
        height: 4px;
        background: #111;
        border: 1px solid #333;
        position: relative;
        overflow: hidden;
      }

      .cheat-progress-bar {
        height: 100%;
        background: #0f0;
        width: 0%;
        box-shadow: 0 0 20px #0f0;
        transition: width 0.1s linear;
      }

      /* Mobile Controls */
      .mobile-controls-overlay {
        display: none;
        position: fixed;
        bottom: 20px;
        left: 0;
        width: 100%;
        height: 140px;
        pointer-events: none;
        z-index: 1000;
        justify-content: space-between;
        padding: 0 30px;
        box-sizing: border-box;
      }

      body.mobile-mode.in-game .mobile-controls-overlay {
        display: flex;
      }

      .mc-dpad,
      .mc-action {
        display: flex;
        gap: 20px;
        pointer-events: auto;
        align-items: center;
      }

      .mc-btn {
        width: 16vw;
        height: 16vw;
        max-width: 70px;
        max-height: 70px;
        background: rgba(255, 255, 255, 0.15);
        border-radius: 50%;
        background: rgba(255, 255, 255, 0.1);
        border: 2px solid rgba(255, 255, 255, 0.3);
        border-radius: 50%;
        backdrop-filter: blur(4px);
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-size: 24px;
        touch-action: manipulation;
        touch-action: none;
        user-select: none;
        -webkit-user-select: none;
        backdrop-filter: blur(4px);
        -webkit-backdrop-filter: blur(4px);
      }
      .mc-btn:active,
      .mc-btn.pressed {
        background: rgba(255, 255, 255, 0.4);
        transform: scale(0.95);
      }
      .mc-btn svg {
        width: 32px;
        height: 32px;
        fill: currentColor;
      }

      @media (max-width: 768px) {
        h1 {
          font-size: 2.5rem;
          letter-spacing: 2px;
        }
        /* --- Mobile Mode Overhaul --- */
        .mobile-mode h1 {
          font-size: 2rem;
          letter-spacing: 2px;
          text-shadow: 2px 2px 0px #335699;
          margin-bottom: 10px;
        }
        .mobile-mode .menu-container {
          width: 100%;
          padding: 0 20px 120px 20px;
          box-sizing: border-box;
          max-width: 500px;
          max-width: 100%;
          display: flex;
          align-items: center;
          justify-content: flex-start;
        }
        .mobile-mode .btn {
          width: 100%;
          padding: 15px;
          font-size: 1.2rem;
          margin: 8px 0;
          background: #333;
          border: 2px solid #555;
        }
        .mobile-mode .popup-btn {
          padding: 10px 20px;
          font-size: 0.9rem;
        }

        .mobile-mode .level-btn {
          width: 60px;
          height: 60px;
          font-size: 1.5rem;
          padding: 0;
        }

        /* Mobile Menu Grid */
        .mobile-mode .mobile-menu-grid {
          display: flex;
          gap: 30px;
          align-items: center;
          justify-content: center;
        }
        .mobile-mode .level-grid {
          gap: 10px;
        }

        @media (orientation: portrait) {
          .mobile-mode .mobile-menu-grid {
            flex-direction: column;
          }
        }
        .mobile-mode .controls-hint {
          display: none;
        }
        .mobile-mode .popup {
          padding: 20px;
          max-width: 90%;
        }

        .mobile-mode .mobile-icon-btn {
          width: 18vw;
          height: 18vw;
          max-width: 80px;
          max-height: 80px;
          border-radius: 20px;
          background: rgba(255, 255, 255, 0.1);
          border: 2px solid rgba(255, 255, 255, 0.2);
          color: white;
          display: flex;
          align-items: center;
          justify-content: center;
          background: rgba(50, 50, 50, 0.8);
          backdrop-filter: blur(4px);
          -webkit-backdrop-filter: blur(4px);
          border: 2px solid rgba(255, 255, 255, 0.1);
          z-index: 200;
          box-shadow: 0 4px 10px rgba(0, 0, 0, 0.3);
          backdrop-filter: blur(5px);
          transition: transform 0.1s;
        }
        .mobile-mode .mobile-icon-btn:active {
          transform: scale(0.95);
          background: rgba(255, 255, 255, 0.2);
        }
        .mobile-mode .mobile-icon-btn svg {
          width: 40px;
          height: 40px;
          fill: currentColor;
        }

        /* Center Campaign Button (Larger) */
        .mobile-mode .mobile-icon-btn.campaign-btn {
          width: 25vw;
          height: 25vw;
          max-width: 120px;
          max-height: 120px;
          background: #335699;
          border-color: #5588cc;
          box-shadow: 0 0 20px rgba(51, 86, 153, 0.4);
        }
        .mobile-mode .mobile-icon-btn.campaign-btn svg {
          width: 60px;
          height: 60px;
        }

        /* Mobile Beats Button */
        #mobile-beats-btn {
          position: fixed;
          bottom: 20px;
          left: 20px;
          width: 60px;
          height: 60px;
          border-radius: 50%;
          background: #333;
          border: 2px solid #555;
          color: white;
          display: none; /* Toggled by JS */
          align-items: center;
          justify-content: center;
          z-index: 150;
          box-shadow: 0 4px 10px rgba(0, 0, 0, 0.5);
        }
        #mobile-beats-btn svg {
          width: 30px;
          height: 30px;
          fill: currentColor;
        }
      }

      /* Mobile Landscape Optimizations */
      @media screen and (orientation: landscape) and (max-height: 500px) {
        #main-menu {
          padding-top: 10px;
        }
        .mobile-mode h1 {
          display: none;
        }

        .btn {
          font-size: 1rem;
          padding: 12px 20px;
          min-width: 180px;
        }
        .level-btn {
          width: 60px;
          height: 60px;
          font-size: 1.5rem;
        }
        .level-grid {
          gap: 10px;
        }
        .mobile-mode .menu-container {
          flex-direction: column;
          justify-content: center;
          align-items: center;
          padding-top: 0;
          height: 100%;
        }
        .menu-container {
          padding: 0 20px;
          overflow-y: auto;
          max-height: calc(100vh - 150px);
        }
        .controls-hint {
          font-size: 0.7rem;
          bottom: 10px;
        }
        .popup {
          padding: 20px;
          max-width: 90%;
        }
        .popup-title {
          font-size: 1.5rem;
        }
        .popup-message {
          font-size: 1rem;
        }
        .mobile-mode .btn {
          width: 45%;
          font-size: 1rem;
          padding: 12px;
          margin: 5px;
        }

        /* Adjust level grid in landscape */
        .mobile-mode .level-grid {
          max-height: 60vh;
          overflow-y: auto;
          padding: 5px;
        }
        .mobile-mode .leaderboard-btn {
          width: 40px;
          height: 40px;
          top: 10px;
          left: 60px;
        }
      }

      /* Global Mobile Mode Overrides (Apply regardless of screen width if class is present) */
      .mobile-mode .bottom-controls,
      .mobile-mode .top-left-controls,
      .mobile-mode .leaderboard-btn,
      .mobile-mode .editor-btn,
      .mobile-mode .login-btn,
      .mobile-mode .feedback-btn,
      .mobile-mode .controls-hint,
      .mobile-mode #social-notif {
        display: none !important;
      }

      .mobile-mode .mobile-menu-grid {
        display: flex;
        gap: 30px;
        align-items: center;
        justify-content: center;
        flex-direction: column; /* Default Portrait */
      }

      /* Mobile Landscape Redesign */
      @media screen and (orientation: landscape) and (max-height: 600px) {
        .mobile-mode .mobile-menu-grid {
          flex-direction: row !important;
          position: absolute;
          top: 50%;
          left: 50%;
          transform: translate(-50%, -50%);
          gap: 40px;
          width: auto;
        }
        .mobile-mode .mobile-icon-btn {
          width: 70px;
          height: 70px;
        }
        .mobile-mode .mobile-icon-btn.campaign-btn {
          width: 100px;
          height: 100px;
        }
        .mobile-mode h1 {
          display: none;
        }

        /* Settings Grid in Landscape */
        .mobile-mode .settings-grid {
          display: grid;
          grid-template-columns: 1fr 1fr;
          gap: 20px;
          width: 100%;
        }

        /* Leaderboard in Landscape */
        .mobile-mode .mobile-leaderboard-container {
          flex-direction: row !important;
        }
        .mobile-mode .mobile-leaderboard-header {
          width: 300px;
          border-bottom: none !important;
          border-right: 1px solid #333;
          height: 100%;
          justify-content: center;
        }

        /* Gamemode Carousel in Landscape */
        .mobile-mode .gamemode-carousel {
          height: 50vh !important;
        }
        .mobile-mode .gamemode-card {
          height: 200px !important;
          flex: 0 0 300px !important;
        }
      }

      .stats-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
        gap: 10px;
        width: 100%;
      }
      .stat-card {
        background: #222;
        padding: 10px;
        border: 1px solid #444;
        border-radius: 4px;
        text-align: center;
      }
      .stat-val {
        font-size: 1.2rem;
        font-weight: bold;
        color: #fff;
      }
      .stat-label {
        font-size: 0.7rem;
        color: #888;
        text-transform: uppercase;
        margin-top: 5px;
      }

      /* Accordion Styles */
      .accordion-section {
        width: 100%;
        border: 2px solid #333;
        background: #1a1a1a;
        margin-bottom: 10px;
        border-radius: 4px;
        overflow: hidden;
      }
      .accordion-header {
        padding: 15px;
        background: #222;
        cursor: pointer;
        display: flex;
        justify-content: space-between;
        align-items: center;
        font-size: 1.2rem;
        font-weight: bold;
        color: #ccc;
        transition: background 0.2s;
        user-select: none;
      }
      .accordion-header:hover {
        background: #333;
        color: #fff;
      }
      .accordion-content {
        padding: 15px;
        display: none;
        border-top: 1px solid #333;
        flex-direction: column;
        gap: 15px;
      }
      .accordion-content.open {
        display: flex;
      }
      /* Custom Scrollbar for Accordion */
      .accordion-content::-webkit-scrollbar {
        width: 6px;
      }
      .accordion-content::-webkit-scrollbar-track {
        background: #1a1a1a;
      }
      .accordion-content::-webkit-scrollbar-thumb {
        background: #333;
        border-radius: 3px;
      }
      .accordion-arrow {
        transition: transform 0.2s;
      }
      .accordion-header.active .accordion-arrow {
        transform: rotate(180deg);
      }

      /* --- Intro Styles --- */
      #intro-layer {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: #000;
        z-index: 9999;
        display: none;
        align-items: center;
        justify-content: center;
        overflow: hidden;
      }
      #intro-sellwood {
        font-size: 3rem;
        color: #fff;
        opacity: 0;
        transition: opacity 1s;
        font-family: sans-serif;
        text-transform: uppercase;
        letter-spacing: 5px;
        position: absolute;
      }
      #intro-anim-container {
        position: relative;
        width: 100%;
        height: 100%;
        display: none;
        justify-content: center;
        align-items: center;
      }
      #intro-cube {
        width: 60px;
        height: 60px;
        background: #335699;
        position: absolute;
        top: -100px;
        left: 50%;
        transform: translateX(-50%);
        box-shadow: 0 0 30px #335699;
        border: 2px solid #fff;
      }
      #intro-title-text {
        font-size: 5rem;
        color: #fff;
        text-transform: uppercase;
        letter-spacing: 10px;
        text-shadow: 5px 5px 0px #335699;
        text-align: center;
        opacity: 0;
        transform: scale(0.8);
        transition: all 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275);
      }
    </style>
  </head>
  <body>
    <div id="main-menu">
      <h1>Block Over It</h1>
      <h2 id="menu-subtitle"></h2>
      <div id="menu-content" class="menu-container"></div>

      <div class="bottom-controls">
        <button
          class="news-btn btn"
          style="min-width: auto; padding: 10px 20px; font-size: 1rem"
          onclick="showMenu('news')"
        >
          <span>News</span>
          <div id="news-notif" class="notif-dot"></div>
        </button>

        <button
          class="credits-btn btn"
          style="min-width: auto; padding: 10px 20px; font-size: 1rem"
          onclick="showMenu('credits')"
        >
          <span>Credits</span>
        </button>

        <button
          class="beats-btn btn"
          style="min-width: auto; padding: 10px 20px; font-size: 1rem"
          onclick="showMenu('beats-menu')"
        >
          <span>Beats</span>
        </button>

        <button
          class="settings-btn btn"
          style="min-width: auto; padding: 10px 20px; font-size: 1rem"
          onclick="showMenu('settings')"
        >
          <span>Settings</span>
        </button>
      </div>

      <div class="top-left-controls">
        <button class="leaderboard-btn" onclick="showMenu('leaderboards-new')">
          <span>Leaderboards</span>
          <svg
            style="display: none; width: 24px; height: 24px; fill: currentColor"
            viewBox="0 0 24 24"
          >
            <path
              d="M16 11V3H8v6H2v12h20V11h-6zm-6-6h4v14h-4V5zm-6 6h4v8H4v-8zm16 8h-4v-6h4v6z"
            />
          </svg>
          <div id="leaderboard-notif" class="notif-dot"></div>
        </button>
        <button class="awards-btn" onclick="showMenu('level-awards')">
          <span>Level Awards</span>
        </button>
      </div>

      <button
        class="editor-btn"
        onclick="
          if (gameSettings.editorNewTab)
            window.open('Block%20Architect%20Pro.html', '_blank');
          else window.location.href = 'Block%20Architect%20Pro.html';
            window.open('editor.html', '_blank');
          else window.location.href = 'editor.html';
        "
      >
        <span>Level Editor</span>
        <svg
          style="display: none; width: 24px; height: 24px; fill: currentColor"
          viewBox="0 0 24 24"
        >
          <path
            d="M3 17.25V21h3.75L17.81 9.94l-3.75-3.75L3 17.25zM20.71 7.04c.39-.39.39-1.02 0-1.41l-2.34-2.34c-.39-.39-1.02-.39-1.41 0l-1.83 1.83 3.75 3.75 1.83-1.83z"
          />
        </svg>
      </button>

      <button class="feedback-btn" onclick="openFeedbackModal()">
        <svg width="20" height="20" fill="currentColor" viewBox="0 0 24 24">
          <path
            d="M20 2H4c-1.1 0-1.99.9-1.99 2L2 22l4-4h14c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2zm-7 12h-2v-2h2v2zm0-4h-2V6h2v4z"
          />
        </svg>
      </button>

      <button id="login-menu-btn" class="login-btn" onclick="openLoginModal()">
        <div class="login-icon">
          <svg width="24" height="24" fill="currentColor" viewBox="0 0 24 24">
            <path
              d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z"
            />
          </svg>
        </div>
        <span class="login-text">Sign In</span>
      </button>

      <div class="controls-hint">
        ARROWS/WASD to Move | ESC for Menu | Made by Theo
      </div>
    </div>

    <input type="file" id="file-input" accept=".json" />

    <div id="game-container"></div>
    <div class="hud" id="hud">ESC</div>

    <button
      id="zoom-btn"
      class="btn"
      onclick="
        if (activeLevelDisplay)
          activeLevelDisplay.setZoomOut(!activeLevelDisplay.zoomedOut);
      "
      style="
        display: none;
        position: absolute;
        top: 20px;
        right: 70px;
        width: 44px;
        height: 44px;
        padding: 0;
        z-index: 60;
        align-items: center;
        justify-content: center;
      "
    >
      <svg width="24" height="24" fill="currentColor" viewBox="0 0 24 24">
        <path
          d="M15.5 14h-.79l-.28-.27C15.41 12.59 16 11.11 16 9.5 16 5.91 13.09 3 9.5 3S3 5.91 3 9.5 5.91 16 9.5 16c1.61 0 3.09-.59 4.23-1.57l.27.28v.79l5 4.99L20.49 19l-4.99-5zm-6 0C7.01 14 5 11.99 5 9.5S7.01 5 9.5 5 14 7.01 14 9.5 11.99 14 9.5 14zM7 9h5v1H7z"
        />
      </svg>
    </button>
    <button id="restart-btn" class="btn" onclick="restartCurrentLevel()">
      <svg width="24" height="24" fill="currentColor" viewBox="0 0 24 24">
        <path
          d="M17.65 6.35C16.2 4.9 14.21 4 12 4c-4.42 0-7.99 3.58-7.99 8s3.57 8 7.99 8c3.73 0 6.84-2.55 7.73-6h-2.08c-.82 2.33-3.04 4-5.65 4-3.31 0-6-2.69-6-6s2.69-6 6-6c1.66 0 3.14.69 4.22 1.78L13 11h7V4l-2.35 2.35z"
        />
      </svg>
    </button>
    <div id="timer-display">00:00.000</div>
    <div id="highscore-display">BEST: --:--.---</div>
    <canvas id="confetti-canvas"></canvas>

    <div id="intro-layer">
      <div id="intro-sellwood">Sellwood Game Studios</div>
      <div id="intro-anim-container">
        <div id="intro-cube"></div>
        <div id="intro-title-text">BLOCK<br />OVER IT</div>
      </div>
    </div>

    <div id="notification-banner" class="notification-banner">
      <div id="notif-text">Notification Text</div>
      <div id="notif-actions" style="display: flex; gap: 10px"></div>
    </div>

    <div class="mobile-controls-overlay">
      <div class="mc-dpad">
        <div class="mc-btn" id="mc-left">
          <svg viewBox="0 0 24 24">
            <path d="M15.41 7.41L14 6l-6 6 6 6 1.41-1.41L10.83 12z" />
          </svg>
        </div>
        <div class="mc-btn" id="mc-right">
          <svg viewBox="0 0 24 24">
            <path d="M10 6L8.59 7.41 13.17 12l-4.58 4.59L10 18l6-6z" />
          </svg>
        </div>
      </div>
      <div class="mc-action">
        <div class="mc-btn" id="mc-up">
          <svg viewBox="0 0 24 24">
            <path d="M12 8l-6 6 1.41 1.41L12 10.83l4.59 4.58L18 14z" />
          </svg>
        </div>
      </div>
    </div>

    <script>
      // --- Safe Storage Helper ---
      const safeStorage = {
        getItem: function (key) {
          try {
            return localStorage.getItem(key);
          } catch (e) {
            return null;
          }
        },
        setItem: function (key, value) {
          try {
            localStorage.setItem(key, value);
          } catch (e) {}
        },
        removeItem: function (key) {
          try {
            localStorage.removeItem(key);
          } catch (e) {}
        },
        clear: function () {
          try {
            localStorage.clear();
          } catch (e) {}
        },
      };

      // --- Supabase Stuff ---
      const supabaseUrl = "https://heqmnluegbbglmhtublu.supabase.co";
      const supabaseKey = "sb_publishable_tOOikmqOrVhpJAjLuyeqaA_nzF6CkOA";
      let _supabase = null;
      let currentUser = null;
      let currentUserSkins = ["default"];
      const SKIN_DEFINITIONS = {
        default: { name: "Default", copies: "N/A" },
        chairlord: { name: "Chairlord", copies: "1/1" },
        sunset: { name: "Sunset", copies: "1/2" },
        rainbowmonster: { name: "Rainbow Monster", copies: "1/2" },
        burningheart: { name: "Burning Heart", copies: "1/3" },
        tv: { name: "TV", copies: "1/2" },
        cubemouth: { name: "Cube Mouth", copies: "1/5" },
        bluecoin: { name: "Blue Coin", copies: "Unlockable" },
        firstplacedaddy: { name: "First Place Daddy", copies: "1/1" },
        dino: { name: "Dino", copies: "1/2" },
        emo: { name: "Emotion", copies: "1/3" },
      };
      const LATEST_NEWS_VERSION = "1.5.1"; // Not even really related to supabase
      if (window.supabase && supabaseKey !== "INSERT_YOUR_ANON_KEY_HERE") {
        _supabase = window.supabase.createClient(supabaseUrl, supabaseKey);
      }

      async function fetchGlobalHighscore(key) {
        if (!_supabase) return null;
        try {
          const { data, error } = await _supabase
            .from("highscores")
            .select("time_ms")
            .eq("level_key", key)
            .order("time_ms", { ascending: true })
            .limit(1)
            .single();

          if (error && error.code !== "PGRST116") {
            // PGRST116 is "Row not found" which is fine
            console.warn("Supabase fetch error:", error);
            return null;
          }
          return data ? data.time_ms : null;
        } catch (e) {
          return null;
        }
      }

      async function fetchLevelLeaderboard(key, limit = 10) {
        if (!_supabase) return [];
        try {
          let query = _supabase
            .from("leaderboard")
            .select("username, time_ms")
            .eq("level_key", key)
            .order("time_ms", { ascending: true });

          if (limit > 0) query = query.limit(limit);

          const { data, error } = await query;

          if (error) {
            console.warn("Supabase leaderboard error:", error);
            return [];
          }
          return data || [];
        } catch (e) {
          return [];
        }
      }

      async function submitHighscoreToCloud(key, time) {
        if (!_supabase || !currentUser) return;
        if (currentUser.toLowerCase() === "anonymous") return;
        try {
          await _supabase.from("highscores").insert([
            {
              level_key: key,
              time_ms: time,
              username: currentUser,
            },
          ]);
        } catch (e) {
          console.warn("Supabase submit error:", e);
        }
      }

      async function syncDataToCloud() {
        if (!_supabase || !currentUser) return;
        const saveData = {
          gameState,
          customLevels,
          customLevelsProgress,
          highscores,
          gameSettings,
        };
        try {
          await _supabase
            .from("users")
            .update({ data: saveData, skins: currentUserSkins })
            .eq("username", currentUser);
        } catch (e) {
          console.warn("Cloud sync error:", e);
        }
      }

      async function handleAuth(type, username, password) {
        if (!_supabase)
          return showPopup("ERROR", "Supabase not configured.", () => {});
        if (!username || !password)
          return showPopup(
            "ERROR",
            "Please enter username and password.",
            () => {},
          );

        try {
          if (type === "signup") {
            // Check if user exists
            const { data: existing } = await _supabase
              .from("users")
              .select("username")
              .eq("username", username)
              .single();
            if (existing)
              return showPopup("ERROR", "Username already taken.", () => {});

            const saveData = {
              gameState,
              customLevels,
              customLevelsProgress,
              highscores,
              gameSettings,
            };
            const { error } = await _supabase
              .from("users")
              .insert([
                { username, password, data: saveData, skins: ["default"] },
              ]);
            if (error) throw error;

            currentUser = username;
            showPopup("SUCCESS", "Signed up successfully!", () => {});
          } else {
            const { data, error } = await _supabase
              .from("users")
              .select("*")
              .eq("username", username)
              .eq("password", password)
              .single();
            if (error || !data)
              return showPopup("ERROR", "Invalid credentials.", () => {});

            currentUser = username;
            if (data.skins) currentUserSkins = data.skins;
            if (data.data) {
              // Load data
              const d = data.data;
              if (d.gameState) gameState = d.gameState;
              if (d.customLevels) customLevels = d.customLevels;
              if (d.customLevelsProgress)
                customLevelsProgress = d.customLevelsProgress;
              // Only load highscores as requested
              if (d.highscores) highscores = d.highscores;
              if (d.gameSettings) gameSettings = d.gameSettings;
              saveGame();
              saveCustomLevels();
              saveCustomLevelsProgress();
              saveHighscores();
              saveSettings();
              checkBlueCoinSkinUnlock();
            }
            showPopup("SUCCESS", "Logged in! Data synced.", () => {});
          }
          updateLoginButton();
          safeStorage.setItem("blockoverit_username", currentUser);
        } catch (e) {
          showPopup("ERROR", "Auth error: " + e.message, () => {});
        }
      }

      async function fetchAndSyncUserData() {
        if (!_supabase || !currentUser) return;
        try {
          const { data, error } = await _supabase
            .from("users")
            .select("data, skins")
            .eq("username", currentUser)
            .single();

          if (data && data.skins) currentUserSkins = data.skins;
          if (data && data.data) {
            const d = data.data;
            if (d.gameState) {
              if (d.gameState.levelBlueCoins) {
                gameState.levelBlueCoins = {
                  ...gameState.levelBlueCoins,
                  ...d.gameState.levelBlueCoins,
                };
              }
              gameState.unlockedLevel = Math.max(
                gameState.unlockedLevel,
                d.gameState.unlockedLevel || 0,
              );
              gameState.unlockedLevelCh2 = Math.max(
                gameState.unlockedLevelCh2,
                d.gameState.unlockedLevelCh2 || 0,
              );
              gameState.unlockedLevelCh3 = Math.max(
                gameState.unlockedLevelCh3,
                d.gameState.unlockedLevelCh3 || 0,
              );
              if (d.gameState.chapter1Beaten) gameState.chapter1Beaten = true;
              if (d.gameState.chapter2Beaten) gameState.chapter2Beaten = true;
              if (d.gameState.chapter3Beaten) gameState.chapter3Beaten = true;
              if (d.gameState.gameBeaten) gameState.gameBeaten = true;
              if (d.gameState.blueCoinUnlockShown)
                gameState.blueCoinUnlockShown = true;
            }
            if (d.customLevelsProgress)
              customLevelsProgress = {
                ...customLevelsProgress,
                ...d.customLevelsProgress,
              };
            if (d.highscores) {
              for (const key in d.highscores) {
                if (!highscores[key] || d.highscores[key] < highscores[key])
                  highscores[key] = d.highscores[key];
              }
            }
            if (d.customLevels) customLevels = d.customLevels;
            if (d.gameSettings && d.gameSettings.playlist)
              gameSettings.playlist = d.gameSettings.playlist;

            saveGame();
            saveCustomLevels();
            saveCustomLevelsProgress();
            saveHighscores();
            saveSettings();
            checkBlueCoinSkinUnlock();
          }
        } catch (e) {
          console.warn("Sync error:", e);
        }
      }

      async function submitFeedback(text) {
        if (!_supabase)
          return showPopup("ERROR", "Supabase not configured.", () => {});
        if (!text || text.trim() === "")
          return showPopup("ERROR", "Feedback cannot be empty.", () => {});

        try {
          await _supabase.from("feedback").insert([
            {
              feedback: text,
              username: currentUser || "Anonymous",
            },
          ]);
          showPopup("SUCCESS", "Feedback sent! Thank you.", () => {});
        } catch (e) {
          showPopup("ERROR", "Failed to send feedback: " + e.message, () => {});
        }
      }

      function openFeedbackModal() {
        const html = `
            <textarea id="feedback-text" placeholder="Enter your feedback here..." style="width: 100%; height: 150px; background: #333; color: white; border: 1px solid #555; padding: 10px; box-sizing: border-box; resize: none; font-family: inherit; margin-bottom: 15px;"></textarea>
            <div style="display:flex; justify-content:center;">
                <button class="popup-btn" onclick="submitFeedback(document.getElementById('feedback-text').value); document.querySelector('.popup-overlay').remove()">SEND</button>
            </div>
        `;
        showPopup("FEEDBACK", "", () => {});
        const msgEl = document.querySelector(".popup-message");
        if (msgEl) msgEl.innerHTML = html;
        const btns = document.querySelector(".popup-buttons");
        if (btns) btns.style.display = "none";
      }

      function openChangePasswordModal() {
        const html = `
            <div style="display:flex; flex-direction:column; gap:10px;">
                <input id="cp-old" type="password" placeholder="Current Password" style="padding:10px; background:#333; color:white; border:1px solid #555;">
                <input id="cp-new" type="password" placeholder="New Password" style="padding:10px; background:#333; color:white; border:1px solid #555;">
                <div style="display:flex; gap:10px; justify-content:center; margin-top:10px;">
                    <button class="popup-btn" onclick="changePassword(document.getElementById('cp-old').value, document.getElementById('cp-new').value); document.querySelector('.popup-overlay').remove()">UPDATE</button>
                </div>
            </div>
        `;
        showPopup("CHANGE PASSWORD", "", () => {});
        const msgEl = document.querySelector(".popup-message");
        if (msgEl) msgEl.innerHTML = html;
        const btns = document.querySelector(".popup-buttons");
        if (btns) btns.style.display = "none";
      }

      async function changePassword(oldPass, newPass) {
        if (!_supabase || !currentUser) return;
        if (!newPass)
          return showPopup("ERROR", "Password cannot be empty.", () => {});
        if (!oldPass)
          return showPopup(
            "ERROR",
            "Please enter your current password.",
            () => {},
          );

        try {
          // Verify old password
          const { data, error: verifyError } = await _supabase
            .from("users")
            .select("id")
            .eq("username", currentUser)
            .eq("password", oldPass)
            .single();

          if (verifyError || !data) {
            return showPopup("ERROR", "Incorrect current password.", () => {});
          }

          const { error } = await _supabase
            .from("users")
            .update({ password: newPass })
            .eq("username", currentUser);

          if (error) throw error;
          showPopup("SUCCESS", "Password updated successfully!", () => {});
        } catch (e) {
          showPopup(
            "ERROR",
            "Failed to update password: " + e.message,
            () => {},
          );
        }
      }

      function updateLoginButton() {
        const btn = document.getElementById("login-menu-btn");
        if (currentUser) {
          btn.innerHTML = `<div class="login-icon"><svg width="24" height="24" fill="currentColor" viewBox="0 0 24 24"><path d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z"/></svg></div><span class="login-text">${currentUser}</span>`;
          btn.onclick = () => {
            openAccountModal();
          };
        } else {
          btn.innerHTML = `<div class="login-icon"><svg width="24" height="24" fill="currentColor" viewBox="0 0 24 24"><path d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z"/></svg></div><span class="login-text">Sign In</span>`;
          btn.onclick = openLoginModal;
        }
      }

      // Synth

      const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
      let bgmOscillator = null;
      let synthGainNode = null;
      let currentSynthId = 0;
      let currentAudio = null;
      let currentPlayingTrackId = null;
      let isMusicPaused = false;
      let isTransitioning = false;
      let fadeInterval = null;
      let beatsUpdateInterval = null;
      let menuMusicState = { trackId: "synth", time: 0 };
      let synthVolumeScale = 1.0;
      let synthStartTime = 0;

      function togglePause() {
        isMusicPaused = !isMusicPaused;
        if (isMusicPaused) {
          if (currentAudio) currentAudio.pause();
          if (bgmOscillator) {
            if (synthGainNode) synthGainNode.gain.value = 0;
          }
        } else {
          if (currentAudio) currentAudio.play();
          else if (currentPlayingTrackId === "synth") {
            if (synthGainNode)
              synthGainNode.gain.value = 0.02 * (gameSettings.volume / 100);
          }
        }
        if (currentMenuView === "beats-menu") showMenu("beats-menu");
      }

      function getNextPlaylistTrack() {
        const playlist = gameSettings.playlist || [];
        if (playlist.length === 0) return "synth";

        if (gameSettings.shuffleMusic) {
          return playlist[Math.floor(Math.random() * playlist.length)];
        } else {
          let idx = playlist.indexOf(currentPlayingTrackId);
          if (idx === -1) idx = 0;
          else idx = (idx + 1) % playlist.length;
          return playlist[idx];
        }
      }

      function playMusic(specificTrackId = null, immediate = false) {
        if (isMusicPaused && !immediate) return;
        if (immediate) isMusicPaused = false;

        // If immediate request (user clicked), cancel any ongoing transition
        if (immediate && isTransitioning) {
          clearInterval(fadeInterval);
          isTransitioning = false;
        } else if (isTransitioning) return;

        let targetId = null;
        let targetFile = null;

        // Determine target track logic
        if (specificTrackId) {
          // User clicked a specific track
          targetId = specificTrackId;
          const libItem = MUSIC_LIBRARY.find((t) => t.id === targetId);
          if (libItem) {
            targetFile = libItem.file;
          } else {
            // Fallback for direct file paths or if unknown ID
            targetFile = targetId.includes(".") ? targetId : null;
          }
        } else if (activeLevelDisplay) {
          // In a level, automatic music
          if (
            currentGameMode === "speedrun" ||
            currentGameMode === "deathrun" ||
            currentGameMode === "chapter_speedrun"
          ) {
            // Speedrun/Deathrun music
            const t = MUSIC_LIBRARY.find((x) => x.id === "skate");
            if (t) {
              targetId = t.id;
              targetFile = t.file;
            }
          } else if (currentLevelData && currentLevelData.music) {
            let libItem = MUSIC_LIBRARY.find(
              (t) => t.id === currentLevelData.music,
            );
            if (!libItem) {
              libItem = MUSIC_LIBRARY.find(
                (t) => t.file === currentLevelData.music,
              );
            }

            if (libItem) {
              targetId = libItem.id;
              targetFile = libItem.file;
            } else {
              targetId = "level_custom";
              targetFile = currentLevelData.music;
            }
          } else {
            targetId = "synth";
          }
        } else {
          // In the menu, automatic music
          // Menu Mode
          targetId = menuMusicState.trackId || getNextPlaylistTrack();
          if (targetId !== "synth") {
            const t = MUSIC_LIBRARY.find((x) => x.id === targetId);
            targetFile = t ? t.file : null;
          }
        }

        if (targetId === currentPlayingTrackId && !immediate) return;

        if (immediate) {
          if (targetId === currentPlayingTrackId) {
            if (currentAudio && currentAudio.paused) currentAudio.play();
            if (
              currentPlayingTrackId === "synth" &&
              bgmOscillator &&
              synthGainNode
            ) {
              synthGainNode.gain.value = 0.02 * (gameSettings.volume / 100);
            }
            return;
          }
          stopAllAudio();
          startTrack(targetId, targetFile);
          return;
        }

        // Start Transition
        isTransitioning = true;

        // Fade out current
        const fadeTime = 500;
        const steps = 20;
        const volStep = gameSettings.volume / 100 / steps;

        fadeInterval = setInterval(() => {
          let done = true;
          if (currentAudio && currentAudio.volume > 0) {
            currentAudio.volume = Math.max(0, currentAudio.volume - volStep);
            done = false;
          }
          if (bgmOscillator && synthVolumeScale > 0) {
            synthVolumeScale = Math.max(0, synthVolumeScale - 1 / steps);
            done = false;
          }

          if (done) {
            clearInterval(fadeInterval);
            stopAllAudio();

            setTimeout(() => {
              startTrack(targetId, targetFile);
              isTransitioning = false;
            }, 300);
          }
        }, fadeTime / steps);
      }

      function stopAllAudio() {
        if (currentAudio) {
          currentAudio.pause();
          currentAudio.currentTime = 0;
          currentAudio = null;
        }
        if (bgmOscillator) {
          bgmOscillator = null;
          synthGainNode = null;
        }
      }

      function startTrack(id, file) {
        currentPlayingTrackId = id;
        synthVolumeScale = 1.0;

        // Check restoration before updating state
        let shouldRestore = false;
        let restoreTime = 0;
        if (
          !activeLevelDisplay &&
          id === menuMusicState.trackId &&
          menuMusicState.time > 0
        ) {
          shouldRestore = true;
          restoreTime = menuMusicState.time;
        }

        // Update menu state if in menu to prevent reverting to old track
        if (!activeLevelDisplay) {
          menuMusicState.trackId = id;
          menuMusicState.time = 0;
        }

        if (file) {
          // Play Song
          currentAudio = new Audio(file);
          currentAudio.onerror = () => {
            console.warn("Audio load error, falling back to synth");
            startTrack("synth", null);
          };
          currentAudio.volume = gameSettings.volume / 100;

          if (activeLevelDisplay) {
            currentAudio.loop = true;
          } else {
            currentAudio.loop = false;
            // Restore time if resuming menu track
            if (shouldRestore) {
              currentAudio.currentTime = restoreTime;
            }
            currentAudio.addEventListener("ended", () => {
              const next = getNextPlaylistTrack();
              currentPlayingTrackId = null;
              playMusic(next);
            });
          }

          currentAudio
            .play()
            .catch((e) => console.warn("Audio play failed", e));

          if (!activeLevelDisplay) {
            const info = MUSIC_LIBRARY.find((t) => t.id === id);
            if (info) showMusicNotification(info.title, info.artist);
          }
        } else {
          // Play Synth
          playSynth();
          if (!activeLevelDisplay && id === "synth" && !isTransitioning) {
            showMusicNotification("Blockoverit", "Classic Synth");
          }
        }

        if (currentMenuView === "beats-menu") updateBeatsUI();
      }

      function showMusicNotification(title, artist) {
        let notif = document.getElementById("music-notif");
        if (!notif) {
          notif = document.createElement("div");
          notif.id = "music-notif";
          notif.className = "music-notification";
          document.body.appendChild(notif);
        }
        notif.innerHTML = `
            <div class="music-notif-title">Now Playing</div>
            <div style="font-size: 0.9rem; color: #fff;">${title}</div>
            <div class="music-notif-artist">${artist}</div>
          `;

        requestAnimationFrame(() => {
          notif.classList.add("show");
          setTimeout(() => {
            notif.classList.remove("show");
          }, 4000);
        });
      }

      function playSynth() {
        if (bgmOscillator) return; // Already playing synth
        currentSynthId++;
        const thisSynthId = currentSynthId;

        const notes = [
          220, 0, 220, 0, 261, 0, 329, 0, 220, 0, 220, 0, 196, 0, 164, 0, 220,
          0, 329, 0, 392, 0, 440, 0, 392, 0, 329, 0, 261, 0, 246, 0,
        ];
        let noteIndex = 0;
        const tempo = 120;
        synthStartTime = Date.now();

        function playNextNote() {
          // Stop if we switched to a file or stopped synth
          if (thisSynthId !== currentSynthId) return;
          if (currentPlayingTrackId !== "synth") return;
          if (isMusicPaused) {
            setTimeout(playNextNote, 500);
            return;
          }

          // Synth duration limit (1.5 mins)
          if (Date.now() - synthStartTime > 90000) {
            currentPlayingTrackId = null;
            playMusic(getNextPlaylistTrack());
            return;
          }

          const osc = audioCtx.createOscillator();
          const gainNode = audioCtx.createGain();
          synthGainNode = gainNode;

          osc.type = "square";
          osc.frequency.setValueAtTime(notes[noteIndex], audioCtx.currentTime);

          const vol = 0.1 * (gameSettings.volume / 100) * synthVolumeScale;
          gainNode.gain.setValueAtTime(vol, audioCtx.currentTime);
          gainNode.gain.exponentialRampToValueAtTime(
            0.001,
            audioCtx.currentTime + tempo / 1000,
          );

          osc.connect(gainNode);
          gainNode.connect(audioCtx.destination);

          osc.start();
          osc.stop(audioCtx.currentTime + tempo / 1000);

          noteIndex = (noteIndex + 1) % notes.length;
          setTimeout(playNextNote, tempo);
        }

        if (audioCtx.state === "suspended") audioCtx.resume();
        bgmOscillator = true;
        playNextNote();
      }

      // --- Data & Persistence ---
      const SAVE_KEY = "blockoverit_v3_save";
      const CUSTOM_LEVELS_KEY = "blockoverit_custom_levels";
      const CUSTOM_LEVELS_PROGRESS_KEY = "blockoverit_custom_levels_progress";

      // Campaign Progress
      let gameState = JSON.parse(safeStorage.getItem(SAVE_KEY)) || {
        unlockedLevel: 0,
        unlockedLevelCh2: 0,
        unlockedLevelCh3: 0,
        gameBeaten: false,
        levelBlueCoins: {},
        blueCoinUnlockShown: false,
        chapter1Beaten: false,
        chapter2Beaten: false,
        chapter3Beaten: false,
      };

      // Migration for existing saves
      if (gameState.unlockedLevelCh2 === undefined)
        gameState.unlockedLevelCh2 = 0;
      if (gameState.unlockedLevelCh3 === undefined)
        gameState.unlockedLevelCh3 = 0;
      if (gameState.chapter3Beaten === undefined)
        gameState.chapter3Beaten = false;

      // Custom Levels Storage
      let customLevels =
        JSON.parse(safeStorage.getItem(CUSTOM_LEVELS_KEY)) || [];

      // Custom Levels Progress (tracks which levels have been beaten)
      let customLevelsProgress =
        JSON.parse(safeStorage.getItem(CUSTOM_LEVELS_PROGRESS_KEY)) || {};

      // Game Modes
      let currentGameMode = "campaign"; // 'campaign', 'custom', 'speedrun', 'deathrun'
      let gameTimer = 0;
      let gameTimerRunning = false;
      let gameTimerStart = 0;
      let speedrunEndTime = 0;

      // Highscores
      const HIGHSCORES_KEY = "blockoverit_highscores";
      let highscores = JSON.parse(safeStorage.getItem(HIGHSCORES_KEY)) || {};

      const MUSIC_LIBRARY = [
        {
          id: "synth",
          title: "Blockoverit",
          artist: "Block Over It",
          file: null,
        },
        {
          id: "none",
          title: "No Music",
          artist: "Silence",
          file: null,
        },
        {
          id: "joyful",
          title: "Joyful Morning",
          artist: "Noah Mark Hansen",
          file: "joyful_morning.mp3",
        },
        {
          id: "ant",
          title: "Ant Territory",
          artist: "Noah Mark Hansen",
          file: "ant_territory.mp3",
        },
        {
          id: "byte",
          title: "Byte Blast",
          artist: "Noah Mark Hansen",
          file: "byte_blast.mp3",
        },
        {
          id: "peaceful",
          title: "Peaceful Ambush",
          artist: "Noah Mark Hansen",
          file: "peaceful_ambush.mp3",
        },
        {
          id: "cold",
          title: "Cold Breeze",
          artist: "Noah Mark Hansen",
          file: "cold_breeze.mp3",
        },
        {
          id: "champions",
          title: "For Champions",
          artist: " ",
          file: "for_champions.mp3",
        },
        { id: "level6", title: "Level VI", artist: " ", file: "level_vi.mp3" },
        {
          id: "skate",
          title: "Skate Away",
          artist: "Noodlez Studios",
          file: "skate_away.mp3",
        },
        {
          id: "arcade",
          title: "Arcade",
          artist: "Blockoverit",
          file: "arcade.mp3",
        },
        {
          id: "time",
          title: "Taking Our Time",
          artist: "Alex Grohl",
          file: "time.mp3",
        },
        {
          id: "darkness",
          title: "Darkness",
          artist: "Dmitrii Spis",
          file: "darkness.mp3",
        },
        {
          id: "last_point",
          title: "The Last Point",
          artist: "Rasberry Music",
          file: "last_point.mp3",
        },
        {
          id: "drift",
          title: "Drift",
          artist: "DELOsound",
          file: "drift.mp3",
        },
        {
          id: "night",
          title: "Night",
          artist: "DELOsound",
          file: "night.mp3",
        },
        {
          id: "showcase",
          title: "Showcase",
          artist: "DELOsound",
          file: "showcase.mp3",
        },
      ];

      const SETTINGS_KEY = "blockoverit_settings";
      let gameSettings = JSON.parse(safeStorage.getItem(SETTINGS_KEY)) || {
        camera: false,
        alternateBlueCoinStyle: false, // New setting for alternate blue coin style
        volume: 50,
        menuMusic: "synth",
        confirmDelete: true,
        sensitivity: 50,
        shuffleMusic: true,
        showEditorButton: false,
        editorNewTab: false,
        currentSkin: "default",
        showHitboxes: false,
        playlist: [
          "synth",
          "joyful",
          "ant",
          "byte",
          "peaceful",
          "cold",
          "champions",
          "level6",
        ],
      };
      if (!gameSettings.playlist) {
        gameSettings.playlist = [
          "synth",
          "joyful",
          "ant",
          "byte",
          "peaceful",
          "cold",
          "champions",
          "level6",
        ];
      }
      // Add new songs to default playlist for new users
      if (!gameSettings.playlist.includes("skate"))
        gameSettings.playlist.push("skate");
      if (!gameSettings.playlist.includes("arcade"))
        gameSettings.playlist.push("arcade");
      if (!gameSettings.playlist.includes("time"))
        gameSettings.playlist.push("time");
      if (!gameSettings.playlist.includes("darkness"))
        gameSettings.playlist.push("darkness");
      if (!gameSettings.playlist.includes("last_point"))
        gameSettings.playlist.push("last_point");
      if (!gameSettings.playlist.includes("drift"))
        gameSettings.playlist.push("drift");
      if (!gameSettings.playlist.includes("night"))
        gameSettings.playlist.push("night");
      if (!gameSettings.playlist.includes("showcase"))
        gameSettings.playlist.push("showcase");

      if (gameSettings.shuffleMusic === undefined)
        gameSettings.shuffleMusic = true;
      if (gameSettings.sensitivity === undefined) gameSettings.sensitivity = 50;
      if (gameSettings.confirmDelete === undefined)
        gameSettings.confirmDelete = true;
      if (gameSettings.showEditorButton === undefined)
        gameSettings.showEditorButton = false;
      if (gameSettings.editorNewTab === undefined)
        gameSettings.editorNewTab = false;
      if (gameSettings.showHitboxes === undefined)
        gameSettings.showHitboxes = false;
      if (gameSettings.currentSkin === undefined)
        gameSettings.currentSkin = "default";
      if (!gameSettings.playlist)
        gameSettings.playlist = MUSIC_LIBRARY.map((t) => t.id);

      function saveSettings() {
        safeStorage.setItem(SETTINGS_KEY, JSON.stringify(gameSettings));
      }

      function saveHighscores() {
        safeStorage.setItem(HIGHSCORES_KEY, JSON.stringify(highscores));
        syncDataToCloud();
      }

      function getHighscoreKey(type, chapter, index, category = "any") {
        let prefix = "";
        if (currentGameMode === "speedrun") prefix = "speedrun_";
        else if (currentGameMode === "deathrun") prefix = "deathrun_";
        else if (currentGameMode === "chapter_speedrun")
          return `chapter_speedrun_${chapter}`;

        if (category === "blue") prefix += "blue_";

        if (type === "custom") return `${prefix}custom_${index}`;
        return `${prefix}campaign_${chapter}_${index}`;
      }

      function saveGame() {
        safeStorage.setItem(SAVE_KEY, JSON.stringify(gameState));
        syncDataToCloud();
      }

      // --- Confetti System ---
      const confettiCanvas = document.getElementById("confetti-canvas");
      const confettiCtx = confettiCanvas.getContext("2d");
      let confettiParticles = [];
      let confettiAnimationId = null;

      function resizeConfetti() {
        confettiCanvas.width = window.innerWidth;
        confettiCanvas.height = window.innerHeight;
      }
      window.addEventListener("resize", resizeConfetti);
      resizeConfetti();

      function triggerConfetti() {
        for (let i = 0; i < 150; i++) {
          confettiParticles.push({
            x: window.innerWidth / 2,
            y: window.innerHeight / 2,
            vx: (Math.random() - 0.5) * 25,
            vy: (Math.random() - 0.5) * 25,
            color: `hsl(${Math.random() * 360}, 100%, 50%)`,
            life: 100 + Math.random() * 50,
            size: Math.random() * 8 + 4,
          });
        }
        if (!confettiAnimationId) animateConfetti();
      }

      function animateConfetti() {
        confettiCtx.clearRect(
          0,
          0,
          confettiCanvas.width,
          confettiCanvas.height,
        );
        confettiParticles.forEach((p) => {
          p.x += p.vx;
          p.y += p.vy;
          p.vy += 0.2; // gravity
          p.vx *= 0.96; // friction
          p.life--;
          confettiCtx.fillStyle = p.color;
          confettiCtx.fillRect(p.x, p.y, p.size, p.size);
        });
        confettiParticles = confettiParticles.filter((p) => p.life > 0);
        if (confettiParticles.length > 0) {
          confettiAnimationId = requestAnimationFrame(animateConfetti);
        } else {
          confettiAnimationId = null;
          confettiCtx.clearRect(
            0,
            0,
            confettiCanvas.width,
            confettiCanvas.height,
          );
        }
      }

      function saveCustomLevels() {
        safeStorage.setItem(CUSTOM_LEVELS_KEY, JSON.stringify(customLevels));
        syncDataToCloud();
      }

      function saveCustomLevelsProgress() {
        safeStorage.setItem(
          CUSTOM_LEVELS_PROGRESS_KEY,
          JSON.stringify(customLevelsProgress),
        );
        syncDataToCloud();
      }

      // --- Popup System ---
      function showPopup(title, message, onConfirm) {
        const overlay = document.createElement("div");
        overlay.className = "popup-overlay";

        const popup = document.createElement("div");
        popup.className = "popup";

        const titleEl = document.createElement("div");
        titleEl.className = "popup-title";
        titleEl.textContent = title;

        const messageEl = document.createElement("div");
        messageEl.className = "popup-message";
        messageEl.textContent = message;

        const buttonsDiv = document.createElement("div");
        buttonsDiv.className = "popup-buttons";

        const closeBtn = document.createElement("button");
        closeBtn.className = "popup-close";
        closeBtn.innerHTML = "&times;";
        closeBtn.onclick = () => overlay.remove();

        const confirmBtn = document.createElement("button");
        confirmBtn.className = "popup-btn";
        confirmBtn.textContent = "OK";
        confirmBtn.onclick = () => {
          overlay.remove();
          onConfirm();
        };

        buttonsDiv.appendChild(confirmBtn);
        popup.appendChild(closeBtn);
        popup.appendChild(titleEl);
        popup.appendChild(messageEl);
        popup.appendChild(buttonsDiv);
        overlay.appendChild(popup);
        document.body.appendChild(overlay);
      }

      // --- Confirmation Popup ---
      function showConfirmPopup(title, message, onConfirm, onCancel) {
        const overlay = document.createElement("div");
        overlay.className = "popup-overlay";

        const popup = document.createElement("div");
        popup.className = "popup";

        const titleEl = document.createElement("div");
        titleEl.className = "popup-title";
        titleEl.textContent = title;

        const messageEl = document.createElement("div");
        messageEl.className = "popup-message";
        messageEl.textContent = message;

        const buttonsDiv = document.createElement("div");
        buttonsDiv.className = "popup-buttons";

        const closeBtn = document.createElement("button");
        closeBtn.className = "popup-close";
        closeBtn.innerHTML = "&times;";
        closeBtn.onclick = () => overlay.remove();

        const confirmBtn = document.createElement("button");
        confirmBtn.className = "popup-btn";
        confirmBtn.textContent = "YES";
        confirmBtn.onclick = () => {
          overlay.remove();
          onConfirm();
        };

        const cancelBtn = document.createElement("button");
        cancelBtn.className = "popup-btn secondary";
        cancelBtn.textContent = "NO";
        cancelBtn.onclick = () => {
          overlay.remove();
          if (onCancel) onCancel();
        };

        buttonsDiv.appendChild(confirmBtn);
        buttonsDiv.appendChild(cancelBtn);
        popup.appendChild(closeBtn);
        popup.appendChild(titleEl);
        popup.appendChild(messageEl);
        popup.appendChild(buttonsDiv);
        overlay.appendChild(popup);
        document.body.appendChild(overlay);
      }

      // --- Custom Level Popup ---
      function openAwardLevelPopup(lvl) {
        const difficulty = lvl.difficulty || 1;
        const desc = lvl.description || "No description provided.";
        const creator = lvl.creator || "Anonymous";

        const overlay = document.createElement("div");
        overlay.className = "cl-popup-overlay";

        let diffBars = "";
        for (let i = 1; i <= 5; i++) {
          diffBars += `<div class="diff-seg ${i <= difficulty ? "active" : ""}"></div>`;
        }

        overlay.innerHTML = `
            <div class="cl-popup">
                <div class="cl-header">
                    <div class="cl-title">
                        ${lvl.name || "Custom Level"}
                        <div style="font-size:0.8rem; color:#888; font-weight:normal; margin-top:5px;">by ${creator}</div>
                    </div>
                    <button class="cl-close" onclick="this.closest('.cl-popup-overlay').remove()">&times;</button>
                </div>
                <div class="cl-body">
                    <div class="cl-meta">
                        <div class="cl-meta-item">
                            <span style="color:#666; font-size:0.7rem; text-transform:uppercase;">Difficulty</span>
                            <div class="difficulty-bar">${diffBars}</div>
                        </div>
                    </div>
                    <div class="cl-desc">${desc}</div>
                    <div class="cl-stats">
                        <div class="cl-stat-box"><div class="cl-stat-label">Size</div><div class="cl-stat-value">${lvl.plan[0].length}x${lvl.plan.length}</div></div>
                        <div class="cl-stat-box"><div class="cl-stat-label">Gravity</div><div class="cl-stat-value">${lvl.gravity || 27}</div></div>
                    </div>
                </div>
                <div class="cl-actions">
                    <button class="btn" style="background:#335699; border-color:#2a4a7a; color:#fff; font-size:1rem; padding:10px 20px;" id="cl-add-btn">ADD TO MY LEVELS</button>
                </div>
            </div>
        `;

        document.body.appendChild(overlay);

        document.getElementById("cl-add-btn").onclick = () => {
          customLevels.push(JSON.parse(JSON.stringify(lvl)));
          saveCustomLevels();
          overlay.remove();
          showPopup("SUCCESS", "Level added to your custom levels!", () => {});
        };
      }

      function openCustomLevelPopup(index) {
        const lvl = customLevels[index];
        const isBeaten = customLevelsProgress[index] || false;
        const hasBlueCoin =
          gameState.levelBlueCoins[`custom_${index}`] || false;

        // Get Highscore
        const key = getHighscoreKey("custom", 1, index, "any");
        const bestTime = highscores[key];
        let timeStr = "--:--.---";
        if (bestTime) {
          const ms = String(bestTime % 1000).padStart(3, "0");
          const s = String(Math.floor(bestTime / 1000) % 60).padStart(2, "0");
          const m = String(Math.floor(bestTime / 60000)).padStart(2, "0");
          timeStr = `${m}:${s}.${ms}`;
        }

        const difficulty = lvl.difficulty || 1;
        const desc = lvl.description || "No description provided.";
        const creator = lvl.creator || "Anonymous";

        // Determine Buttons based on Mode
        let buttonsHtml = "";
        if (currentGameMode === "speedrun") {
          buttonsHtml = `<button class="btn" style="background:#e67e22; border-color:#d35400; color:#fff; font-size:1rem; padding:10px 20px;" id="cl-action-btn">SPEEDRUN</button>`;
        } else if (currentGameMode === "deathrun") {
          buttonsHtml = `<button class="btn" style="background:#a04040; border-color:#802020; color:#fff; font-size:1rem; padding:10px 20px;" id="cl-action-btn">DEATHRUN</button>`;
        } else if (currentGameMode === "practice") {
          buttonsHtml = `<button class="btn" style="background:#2ecc71; border-color:#27ae60; color:#000; font-size:1rem; padding:10px 20px;" id="cl-action-btn">PRACTICE</button>`;
        } else {
          buttonsHtml = `
            <button class="btn" style="background:#e67e22; border-color:#d35400; color:#fff; font-size:1rem; padding:10px 20px;" id="cl-speed-btn">SPEEDRUN</button>
            <button class="btn" style="background:#2ecc71; border-color:#27ae60; color:#000; font-size:1rem; padding:10px 20px;" id="cl-play-btn">PLAY LEVEL</button>
          `;
        }

        const overlay = document.createElement("div");
        overlay.className = "cl-popup-overlay";

        let diffBars = "";
        for (let i = 1; i <= 5; i++) {
          diffBars += `<div class="diff-seg ${i <= difficulty ? "active" : ""}"></div>`;
        }

        overlay.innerHTML = `
            <div class="cl-popup">
                <div class="cl-header">
                    <div class="cl-title">
                        ${lvl.name || "Custom Level"}
                        <div style="font-size:0.8rem; color:#888; font-weight:normal; margin-top:5px;">by ${creator}</div>
                    </div>
                    <button class="cl-close" onclick="this.closest('.cl-popup-overlay').remove()">&times;</button>
                </div>
                <div class="cl-body">
                    <div class="cl-meta">
                        <div class="cl-meta-item">
                            <span style="color:#666; font-size:0.7rem; text-transform:uppercase;">Difficulty</span>
                            <div class="difficulty-bar">${diffBars}</div>
                        </div>
                        ${isBeaten ? '<div class="cl-meta-item" style="color:#2ecc71; font-weight:bold;"> BEATEN</div>' : ""}
                        ${hasBlueCoin ? '<div class="cl-meta-item" style="color:#335699; font-weight:bold;"> BLUE COIN</div>' : ""}
                    </div>
                    <div class="cl-desc">${desc}</div>
                    <div class="cl-stats">
                        <div class="cl-stat-box"><div class="cl-stat-label">Best Time</div><div class="cl-stat-value">${timeStr}</div></div>
                        <div class="cl-stat-box"><div class="cl-stat-label">Size</div><div class="cl-stat-value">${lvl.plan[0].length}x${lvl.plan.length}</div></div>
                        <div class="cl-stat-box"><div class="cl-stat-label">Gravity</div><div class="cl-stat-value">${lvl.gravity || 27}</div></div>
                    </div>
                </div>
                <div class="cl-actions">
                    ${buttonsHtml}
                </div>
            </div>
        `;

        document.body.appendChild(overlay);

        if (
          currentGameMode === "speedrun" ||
          currentGameMode === "deathrun" ||
          currentGameMode === "practice"
        ) {
          document.getElementById("cl-action-btn").onclick = () => {
            overlay.remove();
            startGameLevel(lvl, index, "custom");
          };
        } else {
          document.getElementById("cl-play-btn").onclick = () => {
            currentGameMode = "custom";
            overlay.remove();
            startGameLevel(lvl, index, "custom");
          };
          document.getElementById("cl-speed-btn").onclick = () => {
            currentGameMode = "speedrun";
            overlay.remove();
            startGameLevel(lvl, index, "custom");
          };
        }
      }

      function clearAllProgress() {
        // Clear all game progress
        gameState = {
          unlockedLevel: 0,
          unlockedLevelCh2: 0,
          unlockedLevelCh3: 0,
          gameBeaten: false,
          levelBlueCoins: {},
          blueCoinUnlockShown: false,
          chapter1Beaten: false,
          chapter2Beaten: false,
          chapter3Beaten: false,
        };
        customLevelsProgress = {};
        highscores = {};
        safeStorage.clear();
        showPopup("PROGRESS CLEARED", "All game progress has been reset!", () =>
          showMenu("main"),
        );
      }

      // --- Level Data ---
      // converted to objects to support gravity
      const RAW_LEVEL_PLANS = [
        [
          "                                                                                ",
          "                                                                                ",
          "                                                                                ",
          "                                                                                ",
          "                                                                                ",
          "                                                                   B            ",
          "                                                                  xxx           ",
          "                                                   xx      xx    xx!xx          ",
          "                                    o o      xx                  x!!!x          ",
          "                                                                 xx!xx          ",
          "                                   xxxxx                          xvx           ",
          "                                                                            xx  ",
          "  xx                                      o o                                x  ",
          "  x                     o                                                    x  ",
          "  x                                      xxxxx                             o x  ",
          "  x          xxxx       o                                                    x  ",
          "  x  @       x  x                                                xxxxx       x  ",
          "  xxxxxxxxxxxx  xxxxxxxxxxxxxxx   xxxxxxxxxxxxxxxxxxxx     xxxxxxx   xxxxxxxxx  ",
          "                              x   x                  x     x                    ",
          "                              x!!!x                  x!!!!!x                    ",
          "                              x!!!x                  x!!!!!x                    ",
          "                              xxxxx                  xxxxxxx                    ",
          "                                                                                ",
          "                                                                                ",
        ],
        [
          "                                      x!!x                        xxxxxxx                                    x!x  ",
          "                                      x!!x                     xxxx     xxxx                                 x!x  ",
          "                                      x!!xxxxxxxxxx           xx           xx                                x!x  ",
          "                                      xx!!!!!!!!!!xx         xx             xx                               x!x  ",
          "                                       xxxxxxxxxx!!x         x                                    o   o   o  x!x  ",
          "                                                xx!x         x     o   o                                    xx!x  ",
          "                                                 x!x         x                                xxxxxxxxxxxxxxx!!x  ",
          "                                                 xvx         x     x   x                        !!!!!!!!!!!!!!xx  ",
          "                                                             xx  |   |   |  xx            xxxxxxxxxxxxxxxxxxxxx   ",
          "                                                              xx!!!!!!!!!!!xx            v                        ",
          "                                                               xxxx!!!!!xxxx                                      ",
          "                                               x     x            xxxxxxx        xxx         xxx                  ",
          "                                               x     x                           x x         x x                  ",
          "                                               x     x                             x         x                    ",
          "                                               x     x                             xx        x                    ",
          "                                               xx    x                             x         x                    ",
          "                                               x     x      o  o     x   x         x         x                    ",
          "               xxxxxxx        xxx   xxx        x     x               x   x         x         x                    ",
          "              xx     xx         x   x          x     x     xxxxxx    x   x   xxxxxxxxx       x                    ",
          "             xx       xx        x o x          x    xx               x   x   x               x                    ",
          "     @       x         x        x   x          x     x               x   x   x               x                    ",
          "    xxx      x         x        x   xB         x     x               x   xxxxx   xxxxxx      x                    ",
          "    x x      x         x       xx o xx         x     x               x     o     x x         x                    ",
          "!!!!x x!!!!!!x         x!!!!!!xx     xx!!!!!!!!xx    x!!!!!!!!!!     x     =     x x         x                    ",
          "!!!!x x!!!!!!x         x!!!!!xx       xxxxxxxxxx     x!!!!!!!xx!     xxxxxxxxxxxxx xx  o o  xx                    ",
          "!!!!x x!!!!!!x         x!!!!!x    o                 xx!!!!!!xx !                    xx     xx                     ",
          "!!!!x x!!!!!!x         x!!!!!x                     xx!!!!!!xx  !                     xxxxxxx                      ",
          "!!!!x x!!!!!!x         x!!!!!xx       xxxxxxxxxxxxxx!!!!!!xx   !                                                  ",
          "!!!!x x!!!!!!x         x!!!!!!xxxxxxxxx!!!!!!!!!!!!!!!!!!xx    !                                                  ",
          "!!!!x x!!!!!!x         x!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!xx     !                                                  ",
        ],
        [
          "                                                                                                              ",
          "                                                                                                              ",
          "                                                                                                              ",
          "                                                                                                              ",
          "                                                                                                              ",
          "                                        o                                                                     ",
          "                                                                                                              ",
          "                                        x                                                                     ",
          "                                        x                                                                     ",
          "                                        x                                                                     ",
          "                                        x                                                                     ",
          "                                       xxx                                                                    ",
          "                                       x x                 !!!        !!!  xxx                                ",
          "                                       x x                 !x!        !x!                                     ",
          "                                     xxx xxx                x          x                                      ",
          "                                      x   x                 x   oooo   x       xxx                            ",
          "                                      x   x                 x          x      x!!!x                           ",
          "                                      x   x                 xxxxxxxxxxxx       xxx                            ",
          "                                     xx   xx      x   x      x               B                                ",
          "                                      x   xxxxxxxxx   xxxxxxxx              x x                               ",
          "                                      x   x           x                    x!!!x                              ",
          "                                      x   x           x                     xxx                               ",
          "                                     xx   xx          x                                                       ",
          "                                      x   x= = = =    x            xxx                                        ",
          "                                      x   x           x           x!!!x                                       ",
          "                                      x   x    = = = =x     o      xxx       xxx                              ",
          "                                     xx   xx          x                     x!!!x                             ",
          "                              o   o   x   x           x     x                xxv        xxx                   ",
          "                                      x   x           x              x                 x!!!x                  ",
          "                             xxx xxx xxx xxx     o o  x!!!!!!!!!!!!!!x                   vx                   ",
          "                             x xxx x x xxx x          x!!!!!!!!!!!!!!x                                        ",
          "                             x             x   xxxxxxxxxxxxxxxxxxxxxxx                                        ",
          "                             xx           xx                                         xxx                      ",
          "  xxx                         x     x     x                                         x!!!x                xxx  ",
          "  x x                         x    xxx    x                                          xxx                 x x  ",
          "  x                           x    xxx    xxxxxxx                        xxxxx                             x  ",
          "  x                           x           x                              x   x                             x  ",
          "  x                           xx          x                              x x x                             x  ",
          "  x                                       x       |xxxx|    |xxxx|     xxx xxx                             x  ",
          "  x                xxx             o o    x                              x         xxx                     x  ",
          "  x               xxxxx       xx          x                             xxx       x!!!x          x         x  ",
          "  x               oxxxo       x    xxx    x                             x x        xxx          xxx        x  ",
          "  x                xxx        xxxxxxxxxxxxx  x oo x    x oo x    x oo  xx xx                    xxx        x  ",
          "  x      @          x         x           x!!x    x!!!!x    x!!!!x    xx   xx                    x         x  ",
          "  xxxxxxxxxxxxxxxxxxxxxxxxxxxxx           xxxxxxxxxxxxxxxxxxxxxxxxxxxxx     xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx  ",
          "                                                                                                              ",
          "                                                                                                              ",
        ],
        [
          "                                                                                                              ",
          "                                                                                                              ",
          "                                                                                                              ",
          "                                                                                                  xxxxx       ",
          "                                                                                                  x           ",
          "                                                                                                  x xxx       ",
          "                          o                                                                       x x x       ",
          "                                                                                             o o oxxx x       ",
          "                   xxx                                                                                x       ",
          "      B!  o  !                                                xxxxx xxxxx xxxxx xxxxx xxxxx xxxxx xxxxx       ",
          "       x     x                                                x   x x   x x   x x   x x   x x   x x           ",
          "       x= o  x            x                                   xxx x xxx x xxx x xxx x xxx x xxx x xxxxx       ",
          "       x     x                                                  x x   x x   x x   x x   x x   x x     x       ",
          "       !  o  !            o                                  xxxx xxxxx xxxxx xxxxx xxxxx xxxxx xxxxxxx       ",
          "                                                                                                              ",
          "          o              xxx                              xx                                                  ",
          "                                                                                                              ",
          "                                                                                                              ",
          "                                                      xx                                                      ",
          "                   xxx         xxx                                                                            ",
          "                                                                                                              ",
          "                          o                                                     x      x                      ",
          "                                                          xx     xx                                           ",
          "             xxx         xxx         xxx                                 x                  x                 ",
          "                                                                                                              ",
          "                                                                 ||                                           ",
          "  xxxxxxxxxxx                                                                                                 ",
          "  x         x o xxxxxxxxx o xxxxxxxxx o xx                                                x                   ",
          "  x         x   x       x   x       x   x                 ||                  x     x                         ",
          "  x  @      xxxxx   o   xxxxx   o   xxxxx                                                                     ",
          "  xxxxxxx                                     xxxxx       xx     xx     xxx                                   ",
          "        x=                  =                =x   x                     xxx                                   ",
          "        xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx   x!!!!!!!!!!!!!!!!!!!!!xxx!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!",
          "                                                  xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx",
          "                                                                                                              ",
        ],
        [
          "                                                             ",
          "                                                             ",
          "                                                             ",
          "                                                             ",
          "                                                             ",
          "@                                            o               ",
          "xxxx                                         x               ",
          "                                             x               ",
          "                                             x!x             ",
          "                                             xxx             ",
          "                                                 x           ",
          "                                                             ",
          "       ooooooo                                  o            ",
          "       xxxxxxx  x!! x  xxxx    xxxx  x    x  xxxx            ",
          "          x     x!! x  x       xo   Bxx   x  x   x           ",
          "          x     x!!ox  xo      x     x x  x  x   x           ",
          "          x     xxxxx  xxxx    xxxx  x  xox  x   x           ",
          "          x     x   x  x       x     x   xx  x   x           ",
          "          x     x   x  xo      x     x    x  x   x           ",
          "          x     x   x  xxxx    xxxx  x    x  xxxx            ",
          "          v     v   v  vvvv    vvvv  v    v  vvvv            ",
          "                                                             ",
          "                                                             ",
          "                                                             ",
          "                                                             ",
          "                                                             ",
          "                                                             ",
          "                                                             ",
          "!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!",
        ],
      ];

      // Format for game: { plan: [...], gravity: 27 }
      const CHAPTER_1 = RAW_LEVEL_PLANS.map((p) => ({
        plan: p,
        gravity: 27,
      }));
      CHAPTER_1[0].music = "joyful_morning.mp3";
      CHAPTER_1[4].music = "for_champions.mp3";

      const CHAPTER_2 = [
        {
          plan: [
            "                                                                  ",
            "                                                                  ",
            "                                                                  ",
            "                                                    o             ",
            "                                                   xxx            ",
            "                                                                  ",
            "                                                                  ",
            "                         o                                        ",
            "                        xxx                                       ",
            "                                                                  ",
            "                    o                                             ",
            "                   xxx                                            ",
            "                                                                  ",
            "                   o                                              ",
            "                  xxx             B                               ",
            "                                   x                              ",
            "          o                        xxx                            ",
            "         xxx                                                      ",
            "                                                                  ",
            "        o                                                         ",
            "       xxx                                                        ",
            "                                                                  ",
            "       o                                                          ",
            "      xxx                                                         ",
            "  @                                                               ",
            "  xxx                                                             ",
            "                                                                  ",
            "!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!",
          ],
          gravity: 10,
        },
        {
          gravity: 10,
          plan: [
            "                              ",
            "                              ",
            "                              ",
            "                              ",
            "                             @",
            "                         xxxxx",
            "                              ",
            "                         |    ",
            "                         |    ",
            "                         |    ",
            "                         |    ",
            "                         |    ",
            "                              ",
            "                              ",
            "                              ",
            "                              ",
            "=      =      =      =      !!",
            "                            xx",
            "                              ",
            "                              ",
            "                              ",
            "                              ",
            "                              ",
            "!!!!o!!!!!!!o!!!!!!!!o!!!!!!!B",
            "xxxxxxxxxxxxxxxxxxxxxxxxxxxxxx",
          ],
        },
        {
          plan: [
            "                                                             ",
            "                                 B                           ",
            "                                 x!!                         ",
            "                                 x!x                         ",
            "                                 xxx                         ",
            "                                                             ",
            "      o         o         o                                  ",
            "     xxx       xxx       xxx                                 ",
            "                                                             ",
            "    =   =    =   =    =   =    =   =    =   =              ",
            "                                                             ",
            "     xxx      xxx      xxx       xxx      xxx               ",
            "       x        x        x         x        x               ",
            "   o   x    o   x    o   x     o   x    o   x              ",
            "  xxx  x   xxx  x   xxx  x    xxx  x   xxx  x              ",
            "       x        x        x         x        x               ",
            "       xxx      xxx      xxx       xxx      xxx             ",
            "                                                             ",
            "  !                                                          ",
            "  !    x   x   x   x   x   x    x   x   x   x   x         ",
            "  !   xxx xxx xxx xxx xxx xxx   xxx xxx xxx xxx xxx         ",
            "  !    x   x   x   x   x   x    x   x   x   x   x         ",
            "  !                                                        ",
            "  !                                                           ",
            "  !   !!! !!! !!! !!! !!! !!!  !!! !!! !!! !!! !!!            ",
            "       xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx          ",
            "                                                             ",
            "@                                                           ",
            "xxxx                                                        ",
            "                                                            ",
            "                                                            ",
            "                                                            ",
            "                                                            ",
            "                                                            ",
            "!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!",
          ],
          gravity: 6,
        },
        {
          plan: [
            "                                                             ",
            "                                                             ",
            "                                                             ",
            "                                                             ",
            "                                                             ",
            "                                          o                  ",
            "                                         xxx                 ",
            "                                         x!x                 ",
            "                                                             ",
            "                                         x!x                 ",
            "                                 xxx     xxx                 ",
            "                                 x!x     xxx                 ",
            "                                                            ",
            "       o      o      o                   xxx                ",
            "      xxx    xxx    xxx                                     ",
            "      x!x    x!x    x!x                                     ",
            "                              v                             ",
            "                              v                             ",
            "                    =   =   =  v  =   =   =                 ",
            "                                v                           ",
            "  xxx     xxx     xxx     xxx   x   xxx     xxx     xxx     ",
            "  x x     x x     x x     x x   x   x x     x x       x     ",
            "  x x     x x     x x     x x   x   x x     x x      Bx     ",
            "  x x     x x     x x     x x   x   x x     x x     x x     ",
            "                                           o      o         ",
            "  x x     x x     x x     xo      xxx     xxx     x x       ",
            "  x x     x x     x x     xxx     x x     x x     x x       ",
            "  x x     x x     x x     x!x     x x     x x     x x       ",
            "  x x     x x     x x     x       x x     x x     x x       ",
            "  xxx     xxx     xxx     x       x x     x x     xxx       ",
            "                          o                                 ",
            "  ===   ===   ===   ===   ===   ===   ===   ===   ===   === ",
            "@                                                           ",
            "xxxx                                                        ",
            "                                                            ",
            "                                                            ",
            "                                                            ",
            "                                                            ",
            "                                                            ",
            "                                                            ",
            "!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!",
          ],
          gravity: 5,
        },
        {
          plan: [
            "                                                                                                              ",
            "                                                                                                              ",
            "            o                                                                                                ",
            "           xxx                         xxx                           xxx                                     ",
            "                                        x x                           x x                                     ",
            "                                    o   x x   o                   o   x x   o                                 ",
            "                                   xxx  x x  xxx                 xxx  x x  xxx                                ",
            "                                        x x                           x x                                     ",
            "          v                             xxx                           xxx                                     ",
            "          v                                                                                                  ",
            "  ===  =  v  =  ===                      x                                                                  ",
            "          v                           xxx x xxx                                                            ",
            "          v                           x       x                                                              ",
            "                                      x       x                                                              ",
            "                                      x!!!!!!!x                                                              ",
            "                                      xxxxxxxxx                                                              ",
            "                                                                                                              ",
            "                            xxx                              xxx                                            ",
            "                            x x          o o o              x x                                            ",
            "                        =   x x   =  xxxxxxxxxxxxxx     =   x x   =                                         ",
            "                            xxx                              xxx                                            ",
            "                                                                                                              ",
            "           xxx              xB                                 x              xxx                            ",
            "           x x              xxx                              xxx              x x                            ",
            "       o    x x    o             x                          x                 x x    o                       ",
            "      xxx   x x   xxx        xxxx x xxxx              xxxx x xxxx             x x   xxx                      ",
            "           xxx                   x                        x                   xxx                            ",
            "                                  x                        x                                                ",
            "     =    =                  !!!!!!!!!!!!            !!!!!!!!!!!!                  =    =                    ",
            "                                                                                                              ",
            "                                                                                                              ",
            "  xxx       xxx                 x                        x                 xxx       xxx                     ",
            "  x x       x x             xxxxx x xxxxx            xxxxx x xxxxx                                           ",
            "  x x   o   x x   o         x         x              x         x                                            ",
            "  x x  xxx  x x  xxx        x    o    x              x    o    x                                            ",
            "  xxx  x x  xxx             x         x              x         x       xxx                           ",
            "       xxx                  xxxxxxxxxx              xxxxxxxxxx                                              ",
            "                                                                                                              ",
            "  x x                       x                                                x x                            ",
            "  x x                       x                        x                       x x                            ",
            "  x x       o   o   o   o   x       o           o    x                       x x                            ",
            "  x x       xv xv xv xv  xxxxx   xxxxx    xxxxx  xxx xxxxx                  x x                            ",
            "  x x                                                                       x x                            ",
            "  xxx                                                                       xxx                           ",
            "            !!!       !!!       !!!       !!!       !!!       !!!       !!!                                  ",
            "  @                                                                                                          ",
            "  xxx                                                                                                        ",
            "                                                                                                              ",
          ],
          gravity: 7,
          music: "ant_territory.mp3",
        },
      ];
      CHAPTER_2[0].music = "level_vi.mp3";

      const CHAPTER_3 = [
        {
          gravity: 24,
          plan: [
            "               x            !",
            "               x            !",
            "               x          oo!",
            "  ooo          x          xx!",
            "  xxx          x       oo   !",
            "               x       xx   !",
            "               x            !",
            "               x            !",
            "      xxx      x    oo      !",
            "               x    xx      !",
            "               x      !!!  B!",
            "          xx   x      !!!   !",
            "               x            !",
            "              @x   @        !",
            "               x            ^",
            "               x            ^",
            "               x          oo^",
            "  ooo          x          xx^",
            "  xxx          x       oo   ^",
            "               x       xx   ^",
            "               x            ^",
            "               x            ^",
            "      xxx      x    oo      ^",
            "               x    xx      ^",
            "               x      !!!  B^",
            "          xx   x      !!!   ^",
            "               x            ^",
            "              @x   @        ^",
            "!!!!!!!!!!!!!!xxxxxxxxxxxxxxx",
          ],
        },
        {
          plan: [
            "                                                                                      ",
            "                                                                                      ",
            "                                    o                                                 ",
            "                                   xxx                                                ",
            "                                                                                      ",
            "                                    x!x                                               ",
            "                                    xxx                                               ",
            "                                                                                      ",
            "                              xxx                                                    ",
            "                              x x                                                    ",
            "                          o   x x   o                                                ",
            "                         xxx  x x  xxx                                               ",
            "                              x x                                                    ",
            "                              xxx                                                    ",
            "                                                                                      ",
            "                         |     x x     |                                             ",
            "                         |     x x     |                                             ",
            "                  xxxx   |   xxxx xxxx  |   xxxx                                     ",
            "                  x  x   |   x      x   |   x  x                                     ",
            "              o   x  x   |   x  o   x   |   x  x   o                                 ",
            "             xxx  x  x   |   x     xxx  |   x  x  xxx                                ",
            "                  x  x   |   xxxx       |   x  x                                     ",
            "                  xxxx   |             |   xxxx                                      ",
            "                        |              |                                             ",
            "                   v    | v    v    v  |  v     v                                    ",
            "                   v    | v    v    v  |  v     v                                    ",
            "            ===   xxx   xxx  xxx   xxx xxx xxx   ===                                 ",
            "                                                                                      ",
            "                   x    x x    x x    x x    x x                                     ",
            "                   x    H x    H x    H x    H x                                     ",
            "                  xxx  xxx    xxx    xxx    xxx                                      ",
            "                                                                                      ",
            "                   x    x x    x x    x x    x x                                     ",
            "                   x    x x    x x    x x    x x                                     ",
            "                   x    x x    x x    x x    x x                                     ",
            "                   x    x x    x x    x x    x x                                     ",
            "                   x    H x    H x    H x    H x                                     ",
            "                   x    H x    H x    H x    H x                                     ",
            "                   x    H x    H x    H x    H x                                     ",
            "                   x    H x    H x    H x    H x                                     ",
            "                 xxx   xxx    xxx    xxx    xxx                                      ",
            "                                                                                      ",
            "  @                                                                                  ",
            "  xxxx                                                                               ",
            "                                                                                      ",
            "                                                                                      ",
            "!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!  ",
          ],
          gravity: 20,
        },
        {
          plan: [
            "                                                                                                  ",
            "                                                                                                  ",
            "                                    o                                                            ",
            "                                   xxx                                                           ",
            "                                                                                                  ",
            "                                   x!x                                                           ",
            "                                   xxx                                                           ",
            "                                                                                                  ",
            "            x                      x x                      x                                    ",
            "            x       o              x x       o              x       o                            ",
            "            xxxx   xxx             xxxxx    xxx             xxxx   xxx                           ",
            "                                                                                                  ",
            "            =   =   =              =   =    =              =   =   =                            ",
            "                                                                                                  ",
            "            x       x              x x      x              x       x                             ",
            "            x   o   x              x x  o   x              x   o   x                             ",
            "            xxx xxx xxx            xxxxx   xxx             xxx xxx xxx                           ",
            "            xxx HHH xxx            xxxxx   HHH             xxx HHH xxx                           ",
            "                                                                                                  ",
            "            x       x              x x      x              x       x                             ",
            "            x       x              x x      x              x       x                             ",
            "            xxx xxx xxx            xxxxx   xxx             xxx xxx xxx                           ",
            "            xxx HHH xxx            xxxxx   HHH             xxx HHH xxx                           ",
            "                                                                                                  ",
            "            =   =   =              =   =    =              =   =   =                            ",
            "                                                                                                  ",
            "            x       x              x x      x              x       x         B                   ",
            "            x   o   x              x x  o   x              x   o   x         x                   ",
            "            xxx xxx xxx            xxxxx   xxx             xxx xxx xxx       xxx                 ",
            "            xxx HHH xxx            xxxxx   HHH             xxx HHH xxx       xxx                 ",
            "                                                                                                  ",
            "            x       x              x x      x              x       x                             ",
            "            x       x              x x      x              x       x                             ",
            "            xxx xxx xxx            xxxxx   xxx             xxx xxx xxx                           ",
            "            xxx HHH xxx            xxxxx   HHH             xxx HHH xxx                           ",
            "                                                                                                  ",
            "            =   =   =              =   =    =              =   =   =                            ",
            "                                                                                                  ",
            "  @                                                                                              ",
            "  xxxx                                                                                           ",
            "                                                                                                  ",
            "!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!  ",
          ],
          gravity: 15,
        },
        {
          plan: [
            "                                                                                                                 ",
            "                                      o                                                                         ",
            "                                     xxx                                                                        ",
            "                                                                                                                 ",
            "                                     x!x                                                                        ",
            "                                     xxx                                                                        ",
            "                                                                                                                 ",
            "           xxx                       x x                       xxx                                              ",
            "           x x       o               x x       o               x x       o                                      ",
            "       v   x x  xxx xxx              xxxxx    xxx xxx          x x  xxx xxx                                      ",
            "       v   x x  x x                                           x x  x x                                           ",
            "       v   xxx  x x                  xxx                      xxx  x x                                           ",
            "       v       xxx                                                 xxx                                          ",
            "                                                                                                                 ",
            "       v   x x     x x x x x x       x x     x x x x x x      x x     x x x x x x                               ",
            "       v   xxx    xxx x x xxx x      xxx    xxx x x xxx x     xxx    xxx x x xxx x                              ",
            "                      x x                       x x                       x x                                   ",
            "       v   x x x       x x x x   !!!x x x!!!    x x x x   !!!x x x!!!   x x x x                                ",
            "       v   xxx xxx    xxx xxx   !!!xxxxxxx!!!   xxx xxx   !!!xxxxxxx!!!  xxx xxx                                ",
            "                                 !!!xxx xxx!!!                 !!!xxx xxx!!!                                     ",
            "       v   x x        xxx xxx    !!!x   x!!!    xxx xxx    !!!x   x!!!   xxx xxx                                 ",
            "       v   xxx        x x          x   x          x   x       x   x        x x                                   ",
            "       v   x x        x x          x   x          x   x       x   x        x x                                   ",
            "                                                                                                                 ",
            "       v   ===        ===          ===             ===          ===        ===                                   ",
            "                                                                                                                 ",
            "       v   x x x      x x x x      x x x           x x x        x x x     x x x                                  ",
            "       v   xxx xx    xxx xxx x    xxx xxx          xxx xx       xxx xx    xxx xx                                 ",
            "                       x    x          x                 x           x                                           ",
            "       v   x     x    x     x x   x     x           x    x       x    x   x     x                               ",
            "       v   x     x    x     xxx   x     x           x    x       x    x   x     x                               ",
            "       v                                                                                                        ",
            "           B   x     x    x     x x   x     x           x    x       x    x   x     x                           ",
            "          xxx  x     x    x     xxx   x     x           x    x       x    x   x     x                           ",
            "                                                                                                                 ",
            "  @                                                                                                              ",
            "  xxxx                                                                                                           ",
            "                                                                                                                 ",
            "!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!  ",
            "^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^  ",
          ],
          gravity: 12,
        },
        {
          plan: [
            "                                                                                                                  ",
            "                                                                                                                  ",
            "                                      o                                                                          ",
            "                                     xxx                                                                         ",
            "                                                                                                                  ",
            "                                     x!x                                                                         ",
            "                                     xxx                                                                         ",
            "                                                                                                                  ",
            "       x                             x x                             x                                           ",
            "       x       o                     x x       o                     x       o                                   ",
            "       xxxx   xxx                    xxxxx    xxx                    xxxx   xxx                                   ",
            "                                                                                                                  ",
            "       ===  ===  ===  ===  ===      ===  ===  ===  ===  ===       ===  ===  ===  ===  ===                       ",
            "                                                                                                                  ",
            "       x x                          x x                            x x                                           ",
            "       x x       o                  x x       o                    x x       o                                   ",
            "       xxx   x   x                  xxx   x   x                    xxx   x   x                 B                  ",
            "             xxx                        xxx                            xxx                  x                   ",
            "                                                                                            xxx                   ",
            "       x x                          x x                            x x                                           ",
            "       x x       o                  x x       o                    x x       o                                   ",
            "       xxx   x   x                  xxx   x   x                    xxx   x   x                                    ",
            "             xxx                        xxx                            xxx                                       ",
            "                                                                                                                  ",
            "       x x                          x x                            x x                                           ",
            "       x x       o                  x x       o                    x x       o                                   ",
            "       xxx   x   x                  xxx   x   x                    xxx   x   x                                    ",
            "             xxx                        xxx                            xxx                                       ",
            "                                                                                                                  ",
            "       x x                          x x                            x x                                           ",
            "       x x       o                  x x       o                    x x       o                                   ",
            "       xxx   x   x                  xxx   x   x                    xxx   x   x                                    ",
            "             xxx                        xxx                            xxx                                       ",
            "                                                                                                                  ",
            "       ===  ===  ===  ===  ===      ===  ===  ===  ===  ===       ===  ===  ===  ===  ===                       ",
            "                                                                                                                  ",
            "  @                                                                                                               ",
            "  xxxx                                                                                                            ",
            "                                                                                                                  ",
            "!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!! ",
            "^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^ ",
          ],
          gravity: 10,
          music: "ant_territory.mp3",
        },
      ];

      // --- Engine  ---

      function adjustColor(color, amount) {
        if (!color) return null;
        let usePound = false;
        if (color[0] == "#") {
          color = color.slice(1);
          usePound = true;
        }
        let num = parseInt(color, 16);
        let r = (num >> 16) + amount;
        if (r > 255) r = 255;
        else if (r < 0) r = 0;
        let b = ((num >> 8) & 0x00ff) + amount;
        if (b > 255) b = 255;
        else if (b < 0) b = 0;
        let g = (num & 0x0000ff) + amount;
        if (g > 255) g = 255;
        else if (g < 0) g = 0;
        return (
          (usePound ? "#" : "") +
          (g | (b << 8) | (r << 16)).toString(16).padStart(6, "0")
        );
      }

      function getAvailableSkins() {
        return currentUserSkins;
      }

      function checkBlueCoinSkinUnlock() {
        if (!currentUser) return;
        if (currentUserSkins.includes("blue_coin")) return;

        let total = 0;
        let collected = 0;

        const checkChapter = (chapter, prefix) => {
          chapter.forEach((lvl, idx) => {
            let hasBlue = false;
            if (lvl.plan) {
              for (let row of lvl.plan) {
                if (row.includes("B")) {
                  hasBlue = true;
                  break;
                }
              }
            }
            if (hasBlue) {
              total++;
              const key = prefix ? `${prefix}_${idx}` : idx;
              if (gameState.levelBlueCoins[key]) collected++;
            }
          });
        };

        if (typeof CHAPTER_1 !== "undefined") checkChapter(CHAPTER_1, "");
        if (typeof CHAPTER_2 !== "undefined") checkChapter(CHAPTER_2, "ch2");
        if (typeof CHAPTER_3 !== "undefined") checkChapter(CHAPTER_3, "ch3");

        if (total > 0 && collected >= total) {
          currentUserSkins.push("blue_coin");
          syncDataToCloud();
          showPopup(
            "SKIN UNLOCKED",
            "You unlocked the Blue Coin skin!",
            () => {},
          );
        }
      }

      function Vector(x, y) {
        this.x = x;
        this.y = y;
      }
      Vector.prototype.plus = function (other) {
        return new Vector(this.x + other.x, this.y + other.y);
      };
      Vector.prototype.times = function (scale) {
        return new Vector(this.x * scale, this.y * scale);
      };

      function Player(pos) {
        this.pos = pos.plus(new Vector(0, -0.5));
        this.size = new Vector(0.5, 1);
        this.speed = new Vector(0, 0);
      }
      Player.prototype.type = "player";

      function Lava(pos, ch) {
        this.pos = pos;
        this.size = new Vector(1, 1);
        if (ch === "=") this.speed = new Vector(2, 0);
        else if (ch === "|") this.speed = new Vector(0, 2);
        else if (ch === "v") {
          this.speed = new Vector(0, 3);
          this.repeatPos = pos;
        } else if (ch === "!") {
          // Static Lava
          this.speed = new Vector(0, 0);
          this.pos = pos;
          this.size = new Vector(1, 1);
        }
      }
      Lava.prototype.type = "lava";

      function Coin(pos) {
        this.basePos = this.pos = pos;
        this.size = new Vector(0.6, 0.6);
        this.wobble = Math.random() * Math.PI * 2;
      }
      Coin.prototype.type = "coin";

      function BonusCoin(pos) {
        this.basePos = this.pos = pos;
        this.size = new Vector(0.6, 0.6);
        this.wobble = 0; // No wobble for flat look
      }
      BonusCoin.prototype.type = "bonus-coin";

      function MovingBlock(pos, ch) {
        this.pos = pos;
        this.size = new Vector(1, 1);
        if (ch === "H") {
          this.speed = new Vector(2, 0);
        } else {
          this.speed = new Vector(0, 2);
        }
      }
      MovingBlock.prototype.type = "moving-block";

      function RisingLava(pos, ch) {
        this.pos = pos;
        this.size = new Vector(1, 1);
      }
      RisingLava.prototype.type = "rising-lava";
      RisingLava.prototype.act = function (step, level) {
        var interval =
          this.riseInterval !== undefined
            ? this.riseInterval
            : level.riseInterval;
        if (interval > 0) {
          var riseAmount = (1 / interval) * step;
          var newY = this.pos.y - riseAmount;

          // Check for wall collision above
          var blocked = false;
          if (!this.throughBlocks) {
            var startX = Math.floor(this.pos.x);
            var endX = Math.ceil(this.pos.x + this.size.x);
            var checkY = Math.floor(newY + 0.01);

            if (checkY >= 0 && checkY < level.height) {
              for (var x = startX; x < endX; x++) {
                if (level.grid[checkY][x] === "wall") {
                  blocked = true;
                  break;
                }
              }
            }
          }

          if (!blocked) {
            this.pos.y = newY;
            this.size.y += riseAmount;
          }
        }
      };

      function VisualWall(pos, type) {
        this.pos = pos;
        this.size = new Vector(1, 1);
        this.wallType = type; // 'flicker' or 'jump_flicker'
        this.timer = 0;
        this.visibleTime = 0;
        this.isVisible = false;
      }
      VisualWall.prototype.type = "visual-wall";
      VisualWall.prototype.act = function (step, level) {
        // Logic moved to updateFlicker
      };

      function Spike(pos, ch) {
        // Smaller hitbox centered at bottom
        this.pos = pos.plus(new Vector(0.2, 0.5));
        this.size = new Vector(0.6, 0.5);
      }
      Spike.prototype.type = "spike";
      Spike.prototype.act = function (step, level) {};

      function UpsideDownSpike(pos, ch) {
        this.pos = pos.plus(new Vector(0.2, 0));
        this.size = new Vector(0.6, 0.5);
      }
      UpsideDownSpike.prototype.type = "upside-down-spike";
      UpsideDownSpike.prototype.act = function (step, level) {};

      function FallingBlock(pos) {
        this.pos = pos;
        this.size = new Vector(1, 1);
        this.speed = new Vector(0, 0);
        this.repeatPos = pos;
      }
      FallingBlock.prototype.type = "falling-block";
      FallingBlock.prototype.act = function (step, level) {
        this.speed.y = 3; // Constant speed matching dripping lava
        var newPos = this.pos.plus(this.speed.times(step));

        var player = level.player;
        if (player) {
          if (
            newPos.x < player.pos.x + player.size.x &&
            newPos.x + this.size.x > player.pos.x &&
            newPos.y < player.pos.y + player.size.y &&
            newPos.y + this.size.y > player.pos.y
          ) {
            level.playerTouched("crush", this);
          }
        }

        if (level.obstacleAt(newPos, this.size, this)) {
          this.pos = new Vector(this.repeatPos.x, this.repeatPos.y);
          this.speed = new Vector(0, 0);
        } else {
          this.pos = newPos;
        }
      };

      function BreakableBlock(pos) {
        this.pos = pos;
        this.size = new Vector(1, 1);
        this.triggered = false;
        this.timer = -1;
      }
      BreakableBlock.prototype.type = "breakable-block";
      BreakableBlock.prototype.trigger = function () {
        if (!this.triggered) {
          this.triggered = true;
          this.timer = 0.4; // short delay
        }
      };
      BreakableBlock.prototype.act = function (step, level) {
        if (this.triggered) {
          if (this.timer > 0) this.timer -= step;
          if (this.timer <= 0) this.toRemove = true;
        }
      };

      function SpikeBlock(pos) {
        this.pos = pos;
        this.size = new Vector(1, 1);
        this.triggered = false;
      }
      SpikeBlock.prototype.type = "spike-block";
      SpikeBlock.prototype.act = function (step, level) {
        if (this.triggered) return;
        var p = level.player;
        if (!p) return;
        var dx = p.pos.x + p.size.x / 2 - (this.pos.x + this.size.x / 2);
        var dy = p.pos.y + p.size.y / 2 - (this.pos.y + this.size.y / 2);
        var dist = Math.sqrt(dx * dx + dy * dy);

        if (dist < 2.0) {
          var targetPos = this.pos.plus(new Vector(0, -1));
          if (!level.obstacleAt(targetPos, new Vector(1, 1), null)) {
            for (let i = 0; i < (this.produceCount || 1); i++) {
              var p = targetPos.plus(new Vector(0, -i));
              if (!level.obstacleAt(p, new Vector(1, 1), null)) {
                var spike = new Spike(p);
                spike.id = level.nextActorId++;
                level.actors.push(spike);
              }
            }
          }
          this.triggered = true;
        }
      };

      function WallBlock(pos) {
        this.pos = pos;
        this.size = new Vector(1, 1);
        this.triggered = false;
      }
      WallBlock.prototype.type = "wall-block";
      WallBlock.prototype.act = function (step, level) {
        if (this.triggered) return;
        var p = level.player;
        if (!p) return;
        var dx = p.pos.x + p.size.x / 2 - (this.pos.x + this.size.x / 2);
        var dy = p.pos.y + p.size.y / 2 - (this.pos.y + this.size.y / 2);
        var dist = Math.sqrt(dx * dx + dy * dy);

        if (dist < 2.0) {
          var targetPos = this.pos.plus(new Vector(0, -1));

          // Check first block (ignoring player to allow bump)
          var firstObs = level.obstacleAt(targetPos, new Vector(1, 1), null);
          if (firstObs && firstObs.type === "player") firstObs = null;

          if (!firstObs) {
            var spawned = [];
            for (let i = 0; i < (this.produceCount || 1); i++) {
              var p = targetPos.plus(new Vector(0, -i));
              var obs = level.obstacleAt(p, new Vector(1, 1), null);
              if (obs && obs.type === "player") obs = null;

              if (!obs) {
                var wall = new VisualWall(p);
                wall.isVisible = true;
                wall.id = level.nextActorId++;
                level.actors.push(wall);
                spawned.push(wall);
              } else {
                break;
              }
            }
            // Bump player up if they are inside any spawned wall
            if (spawned.length > 0 && level.player) {
              for (var w of spawned) {
                if (
                  level.player.pos.x < w.pos.x + w.size.x &&
                  level.player.pos.x + level.player.size.x > w.pos.x &&
                  level.player.pos.y < w.pos.y + w.size.y &&
                  level.player.pos.y + level.player.size.y > w.pos.y
                ) {
                  level.player.pos.y = w.pos.y - level.player.size.y - 0.01;
                  if (level.player.speed.y > 0) level.player.speed.y = 0;
                }
              }
            }
          }
          this.triggered = true;
        }
      };

      function UpsideDownSpikeBlock(pos) {
        this.pos = pos;
        this.size = new Vector(1, 1);
        this.triggered = false;
      }
      UpsideDownSpikeBlock.prototype.type = "spike-block-u";
      UpsideDownSpikeBlock.prototype.act = function (step, level) {
        if (this.triggered) return;
        var p = level.player;
        if (!p) return;
        var dx = p.pos.x + p.size.x / 2 - (this.pos.x + this.size.x / 2);
        var dy = p.pos.y + p.size.y / 2 - (this.pos.y + this.size.y / 2);
        var dist = Math.sqrt(dx * dx + dy * dy);

        if (dist < 2.0) {
          var targetPos = this.pos.plus(new Vector(0, 1));
          if (!level.obstacleAt(targetPos, new Vector(1, 1), null)) {
            for (let i = 0; i < (this.produceCount || 1); i++) {
              var p = targetPos.plus(new Vector(0, i));
              if (!level.obstacleAt(p, new Vector(1, 1), null)) {
                var spike = new UpsideDownSpike(p);
                spike.id = level.nextActorId++;
                level.actors.push(spike);
              }
            }
          }
          this.triggered = true;
        }
      };

      function JumpPad(pos) {
        this.pos = pos.plus(new Vector(0, 0.5));
        this.size = new Vector(1, 0.5);
      }
      JumpPad.prototype.type = "jump-pad";
      JumpPad.prototype.act = function (step, level) {
        var p = level.player;
        if (p) {
          if (
            p.pos.x + p.size.x > this.pos.x &&
            p.pos.x < this.pos.x + this.size.x &&
            p.pos.y + p.size.y > this.pos.y &&
            p.pos.y < this.pos.y + this.size.y
          ) {
            p.speed.y = -35;
          }
        }
      };

      function Grinder(pos) {
        this.pos = pos;
        this.size = new Vector(1, 1);
        this.speed = new Vector(0, 0);
        this.grinding = false;
      }
      Grinder.prototype.type = "grinder";
      Grinder.prototype.act = function (step, level) {
        if (!level.playerHasMoved) return;
        var p = level.player;
        if (!p) return;

        var myCenterY = this.pos.y + this.size.y / 2;
        var pCenterY = p.pos.y + p.size.y / 2;

        if (pCenterY >= this.pos.y && pCenterY <= this.pos.y + this.size.y) {
          var dir = p.pos.x > this.pos.x ? 1 : -1;
          var speed = 8;
          var motion = new Vector(dir * speed * step, 0);
          var newPos = this.pos.plus(motion);
          var blocked = false;

          var xStart = Math.floor(newPos.x);
          var xEnd = Math.ceil(newPos.x + this.size.x);
          var yStart = Math.floor(newPos.y);
          var yEnd = Math.ceil(newPos.y + this.size.y);
          for (var y = yStart; y < yEnd; y++) {
            for (var x = xStart; x < xEnd; x++) {
              if (y >= 0 && y < level.height && x >= 0 && x < level.width) {
                if (level.grid[y][x] === "wall") {
                  level.grid[y][x] = null;
                  level.backgroundDirty = true;
                  this.grinding = true;
                  blocked = true;
                }
              }
            }
          }
          var other = level.obstacleAt(newPos, this.size, this);
          if (other && typeof other !== "string") {
            if (other.type === "player") {
              level.playerTouched("grinder", this);
            } else if (
              other.type === "breakable-block" ||
              other.type === "moving-block"
            ) {
              other.toRemove = true;
              this.grinding = true;
              blocked = true;
            }
          }
          if (blocked) {
            this.pos = this.pos.plus(motion.times(0.2));
          } else {
            this.grinding = false;
            this.pos = newPos;
          }
        } else {
          this.grinding = false;
        }
      };

      var actorchars = {
        "@": Player,
        o: Coin,
        "=": Lava,
        "|": Lava,
        v: Lava,
        B: BonusCoin,
        H: MovingBlock,
        V: MovingBlock,
        "^": RisingLava,
        S: Spike,
        s: UpsideDownSpike,
        F: FallingBlock,
        G: BreakableBlock,
        K: SpikeBlock,
        W: WallBlock,
        k: UpsideDownSpikeBlock,
        J: JumpPad,
        C: Grinder,
      };

      function cloneActor(actor) {
        if (actor.type === "lava-group") {
          return new LavaGroup(actor.members.map((m) => cloneActor(m)));
        }
        let newActor = Object.create(Object.getPrototypeOf(actor));
        Object.assign(newActor, actor);
        if (newActor.pos) newActor.pos = new Vector(actor.pos.x, actor.pos.y);
        if (newActor.size)
          newActor.size = new Vector(actor.size.x, actor.size.y);
        if (newActor.speed)
          newActor.speed = new Vector(actor.speed.x, actor.speed.y);
        if (newActor.basePos)
          newActor.basePos = new Vector(actor.basePos.x, actor.basePos.y);
        if (newActor.repeatPos)
          newActor.repeatPos = new Vector(actor.repeatPos.x, actor.repeatPos.y);
        return newActor;
      }

      function Level(levelData) {
        let plan = levelData.plan;
        if (!plan || plan.length === 0) {
          plan = [" "]; // Prevent crash on empty plan
        }

        this.colors = levelData.colors || {};
        this.gravity = levelData.gravity || 27; // Use level gravity or default
        this.riseInterval = levelData.riseInterval || 3;
        this.mirrorLevel = levelData.mirrorLevel || false;
        this.forceZoom = levelData.forceZoom || false;
        this.disableDeathAnim = levelData.disableDeathAnim || false;
        this.levelType = levelData.levelType || "campaign"; // Track level type
        this.chapter = levelData.chapter;
        this.customLevelIndex =
          levelData.customLevelIndex !== undefined
            ? levelData.customLevelIndex
            : -1; // Track custom level index
        this.width = plan[0].length;
        this.height = plan.length;
        this.grid = [];
        this.actors = [];
        this.practiceState = null;
        this.backgroundDirty = true;
        this.totalBlueCoins = 0;
        this.blueCoinsCollected = 0;
        this.nextActorId = 0;
        this.actions = levelData.actions || [];
        this.parsedActions = this.parseActions(this.actions);
        this.fakes = new Set(levelData.fakes || []);
        this.risingThrough = new Set(levelData.risingThrough || []);
        this.risingSpeeds = levelData.risingSpeeds || {};
        this.illusions = new Set(levelData.illusions || []);
        this.flickers = new Set(levelData.flickers || []);
        this.touchFlickers = new Set(levelData.touchFlickers || []);
        this.jumpFlickers = new Set(levelData.jumpFlickers || []);
        this.blockConfigs = levelData.blockConfigs || {};
        this.age = 0;
        this.playerHasMoved = false;

        for (var y = 0; y < this.height; y++) {
          var line = plan[y],
            gridLine = [];
          for (var x = 0; x < this.width; x++) {
            var ch = line[x],
              fieldType = null;

            var color = this.colors[`${x},${y}`];
            var isFake = this.fakes.has(x + "," + y);

            // Merging Moving Blocks
            if (ch === "H") {
              var left = this.actors.find(
                (a) =>
                  a.type === "moving-block" &&
                  a.text === "" &&
                  a.pos.y === y &&
                  Math.abs(a.pos.x + a.size.x - x) < 0.1 &&
                  a.color === color &&
                  !!a.fake === isFake,
              );
              if (left) {
                left.size.x += 1;
                gridLine.push(null);
                continue;
              }
            }
            if (ch === "V") {
              var top = this.actors.find(
                (a) =>
                  a.type === "moving-block" &&
                  a.text === "" &&
                  a.pos.x === x &&
                  Math.abs(a.pos.y + a.size.y - y) < 0.1 &&
                  a.color === color &&
                  !!a.fake === isFake,
              );
              if (top) {
                top.size.y += 1;
                gridLine.push(null);
                continue;
              }
            }

            // Merging Lava
            if (ch === "=") {
              var left = this.actors.find(
                (a) =>
                  a.type === "lava" &&
                  a.speed.x !== 0 &&
                  a.pos.y === y &&
                  Math.abs(a.pos.x + a.size.x - x) < 0.1 &&
                  a.color === color &&
                  !!a.fake === isFake,
              );
              if (left) {
                left.size.x += 1;
                gridLine.push(null);
                continue;
              }
            }
            if (ch === "|") {
              var top = this.actors.find(
                (a) =>
                  a.type === "lava" &&
                  a.speed.y !== 0 &&
                  !a.repeatPos && // Exclude dripping lava
                  a.pos.x === x &&
                  Math.abs(a.pos.y + a.size.y - y) < 0.1 &&
                  a.color === color &&
                  !!a.fake === isFake,
              );
              if (top) {
                top.size.y += 1;
                gridLine.push(null);
                continue;
              }
            }

            // Merging Grinders
            if (ch === "C") {
              var top = this.actors.find(
                (a) =>
                  a.type === "grinder" &&
                  a.pos.x === x &&
                  Math.abs(a.pos.y + a.size.y - y) < 0.1,
              );
              if (top) {
                top.size.y += 1;
                gridLine.push(null);
                continue;
              }
            }

            var Actor = actorchars[ch];
            if (Actor) {
              if (ch === "B") {
                // Blue coin spawns if conditions are met:
                // - Campaign: game must be beaten
                // - Custom: level must be beaten before
                let shouldSpawnBlueCoin = false;
                if (currentGameMode !== "deathrun") {
                  if (this.levelType === "campaign") {
                    if (this.chapter === 1 && gameState.chapter1Beaten)
                      shouldSpawnBlueCoin = true;
                    else if (this.chapter === 2 && gameState.chapter2Beaten)
                      shouldSpawnBlueCoin = true;
                    else if (this.chapter === 3 && gameState.chapter3Beaten)
                      shouldSpawnBlueCoin = true;
                  } else if (
                    this.levelType === "custom" &&
                    this.customLevelIndex >= 0 &&
                    customLevelsProgress[this.customLevelIndex]
                  ) {
                    shouldSpawnBlueCoin = true;
                  }
                }
                if (shouldSpawnBlueCoin) {
                  this.totalBlueCoins++;
                  var actor = new Actor(new Vector(x, y), ch);
                  if (color) actor.color = color;
                  if (isFake) actor.fake = true;
                  actor.id = this.nextActorId++;
                  this.actors.push(actor);
                }
              } else {
                var actor = new Actor(new Vector(x, y), ch);
                if (ch === "G" && this.illusions.has(x + "," + y)) {
                  actor.isIllusion = true;
                }
                // Flicker logic for all actors
                if (this.flickers.has(`${x},${y}`)) actor.isFlicker = true;
                if (this.touchFlickers.has(`${x},${y}`))
                  actor.isTouchFlicker = true;
                if (this.jumpFlickers.has(`${x},${y}`))
                  actor.isJumpFlicker = true;

                // Legacy support
                if (color === "flicker") actor.isFlicker = true;
                if (color === "jump_flicker") actor.isJumpFlicker = true;
                if (color === "touch_flicker") actor.isTouchFlicker = true;

                if (
                  actor.isFlicker ||
                  actor.isJumpFlicker ||
                  actor.isTouchFlicker
                ) {
                  actor.flickerType = color;
                  actor.isVisible = false;
                  actor.flickerTimer = 0;
                  actor.flickerVisibleTime = 0;
                }
                if (color) actor.color = color;
                if (isFake) actor.fake = true;
                if (
                  ch === "^" &&
                  this.risingSpeeds[`${x},${y}`] !== undefined
                ) {
                  actor.riseInterval = this.risingSpeeds[`${x},${y}`];
                }
                if (
                  ["W", "K", "k"].includes(ch) &&
                  this.blockConfigs &&
                  this.blockConfigs[`${x},${y}`]
                ) {
                  actor.produceCount =
                    this.blockConfigs[`${x},${y}`].count || 1;
                }
                actor.id = this.nextActorId++;
                this.actors.push(actor);
              }
            } else if (ch === "x") {
              let isFlicker =
                this.flickers.has(`${x},${y}`) || color === "flicker";
              let isTouchFlicker =
                this.touchFlickers.has(`${x},${y}`) ||
                color === "touch_flicker";
              let isJumpFlicker =
                this.jumpFlickers.has(`${x},${y}`) || color === "jump_flicker";

              if (isFlicker || isTouchFlicker || isJumpFlicker) {
                var wall = new VisualWall(new Vector(x, y), color);
                wall.isFlicker = isFlicker;
                wall.isTouchFlicker = isTouchFlicker;
                wall.isJumpFlicker = isJumpFlicker;
                wall.flickerType = "combined";
                wall.isVisible = false;
                wall.flickerTimer = 0;
                wall.flickerVisibleTime = 0;
                wall.id = this.nextActorId++;
                this.actors.push(wall);
                fieldType = "wall"; // Keep in grid for collision
              } else {
                fieldType = "wall";
              }
            } else if (ch === "!") {
              var lava = new Lava(new Vector(x, y), "!");
              lava.id = this.nextActorId++;
              if (color) lava.color = color;
              if (isFake) lava.fake = true;
              if (this.risingThrough.has(x + "," + y))
                lava.throughBlocks = true;
              this.actors.push(lava);
            }
            gridLine.push(fieldType);
          }
          this.grid.push(gridLine);
        }
        this.players = this.actors.filter((a) => a.type === "player");
        this.player = this.players[0];
        this.status = this.finishDelay = null;

        // Apply risingThrough to RisingLava actors
        this.actors
          .filter((a) => a.type === "rising-lava")
          .forEach((a) => {
            if (
              this.risingThrough.has(
                Math.round(a.pos.x) + "," + Math.round(a.pos.y),
              )
            )
              a.throughBlocks = true;
          });

        this.groupLavas();
        this.groupMovingBlocks();

        // Optimization: Cache dynamic actors
        this.dynamicActors = this.actors.filter(
          (a) =>
            a.type === "moving-block" ||
            a.type === "moving-group" ||
            a.type === "lava-group" ||
            (a.type === "lava" && a.speed),
        );
      }

      Level.prototype.parseActions = function (actions) {
        return actions
          .map((a) => {
            const match = a.match(/\[\["(.*?)"\s*\|\s*(.*?)\s*\|\s*(.*?)\]\]/);
            if (!match) return null;
            return {
              title: match[1].trim(),
              triggerStr: match[2].trim(),
              funcStr: match[3].trim(),
              executed: false,
            };
          })
          .filter((a) => a);
      };

      Level.prototype.checkTriggers = function (step) {
        this.age += step;
        this.parsedActions.forEach((action) => {
          // Parse Trigger
          let triggered = false;
          const t = action.triggerStr;

          if (t.startsWith("timeInterval")) {
            const match = t.match(/timeInterval\s*\(\s*([\d\.]+)\s*\)/);
            if (match) {
              const interval = parseFloat(match[1]);
              // Trigger every x seconds. Use a small epsilon for float comparison or check if we crossed the threshold this frame
              const prevAge = this.age - step;
              if (
                Math.floor(this.age / interval) > Math.floor(prevAge / interval)
              ) {
                triggered = true;
              }
            }
          } else if (t.startsWith("time")) {
            const match = t.match(/^time\s*\(\s*([\d\.]+)\s*\)/);
            if (match) {
              const target = parseFloat(match[1]);
              if (this.age >= target && !action.executed) {
                triggered = true;
                action.executed = true;
              }
            }
          } else if (t.startsWith("onBlock")) {
            const match = t.match(/onBlock\s*\(\s*(\d+)\s*,\s*(\d+)\s*\)/);
            if (match && this.players.length > 0) {
              const x = parseInt(match[1]);
              const y = parseInt(match[2]);
              // Check if player center is within block
              const triggered = this.players.some((p) => {
                const cx = Math.floor(p.pos.x + p.size.x / 2);
                const cy = Math.floor(p.pos.y + p.size.y / 2);
                return cx === x && cy === y;
              });
              if (triggered && !action.executed) {
                triggered = true;
                action.executed = true;
              }
            }
          }
          // 'action' and 'blueCoin' triggers are handled via events/calls

          if (triggered) this.executeAction(action);
        });
      };

      Level.prototype.executeAction = function (action) {
        const f = action.funcStr;

        // Check for chained actions
        this.parsedActions.forEach((other) => {
          const match = other.triggerStr.match(/action\s*\(\s*"(.*?)"\s*\)/);
          if (match && match[1] === action.title) {
            this.executeAction(other);
          }
        });

        if (f.startsWith("color")) {
          const match = f.match(
            /color\s*\(\s*(\d+)\s*,\s*(\d+)\s*:\s*(#\w+)\s*\)/,
          );
          if (match) {
            const x = parseInt(match[1]),
              y = parseInt(match[2]),
              col = match[3];
            this.colors[`${x},${y}`] = col;
            this.backgroundDirty = true; // In case it's a wall
            // Update actors if any
            this.actors.forEach((a) => {
              if (Math.round(a.pos.x) === x && Math.round(a.pos.y) === y)
                a.color = col;
            });
          }
        } else if (f.startsWith("removeColor")) {
          const match = f.match(/removeColor\s*\(\s*(\d+)\s*,\s*(\d+)\s*\)/);
          if (match) {
            const x = parseInt(match[1]),
              y = parseInt(match[2]);
            delete this.colors[`${x},${y}`];
            this.backgroundDirty = true;
            this.actors.forEach((a) => {
              if (Math.round(a.pos.x) === x && Math.round(a.pos.y) === y)
                delete a.color;
            });
          }
        } else if (f.startsWith("tempColor")) {
          const match = f.match(
            /tempColor\s*\(\s*(\d+)\s*,\s*(\d+)\s*:\s*(#\w+)\s*,\s*(\d+)\s*\)/,
          );
          if (match) {
            const x = parseInt(match[1]),
              y = parseInt(match[2]),
              col = match[3],
              ms = parseInt(match[4]);
            const oldColor = this.colors[`${x},${y}`];
            this.colors[`${x},${y}`] = col;
            this.backgroundDirty = true;
            this.actors.forEach((a) => {
              if (Math.round(a.pos.x) === x && Math.round(a.pos.y) === y)
                a.color = col;
            });

            setTimeout(() => {
              if (activeLevelDisplay && activeLevelDisplay.level === this) {
                if (oldColor) this.colors[`${x},${y}`] = oldColor;
                else delete this.colors[`${x},${y}`];
                this.backgroundDirty = true;
                this.actors.forEach((a) => {
                  if (Math.round(a.pos.x) === x && Math.round(a.pos.y) === y) {
                    if (oldColor) a.color = oldColor;
                    else delete a.color;
                  }
                });
              }
            }, ms);
          }
        } else if (f.startsWith("randColor")) {
          const match = f.match(/randColor\s*\(\s*(\d+)\s*,\s*(\d+)\s*\)/);
          if (match) {
            const x = parseInt(match[1]),
              y = parseInt(match[2]);
            const col = `hsl(${Math.random() * 360}, 70%, 50%)`;
            // Convert HSL to Hex or just use HSL string (CSS supports it)
            this.colors[`${x},${y}`] = col;
            this.backgroundDirty = true;
            this.actors.forEach((a) => {
              if (Math.round(a.pos.x) === x && Math.round(a.pos.y) === y)
                a.color = col;
            });
          }
        } else if (f.startsWith("delBlock")) {
          const match = f.match(/delBlock\s*\(\s*(\d+)\s*,\s*(\d+)\s*\)/);
          if (match) {
            const x = parseInt(match[1]),
              y = parseInt(match[2]);
            if (y >= 0 && y < this.height && x >= 0 && x < this.width) {
              this.grid[y][x] = null;
              this.backgroundDirty = true;
              this.actors = this.actors.filter(
                (a) =>
                  !(Math.round(a.pos.x) === x && Math.round(a.pos.y) === y),
              );
              // Re-cache dynamic actors
              this.dynamicActors = this.actors.filter(
                (a) =>
                  a.type === "moving-block" ||
                  a.type === "moving-group" ||
                  a.type === "lava-group" ||
                  (a.type === "lava" && a.speed),
              );
            }
          }
        } else if (f.startsWith("addBlock")) {
          const match = f.match(
            /addBlock\s*\(\s*(\d+)\s*,\s*(\d+)\s*:\s*(\S)\s*\)/,
          );
          if (match) {
            const x = parseInt(match[1]),
              y = parseInt(match[2]),
              type = match[3];
            if (y >= 0 && y < this.height && x >= 0 && x < this.width) {
              // Remove existing first
              this.grid[y][x] = null;
              this.actors = this.actors.filter(
                (a) =>
                  !(Math.round(a.pos.x) === x && Math.round(a.pos.y) === y),
              );

              // Add new
              const Actor = actorchars[type];
              if (Actor) {
                const actor = new Actor(new Vector(x, y), type);
                actor.id = this.nextActorId++;
                this.actors.push(actor);
                if (this.colors[`${x},${y}`])
                  actor.color = this.colors[`${x},${y}`];
              } else if (type === "x") {
                this.grid[y][x] = "wall";
              } else if (type === "!") {
                const lava = new Lava(new Vector(x, y), "!");
                lava.id = this.nextActorId++;
                this.actors.push(lava);
              }
              this.backgroundDirty = true;
              this.dynamicActors = this.actors.filter(
                (a) =>
                  a.type === "moving-block" ||
                  a.type === "moving-group" ||
                  a.type === "lava-group" ||
                  (a.type === "lava" && a.speed),
              );
            }
          }
        } else if (f.startsWith("music")) {
          const match = f.match(/music\s*\(\s*["']?(.*?)["']?\s*\)/);
          if (match) {
            playMusic(match[1], true);
          }
        } else if (f === "win") {
          this.status = "won";
          this.finishDelay = 1;
        } else if (f === "lose") {
          this.status = "lost";
          this.finishDelay = 1;
        } else if (f.startsWith("gravity")) {
          const match = f.match(/gravity\s*\(\s*([\d\.]+)\s*\)/);
          if (match) {
            this.gravity = parseFloat(match[1]);
          }
        } else if (f.startsWith("message")) {
          const match = f.match(/message\s*\(\s*["']?(.*?)["']?\s*\)/);
          if (match) {
            showPopup("MESSAGE", match[1], () => {});
          }
        } else if (f.startsWith("teleport")) {
          const match = f.match(/teleport\s*\(\s*(\d+)\s*,\s*(\d+)\s*\)/);
          if (match && this.players.length > 0) {
            this.players.forEach((p) => {
              p.pos = new Vector(parseInt(match[1]), parseInt(match[2]));
              p.speed = new Vector(0, 0);
            });
          }
        } else if (f.startsWith("checkpoint")) {
          const match = f.match(/checkpoint\s*\(\s*(\d+)\s*,\s*(\d+)\s*\)/);
          if (match && currentLevelData && currentLevelData.plan) {
            const nx = parseInt(match[1]);
            const ny = parseInt(match[2]);
            // Update current level data plan to move @ to new pos
            // First remove old @
            currentLevelData.plan = currentLevelData.plan.map((row) =>
              row.replace("@", " "),
            );
            // Place new @
            if (ny < currentLevelData.plan.length) {
              let row = currentLevelData.plan[ny].split("");
              if (nx < row.length) {
                row[nx] = "@";
                currentLevelData.plan[ny] = row.join("");
                // Visual feedback
                showMusicNotification("Checkpoint", "Spawn point set!");
              }
            }
          }
        }
      };

      Level.prototype.isFinished = function () {
        return this.status != null && this.finishDelay < 0;
      };

      // --- Physics ---

      // Lava Grouping Logic
      function LavaGroup(members) {
        this.members = members;
        this.type = "lava-group";
        this.speed = members[0].speed;
      }

      LavaGroup.prototype.act = function (step, level) {
        var newPosList = this.members.map((m) =>
          m.pos.plus(this.speed.times(step)),
        );
        var collision = false;

        // Check collision for all members. If any member hits a wall, the whole group reverses.
        for (var i = 0; i < newPosList.length; i++) {
          if (level.obstacleAt(newPosList[i], this.members[i].size, this)) {
            collision = true;
            break;
          }
        }

        if (collision) {
          this.speed = this.speed.times(-1);
        } else {
          for (var i = 0; i < this.members.length; i++) {
            this.members[i].pos = newPosList[i];
          }
        }
      };

      Level.prototype.groupLavas = function () {
        var visited = new Set();
        var newActors = [];
        var lavas = this.actors.filter(
          (a) => a.type === "lava" && !a.repeatPos,
        );
        var others = this.actors.filter(
          (a) => a.type !== "lava" || (a.type === "lava" && a.repeatPos),
        );

        // Optimization: Map coordinates to lava actors for O(1) lookup
        var lavaMap = {};
        lavas.forEach((l) => {
          lavaMap[Math.round(l.pos.x) + "," + Math.round(l.pos.y)] = l;
        });

        for (var i = 0; i < lavas.length; i++) {
          var lava = lavas[i];
          if (visited.has(lava)) continue;

          var group = [lava];
          visited.add(lava);
          var queue = [lava];

          while (queue.length > 0) {
            var curr = queue.pop();
            var cx = Math.round(curr.pos.x);
            var cy = Math.round(curr.pos.y);

            // Check 4 neighbors
            var potentialNeighbors = [
              lavaMap[cx + 1 + "," + cy],
              lavaMap[cx - 1 + "," + cy],
              lavaMap[cx + "," + (cy + 1)],
              lavaMap[cx + "," + (cy - 1)],
            ];

            potentialNeighbors.forEach((n) => {
              if (
                n &&
                !visited.has(n) &&
                n.speed.x === curr.speed.x &&
                n.speed.y === curr.speed.y
              ) {
                visited.add(n);
                group.push(n);
                queue.push(n);
              }
            });
          }

          if (group.length > 1) {
            newActors.push(new LavaGroup(group));
          } else {
            newActors.push(group[0]);
          }
        }
        this.actors = others.concat(newActors);
      };

      // Moving Block Grouping Logic
      function MovingGroup(members) {
        this.members = members;
        this.type = "moving-group";
        this.speed = members[0].speed;
      }

      MovingGroup.prototype.act = function (step, level) {
        var posBeforeList = this.members.map((m) => m.pos);
        var newPosList = this.members.map((m) =>
          m.pos.plus(this.speed.times(step)),
        );
        var collision = false;

        for (var i = 0; i < newPosList.length; i++) {
          if (level.obstacleAt(newPosList[i], this.members[i].size, this)) {
            collision = true;
            break;
          }
        }

        if (collision) {
          this.speed = this.speed.times(-1);
          return;
        }

        // Move all members
        for (var i = 0; i < this.members.length; i++) {
          this.members[i].pos = newPosList[i];
        }

        var moveDelta = newPosList[0].plus(posBeforeList[0].times(-1));
        var riders = new Set();
        var group = this;

        level.actors.forEach((a) => {
          if (a === group) return;
          if (
            a.type !== "player" &&
            a.type !== "spike" &&
            a.type !== "upside-down-spike"
          )
            return;

          // Check if 'a' is riding ANY member
          for (var m of group.members) {
            if (m.fake) continue;
            var isRiding = false;
            if (a.type === "upside-down-spike") {
              if (
                Math.abs(a.pos.y - (m.pos.y + m.size.y)) < 0.1 &&
                a.pos.x + a.size.x > m.pos.x &&
                a.pos.x < m.pos.x + m.size.x
              )
                isRiding = true;
            } else {
              if (
                Math.abs(a.pos.y + a.size.y - m.pos.y) < 0.1 &&
                a.pos.x + a.size.x > m.pos.x &&
                a.pos.x < m.pos.x + m.size.x
              )
                isRiding = true;
            }
            if (isRiding) {
              riders.add(a);
              break;
            }
          }
        });

        // Check wall collision for riders
        for (let r of riders) {
          var rNewPos = r.pos.plus(moveDelta);
          if (level.obstacleAt(rNewPos, r.size, r) === "wall") {
            if (r.type === "spike" || r.type === "upside-down-spike") {
              // Reverse group
              for (var i = 0; i < this.members.length; i++)
                this.members[i].pos = posBeforeList[i];
              this.speed = this.speed.times(-1);
              return;
            } else if (r.type === "player" && this.speed.y < 0) {
              level.status = "lost";
              level.finishDelay = 1;
            }
          }
        }

        // Move riders
        for (let r of riders) {
          var rNewPos = r.pos.plus(moveDelta);
          if (!level.obstacleAt(rNewPos, r.size, r)) r.pos = rNewPos;
        }

        // Push players
        level.players.forEach((player) => {
          for (var m of group.members) {
            if (m.fake) continue;
            // Standard AABB overlap check with push logic
            if (
              m.pos.x < player.pos.x + player.size.x &&
              m.pos.x + m.size.x > player.pos.x &&
              m.pos.y < player.pos.y + player.size.y &&
              m.pos.y + m.size.y > player.pos.y
            ) {
              if (this.speed.x > 0) player.pos.x = m.pos.x + m.size.x + 0.01;
              else if (this.speed.x < 0)
                player.pos.x = m.pos.x - player.size.x - 0.01;

              if (this.speed.y > 0) player.pos.y = m.pos.y + m.size.y + 0.01;
              else if (this.speed.y < 0) {
                player.pos.y = m.pos.y - player.size.y - 0.01;
                player.speed.y = 0;
              }

              if (level.obstacleAt(player.pos, player.size, player)) {
                level.status = "lost";
                level.finishDelay = 1;
              }
            }
          }
        });
      };

      Level.prototype.groupMovingBlocks = function () {
        var visited = new Set();
        var newActors = [];
        var movers = this.actors.filter((a) => a.type === "moving-block");
        var others = this.actors.filter((a) => a.type !== "moving-block");

        for (var i = 0; i < movers.length; i++) {
          var m1 = movers[i];
          if (visited.has(m1)) continue;

          var group = [m1];
          visited.add(m1);
          var queue = [m1];

          while (queue.length > 0) {
            var curr = queue.pop();
            for (var j = 0; j < movers.length; j++) {
              var m2 = movers[j];
              if (
                !visited.has(m2) &&
                m2.speed.x === curr.speed.x &&
                m2.speed.y === curr.speed.y
              ) {
                // Check adjacency
                var expanded = {
                  pos: new Vector(curr.pos.x - 0.1, curr.pos.y - 0.1),
                  size: new Vector(curr.size.x + 0.2, curr.size.y + 0.2),
                };
                if (
                  expanded.pos.x < m2.pos.x + m2.size.x &&
                  expanded.pos.x + expanded.size.x > m2.pos.x &&
                  expanded.pos.y < m2.pos.y + m2.size.y &&
                  expanded.pos.y + expanded.size.y > m2.pos.y
                ) {
                  visited.add(m2);
                  group.push(m2);
                  queue.push(m2);
                }
              }
            }
          }

          if (group.length > 1) newActors.push(new MovingGroup(group));
          else newActors.push(group[0]);
        }
        this.actors = others.concat(newActors);
      };

      Level.prototype.obstacleAt = function (pos, size, exceptActor) {
        var xStart = Math.floor(pos.x),
          xEnd = Math.ceil(pos.x + size.x);
        var yStart = Math.floor(pos.y),
          yEnd = Math.ceil(pos.y + size.y);
        if (xStart < 0 || xEnd > this.width || yStart < 0) return "wall";
        if (yEnd > this.height) return "lava";
        for (var y = yStart; y < yEnd; y++) {
          for (var x = xStart; x < xEnd; x++) {
            if (this.grid[y][x]) {
              if (this.fakes.has(x + "," + y)) continue;
              return this.grid[y][x];
            }
          }
        }
        // Check all actors now
        for (var i = 0; i < this.actors.length; i++) {
          var other = this.actors[i];
          if (other === exceptActor) continue;
          if (other.flickerType && !other.isVisible) continue;
          if (other.fake) continue;

          var members = other.members || [other];
          for (var j = 0; j < members.length; j++) {
            var member = members[j];
            if (member.fake) continue;

            if (
              pos.x + size.x > member.pos.x &&
              pos.x < member.pos.x + member.size.x &&
              pos.y + size.y > member.pos.y &&
              pos.y < member.pos.y + member.size.y
            ) {
              if (
                member.type === "moving-block" ||
                member.type === "breakable-block" ||
                member.type === "falling-block" ||
                member.type === "spike-block" ||
                member.type === "wall-block" ||
                member.type === "spike-block-u" ||
                member.type === "grinder" ||
                member.type === "moving-group" ||
                (member.type === "visual-wall" && member.isVisible)
              )
                return member;
              if (member.type === "lava") return "lava";
              if (
                member.type === "spike" ||
                member.type === "upside-down-spike"
              ) {
                if (
                  exceptActor &&
                  (exceptActor.type === "moving-block" ||
                    exceptActor.type === "moving-group" ||
                    exceptActor.type === "falling-block")
                )
                  continue;
                return member.type;
              }
            }
          }
        }
      };

      Level.prototype.actorAt = function (actor) {
        for (var i = 0; i < this.actors.length; i++) {
          var other = this.actors[i];
          if (other.fake) continue;
          if (other.members) {
            for (var j = 0; j < other.members.length; j++) {
              var m = other.members[j];
              if (
                m != actor &&
                actor.pos.x + actor.size.x > m.pos.x &&
                actor.pos.x < m.pos.x + m.size.x &&
                actor.pos.y + actor.size.y > m.pos.y &&
                actor.pos.y < m.pos.y + m.size.y
              )
                return m;
            }
          } else {
            if (
              other != actor &&
              actor.pos.x + actor.size.x > other.pos.x &&
              actor.pos.x < other.pos.x + other.size.x &&
              actor.pos.y + actor.size.y > other.pos.y &&
              actor.pos.y < other.pos.y + other.size.y
            )
              return other;
          }
        }
      };

      function updateFlicker(actor, step, level) {
        let shouldBeVisible = false;

        if (actor.isFlicker) {
          actor.flickerTimer += step;
          if (actor.flickerVisibleTime > 0) {
            actor.flickerVisibleTime -= step;
            shouldBeVisible = true;
          }
          if (actor.flickerTimer > 0.2) {
            actor.flickerTimer = 0;
            if (Math.random() < 0.1) {
              actor.flickerVisibleTime = 0.2;
              shouldBeVisible = true;
            }
          }
        }

        if (actor.isJumpFlicker) {
          var p = level.player;
          if (p) {
            // Visible if on ground (not in air)
            var onGround = level.obstacleAt(
              p.pos.plus(new Vector(0, 0.1)),
              p.size,
              p,
            );
            if (onGround) shouldBeVisible = true;
          }
        }

        if (actor.isTouchFlicker) {
          var p = level.player;
          if (p) {
            var margin = 0.1;
            var touching = !(
              p.pos.x > actor.pos.x + actor.size.x + margin ||
              p.pos.x + p.size.x < actor.pos.x - margin ||
              p.pos.y > actor.pos.y + actor.size.y + margin ||
              p.pos.y + p.size.y < actor.pos.y - margin
            );
            if (touching) shouldBeVisible = true;
          }
        }

        actor.isVisible = shouldBeVisible;
      }

      Level.prototype.animate = function (step, keys) {
        if (this.status != null) this.finishDelay -= step;

        // Check Triggers
        this.checkTriggers(step);

        while (step > 0) {
          var thisStep = Math.min(step, 0.05);
          this.actors.forEach(function (actor) {
            if (actor.flickerType) updateFlicker(actor, thisStep, this);
            actor.act(thisStep, this, keys);
          }, this);
          step -= thisStep;
        }

        var actorsToRemove = this.actors.filter((actor) => actor.toRemove);
        if (actorsToRemove.length > 0) {
          this.actors = this.actors.filter((actor) => !actor.toRemove);
          // Re-cache dynamic actors if needed, though the main loop now iterates all actors
          this.dynamicActors = this.actors.filter(
            (a) =>
              a.type === "moving-block" ||
              a.type === "moving-group" ||
              a.type === "lava-group" ||
              (a.type === "lava" && a.speed),
          );
        }
      };

      Lava.prototype.act = function (step, level) {
        var newPos = this.pos.plus(this.speed.times(step));
        if (!level.obstacleAt(newPos, this.size, this)) this.pos = newPos;
        else if (this.repeatPos) this.pos = this.repeatPos;
        else this.speed = this.speed.times(-1);
      };

      MovingBlock.prototype.act = function (step, level) {
        var posBefore = this.pos;
        var newPos = this.pos.plus(this.speed.times(step));
        if (!level.obstacleAt(newPos, this.size, this)) {
          this.pos = newPos;
        } else {
          this.speed = this.speed.times(-1);
          return;
        }

        var moveDelta = newPos.plus(posBefore.times(-1));

        // Handle Riders (Players and Spikes)
        if (this.fake) return; // Fake blocks move but don't interact

        var riders = level.actors.filter((a) => {
          if (a === this) return false;
          if (
            a.type !== "player" &&
            a.type !== "spike" &&
            a.type !== "upside-down-spike"
          )
            return false;

          if (a.type === "upside-down-spike") {
            // Check if spike is attached to bottom of block
            var spikeTop = a.pos.y;
            var blockBottom = posBefore.y + this.size.y;
            if (Math.abs(spikeTop - blockBottom) > 0.1) return false;
            return (
              a.pos.x + a.size.x > posBefore.x &&
              a.pos.x < posBefore.x + this.size.x
            );
          } else {
            var aBottom = a.pos.y + a.size.y;
            var blockTop = posBefore.y;
            if (Math.abs(aBottom - blockTop) > 0.1) return false;
            return (
              a.pos.x + a.size.x > posBefore.x &&
              a.pos.x < posBefore.x + this.size.x
            );
          }
        });

        // Check if any rider (specifically spike) hits a wall
        for (var i = 0; i < riders.length; i++) {
          var r = riders[i];
          var rNewPos = r.pos.plus(moveDelta);
          var obstacle = level.obstacleAt(rNewPos, r.size, r);
          if (obstacle === "wall") {
            if (r.type === "spike" || r.type === "upside-down-spike") {
              // Reverse block and cancel move
              this.pos = posBefore;
              this.speed = this.speed.times(-1);
              return;
            } else if (r.type === "player" && this.speed.y < 0) {
              level.status = "lost";
              level.finishDelay = 1;
            }
          }
        }

        // Move riders
        riders.forEach((r) => {
          var rNewPos = r.pos.plus(moveDelta);
          if (!level.obstacleAt(rNewPos, r.size, r)) {
            r.pos = rNewPos;
          }
        });

        // Push players (side/inside collision)
        level.players.forEach((player) => {
          if (
            this.pos.x < player.pos.x + player.size.x &&
            this.pos.x + this.size.x > player.pos.x &&
            this.pos.y < player.pos.y + player.size.y &&
            this.pos.y + this.size.y > player.pos.y
          ) {
            if (this.speed.x !== 0) {
              if (this.speed.x > 0)
                player.pos.x = this.pos.x + this.size.x + 0.01;
              else player.pos.x = this.pos.x - player.size.x - 0.01;
            }
            if (this.speed.y !== 0) {
              if (this.speed.y > 0)
                player.pos.y = this.pos.y + this.size.y + 0.01;
              else {
                player.pos.y = this.pos.y - player.size.y - 0.01;
                player.speed.y = 0;
              }
            }
            if (level.obstacleAt(player.pos, player.size, player)) {
              level.status = "lost";
              level.finishDelay = 1;
            }
          }
        });
      };

      Coin.prototype.act = function (step) {
        this.wobble += step * 8;
        var wobblePos = Math.sin(this.wobble) * 0.07;
        this.pos = this.basePos.plus(new Vector(0, wobblePos));
      };

      BonusCoin.prototype.act = function (step) {
        // Static, no wobble
      };

      var playerXSpeed = 10;
      Player.prototype.moveX = function (step, level, keys) {
        this.speed.x = 0;
        if (keys.left) this.speed.x -= playerXSpeed;
        if (keys.right) this.speed.x += playerXSpeed;
        var motion = new Vector(this.speed.x * step, 0);
        if (this.speed.x === 0 && (keys.left || keys.right))
          motion.x = (keys.right ? 1 : -1) * 0.001;
        var newPos = this.pos.plus(motion);
        var obstacle = level.obstacleAt(newPos, this.size, this);

        if (obstacle) level.playerTouched(obstacle);
        else this.pos = newPos;
      };

      var jumpSpeed = 17;
      Player.prototype.moveY = function (step, level, keys) {
        // Use level-specific gravity
        this.speed.y += step * level.gravity;
        var motion = new Vector(0, this.speed.y * step);
        var newPos = this.pos.plus(motion);
        var obstacle = level.obstacleAt(newPos, this.size, this);
        if (obstacle) {
          var obstacleType =
            typeof obstacle === "string" ? obstacle : obstacle.type;
          if (obstacleType === "breakable-block") {
            obstacle.trigger();
          }

          level.playerTouched(obstacle);
          if (keys.up && this.speed.y > 0) this.speed.y = -jumpSpeed;
          else this.speed.y = 0;
        } else {
          this.pos = newPos;
        }
      };

      Player.prototype.act = function (step, level, keys) {
        // Timer start for Speedrun/Deathrun
        if (
          (currentGameMode === "speedrun" ||
            currentGameMode === "deathrun" ||
            currentGameMode === "chapter_speedrun") &&
          !gameTimerRunning &&
          !level.status
        ) {
          if (keys.left || keys.right || keys.up) {
            gameTimerRunning = true;
            if (gameTimerStart === 0) gameTimerStart = Date.now();
          }
        }
        if (currentGameMode === "practice" && keys.p) {
          // Save full state
          level.practiceState = level.actors.map((a) => cloneActor(a));
          // Visual feedback is handled by drawPracticeMarker
        }
        if (keys.left || keys.right || keys.up) level.playerHasMoved = true;
        this.moveX(step, level, keys);
        this.moveY(step, level, keys);

        var otherActor = level.actorAt(this);
        if (
          otherActor &&
          otherActor.type === "breakable-block" &&
          otherActor.timer <= 0 &&
          otherActor.triggered
        ) {
          otherActor.toRemove = true;
          otherActor = null;
        }

        if (otherActor) level.playerTouched(otherActor.type, otherActor);
        if (level.status == "lost") {
          this.pos.y += step;
          this.size.y -= step;
        }
      };

      let cheatCodeInput = "";
      const CLEAR_CODE = "clear";
      const CHEAT_CODE = "unlock";

      Level.prototype.playerTouched = function (type, actor) {
        if (type === "crush") {
          this.status = "lost";
          this.finishDelay = 0;
          return;
        } else if (type === "breakable-block" && actor && actor.timer > 0) {
          // Don't die on a breakable block that hasn't broken yet
        } else if (
          (type == "lava" ||
            type == "rising-lava" ||
            type == "lava-group" ||
            type == "spike" ||
            type == "upside-down-spike" ||
            type == "grinder") &&
          this.status == null
        ) {
          if (currentGameMode === "practice" && this.practiceState) {
            // Restore full state
            this.actors = this.practiceState.map((a) => cloneActor(a));
            this.player = this.actors.find((a) => a.type === "player");
            // Re-cache dynamic actors
            this.dynamicActors = this.actors.filter(
              (a) =>
                a.type === "moving-block" ||
                a.type === "moving-group" ||
                a.type === "lava-group" ||
                (a.type === "lava" && a.speed),
            );
            return;
          }
          if (currentGameMode === "deathrun" || this.disableDeathAnim) {
            this.status = "lost";
            this.finishDelay = 0; // Instant fail
          } else {
            this.status = "lost";
            this.finishDelay = 1;
          }
        } else if (type == "coin") {
          if (this.status === "lost") return;
          this.actors = this.actors.filter((other) => other != actor);
          if (!this.actors.some((actor) => actor.type == "coin")) {
            if (currentGameMode === "speedrun") {
              if (gameTimerStart > 0) {
                speedrunEndTime = Date.now(); // Immediate stop
                gameTimer = speedrunEndTime - gameTimerStart;
                gameTimerRunning = false;
              }
            }
            this.status = "won";
            this.finishDelay = 1;
          }
        } else if (type == "bonus-coin") {
          this.actors = this.actors.filter((other) => other != actor);
          this.blueCoinsCollected++;
          // Trigger blueCoin actions
          this.parsedActions.forEach((a) => {
            if (a.triggerStr === "blueCoin") {
              this.executeAction(a);
            }
          });
        }
      };

      // --- Display ---
      function element(name, className) {
        var elem = document.createElement(name);
        if (className) elem.className = className;
        return elem;
      }

      var globalZoomedOut = false;

      function DOMDisplay(parent, level) {
        this.wrap = parent.appendChild(element("div", "game"));
        this.level = level;
        this.zoomedOut = globalZoomedOut;
        if (this.level.forceZoom) this.zoomedOut = false;

        this.world = this.wrap.appendChild(element("div", "world"));
        this.world.style.position = "relative";

        this.actorLayer = this.world.appendChild(element("div"));
        this.actorElements = new Map();
        this.hitboxLayer = this.world.appendChild(element("div"));
        this.hitboxElements = new Map();

        this.updateScale();
        this.world.insertBefore(this.drawBackground(), this.actorLayer);
        this.drawFrame();

        this.resizeHandler = () => {
          this.updateScale();
          this.level.backgroundDirty = true;
          this.drawFrame();
        };
        window.addEventListener("resize", this.resizeHandler);
      }

      DOMDisplay.prototype.drawBackground = function () {
        if (this.bgLayer) this.bgLayer.remove();
        this.bgLayer = element("div", "background-layer");
        this.bgLayer.style.position = "absolute";
        this.bgLayer.style.top = "0";
        this.bgLayer.style.left = "0";
        this.bgLayer.style.width = "100%";
        this.bgLayer.style.height = "100%";

        var s = this.scale;
        var self = this;

        for (var y = 0; y < this.level.height; y++) {
          for (var x = 0; x < this.level.width; x++) {
            var type = this.level.grid[y][x];
            if (type === "wall") {
              var el = element("div", "wall");
              el.style.position = "absolute";
              el.style.left = x * s + "px";
              el.style.top = y * s + "px";
              el.style.width = s + "px";
              el.style.height = s + "px";

              var color = self.level.colors[`${x},${y}`];
              if (
                color === "invisible" ||
                self.level.flickers.has(`${x},${y}`) ||
                self.level.jumpFlickers.has(`${x},${y}`) ||
                self.level.touchFlickers.has(`${x},${y}`) ||
                color === "flicker" ||
                color === "jump_flicker" ||
                color === "touch_flicker"
              ) {
                el.style.background = "transparent";
                el.style.border = "none";
              } else if (color) {
                el.style.backgroundColor = color;
                el.style.borderColor = adjustColor(color, -20);
              }
              el.style.borderWidth =
                (s < 25 ? Math.max(1, s * 0.12) : 3) + "px";
              this.bgLayer.appendChild(el);
            }
          }
        }
        return this.bgLayer;
      };

      DOMDisplay.prototype.syncActors = function () {
        var s = this.scale;
        var drawList = [];

        // Flatten actor list
        this.level.actors.forEach(function (actor) {
          if (actor.members) {
            actor.members.forEach((m) => {
              if (
                m.type === "bonus-coin" &&
                gameSettings.alternateBlueCoinStyle
              )
                m.altStyle = true;
              drawList.push(m);
            });
          } else {
            drawList.push(actor);
          }
        });

        var activeIds = new Set();

        drawList.forEach((actor) => {
          activeIds.add(actor.id);
          let el = this.actorElements.get(actor.id);

          if (!el) {
            let className = "actor " + actor.type;
            if (actor.type === "breakable-block" && actor.isIllusion) {
              className = "actor wall";
            }

            // Create new element
            el = element("div", className);
            this.actorLayer.appendChild(el);
            this.actorElements.set(actor.id, el);

            // Static setup
            if (actor.color) {
              if (actor.color === "invisible" && actor.type !== "player") {
                el.style.visibility = "hidden";
              } else if (actor.flickerType) {
                // Initial state for flicker
                el.style.visibility = actor.isVisible ? "visible" : "hidden";
                el.style.backgroundColor = actor.color;
                el.style.borderColor = adjustColor(actor.color, -20);
              } else if (
                actor.type !== "spike" &&
                actor.type !== "upside-down-spike"
              ) {
                if (
                  !actor.flickerType &&
                  actor.color !== "flicker" &&
                  actor.color !== "jump_flicker" &&
                  actor.color !== "touch_flicker"
                ) {
                  el.style.backgroundColor = actor.color;
                  el.style.borderColor = adjustColor(actor.color, -20);
                }
              }
            }
            if (actor.type === "spike") {
              var visual = document.createElement("div");
              visual.className = "spike-visual";
              visual.style.borderLeftWidth = s * 0.5 + "px";
              visual.style.borderRightWidth = s * 0.5 + "px";
              visual.style.borderBottomWidth = s + "px";
              visual.style.borderTopWidth = "0px";
              visual.style.position = "absolute";
              visual.style.left = "50%";
              visual.style.bottom = "0";
              visual.style.transform = "translateX(-50%)";
              if (actor.color && actor.color !== "invisible")
                visual.style.borderBottomColor = actor.color;
              else if (actor.color === "invisible")
                el.style.visibility = "hidden";
              el.appendChild(visual);
            }
            if (actor.type === "upside-down-spike") {
              var visual = document.createElement("div");
              visual.className = "spike-visual spike-u";
              visual.style.borderLeftWidth = s * 0.5 + "px";
              visual.style.borderRightWidth = s * 0.5 + "px";
              visual.style.borderTopWidth = s + "px";
              visual.style.borderBottomWidth = "0px";
              visual.style.position = "absolute";
              visual.style.left = "50%";
              visual.style.top = "0";
              visual.style.transform = "translateX(-50%)";
              if (actor.color && actor.color !== "invisible")
                visual.style.borderTopColor = actor.color;
              else if (actor.color === "invisible")
                el.style.visibility = "hidden";
              el.appendChild(visual);
            }
            if (actor.text) {
              el.textContent = actor.text;
              el.style.display = "flex";
              el.style.alignItems = "center";
              el.style.justifyContent = "center";
            }
          }

          // Dynamic updates
          if (actor.flickerType) {
            el.style.visibility = actor.isVisible ? "visible" : "hidden";
          }

          if (
            actor.type === "bonus-coin" &&
            gameSettings.alternateBlueCoinStyle
          ) {
            el.classList.add("bonus-coin-alt-visuals");
          } else {
            el.classList.remove("bonus-coin-alt-visuals");
          }

          if (actor.type === "breakable-block") {
            if (actor.triggered) {
              el.classList.add("triggered");
            } else {
              el.classList.remove("triggered");
            }
          }

          if (actor.type === "grinder") {
            if (actor.grinding) el.classList.add("grinding");
            else el.classList.remove("grinding");
          }

          if (actor.type === "spike" || actor.type === "upside-down-spike") {
            var visual = el.firstChild;
            if (visual && visual.classList.contains("spike-visual")) {
              visual.style.borderLeftWidth = s * 0.5 + "px";
              visual.style.borderRightWidth = s * 0.5 + "px";
              if (actor.type === "spike") {
                visual.style.borderBottomWidth = s + "px";
              } else {
                visual.style.borderTopWidth = s + "px";
              }
            }
          } else if (
            [
              "moving-block",
              "falling-block",
              "breakable-block",
              "spike-block",
              "wall-block",
              "visual-wall",
            ].includes(actor.type)
          ) {
            el.style.borderWidth = (s < 25 ? Math.max(1, s * 0.12) : 3) + "px";
          } else if (actor.type === "jump-pad") {
            el.style.borderWidth = (s < 25 ? Math.max(1, s * 0.08) : 2) + "px";
          }

          var visualW = actor.size.x;
          var visualH = actor.size.y;
          var visualX = actor.pos.x;
          var visualY = actor.pos.y;

          let skin = gameSettings.currentSkin || "default";
          const available = getAvailableSkins();
          if (!available.includes(skin)) skin = "default";

          if (actor.type === "player") {
            // Reset defaults to prevent glitches when switching skins
            el.style.backgroundImage = "";
            el.style.backgroundSize = "";
            el.style.backgroundRepeat = "";
            el.style.backgroundPosition = "";
            el.style.backgroundColor = actor.color || "";

            if (skin != "default") {
              if (skin === "emo") {
                if (this.level.status === "lost") {
                  el.style.backgroundImage = `url('emodeath.png')`;
                } else if (this.level.status === "won") {
                  el.style.backgroundImage = `url('emowin.png')`;
                } else {
                  el.style.backgroundImage = `url('emo.png')`;
                }
                el.style.filter = "";
              } else {
                el.style.backgroundImage = `url('${skin}.png')`;
                if (this.level.status === "lost") {
                  el.style.filter =
                    "grayscale(100%) sepia(100%) hue-rotate(-50deg) saturate(600%) contrast(0.8)";
                } else if (this.level.status === "won") {
                  el.style.filter =
                    "grayscale(100%) sepia(100%) hue-rotate(100deg) saturate(600%) contrast(0.8)";
                } else {
                  el.style.filter = "";
                }
              }
              el.style.backgroundSize = "contain";
              el.style.backgroundRepeat = "no-repeat";
              el.style.backgroundPosition = "center";
              el.style.backgroundColor = "transparent";

              // Adjust visuals for custom skins
              visualW = 1.0;
              visualH = 1.0;
              visualX = actor.pos.x - (1.0 - actor.size.x) / 2;
            }
          }

          el.style.width = visualW * s + "px";
          el.style.height = visualH * s + "px";
          el.style.left = visualX * s + "px";
          el.style.top = visualY * s + "px";

          // Hitbox Debugging
          if (gameSettings.showHitboxes) {
            let hb = this.hitboxElements.get(actor.id);
            if (!hb) {
              hb = element("div");
              hb.style.position = "absolute";
              hb.style.border = "1px solid rgba(255, 0, 0, 0.8)";
              hb.style.backgroundColor = "rgba(255, 0, 0, 0.2)";
              hb.style.boxSizing = "border-box";
              hb.style.zIndex = "100";
              hb.style.pointerEvents = "none";
              this.hitboxLayer.appendChild(hb);
              this.hitboxElements.set(actor.id, hb);
            }
            hb.style.left = actor.pos.x * s + "px";
            hb.style.top = actor.pos.y * s + "px";
            hb.style.width = actor.size.x * s + "px";
            hb.style.height = actor.size.y * s + "px";
          }
        });

        // Remove unused elements
        for (const [id, el] of this.actorElements) {
          if (!activeIds.has(id)) {
            el.remove();
            this.actorElements.delete(id);
          }
        }
        for (const [id, hb] of this.hitboxElements) {
          if (!activeIds.has(id) || !gameSettings.showHitboxes) {
            hb.remove();
            this.hitboxElements.delete(id);
          }
        }
      };

      DOMDisplay.prototype.drawPracticeMarker = function () {
        this.world
          .querySelectorAll(".practice-marker")
          .forEach((el) => el.remove());
        if (this.level.practiceState) {
          var players = this.level.practiceState.filter(
            (a) => a.type === "player",
          );
          var s = this.scale;
          players.forEach((p) => {
            var marker = element("div", "practice-marker");
            this.world.appendChild(marker);
            marker.style.width = p.size.x * s + "px";
            marker.style.height = p.size.y * s + "px";
            marker.style.left = p.pos.x * s + "px";
            marker.style.top = p.pos.y * s + "px";
          });
        }
      };

      DOMDisplay.prototype.scrollPlayerIntoView = function () {
        var width = this.wrap.clientWidth;
        var height = this.wrap.clientHeight;
        var player = this.level.player;

        var targetX, targetY;
        if (player) {
          targetX = (player.pos.x + player.size.x / 2) * this.scale;
          targetY = (player.pos.y + player.size.y / 2) * this.scale;
        } else {
          targetX = (this.level.width * this.scale) / 2;
          targetY = (this.level.height * this.scale) / 2;
        }

        // Camera Follow using Transform (Centers player perfectly)

        var offsetX = width / 2 - targetX;
        var offsetY = height / 2 - targetY;

        this.world.style.transform = `translate(${offsetX}px, ${offsetY}px)`;
      };

      DOMDisplay.prototype.updateScale = function () {
        const isMobile = document.body.classList.contains("mobile-mode");
        const useCamera =
          gameSettings.camera || isMobile || this.level.forceZoom;

        if (this.zoomedOut) {
          this.scale = Math.min(
            window.innerWidth / this.level.width,
            window.innerHeight / this.level.height,
          );
        } else if (useCamera) {
          this.scale = window.innerWidth / 15;
        } else {
          this.scale = Math.min(
            window.innerWidth / this.level.width,
            window.innerHeight / this.level.height,
          );
        }
        this.world.style.width = this.level.width * this.scale + "px";
        this.world.style.height = this.level.height * this.scale + "px";
      };

      DOMDisplay.prototype.setZoomOut = function (state) {
        if (this.level.forceZoom) return;
        this.zoomedOut = state;
        globalZoomedOut = state;
        this.updateScale();
        this.level.backgroundDirty = true;
        this.drawFrame();
      };

      DOMDisplay.prototype.drawFrame = function () {
        if (this.level.backgroundDirty) {
          this.world.insertBefore(this.drawBackground(), this.world.firstChild);
          this.level.backgroundDirty = false;
        }
        // Optimization: Sync actors instead of redraw
        this.syncActors();
        this.drawPracticeMarker();
        this.wrap.className = "game " + (this.level.status || "");

        const isMobile = document.body.classList.contains("mobile-mode");
        const useCamera =
          gameSettings.camera || isMobile || this.level.forceZoom;

        if (this.zoomedOut) {
          this.wrap.style.display = "flex";
          this.wrap.style.justifyContent = "center";
          this.wrap.style.alignItems = "center";
          this.wrap.style.overflow = "hidden";
          this.world.style.transform = "none";
        } else if (useCamera) {
          this.wrap.style.display = "block";
          this.wrap.style.overflow = "hidden"; // Hide scrollbars for transform camera
          this.scrollPlayerIntoView();
        } else {
          this.wrap.style.display = ""; // Revert to flex from CSS
          this.wrap.style.overflow = "auto";
          this.world.style.transform = "none"; // Reset transform
        }
      };

      DOMDisplay.prototype.clear = function () {
        window.removeEventListener("resize", this.resizeHandler);
        this.wrap.parentNode.removeChild(this.wrap);
      };

      // --- Game Loop ---
      var arrowCodes = {
        65: "left",
        87: "up",
        68: "right",
        83: "down",
        37: "left",
        38: "up",
        39: "right",
        40: "down",
        32: "up",
        80: "p",
        82: "r",
      };
      function trackKeys(codes) {
        var pressed = Object.create(null);
        function handler(event) {
          if (
            event.target.tagName === "INPUT" ||
            event.target.tagName === "TEXTAREA"
          )
            return;
          if (codes.hasOwnProperty(event.keyCode)) {
            var down = event.type == "keydown";
            pressed[codes[event.keyCode]] = down;
            event.preventDefault();
          }
        }
        addEventListener("keydown", handler);
        addEventListener("keyup", handler);
        return pressed;
      }
      var arrows = trackKeys(arrowCodes);
      var activeAnimationFrame = null;

      // Gamepad Support
      const reusableInputs = {
        left: false,
        right: false,
        up: false,
        down: false,
        p: false,
        r: false,
      };
      function getInputs() {
        // Clone keyboard inputs
        reusableInputs.left = arrows.left;
        reusableInputs.right = arrows.right;
        reusableInputs.up = arrows.up;
        reusableInputs.down = arrows.down;
        reusableInputs.p = arrows.p;
        reusableInputs.r = arrows.r;

        const sensitivity = (gameSettings.sensitivity || 50) / 100;
        const threshold = Math.max(0.1, Math.min(0.9, 0.5 / sensitivity));

        const gamepads = navigator.getGamepads ? navigator.getGamepads() : [];
        for (let i = 0; i < gamepads.length; i++) {
          const gp = gamepads[i];
          if (gp) {
            // Threshold for sticks
            if (gp.axes[0] < -threshold) reusableInputs.left = true;
            if (gp.axes[0] > threshold) reusableInputs.right = true;
            if (gp.axes[1] < -threshold) reusableInputs.up = true;
            if (gp.axes[1] > threshold) reusableInputs.down = true;

            // D-Pad (Standard mapping: 12=Up, 13=Down, 14=Left, 15=Right)
            if (gp.buttons[14] && gp.buttons[14].pressed)
              reusableInputs.left = true;
            if (gp.buttons[15] && gp.buttons[15].pressed)
              reusableInputs.right = true;
            if (gp.buttons[12] && gp.buttons[12].pressed)
              reusableInputs.up = true;
            if (gp.buttons[13] && gp.buttons[13].pressed)
              reusableInputs.down = true;

            // Buttons (0=A/Cross=Jump)
            if (gp.buttons[0] && gp.buttons[0].pressed)
              reusableInputs.up = true;
            // Start/Menu (9) -> Escape logic handled separately or mapped here?
            // We can map Start to 'p' for practice spawn
            if (gp.buttons[9] && gp.buttons[9].pressed) reusableInputs.p = true;
          }
        }
        return reusableInputs;
      }

      var activeLevelDisplay = null;
      var currentPlayingType = null; // 'campaign' or 'custom'
      var currentLevelIndex = 0;
      var animationSessionId = 0;

      function clearGame() {
        animationSessionId++;
        if (activeAnimationFrame) {
          cancelAnimationFrame(activeAnimationFrame);
          activeAnimationFrame = null;
        }
        if (activeLevelDisplay) {
          try {
            activeLevelDisplay.clear();
          } catch (e) {}
          activeLevelDisplay = null;
        }
        const container = document.getElementById("game-container");
        if (container) container.innerHTML = "";
      }

      function runAnimation(frameFunc) {
        var lastTime = null;
        var sessionId = animationSessionId;
        function frame(time) {
          if (activeAnimationFrame === false) return;
          if (sessionId !== animationSessionId) return;

          // Update Timer before frame logic to ensure accuracy
          if (gameTimerRunning) {
            if (activeLevelDisplay && activeLevelDisplay.level.status) {
              gameTimerRunning = false;
              gameTimer = Date.now() - gameTimerStart;
              const ms = String(gameTimer % 1000).padStart(3, "0");
              const s = String(Math.floor(gameTimer / 1000) % 60).padStart(
                2,
                "0",
              );
              const m = String(Math.floor(gameTimer / 60000)).padStart(2, "0");
              document.getElementById("timer-display").innerText =
                `${m}:${s}.${ms}`;
            } else {
              gameTimer = Date.now() - gameTimerStart;
              const ms = String(gameTimer % 1000).padStart(3, "0");
              const s = String(Math.floor(gameTimer / 1000) % 60).padStart(
                2,
                "0",
              );
              const m = String(Math.floor(gameTimer / 60000)).padStart(2, "0");
              document.getElementById("timer-display").innerText =
                `${m}:${s}.${ms}`;
            }
          }

          var stop = false;
          if (lastTime != null) {
            var timeStep = Math.min(time - lastTime, 100) / 1000;
            stop = frameFunc(timeStep) === false;
          }
          lastTime = time;
          if (!stop) activeAnimationFrame = requestAnimationFrame(frame);
        }
        activeAnimationFrame = requestAnimationFrame(frame);
      }

      let highscoreCategory = "any";

      window.toggleHighscoreCategory = function () {
        if (currentGameMode === "deathrun") return;
        highscoreCategory = highscoreCategory === "any" ? "blue" : "any";
        updateHighscoreDisplay();
      };

      async function updateHighscoreDisplay() {
        if (
          (currentGameMode !== "speedrun" && currentGameMode !== "deathrun") ||
          !currentLevelData
        )
          return;

        const type = currentLevelData.levelType;
        const chapter = currentLevelChapter;
        const index = currentLevelIndex;

        // Force 'any' category for deathrun
        let category =
          currentGameMode === "deathrun" ||
          currentGameMode === "chapter_speedrun"
            ? "any"
            : highscoreCategory;
        if (currentGameMode === "deathrun") category = "any";

        const key = getHighscoreKey(type, chapter, index, category);
        const best = highscores[key];

        // Format Local Time
        const hsDisplay = document.getElementById("highscore-display");
        const formatTime = (t) => {
          if (!t) return "--:--.---";
          const ms = String(t % 1000).padStart(3, "0");
          const s = String(Math.floor(t / 1000) % 60).padStart(2, "0");
          const m = String(Math.floor(t / 60000)).padStart(2, "0");
          return `${m}:${s}.${ms}`;
        };

        let displayHtml = `LOCAL: ${formatTime(best)}`;

        // Fetch Global Time
        if (_supabase && type !== "custom") {
          const globalBest = await fetchGlobalHighscore(key);
          if (globalBest) {
            displayHtml += ` | WORLD: ${formatTime(globalBest)}`;
          }
        }

        if (currentGameMode === "deathrun") {
          hsDisplay.innerHTML = displayHtml;
        } else if (currentGameMode === "chapter_speedrun") {
          hsDisplay.innerHTML = `${displayHtml} [Chapter ${chapter}]`;
        } else {
          const catLabel = highscoreCategory === "any" ? "Any%" : "Blue Coin";
          hsDisplay.innerHTML = `${displayHtml} <span onclick="window.toggleHighscoreCategory()" style="cursor:pointer; font-size: 0.8rem; margin-left: 10px; color: #888; border: 1px solid #555; padding: 2px 5px; border-radius: 3px; user-select: none;">[${catLabel}]</span>`;
        }
      }

      function runLevel(level, Display, andThen) {
        activeLevelDisplay = new Display(
          document.getElementById("game-container"),
          level,
        );
        document.getElementById("hud").style.display = "block";

        if (
          currentGameMode === "speedrun" ||
          currentGameMode === "deathrun" ||
          currentGameMode === "chapter_speedrun"
        ) {
          document.getElementById("timer-display").style.display = "block";
          if (gameTimerStart > 0) {
            const ms = String(gameTimer % 1000).padStart(3, "0");
            const s = String(Math.floor(gameTimer / 1000) % 60).padStart(
              2,
              "0",
            );
            const m = String(Math.floor(gameTimer / 60000)).padStart(2, "0");
            document.getElementById("timer-display").innerText =
              `${m}:${s}.${ms}`;
          } else {
            document.getElementById("timer-display").innerText = "00:00.000";
          }
          document.getElementById("highscore-display").style.display = "block";
        } else {
          document.getElementById("timer-display").style.display = "none";
          document.getElementById("highscore-display").style.display = "none";
        }

        if (currentGameMode === "practice") {
          document.getElementById("hud").innerText =
            "ESC | PRESS 'P' TO SET SPAWN";
        }

        playMusic(null, true);
        runAnimation(function (step) {
          const inputs = getInputs();
          if (inputs.r) {
            restartCurrentLevel();
            return false;
          }

          level.animate(step, inputs);
          activeLevelDisplay.drawFrame(step);
          if (level.isFinished()) {
            activeLevelDisplay.clear();
            activeLevelDisplay = null;
            if (andThen) andThen(level.status, level);
            return false;
          }
        });
      }

      function startGameLevel(originalLevelData, index, type, chapter) {
        const wasInLevel = !!activeLevelDisplay;
        clearGame();

        // Save menu music state if starting from menu
        if (!wasInLevel) {
          menuMusicState.trackId = currentPlayingTrackId;
          if (currentAudio) menuMusicState.time = currentAudio.currentTime;
          else menuMusicState.time = 0;
        }

        // Clone level data to prevent permanent modification of source arrays
        let levelData = JSON.parse(JSON.stringify(originalLevelData));

        currentLevelIndex = index;
        // currentPlayingType = type; // Not strictly needed if we use currentGameMode, but kept for compatibility if used elsewhere

        if (currentGameMode === "chapter_speedrun" && gameTimerStart > 0) {
          gameTimerRunning = true;
          gameTimer = Date.now() - gameTimerStart;
        } else {
          gameTimer = 0;
          gameTimerRunning = false;
          gameTimerStart = 0;
          speedrunEndTime = 0; // Reset
        }

        document.getElementById("main-menu").style.display = "none";

        // Attach level type metadata to levelData
        levelData.levelType = type;
        levelData.customLevelIndex = type === "custom" ? index : -1;
        levelData.chapter = chapter || 1; // Track which chapter for campaign levels

        currentLevelData = levelData;
        currentLevelChapter = chapter;

        // Highscore Display
        if (
          currentGameMode === "speedrun" ||
          currentGameMode === "deathrun" ||
          currentGameMode === "chapter_speedrun"
        ) {
          updateHighscoreDisplay();
          document.getElementById("highscore-display").style.display = "block";
        }

        document.getElementById("restart-btn").style.display = "block";
        if (
          document.body.classList.contains("mobile-mode") ||
          gameSettings.camera
        )
          document.getElementById("zoom-btn").style.display = "flex";
        document.getElementById("restart-btn").style.display = "flex";
        document.body.classList.add("in-game"); // Show mobile controls
        if (document.body.classList.contains("mobile-mode")) {
          if (screen.orientation && screen.orientation.unlock) {
            try {
              screen.orientation.unlock();
            } catch (e) {}
          }
        }
        runLevel(
          new Level(levelData),
          DOMDisplay,

          function (status, levelInstance) {
            if (status == "lost") {
              if (currentGameMode === "deathrun") {
                let newRecord = false;
                const key = getHighscoreKey(type, chapter, index, "any");
                if (
                  gameTimer > 0 &&
                  (!highscores[key] || gameTimer < highscores[key])
                ) {
                  highscores[key] = gameTimer;
                  saveHighscores();
                  submitHighscoreToCloud(key, gameTimer);
                  newRecord = true;
                }
                if (newRecord) triggerConfetti();
                startGameLevel(levelData, index, type, chapter);
                return;
              } else if (currentGameMode === "speedrun") {
                // Restart level, reset timer
                startGameLevel(levelData, index, type, chapter);
              } else if (currentGameMode === "chapter_speedrun") {
                // Restart level, KEEP timer (RTA style)
                // gameTimerStart is preserved by the check in startGameLevel
                startGameLevel(levelData, index, type, chapter);
              } else {
                // Standard campaign/custom behavior
                startGameLevel(levelData, index, type, chapter);
              }
            } else if (status == "won") {
              if (currentGameMode === "deathrun") {
                // Failed deathrun (survived level), restart
                startGameLevel(levelData, index, type, chapter);
                return;
              }
              if (currentGameMode === "chapter_speedrun") {
                let chapterData =
                  chapter === 1
                    ? CHAPTER_1
                    : chapter === 2
                      ? CHAPTER_2
                      : CHAPTER_3;

                // Check if there is a next level in this chapter
                if (index < chapterData.length - 1) {
                  // Unlock next level in campaign
                  if (chapter === 1 && index >= gameState.unlockedLevel)
                    gameState.unlockedLevel = index + 1;
                  if (chapter === 2 && index >= gameState.unlockedLevelCh2)
                    gameState.unlockedLevelCh2 = index + 1;
                  if (chapter === 3 && index >= gameState.unlockedLevelCh3)
                    gameState.unlockedLevelCh3 = index + 1;
                  saveGame();

                  // Proceed to next level
                  startGameLevel(
                    chapterData[index + 1],
                    index + 1,
                    type,
                    chapter,
                  );
                } else {
                  // Chapter Complete
                  gameTimerRunning = false;
                  if (gameTimerStart > 0) {
                    gameTimer = Date.now() - gameTimerStart;
                    const ms = String(gameTimer % 1000).padStart(3, "0");
                    const s = String(
                      Math.floor(gameTimer / 1000) % 60,
                    ).padStart(2, "0");
                    const m = String(Math.floor(gameTimer / 60000)).padStart(
                      2,
                      "0",
                    );
                    document.getElementById("timer-display").innerText =
                      `${m}:${s}.${ms}`;
                  }

                  let newRecord = false;
                  const key = getHighscoreKey(type, chapter, index); // index ignored for chapter_speedrun key
                  if (
                    gameTimer > 0 &&
                    (!highscores[key] || gameTimer < highscores[key])
                  ) {
                    highscores[key] = gameTimer;
                    saveHighscores();
                    submitHighscoreToCloud(key, gameTimer);
                    newRecord = true;
                  }
                  if (newRecord) triggerConfetti();

                  showPopup(
                    "CHAPTER COMPLETE",
                    "Final Time: " +
                      document.getElementById("timer-display").innerText,
                    () => exitToMenu(),
                  );
                }
                return;
              }
              if (currentGameMode === "speedrun") {
                gameTimerRunning = false;
                if (gameTimerStart > 0) {
                  gameTimer = (speedrunEndTime || Date.now()) - gameTimerStart; // Use stopped time
                  const ms = String(gameTimer % 1000).padStart(3, "0");
                  const s = String(Math.floor(gameTimer / 1000) % 60).padStart(
                    2,
                    "0",
                  );
                  const m = String(Math.floor(gameTimer / 60000)).padStart(
                    2,
                    "0",
                  );
                  document.getElementById("timer-display").innerText =
                    `${m}:${s}.${ms}`;
                }

                let newRecord = false;
                // Update Highscore (Any%)
                const keyAny = getHighscoreKey(type, chapter, index, "any");
                if (
                  gameTimer > 0 &&
                  (!highscores[keyAny] || gameTimer < highscores[keyAny])
                ) {
                  highscores[keyAny] = gameTimer;
                  saveHighscores();
                  submitHighscoreToCloud(keyAny, gameTimer);
                  newRecord = true;
                }

                // Update Highscore (Blue Coin)
                if (
                  currentGameMode === "speedrun" &&
                  levelInstance.blueCoinsCollected >=
                    levelInstance.totalBlueCoins &&
                  levelInstance.totalBlueCoins > 0 &&
                  gameTimer > 0
                ) {
                  const keyBlue = getHighscoreKey(type, chapter, index, "blue");
                  if (!highscores[keyBlue] || gameTimer < highscores[keyBlue]) {
                    highscores[keyBlue] = gameTimer;
                    saveHighscores();
                    submitHighscoreToCloud(keyBlue, gameTimer);
                    newRecord = true;
                  }
                }

                if (newRecord) triggerConfetti();

                startGameLevel(levelData, index, type, chapter);
                return;
              }

              if (type === "campaign") {
                const ch = chapter || 1;
                let chapterData;
                if (currentGameMode === "rising_lava")
                  chapterData = RISING_LAVA_LEVELS;
                else
                  chapterData =
                    ch === 1 ? CHAPTER_1 : ch === 2 ? CHAPTER_2 : CHAPTER_3;

                const blueCoinKey =
                  ch === 1 ? index : ch === 2 ? `ch2_${index}` : `ch3_${index}`;

                if (
                  levelInstance.blueCoinsCollected >=
                    levelInstance.totalBlueCoins &&
                  levelInstance.totalBlueCoins > 0
                )
                  gameState.levelBlueCoins[blueCoinKey] = true;
                checkBlueCoinSkinUnlock();

                if (ch === 1 && index >= gameState.unlockedLevel)
                  gameState.unlockedLevel = index + 1;

                if (ch === 2 && index >= gameState.unlockedLevelCh2)
                  gameState.unlockedLevelCh2 = index + 1;

                if (ch === 3 && index >= gameState.unlockedLevelCh3)
                  gameState.unlockedLevelCh3 = index + 1;

                // Check if final level of current chapter
                const isFinalLevel = index === chapterData.length - 1;

                if (isFinalLevel && ch === 1) {
                  gameState.chapter1Beaten = true;
                  saveGame();
                  // Only show message if not shown before
                  if (!gameState.blueCoinUnlockShown) {
                    gameState.blueCoinUnlockShown = true;
                    saveGame();
                    showPopup(
                      "CHAPTER I BEATEN",
                      "Blue Coins have been unlocked!",
                      () => exitToMenu(),
                    );
                  } else {
                    exitToMenu();
                  }
                } else if (isFinalLevel && ch === 2) {
                  gameState.chapter2Beaten = true;
                  saveGame();
                  showPopup("CHAPTER II BEATEN", "All levels completed!", () =>
                    exitToMenu(),
                  );
                } else if (isFinalLevel && ch === 3) {
                  gameState.chapter3Beaten = true;
                  gameState.gameBeaten = true;
                  saveGame();
                  showPopup("CHAPTER III BEATEN", "Game Complete!", () =>
                    exitToMenu(),
                  );
                } else {
                  saveGame();
                  // Try next level in the same chapter
                  if (index + 1 < chapterData.length) {
                    startGameLevel(
                      chapterData[index + 1],
                      index + 1,
                      "campaign",
                      ch,
                    );
                  } else {
                    exitToMenu();
                  }
                }
              } else if (type === "custom") {
                // Track custom level completion for blue coin unlocking
                if (index >= 0) {
                  customLevelsProgress[index] = true;
                  saveCustomLevelsProgress();
                }
                // Save blue coin collection if level was beaten before
                if (
                  levelInstance.blueCoinsCollected >=
                    levelInstance.totalBlueCoins &&
                  levelInstance.totalBlueCoins > 0 &&
                  index >= 0
                ) {
                  if (!gameState.levelBlueCoins[`custom_${index}`]) {
                    gameState.levelBlueCoins[`custom_${index}`] = true;
                    saveGame();
                    checkBlueCoinSkinUnlock();
                  }
                }
                exitToMenu();
              } else {
                exitToMenu();
              }
            }
          },
        );
      }

      function exitToMenu() {
        cancelAnimationFrame(activeAnimationFrame);
        activeAnimationFrame = false;
        document.body.classList.remove("in-game"); // Hide mobile controls
        if (document.body.classList.contains("mobile-mode")) {
          if (screen.orientation && screen.orientation.lock) {
            screen.orientation.lock("portrait").catch(() => {});
          }
        }
        if (activeLevelDisplay) {
          activeLevelDisplay.clear();
          activeLevelDisplay = null;
        }
        clearGame();
        document.getElementById("hud").style.display = "none";
        document.getElementById("hud").innerText = "ESC"; // Reset HUD text
        document.getElementById("restart-btn").style.display = "none";
        document.getElementById("zoom-btn").style.display = "none";
        document.getElementById("timer-display").style.display = "none";
        document.getElementById("highscore-display").style.display = "none";
        gameTimerStart = 0; // Ensure timer is reset when exiting

        playMusic(menuMusicState.trackId || "synth");
        showMenu(currentMenuView);
      }

      function restartCurrentLevel() {
        if (currentLevelData) {
          startGameLevel(
            currentLevelData,
            currentLevelIndex,
            currentLevelData.levelType,
            currentLevelChapter,
          );
        }
      }

      let currentMenuView = "main";
      let customMenuSource = "main";

      function handleMenuBack() {
        if (currentMenuView === "main") return;

        if (currentMenuView === "mobile-gamemodes") {
          showMenu("main");
          return;
        }

        if (currentMenuView === "beats-menu") {
          showMenu("main");
          return;
        }

        if (currentMenuView === "other-modes") {
          showMenu("main");
          return;
        }

        if (currentMenuView === "source-select") {
          showMenu("other-modes");
          return;
        }

        if (currentMenuView === "level-awards") {
          showMenu("main");
          return;
        }

        if (currentMenuView === "campaign" || currentMenuView === "custom") {
          if (currentMenuView === "custom") {
            if (customMenuSource === "source-select") showMenu("source-select");
            else showMenu("main");
          } else if (
            currentGameMode === "speedrun" ||
            currentGameMode === "deathrun" ||
            currentGameMode === "practice" ||
            currentGameMode === "chapter_speedrun"
          ) {
            showMenu("source-select");
          } else if (document.body.classList.contains("mobile-mode")) {
            showMenu("mobile-gamemodes");
          } else {
            showMenu("main");
          }
          return;
        }

        if (
          [
            "chapter1",
            "chapter2",
            "chapter3",
            "chapter-speedrun-select",
          ].includes(currentMenuView)
        ) {
          showMenu("campaign");
          return;
        }
      }

      // --- Menu System ---

      function createAccordion(title, contentElements, isOpen = false) {
        const section = document.createElement("div");
        section.className = "accordion-section";

        const header = document.createElement("div");
        header.className = "accordion-header" + (isOpen ? " active" : "");
        header.innerHTML = `<span>${title}</span><span class="accordion-arrow"></span>`;

        const content = document.createElement("div");
        content.className = "accordion-content" + (isOpen ? " open" : "");

        contentElements.forEach((el) => content.appendChild(el));

        header.onclick = () => {
          const wasOpen = content.classList.contains("open");

          // Close all others
          document
            .querySelectorAll(".accordion-content")
            .forEach((el) => el.classList.remove("open"));
          document
            .querySelectorAll(".accordion-header")
            .forEach((el) => el.classList.remove("active"));

          if (!wasOpen) {
            content.classList.add("open");
            header.classList.add("active");
          }
        };

        section.appendChild(header);
        section.appendChild(content);
        return section;
      }

      function renderSkinGrid(container, skins, isInteractive) {
        const grid = document.createElement("div");
        grid.style.cssText =
          "display: grid; grid-template-columns: repeat(auto-fill, minmax(140px, 1fr)); gap: 20px; width: 100%; margin-top: 20px; padding: 10px; box-sizing: border-box;";

        skins.forEach((skinId) => {
          const meta = SKIN_DEFINITIONS[skinId] || {
            name: skinId,
            copies: "Unknown",
          };
          const el = document.createElement("div");
          el.style.cssText =
            "background: #222; border: 2px solid #333; border-radius: 12px; padding: 20px; display: flex; flex-direction: column; align-items: center; gap: 15px; cursor: pointer; transition: all 0.2s; position: relative;";

          if (isInteractive) {
            if (gameSettings.currentSkin === skinId) {
              el.style.borderColor = "#335699";
              el.style.background = "#1a2a40";
              el.style.boxShadow = "0 0 15px rgba(51, 86, 153, 0.3)";
            }
            el.onclick = () => {
              gameSettings.currentSkin = skinId;
              saveSettings();
              showMenu("account");
            };
          }

          const preview = document.createElement("div");
          // 1:2 Aspect Ratio (60x120)
          preview.style.width = "60px";
          preview.style.height = "120px";

          if (skinId === "default") {
            preview.style.background = "#335699";
            preview.style.borderRadius = "4px";
            preview.style.boxShadow = "0 4px 10px rgba(0,0,0,0.5)";
          } else {
            preview.style.backgroundImage = `url('${skinId}.png')`;
            preview.style.backgroundSize = "contain";
            preview.style.backgroundRepeat = "no-repeat";
            preview.style.backgroundPosition = "center";
            preview.style.filter = "drop-shadow(0 4px 5px rgba(0,0,0,0.5))";
          }
          el.appendChild(preview);

          const infoDiv = document.createElement("div");
          infoDiv.style.textAlign = "center";

          const name = document.createElement("div");
          name.innerText = meta.name;
          name.style.fontSize = "0.9rem";
          name.style.fontWeight = "bold";
          name.style.color = "#fff";
          name.style.marginBottom = "5px";
          infoDiv.appendChild(name);

          const copies = document.createElement("div");
          copies.innerText = meta.copies;
          copies.style.fontSize = "0.6rem";
          if (meta.copies === "1/1") {
            copies.style.color = "#ffd700";
            copies.style.fontWeight = "bold";
            copies.style.textShadow = "0 0 5px rgba(255, 215, 0, 0.5)";
          } else {
            copies.style.color = "#888";
          }
          infoDiv.appendChild(copies);

          el.appendChild(infoDiv);

          grid.appendChild(el);
        });
        container.appendChild(grid);
      }

      async function openUserProfile(username) {
        if (!_supabase) return;

        // Optimistic UI: Show loading state immediately
        showMenu("user-profile", { username, loading: true });

        const { data, error } = await _supabase
          .from("users")
          .select("skins")
          .eq("username", username)
          .single();

        if (error || !data) {
          showPopup("ERROR", "Could not load profile.", () =>
            showMenu("leaderboards-new"),
          );
          return;
        }
        showMenu("user-profile", {
          username,
          skins: data.skins || ["default"],
        });
      }

      // Views: 'main', 'campaign', 'chapter1', 'chapter2', 'custom'
      function showMenu(view, context) {
        currentMenuView = view;
        document.getElementById("main-menu").style.display = "flex";
        const container = document.getElementById("menu-content");
        const subtitle = document.getElementById("menu-subtitle");
        container.innerHTML = "";
        container.style.overflow = "";

        const mainTitle = document.querySelector("#main-menu h1");
        if (mainTitle)
          mainTitle.style.display = view === "main" ? "block" : "none";

        const hint = document.querySelector(".controls-hint");
        if (hint) hint.style.display = view === "main" ? "block" : "none";

        const bottomControls = document.querySelector(".bottom-controls");
        if (bottomControls)
          bottomControls.style.display = view === "main" ? "flex" : "none";

        const leaderboardBtn = document.querySelector(".leaderboard-btn");
        if (leaderboardBtn)
          leaderboardBtn.style.display = view === "main" ? "block" : "none";

        const awardsBtn = document.querySelector(".awards-btn");
        if (awardsBtn)
          awardsBtn.style.display = view === "main" ? "block" : "none";

        const editorBtn = document.querySelector(".editor-btn");
        if (editorBtn)
          editorBtn.style.display =
            view === "main" && gameSettings.showEditorButton ? "block" : "none";

        const loginBtn = document.querySelector(".login-btn");
        if (loginBtn)
          loginBtn.style.display = view === "main" ? "block" : "none";

        const feedbackBtn = document.querySelector(".feedback-btn");
        if (feedbackBtn)
          feedbackBtn.style.display = view === "main" ? "flex" : "none";

        // Hide mobile specific buttons if not in main
        document.querySelectorAll(".mobile-fixed-btn").forEach((el) => {
          if (view !== "main") el.style.display = "none";
          else el.style.display = "flex";
        });

        // Clear beats interval if leaving beats menu
        if (view !== "beats-menu" && beatsUpdateInterval) {
          clearInterval(beatsUpdateInterval);
          beatsUpdateInterval = null;
        }

        // Ensure music updates when switching menus (e.g. back from level)
        if (!activeLevelDisplay) playMusic();

        // Check News
        const lastRead = safeStorage.getItem("lastReadNews");
        if (lastRead !== LATEST_NEWS_VERSION) {
          document.getElementById("news-notif").style.display = "block";
        }

        // Top Right Back Button for sub-menus
        const existingBack = document.getElementById("top-right-back-btn");
        if (existingBack) existingBack.remove();

        if (view === "main") {
          subtitle.textContent = "";

          if (document.body.classList.contains("mobile-mode")) {
            const mobileGrid = document.createElement("div");
            mobileGrid.className = "mobile-menu-grid";

            // Leaderboard
            const lbBtn = document.createElement("button");
            lbBtn.className = "mobile-icon-btn";
            lbBtn.innerHTML = `<svg viewBox="0 0 24 24"><path d="M16 11V3H8v6H2v12h20V11h-6zm-6-6h4v14h-4V5zm-6 6h4v8H4v-8zm16 8h-4v-6h4v6z"/></svg>`;
            lbBtn.onclick = () => showMenu("leaderboards-new");

            // Campaign
            const campBtn = document.createElement("button");
            campBtn.className = "mobile-icon-btn";
            campBtn.style.width = "100px";
            campBtn.style.height = "100px";
            campBtn.style.background = "#335699";
            campBtn.style.borderColor = "#5588cc";
            campBtn.className = "mobile-icon-btn campaign-btn";
            campBtn.innerHTML = `<svg viewBox="0 0 24 24"><path d="M8 5v14l11-7z"/></svg>`;
            campBtn.onclick = () => {
              showMenu("mobile-gamemodes");
            };

            // Profile
            const profBtn = document.createElement("button");
            profBtn.className = "mobile-icon-btn";
            profBtn.innerHTML = `<svg viewBox="0 0 24 24"><path d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z"/></svg>`;
            profBtn.onclick = () => {
              if (currentUser) showMenu("account");
              else openLoginModal();
            };

            mobileGrid.appendChild(lbBtn);
            mobileGrid.appendChild(campBtn);
            mobileGrid.appendChild(profBtn);
            container.appendChild(mobileGrid);

            // Mobile Settings Button (Bottom Right)
            const mobSettingsBtn = document.createElement("button");
            mobSettingsBtn.className =
              "mobile-icon-btn settings-btn-mobile mobile-fixed-btn";
            mobSettingsBtn.style.cssText =
              "position: fixed; bottom: 20px; right: 20px; width: 50px; height: 50px; z-index: 100;";
            mobSettingsBtn.innerHTML = `<svg width="24" height="24" fill="currentColor" viewBox="0 0 24 24"><path d="M19.14 12.94c.04-.3.06-.61.06-.94 0-.32-.02-.64-.07-.94l2.03-1.58a.49.49 0 0 0 .12-.61l-1.92-3.32a.488.488 0 0 0-.59-.22l-2.39.96c-.5-.38-1.03-.7-1.62-.94l-.36-2.54a.484.484 0 0 0-.48-.41h-3.84c-.24 0-.43.17-.47.41l-.36 2.54c-.59.24-1.13.57-1.62.94l-2.39-.96a.488.488 0 0 0-.59.22L2.74 8.87a.49.49 0 0 0 .12.61l2.03 1.58c-.05.3-.07.62-.07.94s.02.64.07.94l-2.03 1.58a.49.49 0 0 0-.12.61l1.92 3.32c.12.22.37.29.59.22l2.39-.96c.5.38 1.03.7 1.62.94l.36 2.54c.05.24.24.41.48.41h3.84c.24 0 .44-.17.47-.41l.36-2.54c.59-.24 1.13-.57 1.62-.94l2.39.96c.22.08.47 0 .59-.22l1.92-3.32a.49.49 0 0 0-.12-.61l-2.01-1.58zM12 15.6c-1.98 0-3.6-1.62-3.6-3.6s1.62-3.6 3.6-3.6 3.6 1.62 3.6 3.6-1.62 3.6-3.6 3.6z"/></svg>`;
            mobSettingsBtn.onclick = () => showMenu("mobile-settings");
            container.appendChild(mobSettingsBtn);

            // Mobile Beats Button (Bottom Left)
            const mobBeatsBtn = document.createElement("button");
            mobBeatsBtn.className =
              "mobile-icon-btn beats-btn-mobile mobile-fixed-btn";
            mobBeatsBtn.style.cssText =
              "position: fixed; bottom: 20px; left: 20px; width: 50px; height: 50px; z-index: 100; display:flex;";
            mobBeatsBtn.innerHTML = `<svg viewBox="0 0 24 24"><path d="M12 3v9.28c-.47-.17-.97-.28-1.5-.28C8.01 12 6 14.01 6 16.5S8.01 21 10.5 21c2.31 0 4.2-1.75 4.45-4H15V6h4V3h-7z"/></svg>`;
            mobBeatsBtn.onclick = () => openMobileBeatsUI();
            container.appendChild(mobBeatsBtn);

            // Mobile Custom Levels Button (Top Right)
            const mobCustomBtn = document.createElement("button");
            mobCustomBtn.className =
              "mobile-icon-btn custom-btn-mobile mobile-fixed-btn";
            mobCustomBtn.style.cssText =
              "position: fixed; top: 20px; right: 20px; width: 50px; height: 50px; z-index: 100; display:flex;";
            mobCustomBtn.innerHTML = `<svg viewBox="0 0 24 24"><path d="M3 17.25V21h3.75L17.81 9.94l-3.75-3.75L3 17.25zM20.71 7.04c.39-.39.39-1.02 0-1.41l-2.34-2.34c-.39-.39-1.02-.39-1.41 0l-1.83 1.83 3.75 3.75 1.83-1.83z"/></svg>`;
            mobCustomBtn.onclick = () => {
              currentGameMode = "custom";
              customMenuSource = "main";
              showMenu("custom");
            };
            container.appendChild(mobCustomBtn);
          } else {
            const btnCampaign = document.createElement("button");
            btnCampaign.className = "btn";
            btnCampaign.textContent = "CAMPAIGN";
            btnCampaign.onclick = () => {
              currentGameMode = "campaign";
              showMenu("campaign");
            };

            const btnSpeed = document.createElement("button");
            btnSpeed.className = "btn";
            btnSpeed.textContent = "SPEEDRUN";
            btnSpeed.onclick = () => {
              currentGameMode = "speedrun";
              showMenu("source-select");
            };

            const btnCustom = document.createElement("button");
            btnCustom.className = "btn";
            btnCustom.textContent = "CUSTOM LEVELS";
            btnCustom.onclick = () => {
              currentGameMode = "custom";
              customMenuSource = "main";
              showMenu("custom");
            };

            const btnOther = document.createElement("button");
            btnOther.className = "btn";
            btnOther.textContent = "OTHER MODES";
            btnOther.onclick = () => showMenu("other-modes");

            container.appendChild(btnCampaign);
            container.appendChild(btnSpeed);
            container.appendChild(btnCustom);
            container.appendChild(btnOther);
          }
        } else if (view === "settings") {
          subtitle.textContent = "SETTINGS";

          // --- Gameplay Section ---
          const gameplayItems = [];

          // Camera Toggle
          const camRow = document.createElement("div");
          camRow.style.cssText =
            "display:flex; align-items:center; justify-content:space-between;";
          camRow.innerHTML = `<span style="font-size:1.2rem;">CAMERA ZOOM</span>`;
          const camToggle = document.createElement("div");
          camToggle.className =
            "toggle-btn" + (gameSettings.camera ? " active" : "");
          camToggle.innerHTML = '<div class="toggle-slider"></div>';
          camToggle.onclick = () => {
            gameSettings.camera = !gameSettings.camera;
            camToggle.className =
              "toggle-btn" + (gameSettings.camera ? " active" : "");
            saveSettings();
          };
          camRow.appendChild(camToggle);
          gameplayItems.push(camRow);

          // Alternate Blue Coin Style Toggle
          const bcRow = document.createElement("div");
          bcRow.style.cssText =
            "display:flex; align-items:center; justify-content:space-between;";
          bcRow.innerHTML = `<span style="font-size:1.2rem;">ALT BLUE COIN STYLE</span>`;
          const blueCoinToggle = document.createElement("div");
          blueCoinToggle.className =
            "toggle-btn" +
            (gameSettings.alternateBlueCoinStyle ? " active" : "");
          blueCoinToggle.innerHTML = '<div class="toggle-slider"></div>';
          blueCoinToggle.onclick = () => {
            gameSettings.alternateBlueCoinStyle =
              !gameSettings.alternateBlueCoinStyle;
            blueCoinToggle.className =
              "toggle-btn" +
              (gameSettings.alternateBlueCoinStyle ? " active" : "");
            saveSettings();
          };
          bcRow.appendChild(blueCoinToggle);
          gameplayItems.push(bcRow);

          // Confirm Delete Toggle
          const cdRow = document.createElement("div");
          cdRow.style.cssText =
            "display:flex; align-items:center; justify-content:space-between;";
          cdRow.innerHTML = `<span style="font-size:1.2rem;">CONFIRM DELETE</span>`;
          const confirmDelToggle = document.createElement("div");
          confirmDelToggle.className =
            "toggle-btn" + (gameSettings.confirmDelete ? " active" : "");
          confirmDelToggle.innerHTML = '<div class="toggle-slider"></div>';
          confirmDelToggle.onclick = () => {
            gameSettings.confirmDelete = !gameSettings.confirmDelete;
            confirmDelToggle.className =
              "toggle-btn" + (gameSettings.confirmDelete ? " active" : "");
            saveSettings();
          };
          cdRow.appendChild(confirmDelToggle);
          gameplayItems.push(cdRow);

          // Hitbox Toggle
          const hbRow = document.createElement("div");
          hbRow.style.cssText =
            "display:flex; align-items:center; justify-content:space-between;";
          hbRow.innerHTML = `<span style="font-size:1.2rem;">SHOW HITBOXES</span>`;
          const hbToggle = document.createElement("div");
          hbToggle.className =
            "toggle-btn" + (gameSettings.showHitboxes ? " active" : "");
          hbToggle.innerHTML = '<div class="toggle-slider"></div>';
          hbToggle.onclick = () => {
            gameSettings.showHitboxes = !gameSettings.showHitboxes;
            hbToggle.className =
              "toggle-btn" + (gameSettings.showHitboxes ? " active" : "");
            saveSettings();
          };
          hbRow.appendChild(hbToggle);
          gameplayItems.push(hbRow);

          // Editor Button Toggle
          const edRow = document.createElement("div");
          edRow.style.cssText =
            "display:flex; align-items:center; justify-content:space-between;";
          edRow.innerHTML = `<span style="font-size:1.2rem;">SHOW EDITOR BUTTON</span>`;

          // Open in New Tab Toggle (Dependent)
          const newTabRow = document.createElement("div");

          const editorBtnToggle = document.createElement("div");
          editorBtnToggle.className =
            "toggle-btn" + (gameSettings.showEditorButton ? " active" : "");
          editorBtnToggle.innerHTML = '<div class="toggle-slider"></div>';
          editorBtnToggle.onclick = () => {
            gameSettings.showEditorButton = !gameSettings.showEditorButton;
            editorBtnToggle.className =
              "toggle-btn" + (gameSettings.showEditorButton ? " active" : "");

            // Update dependent toggle
            if (gameSettings.showEditorButton) {
              newTabRow.style.opacity = "1";
              newTabRow.style.pointerEvents = "auto";
            } else {
              newTabRow.style.opacity = "0.5";
              newTabRow.style.pointerEvents = "none";
            }
            saveSettings();
          };
          edRow.appendChild(editorBtnToggle);
          gameplayItems.push(edRow);

          newTabRow.style.cssText =
            "display:flex; align-items:center; justify-content:space-between; margin-left:20px;";
          if (!gameSettings.showEditorButton) {
            newTabRow.style.opacity = "0.5";
            newTabRow.style.pointerEvents = "none";
          }
          newTabRow.innerHTML = `<span style="font-size:1rem; color:#aaa;">OPEN IN NEW TAB</span>`;
          const newTabToggle = document.createElement("div");
          newTabToggle.className =
            "toggle-btn" + (gameSettings.editorNewTab ? " active" : "");
          newTabToggle.innerHTML = '<div class="toggle-slider"></div>';
          newTabToggle.onclick = () => {
            gameSettings.editorNewTab = !gameSettings.editorNewTab;
            newTabToggle.className =
              "toggle-btn" + (gameSettings.editorNewTab ? " active" : "");
            saveSettings();
          };
          newTabRow.appendChild(newTabToggle);
          gameplayItems.push(newTabRow);

          const openGameplay = !context || context === "gameplay";
          container.appendChild(
            createAccordion("GAMEPLAY", gameplayItems, openGameplay),
          );

          // --- Audio Section ---
          const audioItems = [];

          // Volume Slider
          const volRow = document.createElement("div");
          volRow.style.cssText =
            "display:flex; flex-direction:column; gap:10px;";

          const volLabel = document.createElement("div");
          volLabel.innerHTML = `<span style="font-size:1.2rem;">VOLUME: <span id="vol-display">${gameSettings.volume}%</span></span>`;
          const volSlider = document.createElement("input");
          volSlider.type = "range";
          volSlider.min = "0";
          volSlider.max = "100";
          volSlider.value = gameSettings.volume;
          volSlider.style.cursor = "pointer";
          volSlider.oninput = (e) => {
            gameSettings.volume = parseInt(e.target.value);
            document.getElementById("vol-display").innerText =
              gameSettings.volume + "%";
            if (currentAudio) {
              currentAudio.volume = gameSettings.volume / 100;
            }
            saveSettings();
          };

          volRow.appendChild(volLabel);
          volRow.appendChild(volSlider);
          audioItems.push(volRow);

          container.appendChild(createAccordion("AUDIO", audioItems));

          // --- User Section ---
          const userItems = [];
          const accountBtn = document.createElement("button");
          accountBtn.className = "btn";
          accountBtn.textContent = "USER DASHBOARD";
          accountBtn.style.width = "100%";
          accountBtn.onclick = () => {
            if (currentUser) showMenu("account");
            else openLoginModal();
          };
          userItems.push(accountBtn);

          if (currentUser) {
            const passDiv = document.createElement("div");
            passDiv.style.cssText =
              "display:flex; flex-direction:column; gap:10px; padding:10px; background:#222; border:1px solid #444; border-radius:4px;";
            passDiv.innerHTML = `
              <div style="font-size:0.9rem; color:#ccc; font-weight:bold;">CHANGE PASSWORD</div>
              <input type="password" id="old-pass-input" placeholder="Current Password" style="padding:8px; background:#333; color:white; border:1px solid #555; font-size:0.8rem;">
              <input type="password" id="new-pass-input" placeholder="New Password" style="padding:8px; background:#333; color:white; border:1px solid #555; font-size:0.8rem;">
              <button class="btn" style="padding:8px; font-size:0.8rem; min-width:auto;" onclick="changePassword(document.getElementById('old-pass-input').value, document.getElementById('new-pass-input').value)">UPDATE PASSWORD</button>
            `;
            userItems.push(passDiv);
          }

          const openUser = context === "user";
          container.appendChild(
            createAccordion("USER SETTINGS", userItems, openUser),
          );

          const closeBtn = document.createElement("button");
          closeBtn.className = "settings-close-btn";
          closeBtn.innerHTML = "&times;";
          closeBtn.onclick = () => showMenu("main");
          container.appendChild(closeBtn);
        } else if (view === "mobile-settings") {
          subtitle.textContent = "SETTINGS";
          container.style.maxWidth = "100%";
          container.style.padding = "20px";

          const settingsContent = document.createElement("div");
          settingsContent.style.cssText =
            "display: flex; flex-direction: column; gap: 15px; width: 100%;";

          // Volume
          const volDiv = document.createElement("div");
          volDiv.style.cssText =
            "background: #222; padding: 15px; border-radius: 12px; border: 1px solid #333;";
          volDiv.innerHTML = `<div style="margin-bottom:10px; font-weight:bold; color: #ccc; font-size: 0.9rem;">VOLUME <span id="m-vol-val" style="float:right; color: #335699;">${gameSettings.volume}%</span></div>`;
          const volSlider = document.createElement("input");
          volSlider.type = "range";
          volSlider.min = "0";
          volSlider.max = "100";
          volSlider.value = gameSettings.volume;
          volSlider.oninput = (e) => {
            gameSettings.volume = parseInt(e.target.value);
            document.getElementById("m-vol-val").innerText =
              gameSettings.volume + "%";
            if (currentAudio) currentAudio.volume = gameSettings.volume / 100;
            saveSettings();
          };
          volDiv.appendChild(volSlider);
          settingsContent.appendChild(volDiv);

          // Alt Coin
          const altCoinDiv = document.createElement("div");
          altCoinDiv.style.cssText =
            "display:flex; justify-content:space-between; align-items:center; background:#222; padding:15px; border-radius:12px; border:1px solid #333;";
          altCoinDiv.innerHTML = "<span>ALT BLUE COIN</span>";
          const acToggle = document.createElement("div");
          acToggle.className =
            "toggle-btn" +
            (gameSettings.alternateBlueCoinStyle ? " active" : "");
          acToggle.innerHTML = '<div class="toggle-slider"></div>';
          acToggle.onclick = () => {
            gameSettings.alternateBlueCoinStyle =
              !gameSettings.alternateBlueCoinStyle;
            acToggle.className =
              "toggle-btn" +
              (gameSettings.alternateBlueCoinStyle ? " active" : "");
            saveSettings();
          };
          altCoinDiv.appendChild(acToggle);
          settingsContent.appendChild(altCoinDiv);

          // Credits
          const credBtn = document.createElement("button");
          credBtn.className = "btn";
          credBtn.textContent = "CREDITS";
          credBtn.style.cssText =
            "background: #333; border: 1px solid #555; padding: 15px; border-radius: 12px; font-size: 1rem; width: 100%;";
          credBtn.onclick = showCredits;
          settingsContent.appendChild(credBtn);

          // Feedback
          const fbBtn = document.createElement("button");
          fbBtn.className = "btn";
          fbBtn.textContent = "SEND FEEDBACK";
          fbBtn.style.cssText =
            "background: #333; border: 1px solid #555; padding: 15px; border-radius: 12px; font-size: 1rem; width: 100%;";
          fbBtn.onclick = openFeedbackModal;
          settingsContent.appendChild(fbBtn);

          container.appendChild(settingsContent);

          const closeBtn = document.createElement("button");
          closeBtn.className = "settings-close-btn";
          closeBtn.innerHTML = "&times;";
          closeBtn.onclick = () => showMenu("main");
          container.appendChild(closeBtn);
        } else if (view === "mobile-gamemodes") {
          subtitle.textContent = "SELECT MODE";
          container.style.width = "100%";
          container.style.padding = "0";

          const carousel = document.createElement("div");
          carousel.className = "gamemode-carousel";
          carousel.style.cssText =
            "display: flex; overflow-x: auto; scroll-snap-type: x mandatory; width: 100%; height: 60vh; align-items: center; gap: 20px; padding: 0 20px; box-sizing: border-box; scrollbar-width: none;";

          const modes = [
            {
              name: "CAMPAIGN",
              desc: "Play the main story levels.",
              action: () => {
                currentGameMode = "campaign";
                showMenu("campaign");
              },
              color: "#335699",
            },
            {
              name: "SPEEDRUN",
              desc: "Regular speedrun.",
              action: () => {
                currentGameMode = "speedrun";
                showMenu("source-select");
              },
              color: "#e67e22",
            },
            {
              name: "DEATHRUN",
              desc: "Die as fast as possible.",
              action: () => {
                currentGameMode = "deathrun";
                showMenu("source-select");
              },
              color: "#a04040",
            },
            {
              name: "CHAPTER RUN",
              desc: "Speedrun the entire chapter.",
              action: () => {
                currentGameMode = "chapter_speedrun";
                showMenu("chapter-speedrun-select");
              },
              color: "#8e44ad",
            },
          ];

          modes.forEach((m) => {
            const card = document.createElement("div");
            card.className = "gamemode-card";
            card.style.cssText = `flex: 0 0 250px; height: 300px; background: #222; border: 2px solid ${m.color}; border-radius: 15px; scroll-snap-align: center; display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 20px; box-sizing: border-box; position: relative; transition: transform 0.2s; margin: 0 auto;`;

            card.innerHTML = `
                  <div style="font-size: 1.5rem; font-weight: bold; color: ${m.color}; margin-bottom: 10px; text-align: center;">${m.name}</div>
                  <div style="font-size: 0.9rem; color: #aaa; text-align: center; margin-bottom: 20px;">${m.desc}</div>
                  <button class="btn" style="font-size: 1rem; padding: 10px 20px; background: ${m.color}; border-color: #fff;">PLAY</button>
              `;
            card.onclick = m.action;
            carousel.appendChild(card);
          });

          container.appendChild(carousel);

          const backBtn = document.createElement("button");
          backBtn.className = "btn";
          backBtn.textContent = "BACK";
          backBtn.style.cssText =
            "position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%); z-index: 100;";
          backBtn.onclick = () => showMenu("main");
          container.appendChild(backBtn);
        } else if (view === "news") {
          subtitle.textContent = "NEWS & UPDATES";

          safeStorage.setItem("lastReadNews", LATEST_NEWS_VERSION);
          document.getElementById("news-notif").style.display = "none";

          const newsContent = document.createElement("div");
          newsContent.style.cssText =
            "width:100%; max-width:600px; max-height:60vh; overflow-y:auto; background:#222; border:2px solid #444; padding:20px; text-align:left;";

          const updates = [
            {
              v: "1.5.1",
              t: "1.5 Patch",
              d: "Fixed various bugs from the 1.5 update and enhanced customization by allowing the user to choose the amount of blocks in the wall block. Also made wall blocks bump you up when activated right when the player lands on them and changed the way grinders are spawned, allowing different grinder sizes.",
            },
            {
              v: "1.5",
              t: "The Grinder",
              d: "Multiple bug fixes. Win animations now have no time penalty in speedruns. Added upside down spikes, breakable blocks, spike blocks, upside down spike blocks, wall blocks, falling blocks, jump pads, and grinders. Added credits and a new option in the level awards UI to see the level info and add the level to your levels. Added new block mods: flicker, jump flicker, and illusion (only for breakable blocks). Various other changes. ",
            },
            {
              v: "1.4.3",
              t: "Mobile Fixes",
              d: "Fixed multiple bugs and improved the interface on mobile. Added custom levels to mobile. Added the zoom out toggle to desktop (also z on the keyboard) and replaced the previous two zoom modes with three new ones.  Progress in chapter speedruns now counts as progress in the campaign, even if you don't finish the chapter speedrun. Also added a new song: Taking Our Time by Alex Grohl.",
            },
            {
              v: "1.4.2",
              t: "Mobile",
              d: "Completely redesigned the mobile UI to be mobile-friendly. Certain features not supported yet. ",
            },
            {
              v: "1.4.1",
              t: "Bug Fix",
              d: "Various changes to multiple chapter two levels and improvements on the physics of moving bocks.",
            },
            {
              v: "1.4",
              t: "Leaderboards & Cloud Storage",
              d: "Added blockoverit accounts. Once signed in, you can sync your game to all devices. Also added a global highscores list under a new leaderboard interface (the top left button). Leaderboards for every campaign level in speedruns and deathruns and chapter speedruns are included. Also added notifications (disable in settings) and a button to go straight to the level editor (in settings). Refined the practice mode to work better. ",
            },
            {
              v: "1.3",
              t: "Blockoverit Beats & Customization",
              d: "Added Blockoverit Beats, a way of customizing the main menu music. Included are multiple tracks, which are also used as background music for campaign levels and can be used as background music for custom levels. Also added for customization is full support for rising lava, moving blocks, and colored blocks, as well as spikes for a more visually appealing obstacle on a flat path. Added a update overview (this current interface). Also added the ability to specify a difficulty and add a description for custom levels. Reworked the interface for the custom levels menu to support these new features for sharing levels. Added a new 'Chapter Speedrun' mode. Fixed various bugs, including a deathrun bug that didn't keep track of the highscore. ",
            },
            {
              v: "1.2",
              t: "Zero Gravity Update",
              d: "Added Chapter 2 with zero gravity mechanics. Custom levels can now have a custom gravity. In addition, added two new modes: speedrun and deathrun, and added a settings menu. Added options in settings to change the blue coin style and add a camera to follow the player.",
            },
            {
              v: "1.1.1",
              t: "Custom Level Update",
              d: "Added support for custom levels and redesigned the interface. Blue coins were also redesigned.",
            },
            {
              v: "1.1",
              t: "Blue Coin Update",
              d: "Added Blue Coins, which are unlocked for a chapter when you beat the entire chapter. Added a main menu, completely redesigning the interface. This allows players to replay levels.",
            },
            {
              v: "1.0",
              t: "Initial Release",
              d: "Game launch with Chapter 1.",
            },
          ];

          updates.forEach((u) => {
            const row = document.createElement("div");
            row.style.marginBottom = "15px";
            row.style.borderBottom = "1px solid #333";
            row.style.paddingBottom = "10px";
            row.innerHTML = `
              <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:5px;">
                  <span style="color:#335699; font-weight:bold; font-size:1.2rem;">v${u.v}</span>
                  <span style="color:#888; font-size:0.8rem; text-transform:uppercase;">${u.t}</span>
              </div>
              <div style="color:#ccc; font-size:0.9rem; line-height:1.4;">${u.d}</div>
            `;
            newsContent.appendChild(row);
          });

          container.appendChild(newsContent);

          const btnBack = document.createElement("button");
          btnBack.className = "btn";
          btnBack.textContent = "BACK";
          btnBack.style.marginTop = "20px";
          btnBack.onclick = () => showMenu("main");
          container.appendChild(btnBack);
        } else if (view === "credits") {
          subtitle.textContent = "CREDITS";
          container.style.overflow = "hidden"; // Hide scrollbars for the effect

          const creditsContainer = document.createElement("div");
          creditsContainer.style.cssText =
            "width: 100%; height: 60vh; position: relative; overflow: hidden; mask-image: linear-gradient(to bottom, transparent 0%, black 10%, black 90%, transparent 100%); -webkit-mask-image: linear-gradient(to bottom, transparent 0%, black 10%, black 90%, transparent 100%);";

          const scrollContent = document.createElement("div");
          scrollContent.style.cssText =
            "position: absolute; width: 100%; text-align: center; animation: scrollCredits 20s linear infinite; top: 100%;";
          scrollContent.innerHTML = `
            <style>
              @keyframes scrollCredits {
                0% { transform: translateY(0); }
                100% { transform: translateY(-150%); }
              }
              .cred-role { color: #335699; font-weight: bold; font-size: 1.2rem; margin-top: 30px; margin-bottom: 5px; text-transform: uppercase; letter-spacing: 2px; }
              .cred-name { color: #fff; font-size: 1.5rem; font-weight: bold; margin-bottom: 10px; }
              .cred-list { color: #ccc; font-size: 1.1rem; line-height: 1.6; }
            </style>
            <div style="padding-bottom: 100px;">
              <div class="cred-role">Originally Created By</div>
              <div class="cred-name">Torgaar</div>
              <div class="cred-name">Abhay557</div>

              <div class="cred-role">Music</div>
              <div class="cred-list">
                Noah Mark Hansen<br>
                Noodlez Studios<br>
                Alex Grohl<br>
                Torgaar<br>
                Dmitrii Spis<br>
                Rasberry Music<br>
                DELOsound<br>
              </div>

              <div class="cred-role">Art & Skins</div>
              <div class="cred-list">
                Torgaar <br>
                Chairlord
                </div>

              <div class="cred-role">Cloud Data</div>
              <div class="cred-list">
                Supabase and AWS<br>
                </div>

                <div class="cred-role">Special Thanks</div>
              <div class="cred-list">
                The Blockoverit Discord Server <br>
                Every Player of Block Over It, for all the feedback given
                </div>

              <div class="cred-role">By Sellwood Studios</div>
              </div>
            </div>
          `;

          creditsContainer.appendChild(scrollContent);
          container.appendChild(creditsContainer);

          const btnBack = document.createElement("button");
          btnBack.className = "btn";
          btnBack.textContent = "BACK";
          btnBack.style.marginTop = "20px";
          btnBack.style.zIndex = "10";
          btnBack.onclick = () => showMenu("main");
          container.appendChild(btnBack);
        } else if (view === "beats-menu") {
          subtitle.textContent = "BLOCKOVERIT BEATS";

          // Progress Bar
          const progressContainer = document.createElement("div");
          progressContainer.className = "progress-container";
          progressContainer.innerHTML = `
              <div class="time-display" id="beats-curr-time">0:00</div>
              <div class="progress-bar-bg" id="beats-prog-bar">
                  <div class="progress-bar-fill" id="beats-prog-fill"></div>
              </div>
              <div class="time-display" id="beats-total-time">0:00</div>
          `;
          container.appendChild(progressContainer);

          // Seek functionality
          setTimeout(() => {
            const bar = document.getElementById("beats-prog-bar");
            if (bar) {
              bar.onclick = (e) => {
                if (currentAudio && currentAudio.duration) {
                  const rect = bar.getBoundingClientRect();
                  const pct = (e.clientX - rect.left) / rect.width;
                  currentAudio.currentTime = pct * currentAudio.duration;
                }
              };
            }
          }, 0);

          // Controls Row
          const controlsRow = document.createElement("div");
          controlsRow.className = "beats-controls";

          // Shuffle Button
          const shuffleBtn = document.createElement("button");
          shuffleBtn.className =
            "icon-btn" + (gameSettings.shuffleMusic ? " active" : "");
          shuffleBtn.title = "Shuffle";
          shuffleBtn.innerHTML = `<svg viewBox="0 0 24 24"><path d="M10.59 9.17L5.41 4 4 5.41l5.17 5.17 1.42-1.41zM14.5 4l2.04 2.04L4 18.59 5.41 20 17.96 7.46 20 9.5V4h-5.5zm.33 9.41l-1.41 1.41 3.13 3.13L14.5 20H20v-5.5l-2.04 2.04-3.13-3.13z"/></svg>`;
          shuffleBtn.onclick = () => {
            gameSettings.shuffleMusic = !gameSettings.shuffleMusic;
            saveSettings();
            showMenu("beats-menu");
          };

          // Pause/Play Button
          const pauseBtn = document.createElement("button");
          pauseBtn.className = "icon-btn";
          pauseBtn.id = "beats-play-pause-btn";
          pauseBtn.style.transform = "scale(1.2)";
          pauseBtn.title = isMusicPaused ? "Play" : "Pause";
          if (isMusicPaused) {
            pauseBtn.innerHTML = `<svg viewBox="0 0 24 24"><path d="M8 5v14l11-7z"/></svg>`;
          } else {
            pauseBtn.innerHTML = `<svg viewBox="0 0 24 24"><path d="M6 19h4V5H6v14zm8-14v14h4V5h-4z"/></svg>`;
          }
          pauseBtn.onclick = togglePause;

          controlsRow.appendChild(shuffleBtn);
          controlsRow.appendChild(pauseBtn);
          container.appendChild(controlsRow);

          const listContainer = document.createElement("div");
          listContainer.style.width = "100%";
          listContainer.style.display = "flex";
          listContainer.style.flexDirection = "column";
          listContainer.style.alignItems = "center";
          listContainer.style.gap = "10px";
          listContainer.style.maxHeight = "35vh";
          listContainer.style.overflowY = "auto";

          MUSIC_LIBRARY.forEach((track) => {
            const isPlaying = track.id === currentPlayingTrackId;
            const inPlaylist = gameSettings.playlist.includes(track.id);

            const row = document.createElement("div");
            row.className = "track-row" + (isPlaying ? " active" : "");
            row.style.justifyContent = "space-between";

            row.innerHTML = `
                    <div class="track-info">
                        <span class="track-title">${track.title} ${isPlaying && !isMusicPaused ? '<span style="font-size:0.7em; color:#4a4;">(PLAYING)</span>' : ""}</span>
                        <span class="track-artist">${track.artist}</span>
                    </div>
                    <div style="display:flex; gap:10px;">
                        <button class="btn btn-small" style="padding:5px 10px; font-size:0.8rem; ${inPlaylist ? "background:#335699;" : ""}" onclick="event.stopPropagation(); togglePlaylist('${track.id}')">
                            ${inPlaylist ? "IN LIST" : "ADD"}
                        </button>
                        <button class="btn btn-small" style="padding:5px 10px; font-size:0.8rem;" onclick="event.stopPropagation(); playMusic('${track.id}', true)">
                            PLAY
                        </button>
                    </div>
                `;
            listContainer.appendChild(row);
          });

          container.appendChild(listContainer);

          const btnBack = document.createElement("button");
          btnBack.className = "btn";
          btnBack.textContent = "BACK";
          btnBack.style.marginTop = "20px";
          btnBack.onclick = () => showMenu("main");
          container.appendChild(btnBack);

          // Start UI update loop
          if (beatsUpdateInterval) clearInterval(beatsUpdateInterval);
          beatsUpdateInterval = setInterval(updateBeatsUI, 500);
          updateBeatsUI(); // Initial call
        } else if (view === "other-modes") {
          subtitle.textContent = "OTHER MODES";

          const btnSpeed = document.createElement("button");
          btnSpeed.className = "btn";
          btnSpeed.textContent = "SPEEDRUN";
          btnSpeed.onclick = () => {
            currentGameMode = "speedrun";
            showMenu("source-select");
          };

          const btnDeath = document.createElement("button");
          btnDeath.className = "btn";
          btnDeath.textContent = "DEATHRUN";
          btnDeath.onclick = () => {
            currentGameMode = "deathrun";
            showMenu("source-select");
          };

          const btnChapterSpeed = document.createElement("button");
          btnChapterSpeed.className = "btn";
          btnChapterSpeed.textContent = "CHAPTER SPEEDRUN";
          btnChapterSpeed.onclick = () => {
            currentGameMode = "chapter_speedrun";
            showMenu("chapter-speedrun-select");
          };

          const btnPractice = document.createElement("button");
          btnPractice.className = "btn";
          btnPractice.textContent = "PRACTICE";
          btnPractice.onclick = () => {
            currentGameMode = "practice";
            showMenu("source-select");
          };

          container.appendChild(btnSpeed);
          container.appendChild(btnDeath);
          container.appendChild(btnChapterSpeed);
          container.appendChild(btnPractice);

          const btnBack = document.createElement("button");
          btnBack.className = "btn";
          btnBack.textContent = "BACK";
          btnBack.onclick = () => showMenu("main");
          container.appendChild(btnBack);
        } else if (view === "source-select") {
          subtitle.textContent = currentGameMode.toUpperCase() + " SOURCE";

          const btnCamp = document.createElement("button");
          btnCamp.className = "btn";
          btnCamp.textContent = "CAMPAIGN LEVELS";
          btnCamp.onclick = () => showMenu("campaign");

          const btnCust = document.createElement("button");
          btnCust.className = "btn";
          btnCust.textContent = "CUSTOM LEVELS";
          btnCust.onclick = () => {
            customMenuSource = "source-select";
            showMenu("custom");
          };

          const btnBack = document.createElement("button");
          btnBack.className = "btn";
          btnBack.textContent = "BACK";
          btnBack.onclick = () => {
            if (document.body.classList.contains("mobile-mode"))
              showMenu("mobile-gamemodes");
            else showMenu("other-modes");
          };

          container.appendChild(btnCamp);
          container.appendChild(btnCust);
          container.appendChild(btnBack);
        } else if (view === "account") {
          subtitle.textContent = currentUser.toUpperCase();

          const isMobile = document.body.classList.contains("mobile-mode");
          if (isMobile) {
            container.style.width = "100%";
            container.style.padding = "20px";
          } else {
            container.style.maxWidth = "1000px";
          }

          const closeBtn = document.createElement("button");
          closeBtn.className = "settings-close-btn";
          closeBtn.innerHTML = "&times;";
          closeBtn.style.top = "20px";
          closeBtn.onclick = () => showMenu("main");
          container.appendChild(closeBtn);

          // Stats Calculation
          let totalBlue = 0;
          Object.keys(gameState.levelBlueCoins).forEach((key) => {
            if (gameState.levelBlueCoins[key] && !key.startsWith("custom_")) {
              totalBlue++;
            }
          });

          // Stats Grid
          const statsDiv = document.createElement("div");
          statsDiv.style.cssText =
            "display:flex; gap:20px; justify-content:center; margin-bottom:30px; background: #1a1a1a; padding: 20px; border-radius: 12px; border: 1px solid #333;";
          statsDiv.innerHTML = `
            <div style="text-align:center;">
                <div style="font-size:0.9rem; color:#aaa; margin-bottom:5px;">COLLECTION</div>
                <div style="font-size:3.5rem; font-weight:bold; color:#335699; line-height:1;">${totalBlue}</div>
                <div style="font-size:0.8rem; color:#888; letter-spacing:1px;">BLUE COINS</div>
            </div>
          `;
          container.appendChild(statsDiv);

          const skinHeader = document.createElement("div");
          skinHeader.innerText = "MY SKINS";
          skinHeader.style.cssText =
            "color: #fff; font-weight: bold; font-size: 1.5rem; margin-top: 20px; border-bottom: 2px solid #333; padding-bottom: 10px; width: 100%; text-align: center; letter-spacing: 2px;";
          container.appendChild(skinHeader);

          renderSkinGrid(container, getAvailableSkins(), true);

          // Change Password Button
          const changePassBtn = document.createElement("button");
          changePassBtn.className = "btn";
          changePassBtn.textContent = "CHANGE PASSWORD";
          changePassBtn.style.cssText =
            "font-size: 1rem; padding: 15px; width: 100%; margin-top: 30px; background: #333; border: 1px solid #555;";
          changePassBtn.onclick = openChangePasswordModal;
          container.appendChild(changePassBtn);

          // Logout
          const logoutBtn = document.createElement("button");
          logoutBtn.className = "btn";
          logoutBtn.textContent = "LOG OUT";
          logoutBtn.style.cssText =
            "background: #a44; border-color: #822; width: 100%; margin-top: 10px; padding: 15px;";
          logoutBtn.onclick = () => {
            showConfirmPopup(
              "LOG OUT",
              "Are you sure you want to log out?",
              () => {
                currentUser = null;
                safeStorage.clear();
                location.reload();
              },
            );
          };
          container.appendChild(logoutBtn);
        } else if (view === "user-profile") {
          const data = context || {};

          if (data.loading) {
            container.innerHTML =
              "<div style='color:#888; font-size:1.5rem; margin-top:50px;'>Loading Profile...</div>";
            return;
          }

          subtitle.textContent = (data.username || "USER").toUpperCase();
          container.style.maxWidth = "800px";

          const closeBtn = document.createElement("button");
          closeBtn.className = "settings-close-btn";
          closeBtn.innerHTML = "&times;";
          closeBtn.style.top = "20px";
          closeBtn.onclick = () => showMenu("leaderboards-new");
          container.appendChild(closeBtn);

          const skinHeader = document.createElement("div");
          skinHeader.innerText = "SKINS COLLECTION";
          skinHeader.style.cssText =
            "color: #ccc; font-weight: bold; margin-top: 20px; border-bottom: 1px solid #333; padding-bottom: 5px; width: 100%;";
          container.appendChild(skinHeader);

          renderSkinGrid(container, data.skins || ["default"], false);
        } else if (view === "leaderboards-new") {
          subtitle.textContent = "LEADERBOARDS";

          const isMobile = document.body.classList.contains("mobile-mode");

          if (isMobile) {
            // Mobile Leaderboard UI
            container.style.padding = "0";
            container.style.width = "100%";

            const mobileContainer = document.createElement("div");
            mobileContainer.className = "mobile-leaderboard-container";
            mobileContainer.style.cssText =
              "width:100%; height:100%; display:flex; flex-direction:column; background:#111;";

            // Header Controls
            const header = document.createElement("div");
            header.className = "mobile-leaderboard-header";
            header.style.cssText =
              "padding:15px; background:#222; border-bottom:1px solid #333; display:flex; flex-direction:column; gap:10px; flex-shrink: 0;";

            const row1 = document.createElement("div");
            row1.style.display = "flex";
            row1.style.gap = "10px";

            const modeSelect = document.createElement("select");
            modeSelect.style.cssText =
              "flex:1; padding:10px; background:#333; color:white; border:1px solid #555; border-radius:4px;";
            ["Speedrun", "Deathrun", "Chapter Speedrun"].forEach((m) => {
              const opt = document.createElement("option");
              opt.value = m.toLowerCase().replace(" ", "_");
              opt.text = m;
              modeSelect.appendChild(opt);
            });

            const chapSelect = document.createElement("select");
            chapSelect.style.cssText =
              "flex:1; padding:10px; background:#333; color:white; border:1px solid #555; border-radius:4px;";
            [1, 2, 3].forEach((c) => {
              const opt = document.createElement("option");
              opt.value = c;
              opt.text = "Ch " + c;
              chapSelect.appendChild(opt);
            });

            row1.appendChild(modeSelect);
            row1.appendChild(chapSelect);

            const row2 = document.createElement("div");
            row2.style.display = "flex";
            row2.style.gap = "10px";

            const levelSelect = document.createElement("select");
            levelSelect.style.cssText =
              "flex:1; padding:10px; background:#333; color:white; border:1px solid #555; border-radius:4px;";

            const catSelect = document.createElement("select");
            catSelect.style.cssText =
              "flex:1; padding:10px; background:#333; color:white; border:1px solid #555; border-radius:4px;";
            catSelect.innerHTML =
              '<option value="any">Any%</option><option value="blue">Blue Coin</option>';

            row2.appendChild(levelSelect);
            row2.appendChild(catSelect);

            header.appendChild(row1);
            header.appendChild(row2);

            // List
            const list = document.createElement("div");
            list.style.cssText = "flex:1; overflow-y:auto; padding:10px;";
            list.innerHTML =
              "<div style='text-align:center; color:#666; margin-top:20px;'>Loading...</div>";

            const updateLevels = () => {
              levelSelect.innerHTML = "";
              const ch = parseInt(chapSelect.value);
              const levels =
                ch === 1 ? CHAPTER_1 : ch === 2 ? CHAPTER_2 : CHAPTER_3;

              if (modeSelect.value === "chapter_speedrun") {
                levelSelect.style.display = "none";
                levelSelect.disabled = true;
              } else {
                levelSelect.style.display = "block";
                levelSelect.disabled = false;
                levels.forEach((_, i) => {
                  const opt = document.createElement("option");
                  opt.value = i;
                  opt.text = "Level " + (i + 1);
                  levelSelect.appendChild(opt);
                });
              }

              if (
                modeSelect.value === "deathrun" ||
                modeSelect.value === "chapter_speedrun"
              ) {
                catSelect.style.display = "none";
              } else {
                catSelect.style.display = "block";
              }
              fetchScores();
            };

            const fetchScores = async () => {
              list.innerHTML =
                "<div style='text-align:center; color:#666; margin-top:20px;'>Loading...</div>";
              const mode = modeSelect.value;
              const ch = parseInt(chapSelect.value);
              const lvlIdx = parseInt(levelSelect.value);
              const cat = catSelect.value;

              let key = "";
              let prefix = "";
              if (mode === "speedrun") prefix = "speedrun_";
              else if (mode === "deathrun") prefix = "deathrun_";
              else if (mode === "chapter_speedrun")
                key = `chapter_speedrun_${ch}`;

              if (!key) {
                if (cat === "blue" && mode !== "deathrun") prefix += "blue_";
                key = `${prefix}campaign_${ch}_${lvlIdx}`;
              }

              const scores = await fetchLevelLeaderboard(key, 10);
              if (scores.length === 0) {
                list.innerHTML =
                  "<div style='text-align:center; color:#666; margin-top:20px;'>No records found.</div>";
              } else {
                list.innerHTML = scores
                  .map((s, i) => {
                    const t = s.time_ms;
                    const ms = String(t % 1000).padStart(3, "0");
                    const sec = String(Math.floor(t / 1000) % 60).padStart(
                      2,
                      "0",
                    );
                    const min = String(Math.floor(t / 60000)).padStart(2, "0");
                    const isMe = s.username === currentUser;
                    return `
                      <div style="background:${isMe ? "#1a2a40" : "#222"}; padding:15px; margin-bottom:8px; border-radius:8px; border:1px solid ${isMe ? "#335699" : "#333"}; display:flex; justify-content:space-between; align-items:center;">
                        <div style="display:flex; align-items:center; gap:10px;">
                            <span style="font-size:1.2rem; font-weight:bold; color:#666; width:25px;">${i + 1}</span>
                            <span style="font-weight:bold; color:${isMe ? "#fff" : "#ccc"}; cursor:pointer; text-decoration:underline;" onclick="openUserProfile('${s.username}')">${s.username}</span>
                        </div>
                        <span style="font-family:monospace; font-size:1.1rem; color:#fff;">${min}:${sec}.${ms}</span>
                      </div>
                      `;
                  })
                  .join("");
              }
            };

            modeSelect.onchange = updateLevels;
            chapSelect.onchange = updateLevels;
            levelSelect.onchange = fetchScores;
            catSelect.onchange = fetchScores;

            mobileContainer.appendChild(header);
            mobileContainer.appendChild(list);

            // Back Button Floating
            const backBtn = document.createElement("button");
            backBtn.className = "btn";
            backBtn.textContent = "BACK";
            backBtn.style.cssText =
              "position:fixed; bottom:20px; left:50%; transform:translateX(-50%); width:80%; max-width:300px; box-shadow:0 4px 10px rgba(0,0,0,0.5); z-index:100;";
            backBtn.onclick = () => showMenu("main");
            mobileContainer.appendChild(backBtn);

            container.appendChild(mobileContainer);
            updateLevels();
            return;
          }

          // Controls Container
          const controls = document.createElement("div");
          controls.style.display = "flex";
          controls.style.flexWrap = "wrap";
          controls.style.gap = "10px";
          controls.style.justifyContent = "center";
          controls.style.marginBottom = "20px";
          controls.style.width = "100%";

          document.getElementById("leaderboard-notif").style.display = "none";

          // Mode Selector
          const modeSelect = document.createElement("select");
          modeSelect.style.padding = "10px";
          modeSelect.style.background = "#333";
          modeSelect.style.color = "white";
          modeSelect.style.border = "1px solid #555";
          ["Speedrun", "Deathrun", "Chapter Speedrun"].forEach((m) => {
            const opt = document.createElement("option");
            opt.value = m.toLowerCase().replace(" ", "_");
            opt.text = m;
            modeSelect.appendChild(opt);
          });

          // Chapter Selector
          const chapSelect = document.createElement("select");
          chapSelect.style.padding = "10px";
          chapSelect.style.background = "#333";
          chapSelect.style.color = "white";
          chapSelect.style.border = "1px solid #555";
          [1, 2, 3].forEach((c) => {
            const opt = document.createElement("option");
            opt.value = c;
            opt.text = "Chapter " + c;
            chapSelect.appendChild(opt);
          });

          // Level Selector
          const levelSelect = document.createElement("select");
          levelSelect.style.padding = "10px";
          levelSelect.style.background = "#333";
          levelSelect.style.color = "white";
          levelSelect.style.border = "1px solid #555";

          // Category Selector (Any% / Blue Coin)
          const catSelect = document.createElement("select");
          catSelect.style.padding = "10px";
          catSelect.style.background = "#333";
          catSelect.style.color = "white";
          catSelect.style.border = "1px solid #555";
          const optAny = document.createElement("option");
          optAny.value = "any";
          optAny.text = "Any%";
          const optBlue = document.createElement("option");
          optBlue.value = "blue";
          optBlue.text = "Blue Coin";
          catSelect.appendChild(optAny);
          catSelect.appendChild(optBlue);

          // Results Container
          const resultsDiv = document.createElement("div");
          resultsDiv.style.width = "100%";
          resultsDiv.style.maxWidth = "600px";
          resultsDiv.style.background = "#222";
          resultsDiv.style.border = "1px solid #444";
          resultsDiv.style.padding = "15px";
          resultsDiv.style.minHeight = "200px";
          resultsDiv.style.maxHeight = "40vh";
          resultsDiv.style.overflowY = "auto";
          resultsDiv.innerHTML =
            "<div style='text-align:center; color:#888;'>Select options to view scores</div>";

          const updateLevels = () => {
            levelSelect.innerHTML = "";
            const ch = parseInt(chapSelect.value);
            const levels =
              ch === 1 ? CHAPTER_1 : ch === 2 ? CHAPTER_2 : CHAPTER_3;

            if (modeSelect.value === "chapter_speedrun") {
              levelSelect.style.display = "none";
            } else {
              levelSelect.style.display = "block";
              levels.forEach((_, i) => {
                const opt = document.createElement("option");
                opt.value = i;
                opt.text = "Level " + (i + 1);
                levelSelect.appendChild(opt);
              });
            }

            if (
              modeSelect.value === "deathrun" ||
              modeSelect.value === "chapter_speedrun"
            ) {
              catSelect.style.display = "none";
            } else {
              catSelect.style.display = "block";
            }
            fetchScores();
          };

          const fetchScores = async () => {
            resultsDiv.innerHTML =
              "<div style='text-align:center; color:#888;'>Loading...</div>";
            const mode = modeSelect.value;
            const ch = parseInt(chapSelect.value);
            const lvlIdx = parseInt(levelSelect.value);
            const cat = catSelect.value;

            // Construct key
            let key = "";
            let prefix = "";
            if (mode === "speedrun") prefix = "speedrun_";
            else if (mode === "deathrun") prefix = "deathrun_";
            else if (mode === "chapter_speedrun") {
              key = `chapter_speedrun_${ch}`;
            }

            if (!key) {
              if (cat === "blue" && mode !== "deathrun") prefix += "blue_";
              key = `${prefix}campaign_${ch}_${lvlIdx}`;
            }

            const scores = await fetchLevelLeaderboard(key, 100);
            if (scores.length === 0) {
              resultsDiv.innerHTML =
                "<div style='text-align:center; color:#888;'>No records found.</div>";
            } else {
              resultsDiv.innerHTML = scores
                .map((s, i) => {
                  const t = s.time_ms;
                  const ms = String(t % 1000).padStart(3, "0");
                  const sec = String(Math.floor(t / 1000) % 60).padStart(
                    2,
                    "0",
                  );
                  const min = String(Math.floor(t / 60000)).padStart(2, "0");
                  return `
                  <div style="display:flex; justify-content:space-between; padding:8px; border-bottom:1px solid #333; ${s.username === currentUser ? "color:#335699; font-weight:bold;" : "color:#ccc;"}">
                    <span>${i + 1}. <span style="cursor:pointer; text-decoration:underline;" onclick="openUserProfile('${s.username}')">${s.username}</span></span>
                    <span style="font-family:monospace;">${min}:${sec}.${ms}</span>
                  </div>
                `;
                })
                .join("");
            }
          };

          modeSelect.onchange = updateLevels;
          chapSelect.onchange = updateLevels;
          levelSelect.onchange = fetchScores;
          catSelect.onchange = fetchScores;

          controls.appendChild(modeSelect);
          controls.appendChild(chapSelect);
          controls.appendChild(levelSelect);
          controls.appendChild(catSelect);

          const refreshBtn = document.createElement("button");
          refreshBtn.className = "btn";
          refreshBtn.innerHTML = "&#x21bb;"; // Refresh icon
          refreshBtn.style.padding = "10px";
          refreshBtn.style.minWidth = "auto";
          refreshBtn.title = "Refresh";
          refreshBtn.onclick = fetchScores;
          controls.appendChild(refreshBtn);

          const btnBack = document.createElement("button");
          btnBack.className = "btn";
          btnBack.textContent = "BACK";
          btnBack.style.marginTop = "20px";
          btnBack.onclick = () => showMenu("main");

          container.appendChild(controls);
          container.appendChild(resultsDiv);
          container.appendChild(btnBack);

          // Init
          updateLevels();
        } else if (view === "chapter-speedrun-select") {
          subtitle.textContent = "SELECT CHAPTER";

          const startChapterRun = (ch) => {
            gameTimerStart = 0; // Ensure fresh start
            let data =
              ch === 1 ? CHAPTER_1[0] : ch === 2 ? CHAPTER_2[0] : CHAPTER_3[0];
            startGameLevel(data, 0, "campaign", ch);
          };

          const btnCh1 = document.createElement("button");
          btnCh1.className = "btn";
          btnCh1.textContent = "Chapter I";
          btnCh1.onclick = () => startChapterRun(1);

          const btnCh2 = document.createElement("button");
          btnCh2.className = "btn";
          btnCh2.textContent = "Chapter II";
          if (!gameState.chapter1Beaten) btnCh2.disabled = true;
          btnCh2.onclick = () => startChapterRun(2);

          const btnCh3 = document.createElement("button");
          // btnCh3.className = "btn";
          // btnCh3.textContent = "Chapter III";
          // if (!gameState.chapter2Beaten) btnCh3.disabled = true;
          // btnCh3.onclick = () => startChapterRun(3);

          const btnBack = document.createElement("button");
          btnBack.className = "btn";
          btnBack.textContent = "Back";
          btnBack.onclick = () => {
            if (document.body.classList.contains("mobile-mode"))
              showMenu("mobile-gamemodes");
            else showMenu("other-modes");
          };

          container.appendChild(btnCh1);
          container.appendChild(btnCh2);
          // container.appendChild(btnCh3); // Removed Chapter 3 Speedrun
          container.appendChild(btnBack);
        } else if (view === "campaign") {
          subtitle.textContent = "Select Chapter";

          const btnCh1 = document.createElement("button");
          btnCh1.className = "btn";
          btnCh1.textContent = "Chapter I";
          btnCh1.onclick = () => showMenu("chapter1");

          const btnCh2 = document.createElement("button");
          btnCh2.className = "btn";
          btnCh2.textContent = "Chapter II";
          btnCh2.onclick = () => showMenu("chapter2");

          const btnCh3 = document.createElement("button");
          btnCh3.className = "btn";
          btnCh3.textContent = "Chapter III";
          btnCh3.disabled = true;
          btnCh3.onclick = () => showMenu("chapter3");

          const btnBack = document.createElement("button");
          btnBack.className = "btn";
          btnBack.textContent = "Back";
          btnBack.onclick = () => {
            if (
              currentGameMode === "speedrun" ||
              currentGameMode === "chapter_speedrun" ||
              currentGameMode === "deathrun" ||
              currentGameMode === "practice"
            )
              showMenu("source-select");
            else if (document.body.classList.contains("mobile-mode"))
              showMenu("mobile-gamemodes");
            else showMenu("main");
          };

          container.appendChild(btnCh1);
          container.appendChild(btnCh2);
          container.appendChild(btnCh3);
          container.appendChild(btnBack);
        } else if (view === "chapter1") {
          subtitle.textContent = "Chapter I";

          const grid = document.createElement("div");
          grid.className = "level-grid";

          CHAPTER_1.forEach((levelData, index) => {
            var btn = document.createElement("button");
            btn.className = "btn level-btn";
            btn.textContent = index + 1;

            var badge = document.createElement("div");
            badge.className = "coin-badge";
            if (gameState.levelBlueCoins[index]) badge.style.display = "block";
            btn.appendChild(badge);

            if (index > gameState.unlockedLevel && !gameState.chapter1Beaten) {
              btn.disabled = true;
            } else {
              btn.onclick = () =>
                startGameLevel(levelData, index, "campaign", 1);
            }
            grid.appendChild(btn);
          });

          const btnBack = document.createElement("button");
          btnBack.className = "btn";
          btnBack.textContent = "Back";
          btnBack.onclick = () => showMenu("campaign");

          container.appendChild(grid);
          container.appendChild(btnBack);
        } else if (view === "chapter2") {
          subtitle.textContent = "Chapter II";

          const grid = document.createElement("div");
          grid.className = "level-grid";

          CHAPTER_2.forEach((levelData, index) => {
            var btn = document.createElement("button");
            btn.className = "btn level-btn";
            btn.textContent = index + 1;

            var badge = document.createElement("div");
            badge.className = "coin-badge";
            if (gameState.levelBlueCoins[`ch2_${index}`])
              badge.style.display = "block";
            btn.appendChild(badge);

            if (!gameState.chapter1Beaten) {
              btn.disabled = true;
            } else if (
              index > gameState.unlockedLevelCh2 &&
              !gameState.chapter2Beaten
            ) {
              btn.disabled = true;
            } else {
              btn.onclick = () =>
                startGameLevel(levelData, index, "campaign", 2);
            }
            grid.appendChild(btn);
          });

          const btnBack = document.createElement("button");
          btnBack.className = "btn";
          btnBack.textContent = "Back";
          btnBack.onclick = () => showMenu("campaign");

          container.appendChild(grid);
          container.appendChild(btnBack);
        } else if (view === "chapter3") {
          subtitle.textContent = "Chapter III";

          const grid = document.createElement("div");
          grid.className = "level-grid";

          CHAPTER_3.forEach((levelData, index) => {
            var btn = document.createElement("button");
            btn.className = "btn level-btn";
            btn.textContent = index + 1;

            var badge = document.createElement("div");
            badge.className = "coin-badge";
            if (gameState.levelBlueCoins[`ch3_${index}`])
              badge.style.display = "block";
            btn.appendChild(badge);

            if (!gameState.chapter2Beaten) {
              btn.disabled = true;
            } else if (
              index > gameState.unlockedLevelCh3 &&
              !gameState.chapter3Beaten
            ) {
              btn.disabled = true;
            } else {
              btn.onclick = () =>
                startGameLevel(levelData, index, "campaign", 3);
            }
            grid.appendChild(btn);
          });

          const btnBack = document.createElement("button");
          btnBack.className = "btn";
          btnBack.textContent = "Back";
          btnBack.onclick = () => showMenu("campaign");

          container.appendChild(grid);
          container.appendChild(btnBack);
        } else if (view === "custom") {
          subtitle.textContent = "Custom Levels";

          // Reset mode if coming from main menu (fixes getting stuck in speedrun mode)
          if (customMenuSource === "main") {
            currentGameMode = "custom";
          }

          // Mobile Landscape Optimization for Custom Levels
          if (document.body.classList.contains("mobile-mode")) {
            container.style.flexDirection = "row";
            container.style.flexWrap = "wrap";
            container.style.justifyContent = "center";
          }

          // List existing custom levels
          if (customLevels.length === 0) {
            const emptyMsg = document.createElement("div");
            emptyMsg.textContent = "No levels uploaded.";
            emptyMsg.style.color = "#888";
            container.appendChild(emptyMsg);
          } else {
            customLevels.forEach((lvl, idx) => {
              const row = document.createElement("div");
              row.className = "custom-level-row";
              row.style.cursor = "pointer";
              row.onclick = () => {
                openCustomLevelPopup(idx);
              };

              // Get level dimensions
              const levelWidth = lvl.plan[0]?.length || 0;
              const levelHeight = lvl.plan?.length || 0;
              const isBeaten = customLevelsProgress[idx] || false;
              const hasBlueCoins =
                gameState.levelBlueCoins[`custom_${idx}`] || false;

              // Info section
              const infoDiv = document.createElement("div");
              infoDiv.className = "custom-level-info";

              const nameEl = document.createElement("div");
              nameEl.className = "custom-level-name";
              nameEl.textContent = lvl.name || `Custom Level ${idx + 1}`;

              const detailsEl = document.createElement("div");
              detailsEl.className = "custom-level-details";
              detailsEl.innerHTML = `
                      <div class="custom-level-detail-item">[${levelWidth}x${levelHeight}]</div>
                    `;

              // Status section
              const statusDiv = document.createElement("div");
              statusDiv.className = "custom-level-status";
              if (isBeaten) {
                const beatenBadge = document.createElement("div");
                beatenBadge.className = "status-badge status-beaten";
                beatenBadge.textContent = " BEATEN";
                statusDiv.appendChild(beatenBadge);
              }
              if (hasBlueCoins) {
                const blueCoinBadge = document.createElement("div");
                blueCoinBadge.className = "status-badge status-blue-coin";
                blueCoinBadge.textContent = " BLUE COIN";
                statusDiv.appendChild(blueCoinBadge);
              }

              infoDiv.appendChild(nameEl);
              infoDiv.appendChild(detailsEl);
              infoDiv.appendChild(statusDiv);

              // Actions section
              const actionsDiv = document.createElement("div");
              actionsDiv.className = "custom-level-actions";

              const delBtn = document.createElement("button");
              delBtn.className = "btn";
              delBtn.textContent = "DELETE";
              delBtn.style.background = "#a44";
              delBtn.style.border = "2px solid #822";
              delBtn.style.padding = "8px 16px";
              delBtn.style.minWidth = "80px";
              delBtn.style.fontSize = "0.9rem";
              delBtn.onclick = (e) => {
                e.stopPropagation();
                const doDelete = () => {
                  // Shift Custom Levels Progress
                  const newProgress = {};
                  Object.keys(customLevelsProgress).forEach((k) => {
                    const kIdx = parseInt(k);
                    if (kIdx < idx) {
                      newProgress[k] = customLevelsProgress[k];
                    } else if (kIdx > idx) {
                      newProgress[kIdx - 1] = customLevelsProgress[k];
                    }
                  });
                  customLevelsProgress = newProgress;
                  saveCustomLevelsProgress();

                  // Shift Blue Coins
                  const newBlueCoins = {};
                  Object.keys(gameState.levelBlueCoins).forEach((k) => {
                    if (k.startsWith("custom_")) {
                      const kIdx = parseInt(k.replace("custom_", ""));
                      if (!isNaN(kIdx)) {
                        if (kIdx < idx) {
                          newBlueCoins[k] = gameState.levelBlueCoins[k];
                        } else if (kIdx > idx) {
                          newBlueCoins[`custom_${kIdx - 1}`] =
                            gameState.levelBlueCoins[k];
                        }
                      } else {
                        newBlueCoins[k] = gameState.levelBlueCoins[k];
                      }
                    } else {
                      newBlueCoins[k] = gameState.levelBlueCoins[k];
                    }
                  });
                  gameState.levelBlueCoins = newBlueCoins;
                  saveGame();

                  // Shift Highscores
                  const newHighscores = {};
                  Object.keys(highscores).forEach((k) => {
                    if (k.includes("custom_")) {
                      const suffix = k.substring(k.lastIndexOf("_") + 1);
                      const kIdx = parseInt(suffix);
                      if (!isNaN(kIdx) && k.endsWith(`custom_${kIdx}`)) {
                        if (kIdx < idx) {
                          newHighscores[k] = highscores[k];
                        } else if (kIdx > idx) {
                          const prefix = k.substring(0, k.lastIndexOf("_") + 1);
                          newHighscores[`${prefix}${kIdx - 1}`] = highscores[k];
                        }
                        return;
                      }
                    }
                    newHighscores[k] = highscores[k];
                  });
                  highscores = newHighscores;
                  saveHighscores();

                  customLevels.splice(idx, 1);
                  saveCustomLevels();
                  showMenu("custom");
                };

                if (gameSettings.confirmDelete) {
                  showConfirmPopup(
                    "DELETE LEVEL",
                    `Are you sure you want to delete "${
                      lvl.name || "Custom Level " + (idx + 1)
                    }"?`,
                    doDelete,
                  );
                } else {
                  doDelete();
                }
              };

              actionsDiv.appendChild(delBtn);

              row.appendChild(infoDiv);
              row.appendChild(actionsDiv);
              container.appendChild(row);
            });
          }

          // Add Level Button logic
          const controlsDiv = document.createElement("div");
          controlsDiv.style.cssText =
            "width:100%; display:flex; justify-content:center; gap:10px; flex-wrap:wrap; margin-top:20px;";

          const label = document.createElement("label");
          label.className = "file-label";
          label.textContent = "+ Add Level (.json)";
          label.htmlFor = "file-input";
          const btnBack = document.createElement("button");
          btnBack.className = "btn";
          btnBack.textContent = "Back";
          btnBack.style.marginTop = "0"; // Reset margin for flex
          btnBack.onclick = () => {
            if (customMenuSource === "source-select") showMenu("source-select");
            else if (document.body.classList.contains("mobile-mode"))
              showMenu("main");
            else showMenu("main");
          };

          controlsDiv.appendChild(label);
          controlsDiv.appendChild(btnBack);
          container.appendChild(controlsDiv);
        } else if (view === "level-awards") {
          subtitle.textContent = "LEVEL AWARDS";
          container.style.maxWidth = "800px";

          const list = document.createElement("div");
          list.style.cssText =
            "width:100%; display:flex; flex-direction:column; gap:20px; max-height:60vh; overflow-y:auto; padding-right: 10px;";
          list.innerHTML =
            "<div style='text-align:center; color:#888;'>Loading awards...</div>";
          container.appendChild(list);

          const btnBack = document.createElement("button");
          btnBack.className = "btn";
          btnBack.textContent = "BACK";
          btnBack.style.marginTop = "20px";
          btnBack.onclick = () => showMenu("main");
          container.appendChild(btnBack);

          if (_supabase) {
            _supabase
              .from("level_awards")
              .select("*")
              .order("created_at", { ascending: false })
              .then(({ data, error }) => {
                if (error) {
                  console.error("Error fetching awards:", error);
                  list.innerHTML =
                    "<div style='text-align:center; color:#a44;'>Failed to load awards.</div>";
                } else if (!data || data.length === 0) {
                  list.innerHTML =
                    "<div style='text-align:center; color:#888;'>No awards available.</div>";
                } else {
                  list.innerHTML = "";
                  data.forEach((group) => {
                    const groupEl = document.createElement("div");
                    groupEl.style.cssText =
                      "background:#1a1a1a; border:2px solid #333; border-radius:8px; padding:15px; display:flex; flex-direction:column; gap:10px;";

                    const title = document.createElement("div");
                    title.style.cssText =
                      "font-size:1.2rem; font-weight:bold; color:#335699; text-transform:uppercase; border-bottom:1px solid #333; padding-bottom:5px; margin-bottom:5px;";
                    title.textContent = group.title || "Award Event";
                    groupEl.appendChild(title);

                    const places = [
                      {
                        label: "1ST PLACE",
                        color: "#ffd700",
                        data: group.level1,
                      },
                      {
                        label: "2ND PLACE",
                        color: "#c0c0c0",
                        data: group.level2,
                      },
                      {
                        label: "3RD PLACE",
                        color: "#cd7f32",
                        data: group.level3,
                      },
                    ];

                    places.forEach((p) => {
                      if (!p.data) return;
                      let lvl = p.data;
                      if (typeof lvl === "string") {
                        try {
                          lvl = JSON.parse(lvl);
                        } catch (e) {
                          return;
                        }
                      }

                      const row = document.createElement("div");
                      row.style.cssText =
                        "display:flex; align-items:center; justify-content:space-between; background:#222; padding:10px; border-radius:4px; border-left: 4px solid " +
                        p.color;

                      const info = document.createElement("div");
                      info.innerHTML = `
                        <div style="font-size:0.7rem; color:${p.color}; font-weight:bold;">${p.label}</div>
                        <div style="font-size:1rem; font-weight:bold; color:#fff;">${lvl.name || "Unknown Level"}</div>
                        <div style="font-size:0.8rem; color:#888;">by ${lvl.creator || "Anonymous"}</div>
                    `;

                      const btnGroup = document.createElement("div");
                      btnGroup.style.display = "flex";
                      btnGroup.style.gap = "5px";

                      const infoBtn = document.createElement("button");
                      infoBtn.className = "btn";
                      infoBtn.style.cssText =
                        "padding:5px 15px; font-size:0.8rem; min-width:auto; background:#555; border-color:#777;";
                      infoBtn.textContent = "INFO";
                      infoBtn.onclick = () => openAwardLevelPopup(lvl);

                      const playBtn = document.createElement("button");
                      playBtn.className = "btn";
                      playBtn.style.cssText =
                        "padding:5px 15px; font-size:0.8rem; min-width:auto; background:#335699; border-color:#5588cc;";
                      playBtn.textContent = "PLAY";
                      playBtn.onclick = () => {
                        currentGameMode = "custom";
                        startGameLevel(lvl, -1, "custom");
                      };

                      btnGroup.appendChild(infoBtn);
                      btnGroup.appendChild(playBtn);

                      row.appendChild(info);
                      row.appendChild(btnGroup);
                      groupEl.appendChild(row);
                    });

                    list.appendChild(groupEl);
                  });
                }
              });
          } else {
            list.innerHTML =
              "<div style='text-align:center; color:#888;'>Supabase not configured.</div>";
          }
        }
      }

      function updateBeatsUI() {
        if (currentMenuView !== "beats-menu") return;

        // Update List Highlights
        const rows = document.querySelectorAll(".track-row");
        rows.forEach((row, index) => {
          const track = MUSIC_LIBRARY[index];
          const isPlaying = track.id === currentPlayingTrackId;
          if (isPlaying) row.classList.add("active");
          else row.classList.remove("active");

          const titleEl = row.querySelector(".track-title");
          if (titleEl) {
            titleEl.innerHTML = `${track.title} ${isPlaying && !isMusicPaused ? '<span style="font-size:0.7em; color:#4a4;">(PLAYING)</span>' : ""}`;
          }
        });

        // Update Progress Bar
        const currEl = document.getElementById("beats-curr-time");
        const totalEl = document.getElementById("beats-total-time");
        const fillEl = document.getElementById("beats-prog-fill");

        if (currentAudio && !isNaN(currentAudio.duration)) {
          const curr = currentAudio.currentTime;
          const dur = currentAudio.duration;

          const fmt = (t) => {
            const m = Math.floor(t / 60);
            const s = Math.floor(t % 60)
              .toString()
              .padStart(2, "0");
            return `${m}:${s}`;
          };

          if (currEl) currEl.textContent = fmt(curr);
          if (totalEl) totalEl.textContent = fmt(dur);
          if (fillEl) fillEl.style.width = (curr / dur) * 100 + "%";
        } else {
          if (currentPlayingTrackId === "synth" && bgmOscillator) {
            const duration = 60; // 1 minute
            const elapsed = (Date.now() - synthStartTime) / 1000;
            const curr = Math.min(elapsed, duration);

            const fmt = (t) => {
              const m = Math.floor(t / 60);
              const s = Math.floor(t % 60)
                .toString()
                .padStart(2, "0");
              return `${m}:${s}`;
            };

            if (currEl) currEl.textContent = fmt(curr);
            if (totalEl) totalEl.textContent = fmt(duration);
            if (fillEl) fillEl.style.width = (curr / duration) * 100 + "%";
            return;
          }
          if (currEl) currEl.textContent = "0:00";
          if (totalEl) totalEl.textContent = "0:00";
          if (fillEl) fillEl.style.width = "0%";
        }

        // Update Play/Pause Button State
        const btn = document.getElementById("beats-play-pause-btn");
        if (btn) {
          if (isMusicPaused) {
            btn.innerHTML = `<svg viewBox="0 0 24 24"><path d="M8 5v14l11-7z"/></svg>`;
          } else {
            btn.innerHTML = `<svg viewBox="0 0 24 24"><path d="M6 19h4V5H6v14zm8-14v14h4V5h-4z"/></svg>`;
          }
        }
      }

      function showCredits() {
        showMenu("credits");
      }

      // --- File Upload Handling ---
      document
        .getElementById("file-input")
        .addEventListener("change", function (e) {
          const file = e.target.files[0];
          if (!file) return;

          const reader = new FileReader();
          reader.onload = function (e) {
            try {
              const lvl = JSON.parse(e.target.result);
              if (!lvl.plan || !Array.isArray(lvl.plan)) {
                showPopup(
                  "INVALID FORMAT",
                  "Level must contain a 'plan' array.",
                  () => {},
                );
                return;
              }
              // Default name if missing
              if (!lvl.name) lvl.name = file.name.replace(".json", "");

              customLevels.push(lvl);
              saveCustomLevels();
              showMenu("custom"); // refresh
            } catch (err) {
              showPopup("ERROR", "Failed to parse JSON file. ", () => {});
            }
          };
          reader.readAsText(file);
          // clear input so we can select same file again if needed
          e.target.value = "";
        });

      window.togglePlaylist = function (id) {
        const idx = gameSettings.playlist.indexOf(id);
        if (idx === -1) gameSettings.playlist.push(id);
        else gameSettings.playlist.splice(idx, 1);
        saveSettings();
        showMenu("beats-menu");
      };

      // --- Auth UI ---
      function openLoginModal() {
        const html = `
          <div style="display:flex; flex-direction:column; gap:10px;">
            <input id="auth-user" placeholder="Username" style="padding:10px; background:#333; color:white; border:1px solid #555;">
            <input id="auth-pass" type="password" placeholder="Password" style="padding:10px; background:#333; color:white; border:1px solid #555;">
            <div style="display:flex; gap:10px; justify-content:center; margin-top:10px;">
              <button class="btn" style="font-size:1rem; padding:10px;" onclick="handleAuth('signin', document.getElementById('auth-user').value, document.getElementById('auth-pass').value); document.querySelector('.popup-overlay').remove()">Sign In</button>
              <button class="btn" style="font-size:1rem; padding:10px;" onclick="handleAuth('signup', document.getElementById('auth-user').value, document.getElementById('auth-pass').value); document.querySelector('.popup-overlay').remove()">Sign Up</button>
            </div>
          </div>
        `;
        showPopup("ACCOUNT", "", () => {});
        const msgEl = document.querySelector(".popup-message");
        if (msgEl) msgEl.innerHTML = html;
        const okBtn = document.querySelector(".popup-buttons");
        if (okBtn) okBtn.style.display = "none";
      }

      function openAccountModal() {
        if (!currentUser) return openLoginModal();
        showMenu("account");
      }

      // Check for auto-login
      const savedUser = safeStorage.getItem("blockoverit_username");
      if (savedUser) {
        currentUser = savedUser;
        updateLoginButton();
        fetchAndSyncUserData();
      } else {
        if (!safeStorage.getItem("hasSeenLoginPrompt")) {
          safeStorage.setItem("hasSeenLoginPrompt", "true");
          setTimeout(() => {
            showConfirmPopup(
              "Cloud Save",
              "Do you want to sign in to save your progress to the cloud?",
              () => openLoginModal(),
              () => {},
            );
          }, 1000);
        }
      }

      // --- Intro Sequence ---
      function playIntro() {
        const layer = document.getElementById("intro-layer");
        const sellwood = document.getElementById("intro-sellwood");
        const container = document.getElementById("intro-anim-container");
        const cube = document.getElementById("intro-cube");
        const title = document.getElementById("intro-title-text");

        layer.style.display = "flex";

        // Sequence
        setTimeout(() => {
          sellwood.style.opacity = 1;
        }, 100);
        setTimeout(() => {
          sellwood.style.opacity = 0;
        }, 2500);

        setTimeout(() => {
          sellwood.style.display = "none";
          container.style.display = "flex";

          // Cube Fall
          cube.animate(
            [
              { top: "-100px", transform: "translateX(-50%) rotate(0deg)" },
              { top: "50%", transform: "translateX(-50%) rotate(360deg)" },
            ],
            {
              duration: 800,
              easing: "cubic-bezier(0.6, 0.04, 0.98, 0.335)",
              fill: "forwards",
            },
          );

          setTimeout(() => {
            // Impact & Title Reveal
            cube.style.display = "none";
            title.style.opacity = 1;
            title.style.transform = "scale(1)";

            // Shake effect
            container.animate(
              [
                { transform: "translate(0,0)" },
                { transform: "translate(-5px, 5px)" },
                { transform: "translate(5px, -5px)" },
                { transform: "translate(0,0)" },
              ],
              { duration: 200 },
            );

            setTimeout(() => {
              startGameLevel(CHAPTER_1[0], 0, "campaign", 1);
              layer.style.opacity = 0;
              layer.style.transition = "opacity 1s";
              setTimeout(() => {
                layer.style.display = "none";
              }, 1000);
            }, 2000);
          }, 800);
        }, 3500);
      }

      function setupMobileControls() {
        const addTouch = (id, key) => {
          const btn = document.getElementById(id);
          if (!btn) return;
          btn.addEventListener("touchstart", (e) => {
            e.preventDefault();
            arrows[key] = true;
            btn.classList.add("pressed");
          });
          btn.addEventListener("touchend", (e) => {
            e.preventDefault();
            arrows[key] = false;
            btn.classList.remove("pressed");
          });
        };
        addTouch("mc-left", "left");
        addTouch("mc-right", "right");
        addTouch("mc-up", "up");

        const zoomBtn = document.getElementById("zoom-btn");
        if (zoomBtn) {
          const toggleZoom = (e) => {
            e.preventDefault();
            if (activeLevelDisplay)
              activeLevelDisplay.setZoomOut(!activeLevelDisplay.zoomedOut);
          };
          zoomBtn.addEventListener("touchstart", toggleZoom);
        }
      }

      // Mobile Detection
      if (
        /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(
          navigator.userAgent,
        ) ||
        window.innerWidth <= 920
      ) {
        document.body.classList.add("mobile-mode");
        setupMobileControls();
        if (screen.orientation && screen.orientation.lock) {
          screen.orientation.lock("portrait").catch(() => {});
        }
      }

      function openMobileBeatsUI() {
        const overlay = document.createElement("div");
        overlay.className = "popup-overlay";
        overlay.style.zIndex = "2000";

        const container = document.createElement("div");
        container.style.cssText =
          "background:#111; width:90%; max-width:400px; border-radius:15px; padding:20px; border:2px solid #333; display:flex; flex-direction:column; gap:15px; max-height:80vh;";

        const header = document.createElement("div");
        header.innerHTML =
          "<span style='font-size:1.5rem; font-weight:bold; color:#fff;'>BEATS</span>";
        header.style.textAlign = "center";

        const list = document.createElement("div");
        list.style.cssText =
          "overflow-y:auto; flex:1; display:flex; flex-direction:column; gap:10px;";

        MUSIC_LIBRARY.forEach((track) => {
          const isPlaying = track.id === currentPlayingTrackId;
          const row = document.createElement("div");
          row.style.cssText = `padding:15px; background:${isPlaying ? "#1a2a40" : "#222"}; border:1px solid ${isPlaying ? "#335699" : "#333"}; border-radius:8px; display:flex; justify-content:space-between; align-items:center;`;
          row.innerHTML = `
                <div style="display:flex; flex-direction:column;">
                    <span style="color:white; font-weight:bold;">${track.title}</span>
                    <span style="color:#888; font-size:0.8rem;">${track.artist}</span>
                </div>
                ${isPlaying ? '<div style="width:10px; height:10px; background:#2ecc71; border-radius:50%;"></div>' : ""}
              `;
          row.onclick = () => {
            playMusic(track.id, true);
            overlay.remove();
            openMobileBeatsUI(); // Re-open to update UI
          };
          list.appendChild(row);
        });

        const closeBtn = document.createElement("button");
        closeBtn.className = "btn";
        closeBtn.textContent = "CLOSE";
        closeBtn.style.width = "100%";
        closeBtn.onclick = () => overlay.remove();

        container.appendChild(header);
        container.appendChild(list);
        container.appendChild(closeBtn);
        overlay.appendChild(container);
        document.body.appendChild(overlay);
      }

      // --- Start ---
      if (!safeStorage.getItem("hasSeenIntro")) {
        safeStorage.setItem("hasSeenIntro", "true");
        playIntro();
      } else {
        document.getElementById("intro-layer").style.display = "none";
        showMenu("main");
        setTimeout(() => {
          if (!currentPlayingTrackId) playMusic();
        }, 100);
      }

      // Ensure music starts on first interaction if blocked by browser
      document.addEventListener(
        "click",
        () => {
          if (audioCtx.state === "suspended") audioCtx.resume();
          if (!currentPlayingTrackId && !isMusicPaused) playMusic();
        },
        { once: true },
      );

      // HUD Click (ESC)
      document.getElementById("hud").onclick = () => {
        if (activeLevelDisplay) exitToMenu();
      };

      // Add cheat code detection
      document.addEventListener("keydown", (e) => {
        if (e.key === "Escape") {
          // Close popup if open
          const popup = document.querySelector(".popup-overlay");
          if (popup) {
            popup.remove();
            return;
          }

          if (activeLevelDisplay) {
            exitToMenu();
          } else {
            handleMenuBack();
          }
        }

        if (e.key.toLowerCase() === "z" && activeLevelDisplay) {
          activeLevelDisplay.setZoomOut(!activeLevelDisplay.zoomedOut);
        }

        // Only detect when not playing
        if (document.getElementById("main-menu").style.display === "flex") {
          // Ignore cheat codes when typing in inputs
          if (e.target.tagName === "INPUT" || e.target.tagName === "TEXTAREA")
            return;

          if (e.key.length === 1) {
            const key = e.key.toLowerCase();
            cheatCodeInput += key;
          }

          // Keep only last 5 characters (length of "clear")
          if (
            cheatCodeInput.length >
            Math.max(CHEAT_CODE.length, CLEAR_CODE.length)
          ) {
            cheatCodeInput = cheatCodeInput.slice(
              -Math.max(CHEAT_CODE.length, CLEAR_CODE.length),
            );
          }

          // Check if clear code was entered
          if (cheatCodeInput.endsWith(CLEAR_CODE)) {
            showConfirmPopup(
              "CLEAR PROGRESS",
              "Are you sure you want to clear all progress?",
              () => {
                clearAllProgress();
              },
            );
            cheatCodeInput = ""; // Reset
          }

          // Check if cheat code was entered
          if (cheatCodeInput.endsWith(CHEAT_CODE)) {
            showPopup("CHEAT ACTIVATED", "All levels unlocked!", () => {
              gameState.chapter1Beaten = true;
              gameState.chapter2Beaten = true;
              gameState.chapter3Beaten = true;
              gameState.unlockedLevel = 99;
              gameState.unlockedLevelCh2 = 99;
              gameState.unlockedLevelCh3 = 99;
              saveGame();
              location.reload();
            });
            cheatCodeInput = ""; // Reset
          }
        }
      });
    </script>
  </body>
</html>
