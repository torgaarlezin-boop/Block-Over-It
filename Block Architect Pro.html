<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Block Architect Pro</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
      :root {
        --bg-dark: #07090e;
        --bg-panel: #0f121a;
        --accent: #3b82f6;
        --border: #1e293b;
      }
      body {
        background-color: var(--bg-dark);
        color: #f1f5f9;
        font-family: "Inter", system-ui, sans-serif;
        overflow: hidden;
        height: 100vh;
      }

      #viewport {
        background-color: #020617;
        cursor: crosshair;
      }

      /* GAME ACCURATE STYLES */
      .cell {
        width: 24px;
        height: 24px;
        position: relative;
        box-sizing: border-box;
      }
      .t-wall {
        background: #444;
        border: solid 3px #333;
      }
      .t-lava {
        background: #e55;
      }
      .t-lava-h,
      .t-lava-v {
        background: #e55;
        position: relative;
      }
      .t-lava-h::after {
        content: "↔";
        color: white;
        font-size: 10px;
        display: flex;
        align-items: center;
        justify-content: center;
        height: 100%;
        font-weight: bold;
      }
      .t-lava-v::after {
        content: "↕";
        color: white;
        font-size: 10px;
        display: flex;
        align-items: center;
        justify-content: center;
        height: 100%;
        font-weight: bold;
      }
      .t-lava-drip {
        background: #e55;
        position: relative;
      }
      .t-lava-drip::after {
        content: "▼";
        color: white;
        font-size: 10px;
        display: flex;
        align-items: center;
        justify-content: center;
        height: 100%;
        font-weight: bold;
      }
      .t-coin {
        background: #e2e838;
        border-radius: 50%;
        border: 1px solid #c2c828;
        transform: scale(0.6);
      }
      .t-blue {
        background: #335699;
        border-radius: 50%;
        transform: scale(0.65);
      }
      .t-player {
        background: #59a;
        border-radius: 4px;
        transform: scale(0.8);
      }
      .t-moving-h,
      .t-moving-v {
        background: #777;
        border: 3px solid #555;
        position: relative;
      }
      .t-moving-h::after {
        content: "↔";
        color: white;
        font-size: 10px;
        display: flex;
        align-items: center;
        justify-content: center;
        height: 100%;
        font-weight: bold;
      }
      .t-moving-v::after {
        content: "↕";
        color: white;
        font-size: 10px;
        display: flex;
        align-items: center;
        justify-content: center;
        height: 100%;
        font-weight: bold;
      }
      .t-rising {
        background: #d32f2f;
        border: 3px solid #b71c1c;
        position: relative;
      }
      .t-rising::after {
        content: "▲";
        color: rgba(255, 255, 255, 0.7);
        font-size: 10px;
        display: flex;
        align-items: center;
        justify-content: center;
        height: 100%;
      }
      .t-falling {
        background: #444;
        border: 3px solid #333;
        position: relative;
      }
      .t-falling::after {
        content: "▼";
        color: white;
        font-size: 10px;
        display: flex;
        align-items: center;
        justify-content: center;
        height: 100%;
        font-weight: bold;
      }
      .t-breakable {
        background-image: url('data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iOCIgaGVpZ2h0PSI4IiB2aWV3Qm94PSIwIDAgOCA4IiBmaWxsPSJub25lIiB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciPjxyZWN0IHdpZHRoPSI4IiBoZWlnaHQ9IjgiIGZpbGw9IiM2NDY0NjQiLz48Y2lyY2xlIGN4PSI2LjUiIGN5PSI1LjUiIHI9IjAuNSIgZmlsbD0iIzQ0NDQ0NCIvPjxjaXJjbGUgY3g9IjIuNSIgY3k9IjYuNSIgcj0iMC41IiBmaWxsPSIjNDQ0NDQ0Ii8+PGNpcmNsZSBjeD0iNC41IiBjeT0iMy41IiByPSIwLjUiIGZpbGw9IiM0NDQ0NDQiLz48Y2lyY2xlIGN4PSIxLjUiIGN5PSIyLjUiIHI9IjAuNSIgZmlsbD0iIzQ0NDQ0NCIvPjxjaXJjbGUgY3g9IjUuNSIgY3k9IjAuNSIgcj0iMC41IiBmaWxsPSIjNDQ0NDQ0Ii8+PC9zdmc+');
        border: 3px solid #555;
      }
      .t-spike-block {
        background: #444;
        border: 3px solid #333;
        position: relative;
      }
      .t-spike-block::after {
        content: "";
        background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='%23aaaaaa'%3E%3Cpath d='M12 2L2 22h20L12 2z'/%3E%3C/svg%3E");
        background-size: 60%;
        background-repeat: no-repeat;
        background-position: center;
        height: 100%;
        display: block;
      }
      .t-spike-block-u {
        background: #444;
        border: 3px solid #333;
        position: relative;
      }
      .t-spike-block-u::after {
        content: "";
        background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='%23aaaaaa'%3E%3Cpath d='M12 22L22 2H2L12 22z'/%3E%3C/svg%3E");
        background-size: 60%;
        background-repeat: no-repeat;
        background-position: center;
        width: 100%;
        height: 100%;
        display: block;
      }
      .t-wall-block {
        background: #444;
        border: 3px solid #333;
        position: relative;
      }
      .t-wall-block::after {
        content: "W";
        color: #aaa;
        font-size: 10px;
        display: flex;
        align-items: center;
        justify-content: center;
        height: 100%;
        font-weight: bold;
      }
      .t-jump-pad {
        background: #590059;
        border: 2px solid #d946ef;
        position: relative;
      }
      .t-jump-pad::before {
        content: '';
        position: absolute;
        top: 20%; left: 20%; right: 20%; bottom: 20%;
        background: #d946ef;
        border-radius: 50%;
      }
      .t-jump-pad::after {
        content: "J";
        color: white;
        font-size: 10px;
        display: flex;
        align-items: center;
        justify-content: center;
        height: 100%;
        font-weight: bold;
        position: relative;
        z-index: 2;
      }
      .t-grinder {
        background-color: #333;
        background-image: linear-gradient(90deg, transparent 30%, #888 30%, #888 70%, transparent 70%), repeating-linear-gradient(0deg, #222 0px, #222 4px, #aaa 4px, #aaa 8px);
        background-size: 100% 100%, 40% 100%;
        background-position: center center, center 0;
        position: relative;
      }
      .t-grinder::after {
        content: "C";
        color: white;
        font-size: 10px;
        display: flex;
        align-items: center;
        justify-content: center;
        height: 100%;
        font-weight: bold;
      }

      .t-spike-u {
        background: transparent;
        display: flex;
        align-items: flex-start;
        justify-content: center;
      }
      .t-spike-u::after {
        content: none;
      }
      .spike-visual.spike-u {
        border-bottom: 0;
        border-top: 20px solid #94a3b8;
      }
      .style-modern .spike-visual.spike-u {
        border-top-color: #cbd5e1;
      }
      .tool-active {
        background: var(--accent) !important;
        color: white !important;
      }
      #level-grid {
        transform-origin: 0 0;
        background: #000;
        display: grid;
        position: relative;
      }
      .right-sidebar {
        width: 320px;
        transition:
          transform 0.3s cubic-bezier(0.4, 0, 0.2, 1),
          margin-right 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      }

      .template-card {
        cursor: pointer;
        transition: all 0.2s;
        border: 1px solid #1e293b;
        background: #0f121a;
      }
      .template-card:hover {
        border-color: #3b82f6;
        background: #161b26;
        transform: translateY(-1px);
      }

      .accordion-content {
        display: grid;
        grid-template-rows: 0fr;
        transition: grid-template-rows 0.3s ease-out;
      }
      .accordion-open .accordion-content {
        grid-template-rows: 1fr;
      }
      .accordion-header svg {
        transition: transform 0.2s ease;
        transform-origin: center;
      }
      .accordion-open .accordion-header svg {
        transform: rotate(180deg);
      }

      /* Ensure header always sits above content to avoid visual nesting */
      .accordion-header {
        position: relative;
        z-index: 20;
        background: transparent;
      }
      .accordion-content {
        position: relative;
        z-index: 1;
      }
      /* Small visual gap between sections for clarity */
      .border-b {
        padding-bottom: 0.25rem;
      }

      /* Custom Selection Box */
      #selection-overlay {
        position: absolute;
        top: 0;
        left: 0;
        pointer-events: none;
        width: 100%;
        height: 100%;
        z-index: 10;
      }
      .selection-rect {
        position: absolute;
        border: 2px solid #3b82f6;
        background: rgba(59, 130, 246, 0.2);
        box-sizing: border-box;
        z-index: 40;
      }

      /* Custom Scrollbar */
      ::-webkit-scrollbar {
        width: 6px;
        height: 6px;
      }
      ::-webkit-scrollbar-track {
        background: #0f121a;
      }
      ::-webkit-scrollbar-thumb {
        background: #334155;
        border-radius: 3px;
      }
      ::-webkit-scrollbar-thumb:hover {
        background: #475569;
      }

      /* Hide Number Arrows */
      input[type="number"]::-webkit-inner-spin-button,
      input[type="number"]::-webkit-outer-spin-button {
        -webkit-appearance: none;
        margin: 0;
      }
      input[type="number"] {
        -moz-appearance: textfield;
      }
      .grid-lines .cell {
        box-shadow: inset 0 0 0 0.5px rgba(30, 41, 59, 0.5);
      }

      /* Modern Style */
      .style-modern .t-wall {
        background: #334155;
        border: 1px solid #1e293b;
        border-radius: 2px;
      }
      .style-modern .t-lava,
      .style-modern .t-lava-h,
      .style-modern .t-lava-v,
      .style-modern .t-lava-drip {
        background: #ef4444;
        border-radius: 3px;
        opacity: 0.9;
      }
      .style-modern .t-coin {
        background: #fbbf24;
        border: 2px solid #f59e0b;
        transform: scale(0.65);
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
      }
      .style-modern .t-blue {
        background: #3b82f6;
        border: 2px solid #2563eb;
        transform: scale(0.7);
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
      }
      .style-modern .t-player {
        background: #10b981;
        border-radius: 6px;
        transform: scale(0.85);
        box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
      }
      .style-modern .t-moving-h,
      .style-modern .t-moving-v {
        background: #64748b;
        border: 1px solid #475569;
        border-radius: 4px;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
      }
      .style-modern .t-rising {
        background: #ef4444;
        border: 1px solid #b91c1c;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
      }
      .style-modern .t-falling {
        background: #64748b;
        border: 1px solid #475569;
        border-radius: 4px;
      }
      .style-modern .t-breakable {
        background-image: url('data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iOCIgaGVpZ2h0PSI4IiB2aWV3Qm94PSIwIDAgOCA4IiBmaWxsPSJub25lIiB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciPjxyZWN0IHdpZHRoPSI4IiBoZWlnaHQ9IjgiIGZpbGw9IiM3MTg1OWYiLz48Y2lyY2xlIGN4PSI2LjUiIGN5PSI1LjUiIHI9IjAuNSIgZmlsbD0iIzQ3NTU2OSIvPjxjaXJjbGUgY3g9IjIuNSIgY3k9IjYuNSIgcj0iMC41IiBmaWxsPSIjNDc1NTY5Ii8+PGNpcmNsZSBjeD0iNC41IiBjeT0iMy41IiByPSIwLjUiIGZpbGw9IiM0NzU1NjkiLz48Y2lyY2xlIGN4PSIxLjUiIGN5PSIyLjUiIHI9IjAuNSIgZmlsbD0iIzQ3NTU2OSIvPjxjaXJjbGUgY3g9IjUuNSIgY3k9IjAuNSIgcj0iMC41IiBmaWxsPSIjNDc1NTY5Ii8+PC9zdmc+');
        border: 1px solid #475569;
        border-radius: 2px;
      }
      .style-modern .t-spike-block {
        background: #334155;
        border: 1px solid #1e293b;
        border-radius: 2px;
      }
      .style-modern .t-wall-block {
        background: #334155;
        border: 1px solid #1e293b;
        border-radius: 2px;
      }
      .style-modern .t-jump-pad {
        background: #701a75;
        border: 1px solid #d946ef;
        border-radius: 2px;
      }
      .style-modern .t-grinder {
        background: #1e293b;
        border: 1px solid #0f172a;
        border-radius: 2px;
      }
      .t-spike {
        background: transparent;
        display: flex;
        align-items: center;
        justify-content: center;
      }
      .t-spike::after {
        content: none;
      }

      .spike-visual {
        width: 0;
        height: 0;
        border-left: 10px solid transparent;
        border-right: 10px solid transparent;
        border-bottom: 20px solid #94a3b8;
      }
      .style-modern .spike-visual {
        border-bottom-color: #cbd5e1;
        filter: drop-shadow(0 2px 2px rgba(0, 0, 0, 0.3));
      }
      #minimap-container.collapsed {
        width: auto;
        height: auto;
        width: 40px !important;
        height: 40px !important;
        border-radius: 50%;
        background: rgba(15, 23, 42, 0.4);
        border-color: rgba(59, 130, 246, 0.3);
        cursor: pointer;
        overflow: hidden;
        display: flex;
        align-items: center;
        justify-content: center;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
      }
      #minimap-container.collapsed:hover {
        background: rgba(59, 130, 246, 0.2);
        border-color: rgba(59, 130, 246, 0.6);
        transform: scale(1.1);
      }
      #minimap-container.collapsed #minimap-canvas-wrapper {
        display: none;
      }
      #minimap-container.collapsed #minimap-header {
        display: none;
      }
      #minimap-canvas {
        width: 100%;
        height: auto;
        image-rendering: -moz-crisp-edges;
        image-rendering: -webkit-crisp-contrast;
        image-rendering: pixelated;
        border-radius: 2px;
        cursor: crosshair;
      }
      #minimap-container.collapsed::after {
        content: "";
        width: 20px;
        height: 20px;
        background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 24 24' stroke='%2360a5fa' stroke-width='2'%3E%3Cpath stroke-linecap='round' stroke-linejoin='round' d='M9 20l-5.447-2.724A1 1 0 013 16.382V5.618a1 1 0 011.447-.894L9 7m0 13l6-3m-6 3V7m6 10l4.553 2.276A1 1 0 0021 18.382V7.618a1 1 0 00-.553-.894L15 4m0 13V4m0 0L9 7' /%3E%3C/svg%3E");
        background-size: contain;
        background-repeat: no-repeat;
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
      }
      /* Minimap Glass Style */
      .glass-panel {
        background: rgba(15, 23, 42, 0.85);
        backdrop-filter: blur(12px);
        border: 1px solid rgba(51, 65, 85, 0.5);
        box-shadow: 0 10px 30px -5px rgba(0, 0, 0, 0.5);
      }
      /* Difficulty Picker */
      .diff-btn {
        flex: 1;
        height: 100%;
        border-radius: 2px;
        transition: all 0.2s;
      }
      .diff-btn:hover {
        background: rgba(255, 255, 255, 0.1);
      }
      .diff-btn.active {
        box-shadow: 0 0 10px currentColor;
        border-color: currentColor;
      }
      /* Code Editor Syntax Highlighting */
      .hl-keyword {
        color: #c678dd;
        font-weight: bold;
      }
      .hl-string {
        color: #98c379;
      }
      .hl-number {
        color: #d19a66;
      }
      .hl-func {
        color: #61afef;
      }
      .hl-error {
        text-decoration: underline wavy #e06c75;
      }
      .hl-ref {
        color: #e5c07b;
        text-decoration: underline #e5c07b;
        cursor: help;
      }
      .picker-active .cell:hover {
        box-shadow: inset 0 0 0 2px #3b82f6;
        z-index: 50;
      }
      /* Settings Modal Tabs */
      .settings-tab {
        text-align: left;
        padding: 10px 15px;
        border-radius: 6px;
        color: #94a3b8;
        font-size: 12px;
        font-weight: 600;
        transition: all 0.2s;
      }
      .settings-tab:hover {
        background: rgba(30, 41, 59, 0.5);
        color: #f1f5f9;
      }
      .settings-tab.active {
        background: #3b82f6;
        color: white;
      }

      /* Selection Popup */
      #selection-popup {
        transition: opacity 0.1s, transform 0.1s;
      }
      #selection-popup.hidden {
        opacity: 0;
        pointer-events: none;
        transform: scale(0.95);
      }
      .sp-btn {
        transition: all 0.1s;
      }
      .sp-btn:active {
        transform: scale(0.95);
      }
    </style>
  </head>
  <body class="flex flex-col">
    <!-- Selection Popup (Floating) -->
    <div id="selection-popup" class="hidden fixed z-50 bg-[#0f121a] border border-slate-700 rounded-lg shadow-2xl p-2 flex flex-col gap-2 w-48 select-none">
      <div class="grid grid-cols-4 gap-1">
          <button id="btn-sp-fill" onclick="fillSelection()" class="p-1.5 bg-slate-800 hover:bg-slate-700 rounded text-blue-400 flex justify-center items-center sp-btn" title="Fill">
              <svg width="14" height="14" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="m19 11-8-8-8.6 8.6a2 2 0 000 2.8l5.2 5.2c.8.8 2 .8 2.8 0L19 11z"/></svg>
          </button>
          <button id="btn-sp-delete" onclick="deleteSelection()" class="p-1.5 bg-slate-800 hover:bg-red-900/30 rounded text-red-400 flex justify-center items-center sp-btn" title="Delete">
              <svg width="14" height="14" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/></svg>
          </button>
          <button id="btn-sp-paint" onclick="openColorPickerForSelection()" class="p-1.5 bg-slate-800 hover:bg-slate-700 rounded text-purple-400 flex justify-center items-center sp-btn" title="Paint">
              <div class="w-3 h-3 rounded-full bg-current"></div>
          </button>
          <button id="btn-sp-fake" onclick="toggleFakeSelection()" class="p-1.5 bg-slate-800 hover:bg-slate-700 rounded text-yellow-400 flex justify-center items-center sp-btn" title="Fake Block">
              <span class="font-bold text-[10px]">F</span>
          </button>
      </div>
      <div class="grid grid-cols-4 gap-1">
          <button id="btn-sp-invisible" onclick="makeSelectionInvisible()" class="p-1.5 bg-slate-800 hover:bg-slate-700 rounded text-slate-400 flex justify-center items-center sp-btn" title="Invisible">
              <svg width="14" height="14" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M13.875 18.825A10.05 10.05 0 0112 19c-4.478 0-8.268-2.943-9.543-7a9.97 9.97 0 011.563-3.029m5.858.908a3 3 0 114.243 4.243M9.878 9.878l4.242 4.242M9.88 9.88l-3.29-3.29m7.532 7.532l3.29 3.29M3 3l3.59 3.59m0 0A9.953 9.953 0 0112 5c4.478 0 8.268 2.943 9.543 7a10.025 10.025 0 01-4.132 5.411m0 0L21 21"/></svg>
          </button>
          <button id="btn-sp-flicker" onclick="toggleFlickerSelection()" class="p-1.5 bg-slate-800 hover:bg-slate-700 rounded text-slate-400 flex justify-center items-center sp-btn" title="Flicker">
              <svg width="14" height="14" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" /><path d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z" stroke-dasharray="4 4" /></svg>
          </button>
          <button id="btn-sp-jump-flicker" onclick="toggleJumpFlickerSelection()" class="p-1.5 bg-slate-800 hover:bg-slate-700 rounded text-slate-400 flex justify-center items-center sp-btn" title="Jump Flicker">
              <svg width="14" height="14" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M5 15l7-7 7 7" /><path d="M12 8v12" /></svg>
          </button>
          <button id="btn-sp-illusion" onclick="toggleIllusionSelection()" class="hidden p-1.5 bg-slate-800 hover:bg-slate-700 rounded text-cyan-400 flex justify-center items-center sp-btn" title="Toggle Illusion">
              <svg width="14" height="14" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M5 3v4M3 5h4M5 17v4M3 19h4M19 3v4M17 5h4M19 17v4M17 19h4M12 5v14"></path></svg>
          </button>
      </div>
      <div class="bg-slate-900/50 rounded p-1 flex flex-col gap-1">
          <div class="flex gap-1">
               <button onclick="shiftSelection(0, -1)" class="flex-1 p-1 bg-slate-800 hover:bg-slate-700 rounded text-slate-300 flex justify-center sp-btn"><svg width="12" height="12" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M5 15l7-7 7 7"/></svg></button>
               <button onclick="shiftSelection(0, 1)" class="flex-1 p-1 bg-slate-800 hover:bg-slate-700 rounded text-slate-300 flex justify-center sp-btn"><svg width="12" height="12" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M19 9l-7 7-7-7"/></svg></button>
          </div>
          <div class="flex gap-1">
               <button onclick="shiftSelection(-1, 0)" class="flex-1 p-1 bg-slate-800 hover:bg-slate-700 rounded text-slate-300 flex justify-center sp-btn"><svg width="12" height="12" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M15 19l-7-7 7-7"/></svg></button>
               <button onclick="shiftSelection(1, 0)" class="flex-1 p-1 bg-slate-800 hover:bg-slate-700 rounded text-slate-300 flex justify-center sp-btn"><svg width="12" height="12" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M9 5l7 7-7 7"/></svg></button>
          </div>
      </div>
      <button id="sp-expand-btn" onclick="toggleSPExpand()" class="w-full text-[10px] text-slate-500 hover:text-white bg-slate-800/50 hover:bg-slate-800 rounded py-1 transition-colors flex justify-center items-center gap-1 sp-btn">
          <span>More Options</span>
          <svg id="sp-expand-icon" width="10" height="10" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24" class="transition-transform"><path d="M19 9l-7 7-7-7"/></svg>
      </button>
      <div id="sp-expanded" class="hidden flex-col gap-2 pt-1">
          <div class="grid grid-cols-2 gap-1">
              <button onclick="mirrorSelection('h')" class="p-1.5 bg-slate-800 hover:bg-slate-700 rounded text-[10px] text-slate-300 font-bold sp-btn">Mirror H</button>
              <button onclick="mirrorSelection('v')" class="p-1.5 bg-slate-800 hover:bg-slate-700 rounded text-[10px] text-slate-300 font-bold sp-btn">Mirror V</button>
          </div>
          <div id="sp-rising-opt" class="hidden pt-2 border-t border-slate-700/50">
               <label class="flex items-center gap-2 cursor-pointer group">
                  <div class="relative">
                      <input type="checkbox" id="sp-rising-check" class="sr-only peer" onchange="toggleRisingThrough()">
                      <div class="w-7 h-4 bg-slate-900 border border-slate-700 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-slate-500 after:border-gray-300 after:border after:rounded-full after:h-3 after:w-3 after:transition-all peer-checked:bg-blue-600 peer-checked:border-blue-500 peer-checked:after:bg-white"></div>
                  </div>
                  <span class="text-[9px] font-bold text-slate-400 group-hover:text-slate-200 uppercase">Lava Through Blocks</span>
              </label>
          </div>
          <div id="sp-block-config-opt" class="hidden pt-2 border-t border-slate-700/50 flex items-center gap-2">
              <span class="text-[9px] font-bold text-slate-400 uppercase">Blocks Produced</span>
              <input type="number" id="sp-block-count-input" min="1" max="20" class="w-16 bg-slate-900 border border-slate-700 rounded px-1 py-0.5 text-[9px] text-white outline-none focus:border-blue-500" onchange="updateBlockConfig(this.value)" placeholder="1">
              <span class="text-[8px] text-slate-600">Default: 1</span>
          </div>
      </div>
    </div>

    <!-- Header -->
    <header
      class="h-14 border-b border-slate-800 bg-[#0f121a] flex items-center justify-between px-6 z-50"
    >
      <div class="flex items-center gap-4">
        <button
          onclick="
            document.getElementById('start-modal').classList.remove('hidden');
            projectManager.renderList();
          "
          class="w-8 h-8 bg-slate-800 hover:bg-blue-600 transition-colors rounded flex items-center justify-center text-white border border-slate-700 hover:border-blue-500 group"
          title="Main Menu"
        >
          <svg
            width="16"
            height="16"
            fill="none"
            stroke="currentColor"
            stroke-width="2"
            viewBox="0 0 24 24"
          >
            <path
              d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6"
            />
          </svg>
        </button>
        <h1 class="font-bold text-sm tracking-tight text-slate-200 uppercase">
          Architect <span class="text-blue-500">Pro</span><span class="text-purple-500">Beta</span>
        </h1>
      </div>

      <div class="flex items-center gap-3">
        <div
          class="flex bg-slate-900 p-1 rounded-lg border border-slate-800 mr-2"
        >
          <button
            onclick="zoom(-0.1)"
            class="p-1.5 hover:bg-slate-800 rounded px-3 text-slate-400"
          >
            <svg
              width="14"
              height="14"
              fill="none"
              stroke="currentColor"
              stroke-width="2.5"
              viewBox="0 0 24 24"
            >
              <path d="M5 12h14" />
            </svg>
          </button>
          <button
            onclick="autoAdjust()"
            class="p-1.5 hover:bg-slate-800 rounded px-2 text-blue-400"
            title="Fit to Screen"
          >
            <svg
              width="14"
              height="14"
              fill="none"
              stroke="currentColor"
              stroke-width="2.5"
              viewBox="0 0 24 24"
            >
              <path d="M15 3h6v6M9 21H3v-6M21 3l-7 7M3 21l7-7" />
            </svg>
          </button>
          <button
            onclick="zoom(0.1)"
            class="p-1.5 hover:bg-slate-800 rounded px-3 text-slate-400"
          >
            <svg
              width="14"
              height="14"
              fill="none"
              stroke="currentColor"
              stroke-width="2.5"
              viewBox="0 0 24 24"
            >
              <path d="M12 5v14M5 12h14" />
            </svg>
          </button>
        </div>

        <button
          onclick="projectManager.save()"
          class="px-4 py-2 bg-blue-600 hover:bg-blue-500 text-[11px] font-bold rounded text-white shadow-lg shadow-blue-600/20"
        >
          Save
        </button>
        <button
          onclick="projectManager.saveAsTemplate()"
          class="px-4 py-2 bg-slate-800 hover:bg-slate-700 text-[11px] font-bold rounded border border-slate-700 text-slate-300"
        >
          Template
        </button>
        <button
          onclick="io.downloadJson()"
          class="px-4 py-2 bg-slate-800 hover:bg-slate-700 text-[11px] font-bold rounded border border-slate-700 text-slate-300"
        >
          Export
        </button>
        <button
          onclick="exportManager.open()"
          class="px-4 py-2 bg-slate-800 hover:bg-slate-700 text-[11px] font-bold rounded border border-slate-700 text-slate-300"
        >
          Image
        </button>
        <button
          onclick="showPreview()"
          class="px-4 py-2 bg-slate-800 hover:bg-slate-700 text-[11px] font-bold rounded border border-slate-700 text-slate-300"
        >
          Preview
        </button>
        <button
          onclick="helpManager.open()"
          class="px-3 py-2 bg-slate-800 hover:bg-slate-700 text-[11px] font-bold rounded border border-slate-700 text-blue-400 flex items-center gap-1"
        >
          Help
        </button>
        <button
          onclick="whatsNewManager.open()"
          class="px-3 py-2 bg-slate-800 hover:bg-slate-700 text-[11px] font-bold rounded border border-slate-700 text-purple-400 flex items-center gap-1"
        >
          What's New
        </button>
        <button
          onclick="io.importClick()"
          class="ml-2 px-4 py-2 bg-slate-800 hover:bg-slate-700 text-[11px] font-bold rounded border border-slate-700 text-slate-400"
        >
          Import
        </button>
      </div>
    </header>

    <div class="flex flex-1 overflow-hidden relative">
      <!-- LEFT TOOLS -->
      <aside
        class="w-44 border-r border-slate-800 bg-[#0f121a] flex flex-col z-20"
      >
        <div class="p-4 border-b border-slate-800/50">
          <div class="grid grid-cols-2 gap-2">
            <button
              onclick="setTool('pencil')"
              id="btn-pencil"
              class="p-3 rounded bg-slate-900 border border-slate-800 text-slate-500 tool-active flex flex-col items-center gap-1"
              title="Draw (B)"
            >
              <svg
                width="18"
                height="18"
                fill="none"
                stroke="currentColor"
                stroke-width="2"
                viewBox="0 0 24 24"
              >
                <path
                  d="M17 3a2.828 2.828 0 114 4L7.5 20.5 2 22l1.5-5.5L17 3z"
                />
              </svg>
              <span class="text-[8px] font-bold">PENCIL</span>
            </button>
            <button
              onclick="setTool('bucket')"
              id="btn-bucket"
              class="p-3 rounded bg-slate-900 border border-slate-800 text-slate-500 flex flex-col items-center gap-1"
              title="Fill (F)"
            >
              <svg
                width="18"
                height="18"
                fill="none"
                stroke="currentColor"
                stroke-width="2"
                viewBox="0 0 24 24"
              >
                <path
                  d="m19 11-8-8-8.6 8.6a2 2 0 000 2.8l5.2 5.2c.8.8 2 .8 2.8 0L19 11z"
                />
              </svg>
              <span class="text-[8px] font-bold">FILL</span>
            </button>
            <button
              onclick="setTool('select')"
              id="btn-select"
              class="p-3 rounded bg-slate-900 border border-slate-800 text-slate-500 flex flex-col items-center gap-1"
              title="Select (S)"
            >
              <svg
                width="18"
                height="18"
                fill="none"
                stroke="currentColor"
                stroke-width="2"
                viewBox="0 0 24 24"
              >
                <rect
                  x="3"
                  y="3"
                  width="18"
                  height="18"
                  rx="2"
                  stroke-dasharray="4 4"
                />
              </svg>
              <span class="text-[8px] font-bold">SELECT</span>
            </button>
            <button
              onclick="setTool('eraser')"
              id="btn-eraser"
              class="p-3 rounded bg-slate-900 border border-slate-800 text-slate-500 flex flex-col items-center gap-1"
              title="Eraser (E)"
            >
              <svg
                width="18"
                height="18"
                fill="none"
                stroke="currentColor"
                stroke-width="2"
                viewBox="0 0 24 24"
              >
                <path
                  d="m7 21-4.3-4.3c-1-1-1-2.5 0-3.4l9.9-9.9c1-1 2.5-1 3.4 0l4.4 4.4c1 1 1 2.5 0 3.4L10.5 21c-1 1-2.5 1-3.4 0z"
                />
              </svg>
              <span class="text-[8px] font-bold">ERASE</span>
            </button>
          </div>
        </div>
        <div class="p-4 flex-1 overflow-y-auto">
          <h3
            class="text-[9px] font-bold text-slate-500 uppercase tracking-widest mb-4"
          >
            Block Palette
          </h3>
          <div class="grid grid-cols-2 gap-3" id="block-list"></div>
        </div>
        <div class="p-3 border-t border-slate-800 bg-slate-950 flex gap-2">
          <button
            onclick="history.undo()"
            class="flex-1 py-3 flex items-center justify-center rounded bg-slate-900 border border-slate-800 text-slate-400 hover:text-white"
            title="Undo (Ctrl+Z)"
          >
            <svg
              width="16"
              height="16"
              fill="none"
              stroke="currentColor"
              stroke-width="2.5"
              viewBox="0 0 24 24"
            >
              <path d="M3 10h10a5 5 0 010 10H7M3 10l4-4M3 10l4 4" />
            </svg>
          </button>
          <button
            onclick="history.redo()"
            class="flex-1 py-3 flex items-center justify-center rounded bg-slate-900 border border-slate-800 text-slate-400 hover:text-white"
            title="Redo (Ctrl+Y)"
          >
            <svg
              width="16"
              height="16"
              fill="none"
              stroke="currentColor"
              stroke-width="2.5"
              viewBox="0 0 24 24"
            >
              <path d="M21 10H11a5 5 0 000 10h4m6-10l-4-4m4 4l-4 4" />
            </svg>
          </button>
        </div>
      </aside>

      <!-- CANVAS -->
      <main
        id="viewport"
        class="flex-1 relative overflow-auto p-10 bg-[#020617]"
      >
        <div id="level-grid" class="shadow-[0_0_100px_rgba(0,0,0,0.5)]">
          <!-- Selection overlay will be appended here -->
          <div id="selection-overlay"></div>
        </div>
        <div
          id="minimap-container"
          class="fixed top-20 right-6 z-30 glass-panel rounded-xl transition-all duration-300 w-56 overflow-hidden"
          onclick="if (this.classList.contains('collapsed')) minimap.toggle();"
        >
          <div
            class="px-3 py-2 border-b border-slate-700/50 flex justify-between items-center cursor-move bg-slate-900/50"
            id="minimap-header"
          >
            <h4
              class="text-[10px] font-bold text-blue-400 uppercase tracking-widest flex items-center gap-2"
            >
              Minimap
            </h4>
            <button
              onclick="
                event.stopPropagation();
                minimap.toggle();
              "
              id="minimap-toggle-btn"
              class="p-1 text-slate-500 hover:text-white"
            >
              <svg
                width="12"
                height="12"
                fill="none"
                stroke="currentColor"
                stroke-width="2.5"
                viewBox="0 0 24 24"
              >
                <path d="M5 12h14"></path>
              </svg>
            </button>
          </div>
          <div
            id="minimap-canvas-wrapper"
            class="p-3 transition-all duration-300 bg-black/20"
          >
            <canvas id="minimap-canvas" class="w-full h-full"></canvas>
          </div>
        </div>
      </main>

      <!-- RIGHT PANEL -->
      <aside
        id="right-panel"
        class="right-sidebar border-l border-slate-800 bg-[#0f121a] flex flex-col z-20"
      >
        <div
          class="p-5 border-b border-slate-800 flex justify-between items-center bg-slate-900/50"
        >
          <h3
            class="text-[10px] font-bold text-slate-400 uppercase tracking-widest"
          >
            Configuration
          </h3>
          <button
            onclick="toggleRightPanel()"
            class="text-slate-500 hover:text-white bg-slate-800 p-1.5 rounded"
            title="Hide Panel"
          >
            <svg
              width="14"
              height="14"
              fill="none"
              stroke="currentColor"
              stroke-width="2.5"
              viewBox="0 0 24 24"
            >
              <path d="M13 5l7 7-7 7M5 5l7 7-7 7" />
            </svg>
          </button>
        </div>

        <div class="flex-1 overflow-y-auto" id="accordion-container">
          <!-- Section 1: Properties -->
          <div class="border-b border-slate-800 accordion-open">
            <button
              onclick="toggleAccordion(this)"
              class="accordion-header w-full px-5 py-3 flex justify-between items-center hover:bg-white/5 transition-colors bg-slate-900/20"
            >
              <span class="text-[10px] font-bold text-blue-400 uppercase tracking-widest">MAIN</span>
              <svg
                width="12"
                height="12"
                fill="none"
                stroke="currentColor"
                stroke-width="2.5"
                viewBox="0 0 24 24"
              >
                <path d="M19 9l-7 7-7-7" />
                </svg>
            </button>
            <div class="accordion-content">
              <div class="min-h-0 overflow-hidden">
              <div class="px-5 pb-6 space-y-4">
                <div
                  class="text-[9px] font-bold text-slate-600 uppercase tracking-wider border-b border-slate-800/50 pb-1 mb-2"
                >
                  Metadata
                </div>
                <div>
                  <label
                    class="text-[9px] text-slate-500 font-bold uppercase block mb-1.5"
                    >Level Identifier</label
                  >
                  <input
                    id="prop-name"
                    type="text"
                    value="New Level"
                    class="w-full bg-slate-950 border border-slate-800 rounded px-3 py-2 text-xs text-blue-100 outline-none focus:border-blue-500"
                  />
                </div>
                <div>
                  <label
                    class="text-[9px] text-slate-500 font-bold uppercase block mb-1.5"
                    >Creator</label
                  >
                  <input
                    id="prop-creator"
                    type="text"
                    value="Anonymous"
                    class="w-full bg-slate-950 border border-slate-800 rounded px-3 py-2 text-xs text-blue-100 outline-none focus:border-blue-500"
                  />
                </div>
                <div>
                  <label
                    class="text-[9px] text-slate-500 font-bold uppercase block mb-1.5"
                    >Description</label
                  >
                  <textarea
                    id="prop-desc"
                    class="w-full bg-slate-950 border border-slate-800 rounded px-3 py-2 text-xs text-slate-300 outline-none focus:border-blue-500 h-16 resize-none"
                    placeholder="Brief description of your level..."
                    oninput="settingsManager.syncToModal()"
                  ></textarea>
                </div>
                <div>
                  <div class="flex justify-between items-center mb-1.5">
                    <label class="text-[9px] text-slate-500 font-bold uppercase"
                      >Difficulty</label
                    >
                    <span id="diff-val" class="text-xs text-blue-400 font-mono"
                      >1</span
                    >
                  </div>
                  <div
                    class="flex flex-col gap-1 mt-2 bg-slate-950 p-1.5 rounded border border-slate-800"
                  >
                    <div class="flex gap-1 h-4" id="diff-bars">
                      <!-- Injected via JS -->
                    </div>
                    <div
                      class="flex justify-between text-[8px] font-bold text-slate-600 uppercase px-0.5"
                    >
                      <span>Easy</span><span>Medium</span><span>Hard</span
                      ><span>Expert</span><span>Extreme</span>
                    </div>
                  </div>
                  <input type="hidden" id="prop-diff" value="1" />
                  <input type="hidden" id="prop-force-zoom" value="false">
                  <input type="hidden" id="prop-no-death-anim" value="false">
                </div>
                <div
                  class="text-[9px] font-bold text-slate-600 uppercase tracking-wider border-b border-slate-800/50 pb-1 mb-2 mt-4"
                >
                  Physics
                </div>
                <div>
                  <div class="flex justify-between items-center mb-1.5">
                    <div class="flex items-center gap-1.5">
                      <label
                        class="text-[9px] text-slate-500 font-bold uppercase"
                        >Gravity Constant</label
                      >
                      <div
                        onclick="
                          showInfo(
                            'Gravity Constant',
                            'Controls jump height and fall speed. Lower values increase jump height and decrease fall speed, while higher values do the opposite. The default Block Over It gravity is 27.',
                          )
                        "
                        class="flex items-center justify-center w-3 h-3 rounded-full border border-slate-600 text-[8px] text-slate-400 cursor-pointer hover:text-white hover:border-white transition-colors"
                      >
                        i
                      </div>
                    </div>
                    <span
                      id="gravity-val"
                      class="text-xs text-blue-400 font-mono"
                      >27</span
                    >
                  </div>
                  <input
                    id="prop-gravity"
                    type="range"
                    min="5"
                    max="100"
                    value="27"
                    class="w-full h-1 bg-slate-800 rounded-lg appearance-none accent-blue-500"
                    oninput="
                      document.getElementById('gravity-val').innerText =
                        this.value
                      settingsManager.syncToModal();
                    "
                  />
                </div>
                <div class="mt-4">
                  <div class="flex justify-between items-center mb-1.5">
                    <label class="text-[9px] text-slate-500 font-bold uppercase">Rising Lava Speed</label>
                    <span id="rise-val" class="text-xs text-blue-400 font-mono">Disabled</span>
                  </div>
                  <input id="prop-rise" type="range" min="0" max="10" step="0.5" value="0" class="w-full h-1 bg-slate-800 rounded-lg appearance-none accent-blue-500"
                    oninput="
                      const val = parseFloat(this.value);
                      document.getElementById('rise-val').innerText = val > 0 ? (60 / val).toFixed(1) + ' blk/min' : 'Disabled';
                      settingsManager.syncToModal();
                    ">
                </div>
                <div
                  class="text-[9px] font-bold text-slate-600 uppercase tracking-wider border-b border-slate-800/50 pb-1 mb-2 mt-4"
                >
                  Grid Dimensions
                </div>
                <div class="grid grid-cols-2 gap-3">
                  <div>
                    <label
                      class="text-[9px] text-slate-500 font-bold uppercase block mb-1"
                      >Width</label
                    >
                    <div
                      class="flex items-center bg-slate-950 border border-slate-800 rounded hover:border-slate-600 transition-colors"
                    >
                      <button
                        onclick="adjustProp('prop-w', -1)"
                        class="px-2 text-slate-500 hover:text-white hover:bg-slate-800 rounded-l h-full"
                      >
                        -
                      </button>
                      <input
                        id="prop-w"
                        type="number"
                        value="40"
                        class="w-full bg-transparent text-center py-1.5 text-xs text-slate-200 outline-none"
                        oninput="settingsManager.syncToModal()"
                      />
                      <button
                        onclick="adjustProp('prop-w', 1)"
                        class="px-2 text-slate-500 hover:text-white hover:bg-slate-800 rounded-r h-full"
                      >
                        +
                      </button>
                    </div>
                  </div>
                  <div>
                    <label
                      class="text-[9px] text-slate-500 font-bold uppercase block mb-1"
                      >Height</label
                    >
                    <div
                      class="flex items-center bg-slate-950 border border-slate-800 rounded hover:border-slate-600 transition-colors"
                    >
                      <button
                        onclick="adjustProp('prop-h', -1)"
                        class="px-2 text-slate-500 hover:text-white hover:bg-slate-800 rounded-l h-full"
                      >
                        -
                      </button>
                      <input
                        id="prop-h"
                        type="number"
                        value="20"
                        class="w-full bg-transparent text-center py-1.5 text-xs text-slate-200 outline-none"
                        oninput="settingsManager.syncToModal()"
                      />
                      <button
                        onclick="adjustProp('prop-h', 1)"
                        class="px-2 text-slate-500 hover:text-white hover:bg-slate-800 rounded-r h-full"
                      >
                        +
                      </button>
                    </div>
                  </div>
                </div>
                <div class="grid grid-cols-2 gap-2 pt-2">
                  <button
                    onclick="applyResize()"
                    class="py-2 bg-slate-800 text-[10px] font-bold rounded border border-slate-700 hover:bg-slate-700"
                  >
                    Apply Resize
                  </button>
                  <button
                    onclick="clearCanvas()"
                    class="py-2 bg-red-950/30 text-red-500 text-[10px] font-bold rounded border border-red-900/40 hover:bg-red-900/30"
                  >
                    Clear All
                  </button>
                </div>
                <div class="mt-4 flex justify-end">
                  <button onclick="settingsManager.open()" class="flex items-center gap-2 px-3 py-2 bg-slate-800 hover:bg-slate-700 text-[10px] font-bold text-slate-300 rounded border border-slate-700 transition-colors">
                    <svg width="14" height="14" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"/><path d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/></svg>
                    All Settings
                  </button>
                </div>
              </div>
              </div>
            </div>
          </div>

          <!-- Section: Appearance -->
          <div class="border-b border-slate-800">
            <button
              onclick="toggleAccordion(this)"
              class="accordion-header w-full px-5 py-3 flex justify-between items-center hover:bg-white/5 transition-colors bg-slate-900/20"
            >
              <span class="text-[10px] font-bold text-blue-400 uppercase tracking-widest">APPEARANCE</span>
              <svg
                width="12"
                height="12"
                fill="none"
                stroke="currentColor"
                stroke-width="2.5"
                viewBox="0 0 24 24"
              >
                <path d="M19 9l-7 7-7-7" />
              </svg>
            </button>
            <div class="accordion-content">
              <div class="min-h-0 overflow-hidden">
              <div class="px-5 pb-6 space-y-4">
                <div>
                  <label
                    class="text-[9px] text-slate-500 font-bold uppercase block mb-1.5"
                    >Block Style</label
                  >
                  <div class="relative">
                    <select
                      id="prop-style"
                      onchange="updateStyle()"
                      class="w-full bg-slate-950 border border-slate-800 rounded px-3 py-2 text-xs text-slate-300 outline-none focus:border-blue-500 appearance-none cursor-pointer hover:border-blue-500 transition-colors"
                    >
                      <option value="original">Original</option>
                      <option value="modern">Block Architect Pro</option>
                    </select>
                    <div
                      class="absolute right-3 top-1/2 -translate-y-1/2 pointer-events-none text-slate-500"
                    >
                      <svg
                        width="10"
                        height="10"
                        fill="none"
                        stroke="currentColor"
                        stroke-width="2"
                        viewBox="0 0 24 24"
                      >
                        <path d="M19 9l-7 7-7-7" />
                      </svg>
                    </div>
                  </div>
                </div>
                <div class="grid grid-cols-2 gap-3">
                    <label class="flex items-center gap-2 cursor-pointer group">
                      <span
                        class="text-[9px] font-bold text-slate-400 group-hover:text-slate-200 uppercase tracking-wider"
                        >Show Grid</span
                      >
                      <div class="relative">
                        <input
                          type="checkbox"
                          id="opt-showgrid"
                          class="sr-only peer"
                          checked
                          onchange="toggleGrid()"
                        />
                        <div
                          class="w-7 h-4 bg-slate-900 border border-slate-700 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-slate-500 after:border-gray-300 after:border after:rounded-full after:h-3 after:w-3 after:transition-all peer-checked:bg-blue-600 peer-checked:border-blue-500 peer-checked:after:bg-white"
                        ></div>
                      </div>
                    </label>
                    <label
                      class="flex items-center gap-2 cursor-pointer group"
                    >
                      <span
                        class="text-[9px] font-bold text-slate-400 group-hover:text-slate-200 uppercase tracking-wider"
                        >Show Minimap</span
                      >
                      <div class="relative">
                        <input
                          type="checkbox"
                          id="opt-minimap"
                          class="sr-only peer"
                          checked
                          onchange="minimap.toggleVisibility()"
                        />
                        <div
                          class="w-7 h-4 bg-slate-900 border border-slate-700 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-slate-500 after:border-gray-300 after:border after:rounded-full after:h-3 after:w-3 after:transition-all peer-checked:bg-blue-600 peer-checked:border-blue-500 peer-checked:after:bg-white"
                        ></div>
                      </div>
                    </label>
                  </div>
                </div>
              </div>
              </div>
            </div>
          </div>

          <!-- Section 2: Templates -->
          <div class="border-b border-slate-800">
            <button
              onclick="toggleAccordion(this)"
              class="accordion-header w-full px-5 py-3 flex justify-between items-center hover:bg-white/5 transition-colors bg-slate-900/20"
            >
              <span class="text-[10px] font-bold text-blue-400 uppercase tracking-widest">STRUCTURE TEMPLATES</span>
              <svg
                width="12"
                height="12"
                fill="none"
                stroke="currentColor"
                stroke-width="2.5"
                viewBox="0 0 24 24"
              >
                <path d="M19 9l-7 7-7-7" />
              </svg>
            </button>
            <div class="accordion-content">
              <div class="min-h-0 overflow-hidden">
              <div class="px-5 pb-6 space-y-2" id="recent-templates-list">
                <!-- Recent templates injected here -->
                <button
                  onclick="openTemplatesModal()"
                  class="w-full py-2 mt-3 bg-slate-800 text-[10px] font-bold rounded border border-slate-700 hover:bg-slate-700 text-blue-400"
                >
                  Browse Full Library
                </button>
              </div>
              </div>
            </div>
          </div>

          <!-- Section: Music -->
          <div class="border-b border-slate-800">
            <button
              onclick="toggleAccordion(this)"
              class="accordion-header w-full px-5 py-3 flex justify-between items-center hover:bg-white/5 transition-colors bg-slate-900/20"
            >
              <span class="text-[10px] font-bold text-blue-400 uppercase tracking-widest">MUSIC</span>
              <svg
                width="12"
                height="12"
                fill="none"
                stroke="currentColor"
                stroke-width="2.5"
                viewBox="0 0 24 24"
              >
                <path d="M19 9l-7 7-7-7" />
              </svg>
            </button>
            <div class="accordion-content">
              <div class="min-h-0 overflow-hidden">
              <div class="px-5 pb-6 space-y-2" id="music-list">
                <!-- Music injected here -->
              </div>
              </div>
            </div>
          </div>

          <!-- Section 4: Diagnostics -->
          <div class="border-b border-slate-800">
            <button
              onclick="toggleAccordion(this)"
              class="accordion-header w-full px-5 py-3 flex justify-between items-center hover:bg-white/5 transition-colors bg-slate-900/20"
            >
              <span class="text-[10px] font-bold text-blue-400 uppercase tracking-widest">LEVEL CHECK</span>
              <svg
                width="12"
                height="12"
                fill="none"
                stroke="currentColor"
                stroke-width="2.5"
                viewBox="0 0 24 24"
              >
                <path d="M19 9l-7 7-7-7" />
              </svg>
            </button>
            <div class="accordion-content">
              <div class="min-h-0 overflow-hidden">
              <div class="px-5 pb-6">
                <div
                  id="stats"
                  class="bg-slate-950 p-4 rounded-lg border border-slate-800 text-[11px] space-y-2 mb-4"
                >
                  <div class="flex justify-between">
                    <span class="text-slate-500">Collectibles</span
                    ><span id="stat-coins" class="text-white font-mono">0</span>
                  </div>
                  <div class="flex justify-between">
                    <span class="text-slate-500">Blue Coins</span
                    ><span id="stat-blue" class="text-white font-mono">NO</span>
                  </div>
                  <div class="flex justify-between">
                    <span class="text-slate-500">Spawn Point</span
                    ><span id="stat-player" class="text-slate-500 italic"
                      >None</span
                    >
                  </div>
                </div>
                <button
                  onclick="validateLevel()"
                  class="w-full py-2 bg-blue-600/10 text-blue-400 font-bold rounded border border-blue-600/30 hover:bg-blue-600/20 text-xs"
                >
                  Check Level
                </button>
                <div
                  id="val-feedback"
                  class="mt-3 text-[10px] p-3 rounded border border-slate-800 hidden leading-relaxed"
                ></div>
              </div>
              </div>
            </div>
          </div>
        </div>
      </aside>

      <!-- Floating Restore Button -->
      <button
        id="restore-panel"
        onclick="toggleRightPanel()"
        class="fixed right-6 bottom-14 w-12 h-12 bg-blue-600 text-white rounded-full shadow-2xl items-center justify-center z-50 hidden hover:scale-110 flex transition-all"
      >
        <svg
          width="22"
          height="22"
          fill="none"
          stroke="currentColor"
          stroke-width="2.5"
          viewBox="0 0 24 24"
        >
          <path d="M11 19l-7-7 7-7M20 12H4" />
        </svg>
      </button>
    </div>

    <!-- STARTUP MODAL -->
    <div
      id="start-modal"
      class="fixed inset-0 z-[200] flex items-center justify-center p-6 bg-slate-950/95 backdrop-blur-md"
    >
      <div
        class="bg-[#0f121a] border border-slate-800 w-full max-w-5xl rounded-2xl shadow-2xl flex overflow-hidden h-[600px]"
      >
        <!-- Left: New Project -->
        <div
          class="w-5/12 bg-[#0a0c12] border-r border-slate-800 flex flex-col"
        >
          <div class="p-8 pb-4">
            <div class="mb-8">
              <h1
                class="font-black text-2xl text-white tracking-tight uppercase flex items-center gap-2"
              >
                <span class="text-blue-500 text-3xl">■</span> Block Architect
                <span
                  class="text-slate-600 text-sm bg-slate-900 px-1.5 py-0.5 rounded border border-slate-800 align-middle"
                  >Pro</span
                >
              </h1>
              <p class="text-slate-500 text-xs mt-1 ml-8">
                Advanced Level Editor for Block Over It
              </p>
            </div>

            <div class="grid grid-cols-2 gap-3 mb-6">
              <button
                onclick="projectManager.newProject()"
                class="p-4 bg-slate-900 border border-slate-800 rounded-xl hover:border-blue-500 transition-all text-left group"
              >
                <div
                  class="font-bold text-slate-200 text-xs group-hover:text-blue-400 mb-1"
                >
                  Blank Canvas
                </div>
                <div class="text-[9px] text-slate-500">40x20 Grid</div>
              </button>
              <button
                onclick="document.getElementById('menu-upload').click()"
                class="p-4 bg-slate-900 border border-slate-800 rounded-xl hover:border-blue-500 transition-all text-left group"
              >
                <div
                  class="font-bold text-slate-200 text-xs group-hover:text-blue-400 mb-1"
                >
                  Upload File
                </div>
                <div class="text-[9px] text-slate-500">Import JSON</div>
              </button>
              <input
                type="file"
                id="menu-upload"
                class="hidden"
                accept=".json"
                onchange="projectManager.importFromMenu(this)"
              />
            </div>

            <div
              class="text-[10px] font-bold text-slate-500 uppercase tracking-widest mb-3 flex justify-between items-center"
            >
              Featured Templates
              <button
                class="text-[9px] font-bold text-blue-400 bg-blue-500/10 hover:bg-blue-500/20 px-2 py-1 rounded-full transition-colors"
                onclick="openTemplatesModal()"
              >
                View All
              </button>
            </div>
          </div>

          <div
            id="menu-templates"
            class="flex-1 overflow-y-auto px-8 pb-8 space-y-2"
          >
            <!-- Templates injected here -->
          </div>
        </div>

        <!-- Right: Recent Projects -->
        <div class="flex-1 p-8 bg-[#0f121a] flex flex-col">
          <div class="flex justify-between items-end mb-6">
            <div>
              <h2 class="text-xl font-bold mb-1 text-white">My Projects</h2>
              <p class="text-slate-500 text-xs">Local browser storage.</p>
            </div>
            <select
              id="project-sort"
              onchange="projectManager.renderList()"
              class="bg-slate-900 border border-slate-800 text-slate-400 text-[10px] rounded px-2 py-1 outline-none focus:border-blue-500 cursor-pointer"
            >
              <option value="date">Sort: Date</option>
              <option value="name">Sort: Name</option>
            </select>
          </div>

          <div id="project-list" class="flex-1 overflow-y-auto space-y-2 pr-2">
            <!-- Projects injected here -->
          </div>
        </div>
      </div>
    </div>

    <!-- TEMPLATES MODAL -->
    <div
      id="templates-modal"
      class="fixed inset-0 z-[200] hidden flex items-center justify-center p-12 bg-black/80 backdrop-blur-sm"
    >
      <div
        class="bg-[#0f121a] border border-slate-800 w-full max-w-4xl rounded-xl shadow-2xl flex flex-col max-h-full overflow-hidden"
      >
        <div
          class="p-4 border-b border-slate-800 flex justify-between items-center bg-slate-900/50"
        >
          <div class="flex gap-4 items-center w-full">
            <h2
              class="text-xs font-bold text-slate-400 tracking-widest uppercase whitespace-nowrap"
            >
              Template Library
            </h2>
            <div class="relative w-full max-w-xs">
              <i
                class="absolute left-2.5 top-1/2 -translate-y-1/2 text-slate-500"
                ><svg
                  width="12"
                  height="12"
                  fill="none"
                  stroke="currentColor"
                  stroke-width="2"
                  viewBox="0 0 24 24"
                >
                  <path
                    d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"
                  /></svg></i
              ><input
                type="text"
                id="tpl-search"
                placeholder="Search templates..."
                class="w-full bg-slate-950 border border-slate-800 rounded-full pl-8 pr-3 py-1.5 text-xs text-slate-300 outline-none focus:border-blue-500 transition-colors"
                oninput="renderTemplates()"
              />
            </div>
          </div>
          <button
            onclick="closeModal('templates-modal')"
            class="text-slate-500 hover:text-white p-1 ml-4"
          >
            <svg
              width="20"
              height="20"
              fill="none"
              stroke="currentColor"
              stroke-width="2"
              viewBox="0 0 24 24"
            >
              <path d="M6 18L18 6M6 6l12 12" />
            </svg>
          </button>
        </div>
        <div
          id="templates-grid"
          class="flex-1 p-6 overflow-y-auto grid grid-cols-3 gap-4 content-start bg-[#0a0c12]"
        ></div>
      </div>
    </div>

    <!-- SAVE TEMPLATE MODAL -->
    <div
      id="save-template-modal"
      class="fixed inset-0 z-[250] hidden flex items-center justify-center p-6 bg-black/80 backdrop-blur-sm"
    >
      <div
        class="bg-[#0f121a] border border-slate-800 w-full max-w-md rounded-xl shadow-2xl overflow-hidden"
      >
        <div
          class="p-4 border-b border-slate-800 bg-slate-900/50 flex justify-between items-center"
        >
          <h3
            class="text-xs font-bold text-slate-200 uppercase tracking-widest"
          >
            Save Template
          </h3>
          <button
            onclick="closeModal('save-template-modal')"
            class="text-slate-500 hover:text-white"
          >
            <svg
              width="16"
              height="16"
              fill="none"
              stroke="currentColor"
              stroke-width="2"
              viewBox="0 0 24 24"
            >
              <path d="M6 18L18 6M6 6l12 12" />
            </svg>
          </button>
        </div>
        <div class="p-0">
          <div class="flex border-b border-slate-800" id="st-tabs">
            <button
              onclick="templateSaver.switchTab('new')"
              id="st-tab-new"
              class="flex-1 py-3 text-xs font-bold text-blue-400 border-b-2 border-blue-500 bg-slate-900/30 transition-colors"
            >
              Save as New
            </button>
            <button
              onclick="templateSaver.switchTab('replace')"
              id="st-tab-replace"
              class="flex-1 py-3 text-xs font-bold text-slate-500 hover:text-slate-300 border-b-2 border-transparent transition-colors"
            >
              Replace Existing
            </button>
          </div>
          <div class="p-6" id="st-content-new">
            <label
              class="text-[9px] text-slate-500 font-bold uppercase block mb-1.5"
              >Template Name</label
            >
            <input
              type="text"
              id="st-name-new"
              class="w-full bg-slate-950 border border-slate-800 rounded px-3 py-2 text-xs text-white outline-none focus:border-blue-500 mb-4"
            />
            <p class="text-[10px] text-slate-500">
              This will create a new entry in your custom templates library.
            </p>
          </div>
          <div class="p-0 hidden" id="st-content-replace">
            <div
              id="st-list"
              class="max-h-64 overflow-y-auto p-2 space-y-1"
            ></div>
          </div>
        </div>
        <div
          class="p-4 border-t border-slate-800 bg-slate-900/50 flex justify-end gap-2"
        >
          <button
            onclick="closeModal('save-template-modal')"
            class="px-4 py-2 bg-slate-800 hover:bg-slate-700 text-slate-300 text-xs font-bold rounded"
          >
            Cancel
          </button>
          <button
            onclick="templateSaver.confirm()"
            class="px-4 py-2 bg-blue-600 hover:bg-blue-500 text-white text-xs font-bold rounded shadow-lg shadow-blue-600/20"
          >
            Save Template
          </button>
        </div>
      </div>
    </div>

    <!-- PREVIEW MODAL -->
    <div
      id="modal-overlay"
      class="fixed inset-0 z-[100] hidden flex items-center justify-center p-12 bg-black/80 backdrop-blur-sm"
    >
      <div
        class="bg-[#0f121a] border border-slate-800 w-full max-w-2xl rounded-xl shadow-2xl flex flex-col max-h-full overflow-hidden"
      >
        <div
          class="p-4 border-b border-slate-800 flex justify-between items-center bg-slate-900/50"
        >
          <h2
            class="text-xs font-bold text-slate-400 tracking-widest uppercase"
          >
            Export Manifest
          </h2>
          <button
            onclick="closeModal('modal-overlay')"
            class="text-slate-500 hover:text-white p-1"
          >
            <svg
              width="20"
              height="20"
              fill="none"
              stroke="currentColor"
              stroke-width="2"
              viewBox="0 0 24 24"
            >
              <path d="M6 18L18 6M6 6l12 12" />
            </svg>
          </button>
        </div>
        <pre
          id="json-preview-text"
          class="flex-1 p-8 overflow-auto text-blue-400 font-mono text-xs leading-relaxed bg-black/30 select-all"
        ></pre>
        <div
          class="p-4 border-t border-slate-800 flex justify-end gap-3 bg-slate-900/50"
        >
          <button
            onclick="io.copyToClipboard()"
            class="px-6 py-2 bg-slate-800 text-white text-[11px] font-bold rounded border border-slate-700"
          >
            Copy to Clipboard
          </button>
          <button
            onclick="io.downloadJson()"
            class="px-6 py-2 bg-blue-600 text-white text-[11px] font-bold rounded"
          >
            Download Manifest
          </button>
        </div>
      </div>
    </div>

    <!-- EXPORT MODAL -->
    <div
      id="export-modal"
      class="fixed inset-0 z-[300] hidden flex items-center justify-center p-6 bg-black/90 backdrop-blur-md"
    >
      <div
        class="bg-[#0f121a] border border-slate-800 w-full max-w-6xl h-[90vh] rounded-xl shadow-2xl flex overflow-hidden"
      >
        <!-- Left: Preview -->
        <div class="flex-1 bg-[#020617] relative flex flex-col overflow-hidden">
          <div
            class="h-12 border-b border-slate-800 bg-[#0f121a] flex items-center justify-between px-4 z-10 shrink-0"
          >
            <div class="flex items-center gap-2">
              <span
                class="text-xs font-bold text-slate-500 uppercase tracking-wider mr-2"
                >Preview</span
              >
            </div>
            <div class="text-[10px] text-slate-600">
              <span id="exp-dims">0 x 0</span> px
            </div>
          </div>
          <div
            id="export-viewport"
            class="flex-1 overflow-auto p-8 bg-[url('data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMjAiIGhlaWdodD0iMjAiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+PHBhdGggZD0iTTEwIDBoMTB2MTBIMTB6TTAgMTBoMTB2MTBIMHoiIGZpbGw9IiMxZTI5M2IiIGZpbGwtb3BhY2l0eT0iMC4wNSIvPjwvc3ZnPg==')] grid place-items-center"
          >
            <canvas
              id="export-canvas"
              class="shadow-2xl shadow-black cursor-move transition-all duration-200 mx-auto block"
            ></canvas>
          </div>
          <div
            class="absolute bottom-4 left-4 text-[10px] text-slate-500 pointer-events-none bg-black/50 px-2 py-1 rounded backdrop-blur-sm"
          >
            Drag player to reposition • Use toolbar to zoom
          </div>
        </div>

        <!-- Right: Settings -->
        <div class="w-80 bg-[#0f121a] border-l border-slate-800 flex flex-col">
          <div
            class="p-4 border-b border-slate-800 font-bold text-slate-200 text-sm flex items-center gap-2"
          >
            <svg
              width="16"
              height="16"
              fill="none"
              stroke="currentColor"
              stroke-width="2"
              viewBox="0 0 24 24"
            >
              <path
                d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"
              />
            </svg>
            Image Settings
          </div>
          <div class="flex-1 overflow-y-auto" id="export-settings-container">
            <!-- Settings Group -->
            <div class="flex flex-col">
              <!-- Appearance -->
              <div class="border-b border-slate-800 accordion-open">
                <button
                  onclick="toggleAccordion(this)"
                  class="accordion-header w-full px-5 py-3 flex justify-between items-center hover:bg-white/5 transition-colors bg-slate-900/20"
                >
                  <span
                    class="text-[10px] font-bold text-blue-400 uppercase tracking-widest"
                    >Appearance</span
                  >
                  <svg
                    width="12"
                    height="12"
                    fill="none"
                    stroke="currentColor"
                    stroke-width="2.5"
                    viewBox="0 0 24 24"
                  >
                    <path d="M19 9l-7 7-7-7" />
                  </svg>
                </button>
                <div class="accordion-content">
                  <div class="min-h-0 overflow-hidden">
                  <div class="p-5 space-y-3">
                    <div>
                      <label
                        class="text-[9px] text-slate-500 font-bold uppercase block mb-1.5"
                        >Theme</label
                      >
                      <select
                        id="exp-style"
                        onchange="exportManager.update()"
                        class="w-full bg-slate-950 border border-slate-800 rounded px-3 py-2 text-xs text-slate-300 outline-none focus:border-blue-500"
                      >
                        <option value="original">Original (Classic)</option>
                        <option value="modern">Modern (Flat)</option>
                      </select>
                    </div>

                    <label
                      class="flex items-center justify-between cursor-pointer group"
                    >
                      <span
                        class="text-[9px] font-bold text-slate-400 group-hover:text-slate-200 uppercase tracking-wider"
                        >Show Grid Lines</span
                      >
                      <div class="relative">
                        <input
                          type="checkbox"
                          id="exp-grid"
                          onchange="exportManager.update()"
                          class="sr-only peer"
                        />
                        <div
                          class="w-9 h-5 bg-slate-900 border border-slate-700 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-slate-500 after:border-gray-300 after:border after:rounded-full after:h-4 after:w-4 after:transition-all peer-checked:bg-blue-600 peer-checked:border-blue-500 peer-checked:after:bg-white"
                        ></div>
                      </div>
                    </label>

                    <label
                      class="flex items-center justify-between cursor-pointer group"
                    >
                      <span
                        class="text-[9px] font-bold text-slate-400 group-hover:text-slate-200 uppercase tracking-wider"
                        >Show Player</span
                      >
                      <div class="relative">
                        <input
                          type="checkbox"
                          id="exp-show-player"
                          onchange="exportManager.update()"
                          checked
                          class="sr-only peer"
                        />
                        <div
                          class="w-9 h-5 bg-slate-900 border border-slate-700 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-slate-500 after:border-gray-300 after:border after:rounded-full after:h-4 after:w-4 after:transition-all peer-checked:bg-blue-600 peer-checked:border-blue-500 peer-checked:after:bg-white"
                        ></div>
                      </div>
                    </label>

                    <label
                      class="flex items-center justify-between cursor-pointer group"
                    >
                      <span
                        class="text-[9px] font-bold text-slate-400 group-hover:text-slate-200 uppercase tracking-wider"
                        >Alt Blue Coin Style</span
                      >
                      <div class="relative">
                        <input
                          type="checkbox"
                          id="exp-alt-coin"
                          onchange="exportManager.update()"
                          class="sr-only peer"
                        />
                        <div
                          class="w-9 h-5 bg-slate-900 border border-slate-700 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-slate-500 after:border-gray-300 after:border after:rounded-full after:h-4 after:w-4 after:transition-all peer-checked:bg-blue-600 peer-checked:border-blue-500 peer-checked:after:bg-white"
                        ></div>
                      </div>
                    </label>
                  </div>
                  </div>
                </div>
              </div>

              <!-- Effects -->
              <div class="border-b border-slate-800">
                <button
                  onclick="toggleAccordion(this)"
                  class="accordion-header w-full px-5 py-3 flex justify-between items-center hover:bg-white/5 transition-colors bg-slate-900/20"
                >
                  <span
                    class="text-[10px] font-bold text-blue-400 uppercase tracking-widest"
                    >Simulation</span
                  >
                  <svg
                    width="12"
                    height="12"
                    fill="none"
                    stroke="currentColor"
                    stroke-width="2.5"
                    viewBox="0 0 24 24"
                  >
                    <path d="M19 9l-7 7-7-7" />
                  </svg>
                </button>
                <div class="accordion-content">
                  <div class="min-h-0 overflow-hidden">
                  <div class="p-5 space-y-3">
                    <div>
                      <div class="flex justify-between mb-1.5">
                        <label
                          class="text-[9px] text-slate-500 font-bold uppercase"
                          >Simulation</label
                        >
                        <span class="text-[10px] text-blue-400 font-mono"
                          ><span id="exp-ticks-val">0</span> ticks</span
                        >
                      </div>
                      <input
                        type="range"
                        id="exp-ticks"
                        min="0"
                        max="200"
                        value="0"
                        oninput="exportManager.update()"
                        class="w-full h-1 bg-slate-800 rounded-lg appearance-none accent-blue-500"
                      />
                    </div>
                  </div>
                  </div>
                </div>
              </div>

              <!-- Layout -->
              <div class="border-b border-slate-800">
                <button
                  onclick="toggleAccordion(this)"
                  class="accordion-header w-full px-5 py-3 flex justify-between items-center hover:bg-white/5 transition-colors bg-slate-900/20"
                >
                  <span
                    class="text-[10px] font-bold text-blue-400 uppercase tracking-widest"
                    >Layout</span
                  >
                  <svg
                    width="12"
                    height="12"
                    fill="none"
                    stroke="currentColor"
                    stroke-width="2.5"
                    viewBox="0 0 24 24"
                  >
                    <path d="M19 9l-7 7-7-7" />
                  </svg>
                </button>
                <div class="accordion-content">
                  <div class="min-h-0 overflow-hidden">
                  <div class="p-5 space-y-3">
                    <div>
                      <div class="flex justify-between mb-1.5">
                        <label
                          class="text-[9px] text-slate-500 font-bold uppercase"
                          >Padding</label
                        >
                        <span class="text-[10px] text-blue-400 font-mono"
                          ><span id="exp-pad-val">20</span>px</span
                        >
                      </div>
                      <input
                        type="range"
                        id="exp-padding"
                        min="0"
                        max="100"
                        value="20"
                        oninput="exportManager.update()"
                        class="w-full h-1 bg-slate-800 rounded-lg appearance-none accent-blue-500"
                      />
                    </div>
                    <div>
                      <label
                        class="text-[9px] text-slate-500 font-bold uppercase block mb-1.5"
                        >Output Scale</label
                      >
                      <div class="grid grid-cols-3 gap-2">
                        <button
                          onclick="exportManager.setScale(1)"
                          id="btn-scale-1"
                          class="py-2 bg-blue-600 text-white text-[10px] font-bold rounded border border-blue-500"
                        >
                          1x
                        </button>
                        <button
                          onclick="exportManager.setScale(2)"
                          id="btn-scale-2"
                          class="py-2 bg-slate-900 text-slate-400 hover:text-white text-[10px] font-bold rounded border border-slate-800"
                        >
                          2x
                        </button>
                        <button
                          onclick="exportManager.setScale(4)"
                          id="btn-scale-4"
                          class="py-2 bg-slate-900 text-slate-400 hover:text-white text-[10px] font-bold rounded border border-slate-800"
                        >
                          4x
                        </button>
                      </div>
                    </div>
                  </div>
                  </div>
                </div>
              </div>

              <!-- Watermark -->
              <div class="border-b border-slate-800">
                <button
                  onclick="toggleAccordion(this)"
                  class="accordion-header w-full px-5 py-3 flex justify-between items-center hover:bg-white/5 transition-colors bg-slate-900/20"
                >
                  <span
                    class="text-[10px] font-bold text-blue-400 uppercase tracking-widest"
                    >Watermark</span
                  >
                  <svg
                    width="12"
                    height="12"
                    fill="none"
                    stroke="currentColor"
                    stroke-width="2.5"
                    viewBox="0 0 24 24"
                  >
                    <path d="M19 9l-7 7-7-7" />
                  </svg>
                </button>
                <div class="accordion-content">
                  <div class="min-h-0 overflow-hidden">
                  <div class="p-5 space-y-3">
                    <div>
                      <label
                        class="text-[9px] text-slate-500 font-bold uppercase block mb-1.5"
                        >Text</label
                      >
                      <input
                        type="text"
                        id="exp-watermark"
                        placeholder="Enter text..."
                        oninput="exportManager.update()"
                        class="w-full bg-slate-950 border border-slate-800 rounded px-3 py-2 text-xs text-slate-300 outline-none focus:border-blue-500"
                      />
                    </div>

                    <div class="grid grid-cols-2 gap-3">
                      <div>
                        <label
                          class="text-[9px] text-slate-500 font-bold uppercase block mb-1.5"
                          >Color</label
                        >
                        <button
                          id="exp-wm-color-btn"
                          onclick="openColorPickerForWatermark()"
                          class="w-full h-8 bg-slate-950 border border-slate-800 rounded flex items-center justify-center gap-2 hover:border-blue-500 transition-colors"
                        >
                          <div
                            id="exp-wm-color-preview"
                            class="w-4 h-4 rounded-full bg-white border border-slate-700"
                          ></div>
                          <span class="text-[10px] text-slate-400">Select</span>
                        </button>
                      </div>
                      <div>
                        <label
                          class="text-[9px] text-slate-500 font-bold uppercase block mb-1.5"
                          >Position</label
                        >
                        <select
                          id="exp-wm-position"
                          onchange="exportManager.update()"
                          class="w-full bg-slate-950 border border-slate-800 rounded px-2 py-1.5 text-[10px] text-slate-300 outline-none focus:border-blue-500"
                        >
                          <option value="bottom-right">Bottom Right</option>
                          <option value="bottom-left">Bottom Left</option>
                          <option value="top-right">Top Right</option>
                          <option value="top-left">Top Left</option>
                        </select>
                      </div>
                    </div>

                    <div>
                      <div class="flex justify-between mb-1.5">
                        <label
                          class="text-[9px] text-slate-500 font-bold uppercase"
                          >Size</label
                        >
                        <span class="text-[10px] text-blue-400 font-mono"
                          ><span id="exp-wm-size-val">20</span>px</span
                        >
                      </div>
                      <input
                        type="range"
                        id="exp-wm-size"
                        min="10"
                        max="100"
                        value="20"
                        oninput="
                          exportManager.update();
                          document.getElementById('exp-wm-size-val').innerText =
                            this.value;
                        "
                        class="w-full h-1 bg-slate-800 rounded-lg appearance-none accent-blue-500"
                      />
                    </div>

                    <div>
                      <div class="flex justify-between mb-1.5">
                        <label
                          class="text-[9px] text-slate-500 font-bold uppercase"
                          >Opacity</label
                        >
                        <span class="text-[10px] text-blue-400 font-mono"
                          ><span id="exp-wm-opacity-val">100</span>%</span
                        >
                      </div>
                      <input
                        type="range"
                        id="exp-wm-opacity"
                        min="0"
                        max="1"
                        step="0.1"
                        value="1"
                        oninput="
                          exportManager.update();
                          document.getElementById(
                            'exp-wm-opacity-val',
                          ).innerText = Math.round(this.value * 100);
                        "
                        class="w-full h-1 bg-slate-800 rounded-lg appearance-none accent-blue-500"
                      />
                    </div>
                  </div>
                  </div>
                </div>
              </div>
              <!-- End Watermark -->
            </div>
          </div>
          <div class="p-4 border-t border-slate-800 flex gap-2">
            <button
              onclick="closeModal('export-modal')"
              class="flex-1 py-2 bg-slate-800 hover:bg-slate-700 text-slate-300 text-xs font-bold rounded"
            >
              Cancel
            </button>
            <button
              onclick="exportManager.download()"
              class="flex-1 py-2 bg-blue-600 hover:bg-blue-500 text-white text-xs font-bold rounded shadow-lg shadow-blue-600/20"
            >
              Download
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- INFO MODAL -->
    <div
      id="info-modal"
      class="fixed inset-0 z-[250] hidden flex items-center justify-center p-6 bg-black/80 backdrop-blur-sm"
    >
      <div
        class="bg-[#0f121a] border border-slate-800 w-full max-w-sm rounded-xl shadow-2xl p-6"
      >
        <h3 id="info-title" class="text-lg font-bold text-white mb-2">Info</h3>
        <p
          id="info-text"
          class="text-sm text-slate-400 leading-relaxed mb-6"
        ></p>
        <div class="flex justify-end">
          <button
            onclick="closeModal('info-modal')"
            class="px-4 py-2 bg-slate-800 hover:bg-slate-700 text-white text-xs font-bold rounded border border-slate-700"
          >
            Close
          </button>
        </div>
      </div>
    </div>

    <!-- DIALOG MODAL -->
    <div
      id="dialog-modal"
      class="fixed inset-0 z-[300] hidden flex items-center justify-center p-6 bg-black/80 backdrop-blur-sm"
    >
      <div
        class="bg-[#0f121a] border border-slate-800 w-full max-w-sm rounded-xl shadow-2xl p-6 transform transition-all scale-100"
      >
        <h3 id="dialog-title" class="text-lg font-bold text-white mb-2">
          Title
        </h3>
        <p
          id="dialog-message"
          class="text-sm text-slate-400 leading-relaxed mb-4"
        >
          Message
        </p>
        <input
          type="text"
          id="dialog-input"
          class="w-full bg-slate-950 border border-slate-800 rounded px-3 py-2 text-xs text-white outline-none focus:border-blue-500 mb-4 hidden"
        />
        <div class="flex justify-end gap-2" id="dialog-buttons"></div>
      </div>
    </div>

    <!-- COLOR PICKER MODAL -->
    <div
      id="color-picker-modal"
      class="fixed inset-0 z-[400] hidden flex items-center justify-center p-6 bg-black/80 backdrop-blur-sm"
    >
      <div
        class="bg-[#0f121a] border border-slate-800 w-full max-w-xs rounded-xl shadow-2xl p-5"
      >
        <h3
          class="text-xs font-bold text-slate-400 uppercase tracking-widest mb-4"
        >
          Select Color
        </h3>

        <div class="mb-4">
          <label
            class="text-[9px] text-slate-500 font-bold uppercase block mb-2"
            >Basic Colors</label
          >
          <div id="cp-recent" class="flex flex-wrap gap-2">
            <!-- Recent colors injected here -->
          </div>
        </div>

        <div class="mb-6">
          <label
            class="text-[9px] text-slate-500 font-bold uppercase block mb-2"
            >Custom</label
          >
          <div class="flex gap-2">
            <input
              type="color"
              id="cp-input"
              class="h-9 w-12 bg-transparent border border-slate-700 rounded cursor-pointer p-0.5"
              onchange="colorPicker.handleCustom(this.value)"
            />
            <input
              type="text"
              id="cp-text"
              class="flex-1 bg-slate-950 border border-slate-800 rounded px-3 text-xs text-slate-300 font-mono outline-none focus:border-blue-500"
              onchange="colorPicker.handleCustom(this.value)"
            />
          </div>
        </div>

        <div class="flex justify-end gap-2">
          <button
            onclick="colorPicker.clear()"
            class="px-4 py-2 bg-red-950/30 hover:bg-red-900/50 text-red-400 text-xs font-bold rounded border border-red-900/50 mr-auto"
          >
            Clear Paint
          </button>
          <button
            onclick="
              document
                .getElementById('color-picker-modal')
                .classList.add('hidden')
            "
            class="px-4 py-2 bg-slate-800 hover:bg-slate-700 text-slate-300 text-xs font-bold rounded"
          >
            Cancel
          </button>
          <button
            onclick="colorPicker.confirm()"
            class="px-4 py-2 bg-blue-600 hover:bg-blue-500 text-white text-xs font-bold rounded"
          >
            Apply
          </button>
        </div>
      </div>
    </div>

    <!-- ALL SETTINGS MODAL -->
    <div id="settings-modal" class="fixed inset-0 z-[350] hidden flex items-center justify-center p-6 bg-black/80 backdrop-blur-sm">
      <div class="bg-[#0f121a] border border-slate-800 w-full max-w-4xl h-[600px] rounded-xl shadow-2xl flex overflow-hidden">
        <!-- Sidebar -->
        <div class="w-64 bg-[#0a0c12] border-r border-slate-800 flex flex-col p-4">
          <div class="mb-6">
            <h2 class="text-lg font-bold text-white px-2 mb-4">Settings</h2>
          </div>
          <div class="space-y-1">
            <button onclick="settingsManager.switchTab('metadata')" id="tab-metadata" class="settings-tab w-full active">Metadata</button>
            <button onclick="settingsManager.switchTab('physics')" id="tab-physics" class="settings-tab w-full">Physics</button>
            <button onclick="settingsManager.switchTab('grid')" id="tab-grid" class="settings-tab w-full">Grid</button>
          </div>
        </div>
        <!-- Content -->
        <div class="flex-1 bg-[#0f121a] flex flex-col relative">
          <div class="absolute top-4 right-4">
            <button onclick="settingsManager.close()" class="text-slate-500 hover:text-white p-1">
              <svg width="20" height="20" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M6 18L18 6M6 6l12 12"/></svg>
            </button>
          </div>
          
          <div id="settings-content" class="flex-1 overflow-y-auto p-8">
            <!-- Metadata Section -->
            <div id="sec-metadata" class="space-y-6">
              <h3 class="text-sm font-bold text-blue-400 uppercase tracking-widest border-b border-slate-800 pb-2 mb-4">Metadata</h3>
              <div class="grid grid-cols-2 gap-6">
                <div class="setting-item">
                  <label class="text-[10px] text-slate-500 font-bold uppercase block mb-2">Level Identifier</label>
                  <input id="set-prop-name" type="text" class="w-full bg-slate-950 border border-slate-800 rounded px-3 py-2 text-sm text-white outline-none focus:border-blue-500" oninput="settingsManager.syncFromModal()">
                </div>
                <div class="setting-item">
                  <label class="text-[10px] text-slate-500 font-bold uppercase block mb-2">Creator</label>
                  <input id="set-prop-creator" type="text" class="w-full bg-slate-950 border border-slate-800 rounded px-3 py-2 text-sm text-white outline-none focus:border-blue-500" oninput="settingsManager.syncFromModal()">
                </div>
                <div class="col-span-2 setting-item">
                  <label class="text-[10px] text-slate-500 font-bold uppercase block mb-2">Description</label>
                  <textarea id="set-prop-desc" class="w-full bg-slate-950 border border-slate-800 rounded px-3 py-2 text-sm text-slate-300 outline-none focus:border-blue-500 h-24 resize-none" oninput="settingsManager.syncFromModal()"></textarea>
                </div>
                <div class="setting-item">
                  <label class="text-[10px] text-slate-500 font-bold uppercase block mb-2">Difficulty</label>
                  <div class="flex gap-1 h-8" id="set-diff-bars-modal"></div>
                </div>
              </div>
            </div>

            <!-- Physics Section -->
            <div id="sec-physics" class="space-y-6 hidden">
              <h3 class="text-sm font-bold text-blue-400 uppercase tracking-widest border-b border-slate-800 pb-2 mb-4">Physics</h3>
              <div class="space-y-6 max-w-lg">
                <div class="setting-item">
                  <div class="flex justify-between mb-2">
                    <label class="text-[10px] text-slate-500 font-bold uppercase">Gravity Constant</label>
                    <span id="set-gravity-val" class="text-xs text-blue-400 font-mono">27</span>
                  </div>
                  <input id="set-prop-gravity" type="range" min="5" max="100" class="w-full h-1 bg-slate-800 rounded-lg appearance-none accent-blue-500" oninput="document.getElementById('set-gravity-val').innerText = this.value; settingsManager.syncFromModal()">
                </div>
                <!-- Hidden input for compatibility -->
                <input type="hidden" id="prop-rise" value="0">
                <input type="hidden" id="set-prop-rise" value="0">
                <div class="pt-4 border-t border-slate-800 setting-item">
                  <label class="flex items-center justify-between cursor-pointer group">
                    <span class="text-xs font-bold text-slate-300">Mirror Level (Multiple player spawns)</span>
                    <div class="relative">
                      <input type="checkbox" id="set-prop-mirror" class="sr-only peer" onchange="settingsManager.syncFromModal()">
                      <div class="w-11 h-6 bg-slate-900 border border-slate-700 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-slate-500 after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-blue-600 peer-checked:border-blue-500 peer-checked:after:bg-white"></div>
                    </div>
                  </label>
                </div>
                <div class="pt-4 border-t border-slate-800 setting-item">
                  <label class="flex items-center justify-between cursor-pointer group">
                    <span class="text-xs font-bold text-slate-300">Force Zoomed Camera</span>
                    <div class="relative">
                      <input type="checkbox" id="set-prop-force-zoom" class="sr-only peer" onchange="settingsManager.syncFromModal()">
                      <div class="w-11 h-6 bg-slate-900 border border-slate-700 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-slate-500 after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-blue-600 peer-checked:border-blue-500 peer-checked:after:bg-white"></div>
                    </div>
                  </label>
                </div>
                <div class="pt-4 border-t border-slate-800 setting-item">
                  <label class="flex items-center justify-between cursor-pointer group">
                    <span class="text-xs font-bold text-slate-300">Disable Death Animation</span>
                    <div class="relative">
                      <input type="checkbox" id="set-prop-no-death-anim" class="sr-only peer" onchange="settingsManager.syncFromModal()">
                      <div class="w-11 h-6 bg-slate-900 border border-slate-700 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-slate-500 after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-blue-600 peer-checked:border-blue-500 peer-checked:after:bg-white"></div>
                    </div>
                  </label>
                </div>
              </div>
            </div>

            <!-- Grid Section -->
            <div id="sec-grid" class="space-y-6 hidden">
              <h3 class="text-sm font-bold text-blue-400 uppercase tracking-widest border-b border-slate-800 pb-2 mb-4">Grid Configuration</h3>
              <div class="grid grid-cols-2 gap-6 max-w-lg">
                <div class="setting-item">
                  <label class="text-[10px] text-slate-500 font-bold uppercase block mb-2">Width</label>
                  <input id="set-prop-w" type="number" class="w-full bg-slate-950 border border-slate-800 rounded px-3 py-2 text-sm text-white outline-none focus:border-blue-500" oninput="settingsManager.syncFromModal()">
                </div>
                <div class="setting-item">
                  <label class="text-[10px] text-slate-500 font-bold uppercase block mb-2">Height</label>
                  <input id="set-prop-h" type="number" class="w-full bg-slate-950 border border-slate-800 rounded px-3 py-2 text-sm text-white outline-none focus:border-blue-500" oninput="settingsManager.syncFromModal()">
                </div>
              </div>
              <div class="flex gap-3 pt-4">
                <button onclick="applyResize(); settingsManager.close()" class="px-6 py-2 bg-blue-600 hover:bg-blue-500 text-white text-xs font-bold rounded shadow-lg shadow-blue-600/20">
                  Apply Resize
                </button>
                <button onclick="clearCanvas(); settingsManager.close()" class="px-6 py-2 bg-red-950/30 text-red-500 text-xs font-bold rounded border border-red-900/40 hover:bg-red-900/30">
                  Clear All Blocks
                </button>
              </div>
            </div>
          </div>
          
          <div class="p-4 border-t border-slate-800 bg-slate-900/50 flex justify-end">
            <button id="btn-reset-defaults" onclick="settingsManager.resetToDefaults()" class="hidden mr-auto px-4 py-2 text-red-400 hover:text-red-300 text-xs font-bold rounded hover:bg-red-900/20 transition-colors">
              Reset to Default
            </button>
            <button onclick="settingsManager.close()" class="px-6 py-2 bg-slate-800 hover:bg-slate-700 text-slate-300 text-xs font-bold rounded border border-slate-700">
              Close
            </button>
          </div>
        </div>
      </div>
    </div>

    <footer
      class="h-10 bg-slate-950 border-t border-slate-800 flex items-center px-6 justify-between text-[10px] font-medium text-slate-500 uppercase tracking-widest"
    >
      <div class="flex gap-10">
        <div class="flex items-center gap-2">
          <div
            class="w-1.5 h-1.5 bg-green-500 rounded-full animate-pulse"
          ></div>
          Sector: <span id="cursor-pos" class="text-slate-300">0, 0</span>
        </div>
        <div id="action-status" class="text-blue-500 font-bold"></div>
      </div>
      <div class="flex gap-4 items-center">
        <span class="text-slate-700">|</span>
        <span
          >Magnification:
          <span id="zoom-label" class="text-slate-300">100%</span></span
        >
      </div>
    </footer>

    <!-- Context Menu -->
    <div
      id="context-menu"
      class="fixed bg-slate-900 border border-slate-700 rounded-lg shadow-2xl py-1 w-48 z-[300] hidden"
    >
      <button
        onclick="projectManager.handleContext('open')"
        class="w-full text-left px-4 py-2 text-xs font-medium text-slate-300 hover:bg-blue-600 hover:text-white transition-colors flex items-center gap-2"
      >
        <svg
          width="14"
          height="14"
          fill="none"
          stroke="currentColor"
          stroke-width="2"
          viewBox="0 0 24 24"
        >
          <path d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
          <path
            d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"
          />
        </svg>
        Open Project
      </button>
      <button
        onclick="projectManager.handleContext('rename')"
        class="w-full text-left px-4 py-2 text-xs font-medium text-slate-300 hover:bg-blue-600 hover:text-white transition-colors flex items-center gap-2"
      >
        <svg
          width="14"
          height="14"
          fill="none"
          stroke="currentColor"
          stroke-width="2"
          viewBox="0 0 24 24"
        >
          <path
            d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"
          />
        </svg>
        Rename
      </button>
      <button
        onclick="projectManager.handleContext('duplicate')"
        class="w-full text-left px-4 py-2 text-xs font-medium text-slate-300 hover:bg-blue-600 hover:text-white transition-colors flex items-center gap-2"
      >
        <svg
          width="14"
          height="14"
          fill="none"
          stroke="currentColor"
          stroke-width="2"
          viewBox="0 0 24 24"
        >
          <path
            d="M8 7v8a2 2 0 002 2h6M8 7V5a2 2 0 012-2h4.586a1 1 0 01.707.293l4.414 4.414a1 1 0 01.293.707V15a2 2 0 01-2 2h-2M8 7H6a2 2 0 00-2 2v10a2 2 0 002 2h8a2 2 0 002-2v-2"
          />
        </svg>
        Duplicate
      </button>
      <div class="h-px bg-slate-800 my-1"></div>
      <button
        onclick="projectManager.handleContext('delete')"
        class="w-full text-left px-4 py-2 text-xs font-medium text-red-400 hover:bg-red-900/50 transition-colors flex items-center gap-2"
      >
        <svg
          width="14"
          height="14"
          fill="none"
          stroke="currentColor"
          stroke-width="2"
          viewBox="0 0 24 24"
        >
          <path
            d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"
          />
        </svg>
        Delete
      </button>
    </div>

    <input type="file" id="import-file" class="hidden" accept=".json" />
    <script>
      const TILE_MAP = {
        x: "t-wall",
        "!": "t-lava",
        "=": "t-lava-h",
        "|": "t-lava-v",
        v: "t-lava-drip",
        H: "t-moving-h",
        V: "t-moving-v",
        F: "t-falling",
        G: "t-breakable",
        K: "t-spike-block",
        k: "t-spike-block-u",
        W: "t-wall-block",
        J: "t-jump-pad",
        C: "t-grinder",
        "^": "t-rising",
        S: "t-spike",
        s: "t-spike-u",
        o: "t-coin",
        B: "t-blue",
        "@": "t-player",
        " ": "",
      };
      const BLOCK_NAMES = {
        x: "Wall",
        "!": "Lava",
        "=": "Horizontal Lava",
        "|": "Vertical Lava",
        v: "Dripping Lava",
        H: "Horizontal Moving Block",
        V: "Vertical Moving Block",
        F: "Falling Block",
        G: "Breakable Block",
        K: "Spike Block",
        k: "Upside Down Spike Block",
        W: "Wall Block",
        J: "Jump Pad",
        C: "The Grinder",
        "^": "Rising Lava",
        S: "Spike",
        s: "Upside Down Spike",
        o: "Coin",
        B: "Blue Coin",
        "@": "Player",
        " ": "Empty",
      };
      const MUSIC_LIBRARY = [
        {
          id: "synth",
          title: "Blockoverit",
          artist: "Block Over It",
          file: null,
        },
        {
          id: "none",
          title: "No Music",
          artist: "Silence",
          file: null,
        },
        {
          id: "joyful",
          title: "Joyful Morning",
          artist: "Noah Mark Hansen",
          file: "joyful_morning.mp3",
        },
        {
          id: "ant",
          title: "Ant Territory",
          artist: "Noah Mark Hansen",
          file: "ant_territory.mp3",
        },
        {
          id: "byte",
          title: "Byte Blast",
          artist: "Noah Mark Hansen",
          file: "byte_blast.mp3",
        },
        {
          id: "peaceful",
          title: "Peaceful Ambush",
          artist: "Noah Mark Hansen",
          file: "peaceful_ambush.mp3",
        },
        {
          id: "cold",
          title: "Cold Breeze",
          artist: "Noah Mark Hansen",
          file: "cold_breeze.mp3",
        },
        {
          id: "champions",
          title: "For Champions",
          artist: " ",
          file: "for_champions.mp3",
        },
        { id: "level6", title: "Level VI", artist: " ", file: "level_vi.mp3" },
        {
          id: "skate",
          title: "Skate Away",
          artist: "Noodlez Studios",
          file: "skate_away.mp3",
        },
        {
          id: "arcade",
          title: "Arcade",
          artist: "Blockoverit",
          file: "arcade.mp3",
        },
        {
          id: "time",
          title: "Taking Our Time",
          artist: "Alex Grohl",
          file: "time.mp3",
        },
      ];
      const minimap = {
        isCollapsed: false,
        colorMap: {
          x: "#444",
          "!": "#e55",
          "=": "#e55",
          "|": "#e55",
          v: "#e55",
          H: "#777",
          V: "#777",
          "^": "#d32f2f",
          S: "#94a3b8",
          s: "#94a3b8",
          o: "#e2e838",
          B: "#335699",
          "@": "#10b981", // Use a bright color for player on minimap
        },
        toggle() {
          this.isCollapsed = !this.isCollapsed;
          document
            .getElementById("minimap-container")
            .classList.toggle("collapsed", this.isCollapsed);
          const btn = document.getElementById("minimap-toggle-btn");
          // Button content update not needed as it is hidden when collapsed
        },
        toggleVisibility() {
          const el = document.getElementById("minimap-container");
          el.style.display = document.getElementById("opt-minimap").checked
            ? "block"
            : "none";
        },
        render() {
          const canvas = document.getElementById("minimap-canvas");
          if (!canvas) return;
          const ctx = canvas.getContext("2d");

          canvas.width = state.width;
          canvas.height = state.height;

          ctx.clearRect(0, 0, canvas.width, canvas.height);

          for (let y = 0; y < state.height; y++) {
            for (let x = 0; x < state.width; x++) {
              const char = state.grid[y][x];
              if (char !== " ") {
                const customColor = state.colors[`${x},${y}`];
                ctx.fillStyle = customColor || this.colorMap[char] || "#000";
                ctx.fillRect(x, y, 1, 1);
              }
            }
          }

          // Draw Viewport Indicator
          const vp = document.getElementById("viewport");
          const gridEl = document.getElementById("level-grid");
          if (vp && gridEl) {
            const rect = gridEl.getBoundingClientRect();
            const vpRect = vp.getBoundingClientRect();
            const scale = state.zoom;

            // Calculate visible area relative to grid
            const relX = rect.left - vpRect.left;
            const relY = rect.top - vpRect.top;

            const vX = Math.max(0, -relX) / scale / 24;
            const vY = Math.max(0, -relY) / scale / 24;
            const vW = Math.min(rect.width, vpRect.width) / scale / 24;
            const vH = Math.min(rect.height, vpRect.height) / scale / 24;

            ctx.strokeStyle = "rgba(255, 255, 255, 0.8)";
            ctx.lineWidth = 1;
            ctx.strokeRect(vX, vY, vW, vH);
          }

          // Draw selection
          const sel = getNormalizedSelection();
          if (sel) {
            ctx.strokeStyle = "rgba(59, 130, 246, 0.9)";
            ctx.lineWidth = 1;
            ctx.strokeRect(
              sel.x1 - 0.5,
              sel.y1 - 0.5,
              sel.x2 - sel.x1 + 2,
              sel.y2 - sel.y1 + 2,
            );
          }
        },
      };

      const settingsManager = {
        defaults: {
          name: "New Level",
          creator: "Anonymous",
          desc: "",
          difficulty: 1,
          gravity: 27,
          rise: 0,
          forceZoom: false,
          noDeathAnim: false,
          w: 40,
          h: 20
        },
        open() {
          const modal = document.getElementById('settings-modal');
          modal.classList.remove('hidden');
          this.syncToModal();
          this.renderDiffBarsModal();
          this.switchTab('metadata');
          this.checkDirty();
        },
        close() {
          document.getElementById('settings-modal').classList.add('hidden');
        },
        switchTab(tabId) {
          ['metadata', 'physics', 'grid'].forEach(id => {
            document.getElementById(`sec-${id}`).classList.add('hidden');
            document.getElementById(`tab-${id}`).classList.remove('active');
          });
          document.getElementById(`sec-${tabId}`).classList.remove('hidden');
          document.getElementById(`tab-${tabId}`).classList.add('active');
        },
        syncToModal() {
          document.getElementById('set-prop-name').value = document.getElementById('prop-name').value;
          document.getElementById('set-prop-creator').value = document.getElementById('prop-creator').value;
          document.getElementById('set-prop-desc').value = document.getElementById('prop-desc').value;
          document.getElementById('set-prop-gravity').value = document.getElementById('prop-gravity').value;
          document.getElementById('set-gravity-val').innerText = document.getElementById('prop-gravity').value;
          document.getElementById('set-prop-rise').value = document.getElementById('prop-rise').value;
          document.getElementById('set-prop-force-zoom').checked = document.getElementById('prop-force-zoom').value === 'true';
          document.getElementById('set-prop-no-death-anim').checked = document.getElementById('prop-no-death-anim').value === 'true';
          document.getElementById('set-prop-w').value = document.getElementById('prop-w').value;
          document.getElementById('set-prop-h').value = document.getElementById('prop-h').value;
          this.checkDirty();
        },
        syncFromModal() {
          document.getElementById('prop-name').value = document.getElementById('set-prop-name').value;
          document.getElementById('prop-creator').value = document.getElementById('set-prop-creator').value;
          document.getElementById('prop-desc').value = document.getElementById('set-prop-desc').value;
          document.getElementById('prop-gravity').value = document.getElementById('set-prop-gravity').value;
          document.getElementById('gravity-val').innerText = document.getElementById('set-prop-gravity').value;
          document.getElementById('prop-rise').value = document.getElementById('set-prop-rise').value;
          const riseVal = parseFloat(document.getElementById('prop-rise').value);
          document.getElementById('rise-val').innerText = riseVal > 0 ? (60 / riseVal).toFixed(1) + ' blk/min' : 'Disabled';
          document.getElementById('prop-force-zoom').value = document.getElementById('set-prop-force-zoom').checked;
          document.getElementById('prop-no-death-anim').value = document.getElementById('set-prop-no-death-anim').checked;
          document.getElementById('prop-w').value = document.getElementById('set-prop-w').value;
          document.getElementById('prop-h').value = document.getElementById('set-prop-h').value;
          this.checkDirty();
        },
        renderDiffBarsModal() {
          const container = document.getElementById("set-diff-bars-modal");
          container.innerHTML = "";
          const n = parseInt(document.getElementById("prop-diff").value);
          const colors = ["#22c55e", "#84cc16", "#eab308", "#f97316", "#ef4444"];

          for (let i = 1; i <= 5; i++) {
            const btn = document.createElement("button");
            btn.className = `diff-btn border border-slate-800 bg-slate-900 ${i <= n ? "active" : ""}`;
            if (i <= n) {
              btn.style.backgroundColor = colors[i - 1];
              btn.style.borderColor = colors[i - 1];
              btn.style.boxShadow = `0 0 8px ${colors[i - 1]}40`;
            }
            btn.onclick = () => { setDifficulty(i); this.renderDiffBarsModal(); };
            container.appendChild(btn);
          }
          this.checkDirty();
        },
        checkDirty() {
          const current = {
            name: document.getElementById('set-prop-name').value,
            creator: document.getElementById('set-prop-creator').value,
            desc: document.getElementById('set-prop-desc').value,
            difficulty: parseInt(document.getElementById('prop-diff').value),
            gravity: parseInt(document.getElementById('set-prop-gravity').value),
            rise: parseFloat(document.getElementById('set-prop-rise').value || 0),
            forceZoom: document.getElementById('set-prop-force-zoom').checked,
            noDeathAnim: document.getElementById('set-prop-no-death-anim').checked,
            w: parseInt(document.getElementById('set-prop-w').value),
            h: parseInt(document.getElementById('set-prop-h').value)
          };
          
          const isDirty = JSON.stringify(current) !== JSON.stringify(this.defaults);
          const btn = document.getElementById('btn-reset-defaults');
          if (isDirty) btn.classList.remove('hidden');
          else btn.classList.add('hidden');
        },
        resetToDefaults() {
          document.getElementById('set-prop-name').value = this.defaults.name;
          document.getElementById('set-prop-creator').value = this.defaults.creator;
          document.getElementById('set-prop-desc').value = this.defaults.desc;
          document.getElementById('set-prop-gravity').value = this.defaults.gravity;
          document.getElementById('set-gravity-val').innerText = this.defaults.gravity;
          document.getElementById('set-prop-rise').value = this.defaults.rise;
          document.getElementById('set-prop-force-zoom').checked = this.defaults.forceZoom;
          document.getElementById('set-prop-no-death-anim').checked = this.defaults.noDeathAnim;
          document.getElementById('set-prop-w').value = this.defaults.w;
          document.getElementById('set-prop-h').value = this.defaults.h;
          setDifficulty(this.defaults.difficulty);
          this.renderDiffBarsModal();
          this.syncFromModal();
        }
      };
      let currentAudio = null;
      let currentTrackId = null;
      let editorAudioCtx = null;
      let synthTimeout = null;

      const state = {
        width: 40,
        height: 20,
        grid: [],
        colors: {}, // Map "x,y" -> hex
        tool: "pencil",
        selectedChar: "x",
        zoom: 1.0,
        isDrawing: false,
        music: null,
        selection: null,
        rightPanelOpen: true,
        picker: {
          active: false,
          mode: "single",
          callback: null,
          selection: [],
        },
        fakes: new Set(),
        risingThrough: new Set(),
        risingSpeeds: {},
        illusions: new Set(),
        blockConfigs: {},
      };
      let clipboard = null;

      function init() {
        const list = document.getElementById("block-list");
        Object.entries(TILE_MAP).forEach(([char, css]) => {
          if (char === " ") return;
          const btn = document.createElement("button");
          btn.className = `w-full aspect-square bg-slate-900 border border-slate-800 rounded-lg flex items-center justify-center hover:border-blue-500 palette-btn transition-all group ${
            char === "x"
              ? "ring-2 ring-blue-500 border-blue-500 bg-blue-500/10"
              : ""
          }`;
          btn.onclick = () => {
            state.selectedChar = char;
            document
              .querySelectorAll(".palette-btn")
              .forEach((b) =>
                b.classList.remove(
                  "ring-2",
                  "ring-blue-500",
                  "border-blue-500",
                  "bg-blue-500/10",
                ),
              );
            btn.classList.add(
              "ring-2",
              "ring-blue-500",
              "border-blue-500",
              "bg-blue-500/10",
            );
            if (["eraser"].includes(state.tool)) setTool("pencil");
          };
          if (char === "S") {
            btn.innerHTML = `<div class="cell ${css} group-hover:scale-110 transition-transform"><div class="spike-visual"></div></div>`;
          } else if (char === "s") {
            btn.innerHTML = `<div class="cell ${css} group-hover:scale-110 transition-transform"><div class="spike-visual spike-u"></div></div>`;
          } else {
            btn.innerHTML = `<div class="cell ${css} group-hover:scale-110 transition-transform"></div>`;
          }
          list.appendChild(btn);
        });
        state.grid = Array(state.height)
          .fill(null)
          .map(() => Array(state.width).fill(" "));
        if (document.getElementById("opt-showgrid").checked)
          document.getElementById("level-grid").classList.add("grid-lines");
        setDifficulty(1);
        render();
        history.push();
        setupInteractions();
        renderRecentTemplates();
        minimap.render();
        renderMusic();
        projectManager.renderList();
        autoAdjust();
        helpManager.init();

        // Global click to close context menu
        document.addEventListener("click", () => document.getElementById("context-menu").classList.add("hidden"));
      }

      function renderMusic() {
        const container = document.getElementById("music-list");
        container.innerHTML = "";
        container.style.maxHeight = "250px";
        container.style.overflowY = "auto";

        MUSIC_LIBRARY.forEach((track) => {
          const el = document.createElement("div");
          const isPlaying = currentTrackId === track.id;
          const isSelected =
            state.music === track.id ||
            (state.music === null && track.id === "synth");

          el.className = `p-2 rounded text-xs border transition-all flex justify-between items-center mb-1 cursor-pointer group ${isSelected ? "bg-blue-900/20 border-blue-500" : "bg-slate-900 border-slate-800 hover:border-slate-600"}`;
          el.onclick = () => selectLevelMusic(track.id);

          el.innerHTML = `
                <div class="flex-1 min-w-0 mr-2">
                    <div class="font-bold truncate ${isSelected ? "text-blue-400" : "text-slate-200"}">${track.title}</div>
                    <div class="text-[9px] text-slate-500">${track.artist}</div>
                </div>
                <div class="flex-shrink-0">
                    <button class="w-6 h-6 rounded flex items-center justify-center bg-slate-800 hover:bg-slate-700 text-slate-400 hover:text-white transition-colors ${isPlaying ? "text-green-400 hover:text-green-300" : ""}" onclick="event.stopPropagation(); playEditorMusic(MUSIC_LIBRARY.find(t => t.id === '${track.id}'))">
                        ${isPlaying ? '<svg width="10" height="10" fill="currentColor" viewBox="0 0 24 24"><rect x="6" y="4" width="4" height="16"></rect><rect x="14" y="4" width="4" height="16"></rect></svg>' : '<svg width="10" height="10" fill="currentColor" viewBox="0 0 24 24"><path d="M8 5v14l11-7z"></path></svg>'}
                    </button>
                </div>
            `;
          container.appendChild(el);
        });
      }

      function playEditorMusic(track) {
        if (currentAudio) {
          currentAudio.pause();
          currentAudio = null;
        }

        // Stop Synth
        clearTimeout(synthTimeout);
        if (editorAudioCtx) {
          editorAudioCtx.close();
          editorAudioCtx = null;
        }

        if (currentTrackId === track.id) {
          currentTrackId = null;
        } else {
          currentTrackId = track.id;
          if (track.id === "synth") {
            playEditorSynth();
          } else if (track.id === "none") {
            // Do nothing, music stopped
          } else if (track.file) {
            currentAudio = new Audio(track.file);
            currentAudio.loop = true;
            currentAudio.play();
          }
        }
        renderMusic();
      }

      function playEditorSynth() {
        editorAudioCtx = new (
          window.AudioContext || window.webkitAudioContext
        )();
        const notes = [
          220, 0, 220, 0, 261, 0, 329, 0, 220, 0, 220, 0, 196, 0, 164, 0, 220,
          0, 329, 0, 392, 0, 440, 0, 392, 0, 329, 0, 261, 0, 246, 0,
        ];
        let idx = 0;

        function note() {
          if (currentTrackId !== "synth" || !editorAudioCtx) return;

          const osc = editorAudioCtx.createOscillator();
          const gain = editorAudioCtx.createGain();

          osc.type = "square";
          osc.frequency.setValueAtTime(notes[idx], editorAudioCtx.currentTime);

          gain.gain.setValueAtTime(0.1, editorAudioCtx.currentTime);
          gain.gain.exponentialRampToValueAtTime(
            0.001,
            editorAudioCtx.currentTime + 0.1,
          );

          osc.connect(gain);
          gain.connect(editorAudioCtx.destination);
          osc.start();
          osc.stop(editorAudioCtx.currentTime + 0.1);

          idx = (idx + 1) % notes.length;
          synthTimeout = setTimeout(note, 120);
        }
        note();
      }

      function selectLevelMusic(id) {
        state.music = id;
        renderMusic();
      }

      function render() {
        const gridEl = document.getElementById("level-grid");
        gridEl.style.gridTemplateColumns = `repeat(${state.width}, 24px)`;
        gridEl.style.width = `${state.width * 24}px`;
        gridEl.style.height = `${state.height * 24}px`;
        gridEl.innerHTML = "";
        const frag = document.createDocumentFragment();
        const overlay = document.createElement("div");
        overlay.id = "selection-overlay";
        frag.appendChild(overlay);

        for (let y = 0; y < state.height; y++) {
          for (let x = 0; x < state.width; x++) {
            const cell = document.createElement("div");
            cell.className = `cell ${TILE_MAP[state.grid[y][x]]}`;
            cell.dataset.x = x;
            cell.dataset.y = y;

            const color = state.colors[`${x},${y}`];
            if (color) {
              cell.style.backgroundColor = color;
              cell.style.borderColor = adjustColor(color, -20);
              if (color === 'invisible') {
                cell.style.opacity = '0.5';
                cell.style.border = '1px dashed rgba(255,255,255,0.5)';
              } else if (color === 'flicker') {
                cell.style.opacity = '0.7';
                cell.style.border = '1px dotted rgba(255,255,255,0.5)';
              } else if (color === 'jump_flicker') {
                cell.style.opacity = '0.8';
                cell.style.border = '1px solid rgba(100,255,100,0.5)';
              } else {
                cell.style.backgroundColor = color;
                cell.style.borderColor = adjustColor(color, -20);
              }
            }

            if (state.grid[y][x] === "S") {
              const spike = document.createElement("div");
              spike.className = "spike-visual";
              if (color) spike.style.borderBottomColor = color;
              cell.appendChild(spike);
            } else if (state.grid[y][x] === "s") {
              const spike = document.createElement("div");
              spike.className = "spike-visual spike-u";
              if (color) spike.style.borderTopColor = color;
              cell.appendChild(spike);
            }

            if (state.fakes.has(`${x},${y}`)) {
                const ind = document.createElement('div');
                ind.className = 'absolute top-0 right-0 text-[8px] font-bold text-yellow-400 px-0.5 leading-none pointer-events-none z-10';
                ind.innerText = 'F';
                cell.appendChild(ind);
            }

            if (color === 'flicker') {
                const ind = document.createElement('div');
                ind.className = 'absolute bottom-0 left-0 text-[8px] font-bold text-white/70 px-0.5 leading-none pointer-events-none z-10';
                ind.innerText = '👁';
                cell.appendChild(ind);
            }

            if (color === 'jump_flicker') {
                const ind = document.createElement('div');
                ind.className = 'absolute bottom-0 left-0 text-[8px] font-bold text-green-400 px-0.5 leading-none pointer-events-none z-10';
                ind.innerText = '⬆';
                cell.appendChild(ind);
            }

            const isIllusion = state.illusions.has(`${x},${y}`);
            if (isIllusion) {
                cell.className = `cell ${TILE_MAP['x']}`;
                const ind = document.createElement('div');
                ind.className = 'absolute top-0 left-0 text-[8px] font-bold text-cyan-400 px-0.5 leading-none pointer-events-none z-10';
                ind.innerText = 'I';
                cell.appendChild(ind);
            }

            // Picker Highlight
            if (state.picker.active) {
              if (
                state.picker.mode === "multi" &&
                state.picker.selection.some((p) => p.x === x && p.y === y)
              ) {
                cell.style.boxShadow =
                  "inset 0 0 0 2px #3b82f6, 0 0 10px rgba(59, 130, 246, 0.5)";
              } else if (state.picker.mode === "single") {
                cell.style.cursor = "crosshair";
              }
            }

            frag.appendChild(cell);
          }
        }
        gridEl.appendChild(frag);
        updateSelectionUI();
        minimap.render();
      }

      function adjustColor(color, amount) {
        if (!color) return null;
        let usePound = false;
        if (color[0] == "#") {
          color = color.slice(1);
          usePound = true;
        }
        let num = parseInt(color, 16);
        let r = (num >> 16) + amount;
        if (r > 255) r = 255;
        else if (r < 0) r = 0;
        let b = ((num >> 8) & 0x00ff) + amount;
        if (b > 255) b = 255;
        else if (b < 0) b = 0;
        let g = (num & 0x0000ff) + amount;
        if (g > 255) g = 255;
        else if (g < 0) g = 0;
        return (
          (usePound ? "#" : "") +
          (g | (b << 8) | (r << 16)).toString(16).padStart(6, "0")
        );
      }

      function setTool(tool) {
        state.tool = tool;
        document
          .querySelectorAll("aside button")
          .forEach((b) => b.classList.remove("tool-active"));
        const activeBtn = document.getElementById(`btn-${tool}`);
        if (activeBtn) activeBtn.classList.add("tool-active");
        if (tool !== "select") {
          state.selection = null;
          updateSelectionUI();
        }
      }

      function toggleAccordion(btn) {
        const wrapper = btn.parentElement;
        // Find the immediate parent that groups the accordion sections
        const container = wrapper.parentElement;

        // Determine current state
        const wasOpen = wrapper.classList.contains("accordion-open");

        // Close all sibling sections within this container
        Array.from(container.children).forEach((child) => {
          if (child.classList && child.classList.contains("accordion-open")) {
            child.classList.remove("accordion-open");
          }
        });

        // If the clicked one was closed, open it (otherwise leave all closed)
        if (!wasOpen) wrapper.classList.add("accordion-open");
      }

      function setupInteractions() {
        const viewport = document.getElementById("viewport");
        const grid = document.getElementById("level-grid");

        const minimapHeader = document.getElementById("minimap-header");
        const minimapContainer = document.getElementById("minimap-container");
        let isDraggingMinimap = false;
        let minimapOffsetX, minimapOffsetY;

        minimapHeader.addEventListener("mousedown", (e) => {
          isDraggingMinimap = true;
          minimapOffsetX = e.clientX - minimapContainer.offsetLeft;
          minimapOffsetY = e.clientY - minimapContainer.offsetTop;
          minimapContainer.style.transition = "none";
          e.stopPropagation();
        });

        // Minimap Click to Scroll
        const minimapCanvas = document.getElementById("minimap-canvas");
        minimapCanvas.addEventListener("mousedown", (e) => {
          const rect = minimapCanvas.getBoundingClientRect();
          const x = e.clientX - rect.left;
          const y = e.clientY - rect.top;

          // Map minimap coordinate (1px = 1 cell) to grid pixels
          const scaleX = minimapCanvas.width / rect.width;
          const scaleY = minimapCanvas.height / rect.height;

          const cellX = x * scaleX;
          const cellY = y * scaleY;

          const gridX = cellX * 24 * state.zoom;
          const gridY = cellY * 24 * state.zoom;

          // Center viewport on this point
          // We need to account for the current margins/padding of the grid
          const gridEl = document.getElementById("level-grid");
          // Reset margins to 0 for calculation if needed, or just scroll viewport
          // Simpler: Scroll viewport to center this point relative to grid

          // Current grid position relative to viewport
          const gridRect = gridEl.getBoundingClientRect();
          const vpRect = viewport.getBoundingClientRect();

          // Target scroll position
          // We want gridX to be at center of viewport
          // gridX is relative to grid-left.

          // This is tricky because of autoAdjust margins.
          // Let's just try to scroll the viewport element.
          // If grid is larger than viewport, we can scroll.

          // Calculate where the grid point is currently on screen
          const currentScreenX = gridRect.left + gridX;
          const currentScreenY = gridRect.top + gridY;

          const targetScreenX = vpRect.left + vpRect.width / 2;
          const targetScreenY = vpRect.top + vpRect.height / 2;

          viewport.scrollBy({
            left: currentScreenX - targetScreenX,
            top: currentScreenY - targetScreenY,
            behavior: "smooth",
          });
        });

        // Update minimap on scroll
        viewport.addEventListener("scroll", () => minimap.render());
        window.addEventListener("resize", () => {
          autoAdjust();
          minimap.render();
        });

        grid.addEventListener("mousedown", (e) => {
          const cell = e.target.closest(".cell");
          if (!cell) return;
          const x = parseInt(cell.dataset.x);
          const y = parseInt(cell.dataset.y);
          state.isDrawing = true;

          if (state.picker.active) {
            state.isDrawing = false; // Disable normal drawing
            if (state.picker.mode === "single") {
              if (state.picker.callback) state.picker.callback(x, y);
              state.picker.active = false;
              document
                .getElementById("level-grid")
                .classList.remove("picker-active");
              updateStatus("Coordinates Picked");
              render(); // Remove highlights
            } else if (state.picker.mode === "multi") {
              const idx = state.picker.selection.findIndex(
                (p) => p.x === x && p.y === y,
              );
              if (idx >= 0) state.picker.selection.splice(idx, 1);
              else state.picker.selection.push({ x, y });
              render();
            }
            return;
          }

          if (state.tool === "pencil") paint(x, y);
          else if (state.tool === "eraser") paint(x, y, " ");
          else if (state.tool === "bucket") {
            floodFill(x, y, state.selectedChar);
            history.push();
          } else if (state.tool === "select") {
            state.selection = { startX: x, startY: y, endX: x, endY: y };
            updateSelectionUI();
          }
        });

        window.addEventListener("mousemove", (e) => {
          if (isDraggingMinimap) {
            minimapContainer.style.left = `${e.clientX - minimapOffsetX}px`;
            minimapContainer.style.top = `${e.clientY - minimapOffsetY}px`;
            let x = e.clientX - minimapOffsetX;
            let y = e.clientY - minimapOffsetY;

            const maxX = window.innerWidth - minimapContainer.offsetWidth;
            const maxY = window.innerHeight - minimapContainer.offsetHeight;

            x = Math.max(0, Math.min(x, maxX));
            y = Math.max(0, Math.min(y, maxY));

            minimapContainer.style.left = `${x}px`;
            minimapContainer.style.top = `${y}px`;
            return;
          }

          const cell = e.target.closest(".cell");
          if (cell) {
            const x = parseInt(cell.dataset.x),
              y = parseInt(cell.dataset.y);
            
            if (state.tool !== 'select') {
               const char = state.grid[y][x];
               const bName = BLOCK_NAMES[char] || 'Unknown';
               document.getElementById("cursor-pos").innerText = `${x}, ${y} (${bName})`;
            } else {
               document.getElementById("cursor-pos").innerText = `${x}, ${y}`;
            }

            if (state.picker.active) {
              if (state.picker.mode === "multi" && state.isDrawing) {
                // Drag select for multi picker
                const idx = state.picker.selection.findIndex(
                  (p) => p.x === x && p.y === y,
                );
                if (idx === -1) {
                  state.picker.selection.push({ x, y });
                  render();
                }
              }
              return;
            }

            if (state.isDrawing) {
              if (state.tool === "pencil") paint(x, y);
              else if (state.tool === "eraser") paint(x, y, " ");
              else if (state.tool === "select") {
                state.selection.endX = x;
                state.selection.endY = y;
                updateSelectionUI();
              }
            }
          }
        });

        window.addEventListener("mouseup", () => {
          if (isDraggingMinimap) {
            isDraggingMinimap = false;
            minimapContainer.style.transition = "";
          }

          if (state.picker.active && state.picker.mode === "multi") {
            state.isDrawing = false;
          }

          if (state.isDrawing) {
            state.isDrawing = false;
            if (state.tool !== "select") history.push();
          }
        });

        window.addEventListener("keydown", (e) => {
          // Shortcuts
          if (e.target.tagName === "INPUT" || e.target.tagName === "TEXTAREA")
            return;

          const key = e.key.toLowerCase();
          if (!e.shiftKey && !e.ctrlKey && !e.altKey) {
            if (key === "b") setTool("pencil");
            if (key === "e") setTool("eraser");
            if (key === "s") setTool("select");
            if (key === "f") setTool("bucket");
            if (key === "m") {
              e.preventDefault();
              minimap.toggle();
            }
            if (key === "g") {
              e.preventDefault();
              document.getElementById("opt-showgrid").checked =
                !document.getElementById("opt-showgrid").checked;
              toggleGrid();
            }
          }
          if (e.altKey && key === "m") {
            e.preventDefault();
            const cb = document.getElementById("opt-minimap");
            cb.checked = !cb.checked;
            minimap.toggleVisibility();
          }
          if (e.ctrlKey && key === "z") {
            e.preventDefault();
            history.undo();
          }
          if (e.ctrlKey && key === "y") {
            e.preventDefault();
            history.redo();
          }
          if (e.ctrlKey && key === "c") {
            e.preventDefault();
            copySelection();
          }
          if (e.ctrlKey && key === "v") {
            e.preventDefault();
            pasteSelection();
          }
          if (e.ctrlKey && key === "s") {
            e.preventDefault();
            projectManager.save();
          }
          if (key === "=" || key === "+") {
            e.preventDefault();
            zoom(0.1);
          }
          if (key === "-") {
            e.preventDefault();
            zoom(-0.1);
          }

          // Block Shortcuts
          if (e.shiftKey) {
            const k = e.key.toUpperCase();
            const map = {
              1: "!",
              "!": "!",
              2: "@",
              "@": "@",
              X: "x",
              B: "x",
              O: "o",
              S: "S",
              D: "s",
              L: "!",
              P: "@",
              C: "o",
            };

            if (map[k]) {
              e.preventDefault();
              state.selectedChar = map[k];
              // Update UI
              document
                .querySelectorAll(".palette-btn")
                .forEach((b) =>
                  b.classList.remove(
                    "ring-2",
                    "ring-blue-500",
                    "border-blue-500",
                    "bg-blue-500/10",
                  ),
                );
              // Find button for this char
              const idx = Object.keys(TILE_MAP).indexOf(map[k]);
              if (idx >= 0) {
                const btn = document.getElementById("block-list").children[idx];
                if (btn)
                  btn.classList.add(
                    "ring-2",
                    "ring-blue-500",
                    "border-blue-500",
                    "bg-blue-500/10",
                  );
              }
              if (state.tool === "eraser") setTool("pencil");
            }
          }

          // Select All
          if (e.ctrlKey && key === "a") {
            e.preventDefault();
            setTool("select");
            state.selection = {
              startX: 0,
              startY: 0,
              endX: state.width - 1,
              endY: state.height - 1,
            };
            updateSelectionUI();
          }

          // Delete Selection
          if ((key === "backspace" || key === "delete") && state.selection) {
            deleteSelection();
            updateStatus("Selection Cleared");
          }
        });
      }

      function toggleSPExpand() {
        const expanded = document.getElementById('sp-expanded');
        const btn = document.getElementById('sp-expand-btn');
        const icon = document.getElementById('sp-expand-icon');
        
        if (expanded.classList.contains('hidden')) {
            expanded.classList.remove('hidden');
            expanded.classList.add('flex');
            icon.style.transform = 'rotate(180deg)';
        } else {
            expanded.classList.add('hidden');
            expanded.classList.remove('flex');
            icon.style.transform = 'rotate(0deg)';
        }
      }

      function getNormalizedSelection() {
        if (!state.selection) return null;
        return {
          x1: Math.min(state.selection.startX, state.selection.endX),
          y1: Math.min(state.selection.startY, state.selection.endY),
          x2: Math.max(state.selection.startX, state.selection.endX),
          y2: Math.max(state.selection.startY, state.selection.endY),
        };
      }

      function updateSelectionUI() {
        const overlay = document.getElementById("selection-overlay");
        overlay.innerHTML = "";
        const popup = document.getElementById("selection-popup");
        const norm = getNormalizedSelection();

        if (!norm) {
          popup.classList.add("hidden");
          return;
        }

        const rect = document.createElement("div");
        rect.className = "selection-rect";
        rect.style.left = `${norm.x1 * 24}px`;
        rect.style.top = `${norm.y1 * 24}px`;
        rect.style.width = `${(norm.x2 - norm.x1 + 1) * 24}px`;
        rect.style.height = `${(norm.y2 - norm.y1 + 1) * 24}px`;
        overlay.appendChild(rect);

        // Position Popup
        popup.classList.remove("hidden");
        
        // Calculate screen position
        const gridEl = document.getElementById("level-grid");
        const gridRect = gridEl.getBoundingClientRect();
        
        // Position at top right of selection
        const left = gridRect.left + (norm.x2 + 1) * 24 * state.zoom + 10;
        const top = gridRect.top + norm.y1 * 24 * state.zoom;
        
        // Keep within bounds
        const maxLeft = window.innerWidth - popup.offsetWidth - 20;
        const maxTop = window.innerHeight - popup.offsetHeight - 20;
        
        popup.style.left = `${Math.min(left, maxLeft)}px`;
        popup.style.top = `${Math.max(20, Math.min(top, maxTop))}px`;

        // Check for Rising Lava in selection
        let hasRising = false;
        let allThrough = true;
        let allFake = true;
        let allInvisible = true;
        let allFlicker = true;
        let allJumpFlicker = true;
        let hasBreakable = false;
        let onlyBreakable = true;
        let allIllusion = true;
        let hasConfigurable = false;
        let allPainted = true;
        let hasBlocks = false;

        for(let y = norm.y1; y <= norm.y2; y++) {
            for(let x = norm.x1; x <= norm.x2; x++) {
                const char = state.grid[y][x];
                if(char === '^') {
                    hasRising = true;
                    if (!state.risingThrough.has(`${x},${y}`)) {
                        allThrough = false;
                    }
                }
                if (char === 'G') {
                    hasBreakable = true;
                    if (!state.illusions.has(`${x},${y}`)) allIllusion = false;
                } else if (char !== ' ') {
                    onlyBreakable = false;
                }
                if (['W', 'K', 'k'].includes(char)) {
                    hasConfigurable = true;
                }
                if (state.grid[y][x] !== ' ') {
                    hasBlocks = true;
                    if (!state.fakes.has(`${x},${y}`)) allFake = false;
                    
                    const col = state.colors[`${x},${y}`];
                    if (col !== 'invisible') allInvisible = false;
                    if (col !== 'flicker') allFlicker = false;
                    if (col !== 'jump_flicker') allJumpFlicker = false;
                    if (!col || ['invisible', 'flicker', 'jump_flicker'].includes(col)) allPainted = false;
                }
            }
        }
        
        if (!hasBlocks) {
            allIllusion = false;
            allFake = false; allInvisible = false; allFlicker = false; allJumpFlicker = false; allPainted = false;
        }

        const setBtn = (id, active) => {
            const btn = document.getElementById(id);
            if(btn) btn.className = active ? "p-1.5 bg-blue-600 text-white rounded flex justify-center items-center sp-btn" : "p-1.5 bg-slate-800 hover:bg-slate-700 rounded text-slate-400 flex justify-center items-center sp-btn";
        };

        setBtn('btn-sp-fake', allFake);
        setBtn('btn-sp-invisible', allInvisible);
        setBtn('btn-sp-paint', allPainted);
        setBtn('btn-sp-flicker', allFlicker);
        setBtn('btn-sp-jump-flicker', allJumpFlicker);

        const illusionBtn = document.getElementById('btn-sp-illusion');
        if (hasBreakable && onlyBreakable) {
            illusionBtn.classList.remove('hidden');
            setBtn('btn-sp-illusion', allIllusion);
        } else {
            illusionBtn.classList.add('hidden');
        }

        const risingOpt = document.getElementById('sp-rising-opt');
        if(hasRising) risingOpt.classList.remove('hidden');
        else risingOpt.classList.add('hidden');
        document.getElementById('sp-rising-check').checked = allThrough;

        const configOpt = document.getElementById('sp-block-config-opt');
        if(hasConfigurable) {
            configOpt.classList.remove('hidden');
            configOpt.classList.add('flex');
            // Check if all selected have same speed
            let commonCount = null;
            let first = true;
            for(let y = norm.y1; y <= norm.y2; y++) {
                for(let x = norm.x1; x <= norm.x2; x++) {
                    if(['W', 'K', 'k'].includes(state.grid[y][x])) {
                        const c = state.blockConfigs[`${x},${y}`]?.count || 1;
                        if (first) { commonCount = c; first = false; }
                        else if (commonCount !== c) commonCount = '';
                    }
                }
            }
            document.getElementById('sp-block-count-input').value = commonCount !== null ? commonCount : '';
        } else {
            configOpt.classList.add('hidden');
            configOpt.classList.remove('flex');
        }
        
        minimap.render();
      }

      function updateStyle() {
        const style = document.getElementById("prop-style").value;
        if (style === "modern") {
          document.body.classList.add("style-modern");
        } else {
          document.body.classList.remove("style-modern");
        }
      }

      function paint(x, y, char = state.selectedChar, updateView = true) {
        const hasColor = state.colors[`${x},${y}`] !== undefined;
        if (state.grid[y][x] === char && !hasColor) return;

        if (char === ' ') {
             state.fakes.delete(`${x},${y}`);
             state.risingThrough.delete(`${x},${y}`);
             delete state.risingSpeeds[`${x},${y}`];
             state.illusions.delete(`${x},${y}`);
             delete state.blockConfigs[`${x},${y}`];
        }

        // Multi-player check
        if (char === "@") {
          for (let ry = 0; ry < state.height; ry++) {
            for (let rx = 0; rx < state.width; rx++) {
              if (state.grid[ry][rx] === "@") paint(rx, ry, " ", updateView);
            }
          }
        }

        state.grid[y][x] = char;
        delete state.colors[`${x},${y}`]; // Reset color on overwrite
        state.illusions.delete(`${x},${y}`);
        
        if (updateView) {
            const cell = document.getElementById("level-grid").children[y * state.width + x + 1];
            if (cell) renderCell(cell, x, y);
            minimap.render();
        }
      }

      function makeSelectionInvisible() {
        const sel = getNormalizedSelection();
        if (!sel) return dialog.alert("No Selection", "Please select an area first.");
        
        let allInvisible = true;
        for (let y = sel.y1; y <= sel.y2; y++) {
          for (let x = sel.x1; x <= sel.x2; x++) {
             if (state.grid[y][x] !== ' ' && state.colors[`${x},${y}`] !== 'invisible') {
                 allInvisible = false;
                 break;
             }
          }
          if (!allInvisible) break;
        }

        for (let y = sel.y1; y <= sel.y2; y++) {
          for (let x = sel.x1; x <= sel.x2; x++) {
             if (state.grid[y][x] !== ' ') {
                 if (allInvisible) {
                     if (state.colors[`${x},${y}`] === 'invisible') delete state.colors[`${x},${y}`];
                 } else {
                     state.colors[`${x},${y}`] = 'invisible';
                 }
             }
          }
        }
        render();
        history.push();
      }

      function toggleFlickerSelection() {
        const sel = getNormalizedSelection();
        if (!sel) return dialog.alert("No Selection", "Please select an area first.");
        
        let allFlicker = true;
        for (let y = sel.y1; y <= sel.y2; y++) {
          for (let x = sel.x1; x <= sel.x2; x++) {
             if (state.grid[y][x] !== ' ' && state.colors[`${x},${y}`] !== 'flicker') {
                 allFlicker = false;
                 break;
             }
          }
          if (!allFlicker) break;
        }

        for (let y = sel.y1; y <= sel.y2; y++) {
          for (let x = sel.x1; x <= sel.x2; x++) {
             if (state.grid[y][x] !== ' ') {
                 if (allFlicker) {
                     if (state.colors[`${x},${y}`] === 'flicker') delete state.colors[`${x},${y}`];
                 } else {
                     state.colors[`${x},${y}`] = 'flicker';
                 }
             }
          }
        }
        render();
        history.push();
      }

      function toggleJumpFlickerSelection() {
        const sel = getNormalizedSelection();
        if (!sel) return dialog.alert("No Selection", "Please select an area first.");
        
        let allJumpFlicker = true;
        for (let y = sel.y1; y <= sel.y2; y++) {
          for (let x = sel.x1; x <= sel.x2; x++) {
             if (state.grid[y][x] !== ' ' && state.colors[`${x},${y}`] !== 'jump_flicker') {
                 allJumpFlicker = false;
                 break;
             }
          }
          if (!allJumpFlicker) break;
        }

        for (let y = sel.y1; y <= sel.y2; y++) {
          for (let x = sel.x1; x <= sel.x2; x++) {
             if (state.grid[y][x] !== ' ') {
                 if (allJumpFlicker) {
                     if (state.colors[`${x},${y}`] === 'jump_flicker') delete state.colors[`${x},${y}`];
                 } else {
                     state.colors[`${x},${y}`] = 'jump_flicker';
                 }
             }
          }
        }
        render();
        history.push();
      }

      function toggleIllusionSelection() {
        const sel = getNormalizedSelection();
        if (!sel) return;
        
        let allAreIllusions = true;
        for (let y = sel.y1; y <= sel.y2; y++) {
            for (let x = sel.x1; x <= sel.x2; x++) {
                if (state.grid[y][x] === 'G' && !state.illusions.has(`${x},${y}`)) {
                    allAreIllusions = false;
                    break;
                }
            }
            if (!allAreIllusions) break;
        }

        for (let y = sel.y1; y <= sel.y2; y++) {
            for (let x = sel.x1; x <= sel.x2; x++) {
                if (state.grid[y][x] === 'G') {
                    if (allAreIllusions) state.illusions.delete(`${x},${y}`);
                    else state.illusions.add(`${x},${y}`);
                }
            }
        }
        render();
        history.push();
      }

      function toggleFakeSelection() {
        const sel = getNormalizedSelection();
        if (!sel) return dialog.alert("No Selection", "Please select an area first.");
        
        let allFake = true;
        for (let y = sel.y1; y <= sel.y2; y++) {
          for (let x = sel.x1; x <= sel.x2; x++) {
             if (state.grid[y][x] !== ' ' && !state.fakes.has(`${x},${y}`)) {
                 allFake = false;
                 break;
             }
          }
          if (!allFake) break;
        }

        for (let y = sel.y1; y <= sel.y2; y++) {
          for (let x = sel.x1; x <= sel.x2; x++) {
             if (state.grid[y][x] !== ' ') {
                 if (allFake) state.fakes.delete(`${x},${y}`);
                 else state.fakes.add(`${x},${y}`);
             }
          }
        }
        render();
        history.push();
      }

      function toggleRisingThrough() {
        const sel = getNormalizedSelection();
        if (!sel) return;
        
        const check = document.getElementById('sp-rising-check');
        const val = check.checked;

        for (let y = sel.y1; y <= sel.y2; y++) {
          for (let x = sel.x1; x <= sel.x2; x++) {
             if (state.grid[y][x] === '^') {
                 if (val) state.risingThrough.add(`${x},${y}`);
                 else state.risingThrough.delete(`${x},${y}`);
             }
          }
        }
        // No render needed as this is invisible property, but good for consistency
        history.push();
        // Update UI to reflect state
        updateSelectionUI(); 
      }

      function toggleFakeSelection() {
        const sel = getNormalizedSelection();
        if (!sel) return dialog.alert("No Selection", "Please select an area first.");
        
        let allFake = true;
        for (let y = sel.y1; y <= sel.y2; y++) {
          for (let x = sel.x1; x <= sel.x2; x++) {
             if (state.grid[y][x] !== ' ' && !state.fakes.has(`${x},${y}`)) {
                 allFake = false;
                 break;
             }
          }
          if (!allFake) break;
        }

        for (let y = sel.y1; y <= sel.y2; y++) {
          for (let x = sel.x1; x <= sel.x2; x++) {
             if (state.grid[y][x] !== ' ') {
                 if (allFake) state.fakes.delete(`${x},${y}`);
                 else state.fakes.add(`${x},${y}`);
             }
          }
        }
        render();
        history.push();
      }

      function toggleRisingThrough() {
        const sel = getNormalizedSelection();
        if (!sel) return;
        
        const check = document.getElementById('sp-rising-check');
        const val = check.checked;

        for (let y = sel.y1; y <= sel.y2; y++) {
          for (let x = sel.x1; x <= sel.x2; x++) {
             if (state.grid[y][x] === '^') {
                 if (val) state.risingThrough.add(`${x},${y}`);
                 else state.risingThrough.delete(`${x},${y}`);
             }
          }
        }
        history.push();
        updateSelectionUI(); 
      }

      function makeSelectionInvisible() {
        const sel = getNormalizedSelection();
        if (!sel) return dialog.alert("No Selection", "Please select an area first.");
        
        let allInvisible = true;
        for (let y = sel.y1; y <= sel.y2; y++) {
          for (let x = sel.x1; x <= sel.x2; x++) {
             if (state.grid[y][x] !== ' ' && state.colors[`${x},${y}`] !== 'invisible') {
                 allInvisible = false;
                 break;
             }
          }
          if (!allInvisible) break;
        }

        for (let y = sel.y1; y <= sel.y2; y++) {
          for (let x = sel.x1; x <= sel.x2; x++) {
             if (state.grid[y][x] !== ' ') {
                 if (allInvisible) {
                     if (state.colors[`${x},${y}`] === 'invisible') delete state.colors[`${x},${y}`];
                 } else {
                     state.colors[`${x},${y}`] = 'invisible';
                 }
             }
          }
        }
        render();
        history.push();
      }

      function toggleFlickerSelection() {
        const sel = getNormalizedSelection();
        if (!sel) return dialog.alert("No Selection", "Please select an area first.");
        
        let allFlicker = true;
        for (let y = sel.y1; y <= sel.y2; y++) {
          for (let x = sel.x1; x <= sel.x2; x++) {
             if (state.grid[y][x] !== ' ' && state.colors[`${x},${y}`] !== 'flicker') {
                 allFlicker = false;
                 break;
             }
          }
          if (!allFlicker) break;
        }

        for (let y = sel.y1; y <= sel.y2; y++) {
          for (let x = sel.x1; x <= sel.x2; x++) {
             if (state.grid[y][x] !== ' ') {
                 if (allFlicker) {
                     if (state.colors[`${x},${y}`] === 'flicker') delete state.colors[`${x},${y}`];
                 } else {
                     state.colors[`${x},${y}`] = 'flicker';
                 }
             }
          }
        }
        render();
        history.push();
      }

      function toggleJumpFlickerSelection() {
        const sel = getNormalizedSelection();
        if (!sel) return dialog.alert("No Selection", "Please select an area first.");
        
        let allJumpFlicker = true;
        for (let y = sel.y1; y <= sel.y2; y++) {
          for (let x = sel.x1; x <= sel.x2; x++) {
             if (state.grid[y][x] !== ' ' && state.colors[`${x},${y}`] !== 'jump_flicker') {
                 allJumpFlicker = false;
                 break;
             }
          }
          if (!allJumpFlicker) break;
        }

        for (let y = sel.y1; y <= sel.y2; y++) {
          for (let x = sel.x1; x <= sel.x2; x++) {
             if (state.grid[y][x] !== ' ') {
                 if (allJumpFlicker) {
                     if (state.colors[`${x},${y}`] === 'jump_flicker') delete state.colors[`${x},${y}`];
                 } else {
                     state.colors[`${x},${y}`] = 'jump_flicker';
                 }
             }
          }
        }
        render();
        history.push();
      }

      function updateBlockConfig(val) {
        const sel = getNormalizedSelection();
        if (!sel) return;
        const count = parseInt(val);
        
        for (let y = sel.y1; y <= sel.y2; y++) {
          for (let x = sel.x1; x <= sel.x2; x++) {
             if (['W', 'K', 'k'].includes(state.grid[y][x])) {
                 if (count > 1) state.blockConfigs[`${x},${y}`] = { count: count };
                 else delete state.blockConfigs[`${x},${y}`];
             }
          }
        }
        history.push();
      }

      function deleteSelection() {
        const b = getNormalizedSelection();
        if (!b) return;
        for (let y = b.y1; y <= b.y2; y++)
          for (let x = b.x1; x <= b.x2; x++) {
              paint(x, y, " ", false);
              state.fakes.delete(`${x},${y}`);
              state.risingThrough.delete(`${x},${y}`);
              state.illusions.delete(`${x},${y}`);
              delete state.risingSpeeds[`${x},${y}`];
              delete state.blockConfigs[`${x},${y}`];
          }
        render(); // Batch render
        history.push();

      }

      function fillSelection() {
        const b = getNormalizedSelection();
        if (!b) return;
        for (let y = b.y1; y <= b.y2; y++)
          for (let x = b.x1; x <= b.x2; x++) paint(x, y, state.selectedChar, false);
        render(); // Batch render
        history.push();
      }

      function mirrorSelection(axis) {
        const b = getNormalizedSelection();
        if (!b) return;

        const w = b.x2 - b.x1 + 1;
        const h = b.y2 - b.y1 + 1;
        const temp = [];

        for (let y = 0; y < h; y++) {
          temp[y] = [];
          for (let x = 0; x < w; x++) {
            temp[y][x] = state.grid[b.y1 + y][b.x1 + x];
            temp[y][x + "_c"] = state.colors[`${b.x1 + x},${b.y1 + y}`];
          }
        }

        if (axis === "h") {
          for (let y = 0; y < h; y++) {
            // Reverse the row data
            // We need to reconstruct the row because color data is interleaved in temp object properties
            const rowChars = [];
            const rowColors = [];
            for (let x = 0; x < w; x++) {
              rowChars.push(temp[y][x]);
              rowColors.push(temp[y][x + "_c"]);
            }
            rowChars.reverse();
            rowColors.reverse();

            for (let x = 0; x < w; x++) {
              temp[y][x] = rowChars[x];
              temp[y][x + "_c"] = rowColors[x];
            }
          }
        } else {
          temp.reverse();
        }

        for (let y = 0; y < h; y++) {
          for (let x = 0; x < w; x++) {
            state.grid[b.y1 + y][b.x1 + x] = temp[y][x];
            const color = temp[y][x + "_c"];
            if (color) state.colors[`${b.x1 + x},${b.y1 + y}`] = color;
            else delete state.colors[`${b.x1 + x},${b.y1 + y}`];
            
            // Handle fakes? Mirroring fakes is complex without storing them in temp.
            // For now, clear fakes in mirrored area to avoid confusion or implement full mirror.
            state.fakes.delete(`${b.x1 + x},${b.y1 + y}`);
            state.risingThrough.delete(`${b.x1 + x},${b.y1 + y}`);
            state.illusions.delete(`${b.x1 + x},${b.y1 + y}`);
          }
        }
        render();
        history.push();
      }

      function shiftSelection(dx, dy) {
        const b = getNormalizedSelection();
        if (!b) return;

        const w = b.x2 - b.x1 + 1;
        const h = b.y2 - b.y1 + 1;
        const temp = [];

        // Copy
        for (let y = b.y1; y <= b.y2; y++) {
          temp[y - b.y1] = [];
          for (let x = b.x1; x <= b.x2; x++) {
            temp[y - b.y1][x - b.x1] = state.grid[y][x];
            temp[y - b.y1][x - b.x1 + "_c"] = state.colors[`${x},${y}`];
            temp[y - b.y1][x - b.x1 + "_f"] = state.fakes.has(`${x},${y}`);
            temp[y - b.y1][x - b.x1 + "_i"] = state.illusions.has(`${x},${y}`);
            temp[y - b.y1][x - b.x1 + "_r"] = state.risingThrough.has(`${x},${y}`);
            temp[y - b.y1][x - b.x1 + "_cfg"] = state.blockConfigs[`${x},${y}`];
            state.grid[y][x] = " "; // Clear source
            delete state.colors[`${x},${y}`];
            state.fakes.delete(`${x},${y}`);
            state.illusions.delete(`${x},${y}`);
            state.risingThrough.delete(`${x},${y}`);
          }
        }

        // Paste at new location
        const nx = b.x1 + dx;
        const ny = b.y1 + dy;

        for (let y = 0; y < h; y++) {
          for (let x = 0; x < w; x++) {
            const ty = ny + y;
            const tx = nx + x;
            if (ty >= 0 && ty < state.height && tx >= 0 && tx < state.width) {
              state.grid[ty][tx] = temp[y][x];
              if (temp[y][x + "_c"])
                state.colors[`${tx},${ty}`] = temp[y][x + "_c"];
              else delete state.colors[`${tx},${ty}`];
              
              if (temp[y][x + "_f"]) state.fakes.add(`${tx},${ty}`);
              else state.fakes.delete(`${tx},${ty}`);

              if (temp[y][x + "_i"]) state.illusions.add(`${tx},${ty}`);
              else state.illusions.delete(`${tx},${ty}`);

              if (temp[y][x + "_r"]) state.risingThrough.add(`${tx},${ty}`);
              else state.risingThrough.delete(`${tx},${ty}`);

              if (temp[y][x + "_cfg"]) state.blockConfigs[`${tx},${ty}`] = temp[y][x + "_cfg"];
              else delete state.blockConfigs[`${tx},${ty}`];
            }
          }
        }

        // Update selection box
        state.selection.startX += dx;
        state.selection.endX += dx;
        state.selection.startY += dy;
        state.selection.endY += dy;

        render();
        history.push();
        updateSelectionUI();
      }

      function floodFill(sx, sy, char) {
        const target = state.grid[sy][sx];
        if (target === char) return;
        const queue = [[sx, sy]];
        while (queue.length) {
          const [x, y] = queue.pop();
          if (
            x < 0 ||
            x >= state.width ||
            y < 0 ||
            y >= state.height ||
            state.grid[y][x] !== target
          )
            continue;
          delete state.colors[`${x},${y}`];
          state.fakes.delete(`${x},${y}`);
          state.risingThrough.delete(`${x},${y}`);
          state.illusions.delete(`${x},${y}`);
          delete state.risingSpeeds[`${x},${y}`];
          delete state.blockConfigs[`${x},${y}`];
          queue.push([x + 1, y], [x - 1, y], [x, y + 1], [x, y - 1]);
        }
        render();

      }

      function zoom(d) {
        state.zoom = Math.max(0.1, Math.min(4, state.zoom + d));
        applyZoom();
      }
      function applyZoom() {
        document.getElementById("level-grid").style.transform =
          `scale(${state.zoom})`;
        document.getElementById("zoom-label").innerText = `${Math.round(
          state.zoom * 100,
        )}%`;
        minimap.render();
      }
      function autoAdjust() {
        const vp = document.getElementById("viewport");
        const vw = vp.clientWidth - 80,
          vh = vp.clientHeight - 80;
        const gw = state.width * 24,
          gh = state.height * 24;
        state.zoom = Math.min(vw / gw, vh / gh, 1.2);
        applyZoom();
        // Center the grid in the viewport
        const gridEl = document.getElementById("level-grid");
        gridEl.style.marginLeft =
          Math.max(0, (vp.clientWidth - gw * state.zoom) / 2) + "px";
        gridEl.style.marginTop =
          Math.max(0, (vp.clientHeight - gh * state.zoom) / 2) + "px";
        minimap.render();
      }

      function toggleRightPanel() {
        state.rightPanelOpen = !state.rightPanelOpen;
        const panel = document.getElementById("right-panel");
        const btn = document.getElementById("restore-panel");
        if (state.rightPanelOpen) {
          panel.style.transform = "translateX(0)";
          panel.style.marginRight = "0";
          btn.classList.add("hidden");
        } else {
          panel.style.transform = "translateX(320px)";
          panel.style.marginRight = "-320px";
          btn.classList.remove("hidden");
        }
        setTimeout(autoAdjust, 350);
      }

      function toggleGrid() {
        const show = document.getElementById("opt-showgrid").checked;
        const grid = document.getElementById("level-grid");
        if (show) grid.classList.add("grid-lines");
        else grid.classList.remove("grid-lines");
      }

      function validateLevel() {
        let coins = 0,
          blue = 0,
          players = 0;
        state.grid.forEach((r) =>
          r.forEach((c) => {
            if (c === "o") coins++;
            if (c === "B") blue++;
            if (c === "@") players++;
          }),
        );
        document.getElementById("stat-coins").innerText = coins;
        document.getElementById("stat-blue").innerText =
          blue > 0 ? "YES" : "NO";
        document.getElementById("stat-player").innerText =
          players > 0 ? "ACTIVE" : "MISSING";
        document.getElementById("stat-player").className =
          players > 0 ? "text-green-400 font-bold" : "text-red-500 italic";

        const feedback = document.getElementById("val-feedback");
        feedback.classList.remove("hidden");
        let errs = [];
        if (players === 0) errs.push("No Spawn Point (@) detected.");
        if (players > 1)
          errs.push("Multiple Spawn Points detected (only 1 allowed).");
        if (coins === 0) errs.push("No Collectibles (o) added.");
        if (blue > 0) errs.push("Blue Coin (B) present.");

        if (errs.length) {
          // Check if errors are critical or just info
          const critical = errs.some(
            (e) =>
              e.includes("No Spawn") ||
              e.includes("No Collectibles") ||
              e.includes("Multiple"),
          );
          if (critical) {
            feedback.innerHTML = `<div class="font-bold text-red-400 mb-1">ISSUES FOUND</div><ul class="space-y-1">${errs
              .map((e) => `<li>• ${e}</li>`)
              .join("")}</ul>`;
            feedback.className =
              "mt-3 text-[10px] p-3 rounded border border-red-900/40 bg-red-900/10 text-red-300";
          } else {
            feedback.innerHTML = `<div class="font-bold text-blue-400 mb-1">LEVEL NOTES</div><ul class="space-y-1">${errs
              .map((e) => `<li>• ${e}</li>`)
              .join("")}</ul>`;
            feedback.className =
              "mt-3 text-[10px] p-3 rounded border border-blue-900/40 bg-blue-900/10 text-blue-300";
          }
        } else {
          feedback.innerText = "Level looks good! Ready to play.";
          feedback.className =
            "mt-3 text-[10px] p-3 rounded border border-green-900/40 bg-green-900/10 text-green-300";
        }
      }

      function clearCanvas() {
        state.grid = Array(state.height)
          .fill(null)
          .map(() => Array(state.width).fill(" "));
        state.colors = {};
        state.fakes = new Set();
        state.risingThrough = new Set();
        state.illusions = new Set();
        state.actions = [];
        state.blockConfigs = {};
        state.selection = null;
        render();
        history.push();
        updateStatus("Canvas Cleared");
      }

      function copySelection() {
        const sel = getNormalizedSelection();
        if (!sel) return;
        const data = [];
        for (let y = sel.y1; y <= sel.y2; y++) {
          const row = [];
          for (let x = sel.x1; x <= sel.x2; x++) {
            row.push(state.grid[y][x]);
            row.push(state.colors[`${x},${y}`]); // Interleave color data? Or use object.
            row.push(state.fakes.has(`${x},${y}`));
            row.push(state.illusions.has(`${x},${y}`));
            row.push(state.risingThrough.has(`${x},${y}`));
            row.push(state.blockConfigs[`${x},${y}`]);
          }
          data.push(row);
        }
        clipboard = data;
        updateStatus("Copied to Clipboard");
      }

      // Simplified paste for now (doesn't support color copy/paste fully in this snippet to save space, but logic is similar to shift)
      function pasteSelection() {
        if (!clipboard) return;
        let startX = state.selection
          ? Math.min(state.selection.startX, state.selection.endX)
          : 0;
        let startY = state.selection
          ? Math.min(state.selection.startY, state.selection.endY)
          : 0;

        const h = clipboard.length;
        const w = clipboard[0].length / 6; // Adjusted for interleaved data

        for (let y = 0; y < h; y++) {
          for (let x = 0; x < w; x++) {
            const ty = startY + y;
            const tx = startX + x;
            if (ty < state.height && tx < state.width) {
              state.grid[ty][tx] = clipboard[y][x * 4];
              if (clipboard[y][x * 5 + 1])
                state.colors[`${tx},${ty}`] = clipboard[y][x * 5 + 1];
              
              if (clipboard[y][x * 5 + 2]) state.fakes.add(`${tx},${ty}`);
              else state.fakes.delete(`${tx},${ty}`);

              if (clipboard[y][x * 5 + 3]) state.illusions.add(`${tx},${ty}`);
              else state.illusions.delete(`${tx},${ty}`);

              if (clipboard[y][x * 5 + 4]) state.risingThrough.add(`${tx},${ty}`);
              else state.risingThrough.delete(`${tx},${ty}`);

              if (clipboard[y][x * 6 + 5]) state.blockConfigs[`${tx},${ty}`] = clipboard[y][x * 6 + 5];
              else delete state.blockConfigs[`${tx},${ty}`];

              // Update visual
              const cell =
                document.getElementById("level-grid").children[
                  ty * state.width + tx + 1
                ];
              if (cell) cell.className = `cell ${TILE_MAP[state.grid[ty][tx]]}`;
            }
          }
        }
        render(); // Full render to be safe
        history.push();
        updateStatus("Pasted");
      }

      function adjustProp(id, delta) {
        const el = document.getElementById(id);
        let val = parseInt(el.value) || 0;
        val = Math.max(1, val + delta);
        el.value = val;
      }

      function setDifficulty(n) {
        document.getElementById("prop-diff").value = n;
        document.getElementById("diff-val").innerText = n;
        const container = document.getElementById("diff-bars");
        container.innerHTML = "";
        const colors = ["#22c55e", "#84cc16", "#eab308", "#f97316", "#ef4444"];

        for (let i = 1; i <= 5; i++) {
          const btn = document.createElement("button");
          btn.className = `diff-btn border border-slate-800 bg-slate-900 ${i <= n ? "active" : ""}`;
          if (i <= n) {
            btn.style.backgroundColor = colors[i - 1];
            btn.style.borderColor = colors[i - 1];
            btn.style.boxShadow = `0 0 8px ${colors[i - 1]}40`;
          }
          btn.onclick = () => setDifficulty(i);
          container.appendChild(btn);
        }
      }

      const dialog = {
        show(type, title, msg, onConfirm, defaultVal = "") {
          const el = document.getElementById("dialog-modal");
          const titleEl = document.getElementById("dialog-title");
          const msgEl = document.getElementById("dialog-message");
          const inputEl = document.getElementById("dialog-input");
          const btnsEl = document.getElementById("dialog-buttons");

          titleEl.innerText = title;
          msgEl.innerText = msg;
          inputEl.value = defaultVal;

          inputEl.classList.add("hidden");
          btnsEl.innerHTML = "";

          const close = () => {
            el.classList.add("hidden");
            inputEl.onkeydown = null;
          };

          if (type === "prompt") {
            inputEl.classList.remove("hidden");
            setTimeout(() => inputEl.focus(), 50);
            inputEl.onkeydown = (e) => {
              if (e.key === "Enter") confirmBtn.click();
            };
          }

          if (type !== "alert") {
            const cancelBtn = document.createElement("button");
            cancelBtn.className =
              "px-4 py-2 bg-slate-800 hover:bg-slate-700 text-slate-300 text-xs font-bold rounded border border-slate-700";
            cancelBtn.innerText = "Cancel";
            cancelBtn.onclick = close;
            btnsEl.appendChild(cancelBtn);
          }

          const confirmBtn = document.createElement("button");
          confirmBtn.className =
            "px-4 py-2 bg-blue-600 hover:bg-blue-500 text-white text-xs font-bold rounded shadow-lg shadow-blue-600/20";
          confirmBtn.innerText = "Confirm";
          confirmBtn.onclick = () => {
            if (type === "prompt") onConfirm(inputEl.value);
            else onConfirm();
            close();
          };
          btnsEl.appendChild(confirmBtn);

          el.classList.remove("hidden");
        },
        alert(title, msg) {
          this.show("alert", title, msg, () => {});
        },
        confirm(title, msg, onYes) {
          this.show("confirm", title, msg, onYes);
        },
        prompt(title, msg, val, onYes) {
          this.show("prompt", title, msg, onYes, val);
        },
      };

      // --- COLOR PICKER SYSTEM ---
      const colorPicker = {
        recent: [
          "#ef4444",
          "#f97316",
          "#f59e0b",
          "#eab308",
          "#84cc16",
          "#22c55e",
          "#10b981",
          "#14b8a6",
          "#06b6d4",
          "#0ea5e9",
          "#3b82f6",
          "#6366f1",
          "#8b5cf6",
          "#a855f7",
          "#d946ef",
          "#ec4899",
          "#f43f5e",
          "#334155",
          "#475569",
          "#ffffff",
        ],
        callback: null,
        current: "#ffffff",

        open(initial, cb) {
          this.callback = cb;
          this.current = initial || "#ffffff";
          this.renderRecent();
          this.handleCustom(this.current);
          document
            .getElementById("color-picker-modal")
            .classList.remove("hidden");
        },

        renderRecent() {
          const container = document.getElementById("cp-recent");
          container.innerHTML = "";
          this.recent.forEach((c) => {
            const btn = document.createElement("button");
            btn.className =
              "w-6 h-6 rounded-full border border-slate-700 hover:scale-110 transition-transform";
            btn.style.backgroundColor = c;
            btn.onclick = () => this.handleCustom(c);
            container.appendChild(btn);
          });
        },

        handleCustom(val) {
          this.current = val;
          document.getElementById("cp-input").value = val;
          document.getElementById("cp-text").value = val;
        },

        confirm() {
          if (this.callback) this.callback(this.current);
          document.getElementById("color-picker-modal").classList.add("hidden");
        },

        clear() {
          if (this.callback) this.callback(null);
          document.getElementById("color-picker-modal").classList.add("hidden");
        },
      };

      function openColorPickerForSelection() {
        const sel = getNormalizedSelection();
        if (!sel)
          return dialog.alert("No Selection", "Please select an area first.");
        colorPicker.open("#ef4444", (color) => {
          for (let y = sel.y1; y <= sel.y2; y++) {
            for (let x = sel.x1; x <= sel.x2; x++) {
              const char = state.grid[y][x];
              if (color === null) {
                delete state.colors[`${x},${y}`];
              } else if (char === "x") {
                state.colors[`${x},${y}`] = color;
              }
            }
          }
          render();
          history.push();
        });
      }

      function openColorPickerForWatermark() {
        colorPicker.open(exportManager.settings.wmColor, (color) => {
          if (color) {
            exportManager.settings.wmColor = color;
            document.getElementById(
              "exp-wm-color-preview",
            ).style.backgroundColor = color;
            exportManager.update();
          }
        });
      }

      // Legacy helper for quick templates, now mostly replaced by projectManager.newProject
      function getQuickTemplate(type) {
        const h = 20,
          w = 40;
        const grid = Array(h)
          .fill(null)
          .map(() => Array(w).fill(" "));
        // Simple procedural generation for quick start
        if (type === "pit") {
          for (let x = 0; x < w; x++) {
            state.grid[h - 1][x] = "x";
            if (x > w / 3 && x < w / 2) state.grid[h - 1][x] = "!";
          }
          state.grid[h - 2][2] = "@";
          state.grid[h - 2][w - 2] = "o";
        } else if (type === "tunnel") {
          for (let x = 0; x < w; x++) {
            state.grid[h - 6][x] = "x";
            state.grid[h - 1][x] = "x";
            if (x % 8 === 0) state.grid[h - 4][x] = "|";
          }
          state.grid[h - 2][1] = "@";
          state.grid[h - 2][w - 2] = "o";
        } else if (type === "climb") {
          for (let y = 0; y < h; y++) {
            if (y % 4 === 0) {
              const s = y % 8 === 0 ? 0 : w - 15;
              for (let x = s; x < s + 15; x++) state.grid[y][x] = "x";
            }
          }
          state.grid[h - 1][2] = "@";
          state.grid[1][w - 2] = "o";
        }
        return { grid, width: w, height: h, gravity: 27 };
      }

      const CHAPTER_1_PLANS = [
        [
          "                                                                                ",
          "                                                                                ",
          "                                                                                ",
          "                                                                                ",
          "                                                                                ",
          "                                                                   B            ",
          "                                                                  xxx           ",
          "                                                   xx      xx    xx!xx          ",
          "                                    o o      xx                  x!!!x          ",
          "                                                                 xx!xx          ",
          "                                   xxxxx                          xvx           ",
          "                                                                            xx  ",
          "  xx                                      o o                                x  ",
          "  x                     o                                                    x  ",
          "  x                                      xxxxx                             o x  ",
          "  x          xxxx       o                                                    x  ",
          "  x  @       x  x                                                xxxxx       x  ",
          "  xxxxxxxxxxxx  xxxxxxxxxxxxxxx   xxxxxxxxxxxxxxxxxxxx     xxxxxxx   xxxxxxxxx  ",
          "                              x   x                  x     x                    ",
          "                              x!!!x                  x!!!!!x                    ",
          "                              x!!!x                  x!!!!!x                    ",
          "                              xxxxx                  xxxxxxx                    ",
          "                                                                                ",
          "                                                                                ",
        ],
        [
          "                                      x!!x                        xxxxxxx                                    x!x  ",
          "                                      x!!x                     xxxx     xxxx                                 x!x  ",
          "                                      x!!xxxxxxxxxx           xx           xx                                x!x  ",
          "                                      xx!!!!!!!!!!xx         xx             xx                               x!x  ",
          "                                       xxxxxxxxxx!!x         x                                    o   o   o  x!x  ",
          "                                                xx!x         x     o   o                                    xx!x  ",
          "                                                 x!x         x                                xxxxxxxxxxxxxxx!!x  ",
          "                                                 xvx         x     x   x                        !!!!!!!!!!!!!!xx  ",
          "                                                             xx  |   |   |  xx            xxxxxxxxxxxxxxxxxxxxx   ",
          "                                                              xx!!!!!!!!!!!xx            v                        ",
          "                                                               xxxx!!!!!xxxx                                      ",
          "                                               x     x            xxxxxxx        xxx         xxx                  ",
          "                                               x     x                           x x         x x                  ",
          "                                               x     x                             x         x                    ",
          "                                               x     x                             xx        x                    ",
          "                                               xx    x                             x         x                    ",
          "                                               x     x      o  o     x   x         x         x                    ",
          "               xxxxxxx        xxx   xxx        x     x               x   x         x         x                    ",
          "              xx     xx         x   x          x     x     xxxxxx    x   x   xxxxxxxxx       x                    ",
          "             xx       xx        x o x          x    xx               x   x   x               x                    ",
          "     @       x         x        x   x          x     x               x   x   x               x                    ",
          "    xxx      x         x        x   xB         x     x               x   xxxxx   xxxxxx      x                    ",
          "    x x      x         x       xx o xx         x     x               x     o     x x         x                    ",
          "!!!!x x!!!!!!x         x!!!!!!xx     xx!!!!!!!!xx    x!!!!!!!!!!     x     =     x x         x                    ",
          "!!!!x x!!!!!!x         x!!!!!xx       xxxxxxxxxx     x!!!!!!!xx!     xxxxxxxxxxxxx xx  o o  xx                    ",
          "!!!!x x!!!!!!x         x!!!!!x    o                 xx!!!!!!xx !                    xx     xx                     ",
          "!!!!x x!!!!!!x         x!!!!!x                     xx!!!!!!xx  !                     xxxxxxx                      ",
          "!!!!x x!!!!!!x         x!!!!!xx       xxxxxxxxxxxxxx!!!!!!xx   !                                                  ",
          "!!!!x x!!!!!!x         x!!!!!!xxxxxxxxx!!!!!!!!!!!!!!!!!!xx    !                                                  ",
          "!!!!x x!!!!!!x         x!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!xx     !                                                  ",
        ],
        [
          "                                                                                                              ",
          "                                                                                                              ",
          "                                                                                                              ",
          "                                                                                                              ",
          "                                                                                                              ",
          "                                        o                                                                     ",
          "                                                                                                              ",
          "                                        x                                                                     ",
          "                                        x                                                                     ",
          "                                        x                                                                     ",
          "                                        x                                                                     ",
          "                                       xxx                                                                    ",
          "                                       x x                 !!!        !!!  xxx                                ",
          "                                       x x                 !x!        !x!                                     ",
          "                                     xxx xxx                x          x                                      ",
          "                                      x   x                 x   oooo   x       xxx                            ",
          "                                      x   x                 x          x      x!!!x                           ",
          "                                      x   x                 xxxxxxxxxxxx       xxx                            ",
          "                                     xx   xx      x   x      x               B                                ",
          "                                      x   xxxxxxxxx   xxxxxxxx              x x                               ",
          "                                      x   x           x                    x!!!x                              ",
          "                                      x   x           x                     xxx                               ",
          "                                     xx   xx          x                                                       ",
          "                                      x   x= = = =    x            xxx                                        ",
          "                                      x   x           x           x!!!x                                       ",
          "                                      x   x    = = = =x     o      xxx       xxx                              ",
          "                                     xx   xx          x                     x!!!x                             ",
          "                              o   o   x   x           x     x                xxv        xxx                   ",
          "                                      x   x           x              x                 x!!!x                  ",
          "                             xxx xxx xxx xxx     o o  x!!!!!!!!!!!!!!x                   vx                   ",
          "                             x xxx x x xxx x          x!!!!!!!!!!!!!!x                                        ",
          "                             x             x   xxxxxxxxxxxxxxxxxxxxxxx                                        ",
          "                             xx           xx                                         xxx                      ",
          "  xxx                         x     x     x                                         x!!!x                xxx  ",
          "  x x                         x    xxx    x                                          xxx                 x x  ",
          "  x                           x    xxx    xxxxxxx                        xxxxx                             x  ",
          "  x                           x           x                              x   x                             x  ",
          "  x                           xx          x                              x x x                             x  ",
          "  x                                       x       |xxxx|    |xxxx|     xxx xxx                             x  ",
          "  x                xxx             o o    x                              x         xxx                     x  ",
          "  x               xxxxx       xx          x                             xxx       x!!!x          x         x  ",
          "  x               oxxxo       x    xxx    x                             x x        xxx          xxx        x  ",
          "  x                xxx        xxxxxxxxxxxxx  x oo x    x oo x    x oo  xx xx                    xxx        x  ",
          "  x      @          x         x           x!!x    x!!!!x    x!!!!x    xx   xx                    x         x  ",
          "  xxxxxxxxxxxxxxxxxxxxxxxxxxxxx           xxxxxxxxxxxxxxxxxxxxxxxxxxxxx     xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx  ",
          "                                                                                                              ",
          "                                                                                                              ",
        ],
        [
          "                                                                                                              ",
          "                                                                                                              ",
          "                                                                                                              ",
          "                                                                                                  xxxxx       ",
          "                                                                                                  x           ",
          "                                                                                                  x xxx       ",
          "                          o                                                                       x x x       ",
          "                                                                                             o o oxxx x       ",
          "                   xxx                                                                                x       ",
          "      B!  o  !                                                xxxxx xxxxx xxxxx xxxxx xxxxx xxxxx xxxxx       ",
          "       x     x                                                x   x x   x x   x x   x x   x x   x x           ",
          "       x= o  x            x                                   xxx x xxx x xxx x xxx x xxx x xxx x xxxxx       ",
          "       x     x                                                  x x   x x   x x   x x   x x   x x     x       ",
          "       !  o  !            o                                  xxxx xxxxx xxxxx xxxxx xxxxx xxxxx xxxxxxx       ",
          "                                                                                                              ",
          "          o              xxx                              xx                                                  ",
          "                                                                                                              ",
          "                                                                                                              ",
          "                                                      xx                                                      ",
          "                   xxx         xxx                                                                            ",
          "                                                                                                              ",
          "                          o                                                     x      x                      ",
          "                                                          xx     xx                                           ",
          "             xxx         xxx         xxx                                 x                  x                 ",
          "                                                                                                              ",
          "                                                                 ||                                           ",
          "  xxxxxxxxxxx                                                                                                 ",
          "  x         x o xxxxxxxxx o xxxxxxxxx o xx                                                x                   ",
          "  x         x   x       x   x       x   x                 ||                  x     x                         ",
          "  x  @      xxxxx   o   xxxxx   o   xxxxx                                                                     ",
          "  xxxxxxx                                     xxxxx       xx     xx     xxx                                   ",
          "        x=                  =                =x   x                     xxx                                   ",
          "        xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx   x!!!!!!!!!!!!!!!!!!!!!xxx!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!",
          "                                                  xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx",
          "                                                                                                              ",
        ],
        [
          "                                                             ",
          "                                                             ",
          "                                                             ",
          "                                                             ",
          "                                                             ",
          "@                                            o               ",
          "xxxx                                         x               ",
          "                                             x               ",
          "                                             x!x             ",
          "                                             xxx             ",
          "                                                 x           ",
          "                                                             ",
          "       ooooooo                                  o            ",
          "       xxxxxxx  x!! x  xxxx    xxxx  x    x  xxxx            ",
          "          x     x!! x  x       xo   Bxx   x  x   x           ",
          "          x     x!!ox  xo      x     x x  x  x   x           ",
          "          x     xxxxx  xxxx    xxxx  x  xox  x   x           ",
          "          x     x   x  x       x     x   xx  x   x           ",
          "          x     x   x  xo      x     x    x  x   x           ",
          "          x     x   x  xxxx    xxxx  x    x  xxxx            ",
          "          v     v   v  vvvv    vvvv  v    v  vvvv            ",
          "                                                             ",
          "                                                             ",
          "                                                             ",
          "                                                             ",
          "                                                             ",
          "                                                             ",
          "                                                             ",
          "!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!",
        ],
      ];

      const CHAPTER_2_LEVELS = [
        {
          gravity: 10,
          plan: [
            "                                                                  ",
            "                                                                  ",
            "                                                                  ",
            "                                                    o             ",
            "                                                   xxx            ",
            "                                                                  ",
            "                                                                  ",
            "                         o                                        ",
            "                        xxx                                       ",
            "                                                                  ",
            "                    o                                             ",
            "                   xxx                                            ",
            "                                                                  ",
            "                   o                                              ",
            "                  xxx             B                               ",
            "                                   x                              ",
            "          o                        xxx                            ",
            "         xxx                                                      ",
            "                                                                  ",
            "        o                                                         ",
            "       xxx                                                        ",
            "                                                                  ",
            "       o                                                          ",
            "      xxx                                                         ",
            "  @                                                               ",
            "  xxx                                                             ",
            "                                                                  ",
            "!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!",
          ],
        },
        {
          gravity: 10,
          plan: [
            "                              ",
            "                              ",
            "                              ",
            "                              ",
            "                             @",
            "                         xxxxx",
            "                              ",
            "                         |    ",
            "                         |    ",
            "                         |    ",
            "                         |    ",
            "                         |    ",
            "                              ",
            "                              ",
            "                              ",
            "                              ",
            "=      =      =      =      !!",
            "                            xx",
            "                              ",
            "                              ",
            "                              ",
            "                              ",
            "                              ",
            "!!!!o!!!!!!!o!!!!!!!!o!!!!!!!B",
            "xxxxxxxxxxxxxxxxxxxxxxxxxxxxxx",
          ],
        },
        {
          gravity: 6,
          plan: [
            "                                                             ",
            "                                 B                           ",
            "                                 x!!                         ",
            "                                 x!x                         ",
            "                                 xxx                         ",
            "                                                             ",
            "      o         o         o                                  ",
            "     xxx       xxx       xxx                                 ",
            "                                                             ",
            "    =   =    =   =    =   =    =   =    =   =              ",
            "                                                             ",
            "     xxx      xxx      xxx       xxx      xxx               ",
            "       x        x        x         x        x               ",
            "   o   x    o   x    o   x     o   x    o   x              ",
            "  xxx  x   xxx  x   xxx  x    xxx  x   xxx  x              ",
            "       x        x        x         x        x               ",
            "       xxx      xxx      xxx       xxx      xxx             ",
            "                                                             ",
            "  v                                                        v ",
            "  v    x   x   x   x   x   x    x   x   x   x   x       v ",
            "  v   xxx xxx xxx xxx xxx xxx   xxx xxx xxx xxx xxx       v ",
            "  v    x   x   x   x   x   x    x   x   x   x   x       v ",
            "  v                                                      v ",
            "  v                                                        v ",
            "  v   !!! !!! !!! !!! !!! !!!  !!! !!! !!! !!! !!!       v ",
            "       xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx          ",
            "                                                             ",
            "@                                                           ",
            "xxxx                                                        ",
            "                                                            ",
            "                                                            ",
            "                                                            ",
            "                                                            ",
            "                                                            ",
            "!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!",
          ],
        },
        {
          gravity: 5,
          plan: [
            "                                                             ",
            "                                                             ",
            "                                                             ",
            "                                                             ",
            "                                                             ",
            "                                          o                  ",
            "                                         xxx                 ",
            "                                                             ",
            "                                         x!x                 ",
            "                                 xxx     xxx                 ",
            "                                                            ",
            "       o      o      o                   xxx                ",
            "      xxx    xxx    xxx                                     ",
            "                              v                             ",
            "                              v                             ",
            "                    =   =   =  v  =   =   =                 ",
            "                                v                           ",
            "  xxx     xxx     xxx     xxx   x   xxx     xxx     xxx     ",
            "  x x     x x     x x     x x   x   x x     x x       x     ",
            "  x x     x x     x x     x x   x   x x     x x      Bx     ",
            "  x x     x x     x x     x x   x   x x     x x     x x     ",
            "                                           o      o         ",
            "  x x     x x     x x     xo      xxx     xxx     x x       ",
            "  x x     x x     x x     xxx     x x     x x     x x       ",
            "  x x     x x     x x     x       x x     x x     x x       ",
            "  xxx     xxx     xxx     x       x x     x x     xxx       ",
            "                          o                                 ",
            "  ===   ===   ===   ===   ===   ===   ===   ===   ===   === ",
            "@                                                           ",
            "xxxx                                                        ",
            "                                                            ",
            "                                                            ",
            "                                                            ",
            "                                                            ",
            "                                                            ",
            "                                                            ",
            "!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!",
          ],
        },
        {
          name: "Low Gravity Gauntlet",
          plan: [
            "                                                                                                              ",
            "                                                                                                              ",
            "            o                                                                                                ",
            "           xxx                         xxx                           xxx                                     ",
            "                                        x x                           x x                                     ",
            "                                    o   x x   o                   o   x x   o                                 ",
            "                                   xxx  x x  xxx                 xxx  x x  xxx                                ",
            "                                        x x                           x x                                     ",
            "          v                             xxx                           xxx                                     ",
            "          v                                                                                                  ",
            "  ===  =  v  =  ===                      x                                                                  ",
            "          v                           xxx x xxx                                                            ",
            "          v                           x       x                                                              ",
            "                                      x       x                                                              ",
            "                                      x!!!!!!!x                                                              ",
            "                                      xxxxxxxxx                                                              ",
            "                                                                                                              ",
            "                            xxx                              xxx                                            ",
            "                            x x          o o o              x x                                            ",
            "                        =   x x   =  xxxxxxxxxxxxxx     =   x x   =                                         ",
            "                            xxx                              xxx                                            ",
            "                                                                                                              ",
            "           xxx              xB                                 x              xxx                            ",
            "           x x              xxx                              xxx              x x                            ",
            "       o    x x    o             x                          x                 x x    o                       ",
            "      xxx   x x   xxx        xxxx x xxxx              xxxx x xxxx             x x   xxx                      ",
            "           xxx                   x                        x                   xxx                            ",
            "                                  x                        x                                                ",
            "     =    =                  !!!!!!!!!!!!            !!!!!!!!!!!!                  =    =                    ",
            "                                                                                                              ",
            "  xxx       xxx                 x                        x                 xxx       xxx                     ",
            "  x x       x x             xxxxx x xxxxx            xxxxx x xxxxx                                           ",
            "  x x   o   x x   o         x         x              x         x                                            ",
            "  x x  xxx  x x  xxx        x    o    x              x    o    x                                            ",
            "  xxx  x x  xxx             x         x              x         x       xxx                           ",
            "       xxx                  xxxxxxxxxx              xxxxxxxxxx                                              ",
            "                                                                                                              ",
            "  x x                       x                        x                       x x                            ",
            "  x x                       x                        x                       x x                            ",
            "  x x       o   o   o   o   x       o           o    x                       x x                            ",
            "  x x       xv xv xv xv  xxxxx   xxxxx    xxxxx  xxx xxxxx                  x x                            ",
            "  x x                                                                       x x                            ",
            "  xxx                                                                       xxx                           ",
            "            !!!       !!!       !!!       !!!       !!!       !!!       !!!                                  ",
            "  @                                                                                                          ",
            "  xxx                                                                                                        ",
            "                                                                                                              ",
          ],
          gravity: 7,
        },
      ];

      function getTemplates() {
        let custom = [];
        try {
          custom = JSON.parse(
            localStorage.getItem("boi_custom_templates") || "[]",
          );
        } catch (e) {
          console.error("Error loading custom templates", e);
        }

        const builtIn = [
          ...CHAPTER_1_PLANS.map((plan, index) => ({
            name: `Game Level ${index + 1}`,
            name: `Level ${index + 1}`,
            description: `Official campaign level ${index + 1}.`,
            category: "Chapter 1",
            gravity: 27,
            plan: plan,
          })),
          ...CHAPTER_2_LEVELS.map((lvl, index) => ({
            name: `Moon Sector ${index + 1}`,
            name: `Level ${index + 1 + CHAPTER_1_PLANS.length}`,
            description: `Low gravity environment.`,
            category: "Chapter 2",
            gravity: lvl.gravity,
            plan: lvl.plan,
          })),
          {
            name: "Speed Run",
            description: "Flat sprint with hazards.",
            category: "Custom",
            gravity: 27,
            plan: [
              "                                                                                ",
              "                                                                                ",
              "                                                                                ",
              "                                                                                ",
              "                                                                                ",
              "                                                                                ",
              "                                                                                ",
              "                                                                                ",
              "                                                                                ",
              "                                                                                ",
              "                                                                                ",
              "                                                                                ",
              "                                                                                ",
              "                                                                                ",
              "                                                                                ",
              "                                                                                ",
              "  @       S       S       S       S       S       S       S       S       o     ",
              "xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx",
            ],
          },
        ];
        return [...custom, ...builtIn];
      }

      function openTemplatesModal() {
        document.getElementById("templates-modal").classList.remove("hidden");
        renderTemplates();
      }

      function renderTemplates() {
        const list = document.getElementById("templates-grid");
        const search = document
          .getElementById("tpl-search")
          .value.toLowerCase();
        list.innerHTML = "";

        let filtered = getTemplates().filter(
          (t) =>
            t.name.toLowerCase().includes(search) ||
            t.description.toLowerCase().includes(search),
        );

        filtered.forEach((t, idx) => {
          const el = document.createElement("div");
          el.className =
            "p-4 bg-slate-900 border border-slate-800 rounded-xl hover:border-blue-500 cursor-pointer group transition-all hover:bg-slate-800 relative overflow-hidden";
          el.innerHTML = `
                    <div class="font-bold text-slate-200 text-sm group-hover:text-blue-400 mb-1 relative z-10">${t.name}</div>
                    <div class="text-[10px] text-slate-500 mt-1">${t.description}</div>
                    <div class="flex justify-between items-end mt-3">
                        <div class="text-[9px] text-blue-500/70 font-bold uppercase tracking-wider bg-blue-900/20 px-2 py-1 rounded">${t.category}</div>
                        <div class="text-[9px] text-slate-600 font-mono">G:${t.gravity}</div>
                    </div>
                    ${
                      t.category === "Custom"
                        ? `
                    <button onclick="event.stopPropagation(); deleteTemplate('${t.name}')" class="absolute top-2 right-2 p-1.5 bg-slate-950/80 text-slate-500 hover:text-red-400 rounded opacity-0 group-hover:opacity-100 transition-opacity">
                        <svg width="12" height="12" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/></svg>
                    </button>
                    `
                        : ""
                    }
                `;
          el.onclick = () => loadTemplate(t);
          list.appendChild(el);
        });
      }

      function deleteTemplate(name) {
        dialog.confirm(
          "Delete Template",
          `Are you sure you want to delete "${name}"?`,
          () => {
            let custom = JSON.parse(
              localStorage.getItem("boi_custom_templates") || "[]",
            );
            custom = custom.filter((t) => t.name !== name);
            localStorage.setItem(
              "boi_custom_templates",
              JSON.stringify(custom),
            );
            renderTemplates();
            renderRecentTemplates();
          },
        );
      }

      function renderRecentTemplates() {
        let recent = [];
        try {
          recent = JSON.parse(
            localStorage.getItem("boi_recent_templates") || "[]",
          );
        } catch (e) {
          console.error("Error loading recent templates", e);
        }

        const container = document.getElementById("recent-templates-list");
        // Keep the browse button
        const browseBtn = container.lastElementChild;
        container.innerHTML = "";

        if (recent.length === 0) {
          container.innerHTML =
            '<div class="text-[10px] text-slate-600 italic text-center py-2">No recent templates</div>';
        } else {
          recent.forEach((t) => {
            const el = document.createElement("div");
            el.className = "template-card p-3 rounded-lg text-xs group";
            el.onclick = () => loadTemplate(t);
            el.innerHTML = `
                        <div class="font-bold text-slate-200 group-hover:text-blue-400 transition-colors">${t.name}</div>
                        <div class="text-[9px] text-slate-500">${t.description}</div>
                    `;
            container.appendChild(el);
          });
        }
        container.appendChild(browseBtn);
      }

      function loadTemplate(t) {
        state.height = t.plan.length;
        state.width = t.plan[0].length;
        state.grid = t.plan.map((row) => row.split(""));
        document.getElementById("prop-w").value = state.width;
        document.getElementById("prop-h").value = state.height;
        document.getElementById("prop-gravity").value = t.gravity || 27;
        document.getElementById("gravity-val").innerText = t.gravity || 27;

        // Update Recents
        let recent = [];
        try {
          recent = JSON.parse(
            localStorage.getItem("boi_recent_templates") || "[]",
          );
        } catch (e) {}

        recent = recent.filter((r) => r.name !== t.name);
        recent.unshift(t);
        if (recent.length > 3) recent.pop();
        localStorage.setItem("boi_recent_templates", JSON.stringify(recent));
        renderRecentTemplates();

        render();
        history.push();
        autoAdjust();
        closeModal("templates-modal");
        closeModal("start-modal");
        updateStatus("Template Loaded");
      }

      function applyResize() {
        const wInput = document.getElementById("prop-w");
        const hInput = document.getElementById("prop-h");
        const nw = parseInt(wInput.value) || 40;
        const nh = parseInt(hInput.value) || 20;

        if (nw === state.width && nh === state.height) return;

        const newGrid = Array(nh)
          .fill(null)
          .map(() => Array(nw).fill(" "));
        for (let y = 0; y < Math.min(state.height, nh); y++)
          for (let x = 0; x < Math.min(state.width, nw); x++)
            newGrid[y][x] = state.grid[y][x];
        state.width = nw;
        state.height = nh;
        state.grid = newGrid;
        render();
        history.push();
        autoAdjust();
      }

      function closeModal(id) {
        document.getElementById(id).classList.add("hidden");
      }
      function showInfo(title, text) {
        document.getElementById("info-title").innerText = title;
        document.getElementById("info-text").innerText = text;
        document.getElementById("info-modal").classList.remove("hidden");
      }
      function showPreview() {
        document.getElementById("modal-overlay").classList.remove("hidden");
        document.getElementById("json-preview-text").innerText = io.export();
      }
      function updateStatus(m) {
        document.getElementById("action-status").innerText = m;
        setTimeout(
          () => (document.getElementById("action-status").innerText = ""),
          3000,
        );
      }

      const io = {
        export() {
          return JSON.stringify(
            {
              name: document.getElementById("prop-name").value,
              creator: document.getElementById("prop-creator").value,
              description: document.getElementById("prop-desc").value,
              difficulty: parseInt(document.getElementById("prop-diff").value),
              gravity: parseInt(document.getElementById("prop-gravity").value),
              riseInterval: parseFloat(
                document.getElementById("prop-rise").value,
              ),
              forceZoom: document.getElementById("prop-force-zoom").value === 'true',
              disableDeathAnim: document.getElementById("prop-no-death-anim").value === 'true',
              music: state.music,
              colors: state.colors,
              fakes: Array.from(state.fakes),
              risingThrough: Array.from(state.risingThrough),
              illusions: Array.from(state.illusions),
              risingSpeeds: state.risingSpeeds,
              blockConfigs: state.blockConfigs,
              plan: state.grid.map((r) => r.join("")),
            },
            null,
            2,
          );
        },
        downloadJson() {
          const blob = new Blob([this.export()], { type: "application/json" });
          const a = document.createElement("a");
          a.href = URL.createObjectURL(blob);
          a.download = `${document
            .getElementById("prop-name")
            .value.replace(/\s+/g, "_")}.json`;
          a.click();
        },
        exportImage() {
          const canvas = document.createElement("canvas");
          const ctx = canvas.getContext("2d");
          const cellSize = 24;
          canvas.width = state.width * cellSize;
          canvas.height = state.height * cellSize;

          const isModern = document.body.classList.contains("style-modern");

          // Background
          ctx.fillStyle = "#020617";
          ctx.fillRect(0, 0, canvas.width, canvas.height);

          // Grid Lines
          if (document.getElementById("opt-showgrid").checked) {
            ctx.strokeStyle = "rgba(30, 41, 59, 0.5)";
            ctx.lineWidth = 0.5;
            ctx.beginPath();
            for (let x = 0; x <= state.width; x++) {
              ctx.moveTo(x * cellSize, 0);
              ctx.lineTo(x * cellSize, canvas.height);
            }
            for (let y = 0; y <= state.height; y++) {
              ctx.moveTo(0, y * cellSize);
              ctx.lineTo(canvas.width, y * cellSize);
            }
            ctx.stroke();
          }

          for (let y = 0; y < state.height; y++) {
            for (let x = 0; x < state.width; x++) {
              const char = state.grid[y][x];
              const px = x * cellSize;
              const py = y * cellSize;
              const cx = px + cellSize / 2;
              const cy = py + cellSize / 2;

              if (char === " ") continue;

              if (char === "x") {
                if (isModern) {
                  ctx.fillStyle = "#334155";
                  ctx.fillRect(px, py, cellSize, cellSize);
                  ctx.strokeStyle = "#1e293b";
                  ctx.lineWidth = 1;
                  ctx.strokeRect(
                    px + 0.5,
                    py + 0.5,
                    cellSize - 1,
                    cellSize - 1,
                  );
                } else {
                  ctx.fillStyle = "#444444";
                  ctx.fillRect(px, py, cellSize, cellSize);
                  ctx.strokeStyle = "#333333";
                  ctx.lineWidth = 3;
                  ctx.strokeRect(
                    px + 1.5,
                    py + 1.5,
                    cellSize - 3,
                    cellSize - 3,
                  );
                }
              } else if (
                char === "!" ||
                char === "=" ||
                char === "|" ||
                char === "v"
              ) {
                ctx.fillStyle = isModern ? "#ef4444" : "#e55555";
                if (isModern) {
                  ctx.beginPath();
                  if (ctx.roundRect)
                    ctx.roundRect(px, py, cellSize, cellSize, 3);
                  else ctx.rect(px, py, cellSize, cellSize);
                  ctx.fill();
                } else {
                  ctx.fillRect(px, py, cellSize, cellSize);
                }
              } else if (char === "H" || char === "V") {
                let fill = isModern ? "#64748b" : "#777777";
                let stroke = isModern ? "#475569" : "#555555";
                if (customColor) {
                  fill = customColor;
                  stroke = adjustColor(customColor, -20);
                }
                ctx.fillStyle = fill;
                if (isModern) {
                  ctx.beginPath();
                  if (ctx.roundRect)
                    ctx.roundRect(px, py, cellSize, cellSize, 4);
                  else ctx.rect(px, py, cellSize, cellSize);
                  ctx.fill();
                  ctx.strokeStyle = stroke;
                  ctx.lineWidth = 1;
                  ctx.stroke();
                } else {
                  ctx.fillRect(px, py, cellSize, cellSize);
                  ctx.strokeStyle = stroke;
                  ctx.lineWidth = 3;
                  ctx.strokeRect(
                    px + 1.5,
                    py + 1.5,
                    cellSize - 3,
                    cellSize - 3,
                  );
                }
                ctx.fillStyle = "#ffffff";
                ctx.font = "bold 10px sans-serif";
                ctx.textAlign = "center";
                ctx.textBaseline = "middle";
                ctx.fillText(char === "H" ? "↔" : "↕", cx, cy);
              } else if (char === "^") {
                ctx.fillStyle = isModern ? "#ef4444" : "#d32f2f";
                if (isModern) {
                  ctx.fillRect(px, py, cellSize, cellSize);
                  ctx.strokeStyle = "#b91c1c";
                  ctx.lineWidth = 1;
                  ctx.strokeRect(
                    px + 0.5,
                    py + 0.5,
                    cellSize - 1,
                    cellSize - 1,
                  );
                } else {
                  ctx.fillRect(px, py, cellSize, cellSize);
                  ctx.strokeStyle = "#b71c1c";
                  ctx.lineWidth = 3;
                  ctx.strokeRect(
                    px + 1.5,
                    py + 1.5,
                    cellSize - 3,
                    cellSize - 3,
                  );
                }
                ctx.fillStyle = "rgba(255,255,255,0.7)";
                ctx.font = "10px sans-serif";
                ctx.fillText("▲", cx, cy);
              } else if (char === "o") {
                ctx.fillStyle = isModern ? "#fbbf24" : "#e2e838";
                ctx.strokeStyle = isModern ? "#f59e0b" : "#c2c828";
                ctx.lineWidth = isModern ? 2 : 1;
                const scale = isModern ? 0.65 : 0.6;
                const r = (cellSize * scale) / 2;
                ctx.beginPath();
                ctx.arc(cx, cy, r, 0, Math.PI * 2);
                ctx.fill();
                ctx.stroke();
              } else if (char === "B") {
                ctx.fillStyle = isModern ? "#3b82f6" : "#335699";
                ctx.strokeStyle = isModern ? "#2563eb" : "transparent";
                ctx.lineWidth = isModern ? 2 : 0;
                const scale = isModern ? 0.7 : 0.65;
                const r = (cellSize * scale) / 2;
                ctx.beginPath();
                ctx.arc(cx, cy, r, 0, Math.PI * 2);
                ctx.fill();
                if (isModern) ctx.stroke();
              } else if (char === "@") {
                ctx.fillStyle = isModern ? "#10b981" : "#5599aa";
                const scale = isModern ? 0.85 : 0.8;
                const size = cellSize * scale;
                const offset = (cellSize - size) / 2;
                const r = isModern ? 6 : 4;
                ctx.beginPath();
                if (ctx.roundRect)
                  ctx.roundRect(px + offset, py + offset, size, size, r);
                else ctx.rect(px + offset, py + offset, size, size);
                ctx.fill();
              } else if (char === "S") {
                ctx.fillStyle = customColor || "#94a3b8";
                ctx.beginPath();
                ctx.moveTo(px, py + cellSize);
                ctx.lineTo(px + cellSize, py + cellSize);
                ctx.lineTo(px + cellSize / 2, py);
                ctx.fill();
              } else if (char === "s") {
                ctx.fillStyle = customColor || "#94a3b8";
                ctx.beginPath();
                ctx.moveTo(px, py);
                ctx.lineTo(px + cellSize, py);
                ctx.lineTo(px + cellSize / 2, py + cellSize);
                ctx.fill();
              }
              ctx.globalAlpha = 1.0;
            }
          }

          const link = document.createElement("a");
          link.download = `${document
            .getElementById("prop-name")
            .value.replace(/\s+/g, "_")}.png`;
          link.href = canvas.toDataURL();
          link.click();
        },
        copyToClipboard() {
          const text = this.export();
          const textArea = document.createElement("textarea");
          textArea.value = text;
          document.body.appendChild(textArea);
          textArea.select();
          try {
            document.execCommand("copy");
            updateStatus("Copied to Clipboard");
          } catch (err) {}
          document.body.removeChild(textArea);
        },
        importClick() {
          document.getElementById("import-file").click();
        },
      };

      const templateSaver = {
        mode: "new", // 'new' or 'replace'
        selectedTemplate: null,

        open() {
          const custom = JSON.parse(
            localStorage.getItem("boi_custom_templates") || "[]",
          );
          const modal = document.getElementById("save-template-modal");
          const tabs = document.getElementById("st-tabs");

          document.getElementById("st-name-new").value =
            document.getElementById("prop-name").value;

          if (custom.length === 0) {
            tabs.classList.add("hidden");
            this.switchTab("new");
          } else {
            tabs.classList.remove("hidden");
            this.switchTab("new");
            this.renderList(custom);
          }

          modal.classList.remove("hidden");
        },

        switchTab(mode) {
          this.mode = mode;
          const btnNew = document.getElementById("st-tab-new");
          const btnRep = document.getElementById("st-tab-replace");
          const contentNew = document.getElementById("st-content-new");
          const contentRep = document.getElementById("st-content-replace");

          if (mode === "new") {
            btnNew.className =
              "flex-1 py-3 text-xs font-bold text-blue-400 border-b-2 border-blue-500 bg-slate-900/30 transition-colors";
            btnRep.className =
              "flex-1 py-3 text-xs font-bold text-slate-500 hover:text-slate-300 border-b-2 border-transparent transition-colors";
            contentNew.classList.remove("hidden");
            contentRep.classList.add("hidden");
          } else {
            btnNew.className =
              "flex-1 py-3 text-xs font-bold text-slate-500 hover:text-slate-300 border-b-2 border-transparent transition-colors";
            btnRep.className =
              "flex-1 py-3 text-xs font-bold text-blue-400 border-b-2 border-blue-500 bg-slate-900/30 transition-colors";
            contentNew.classList.add("hidden");
            contentRep.classList.remove("hidden");
          }
        },

        renderList(custom) {
          const list = document.getElementById("st-list");
          list.innerHTML = "";
          custom.forEach((t, idx) => {
            const el = document.createElement("div");
            el.className =
              "p-3 rounded border border-slate-800 bg-slate-950 hover:border-blue-500 cursor-pointer transition-colors flex justify-between items-center";
            el.innerHTML = `<span class="text-xs font-bold text-slate-300">${t.name}</span><span class="text-[9px] text-slate-600">Custom</span>`;
            el.onclick = () => {
              document
                .querySelectorAll("#st-list > div")
                .forEach((d) =>
                  d.classList.remove("border-blue-500", "bg-blue-900/10"),
                );
              el.classList.add("border-blue-500", "bg-blue-900/10");
              this.selectedTemplate = t.name;
            };
            list.appendChild(el);
          });
        },

        confirm() {
          let name;
          if (this.mode === "new") {
            name = document.getElementById("st-name-new").value.trim();
            if (!name)
              return dialog.alert("Error", "Please enter a template name.");

            const custom = JSON.parse(
              localStorage.getItem("boi_custom_templates") || "[]",
            );
            if (custom.some((t) => t.name === name)) {
              return dialog.confirm(
                "Template Exists",
                "A template with this name already exists. Overwrite?",
                () => {
                  this.save(name, true);
                },
              );
            }
            this.save(name, false);
          } else {
            if (!this.selectedTemplate)
              return dialog.alert(
                "Error",
                "Please select a template to replace.",
              );
            this.save(this.selectedTemplate, true);
          }
        },

        save(name, replace) {
          const t = {
            name: name,
            description:
              document.getElementById("prop-desc").value ||
              "Custom user template",
            category: "Custom",
            gravity: parseInt(document.getElementById("prop-gravity").value),
            riseInterval: parseFloat(
              document.getElementById("prop-rise").value,
            ),
            forceZoom: document.getElementById("prop-force-zoom").value === 'true',
            disableDeathAnim: document.getElementById("prop-no-death-anim").value === 'true',
            music: state.music,
            colors: state.colors,
            fakes: Array.from(state.fakes),
            illusions: Array.from(state.illusions),
            plan: state.grid.map((r) => r.join("")),
            risingSpeeds: state.risingSpeeds,
          };

          let custom = JSON.parse(
            localStorage.getItem("boi_custom_templates") || "[]",
          );
          if (replace) {
            custom = custom.map((ct) => (ct.name === name ? t : ct));
          } else {
            custom.push(t);
          }

          localStorage.setItem("boi_custom_templates", JSON.stringify(custom));
          updateStatus("Template Saved");
          renderRecentTemplates();
          closeModal("save-template-modal");
        },
      };

      const projectManager = {
        currentId: null,
        contextId: null,
        newProject(type) {
          this.currentId = null;
          document.getElementById("prop-name").value = "New Level";
          document.getElementById("prop-creator").value = "Anonymous";
          document.getElementById("prop-desc").value = "";
          setDifficulty(1);

          if (type && ["pit", "tunnel", "climb"].includes(type)) {
            // Quick templates
            const t = getQuickTemplate(type);
            state.width = t.width;
            state.height = t.height;
            state.grid = t.grid;
            document.getElementById("prop-gravity").value = 27;
            document.getElementById("prop-rise").value = 0;
            document.getElementById("prop-force-zoom").value = "false";
            document.getElementById("prop-no-death-anim").value = "false";
          } else {
            // Blank
            state.width = 40;
            state.height = 20;
            state.grid = Array(state.height)
              .fill(null)
              .map(() => Array(state.width).fill(" "));
            document.getElementById("prop-gravity").value = 27;
            document.getElementById("prop-force-zoom").value = "false";
            document.getElementById("prop-no-death-anim").value = "false";
          }

          document.getElementById("prop-w").value = state.width;
          document.getElementById("prop-h").value = state.height;
          document.getElementById("gravity-val").innerText =
            document.getElementById("prop-gravity").value;
          
          state.colors = {};
          state.fakes = new Set();
          state.risingThrough = new Set();
            state.illusions = new Set();
          state.risingSpeeds = {};

          render();
          history.stack = [];
          history.push();
          closeModal("start-modal");
          autoAdjust();
        },
        importFromMenu(input) {
          const file = input.files[0];
          if (!file) return;
          // Re-use the existing file reader logic but adapted
          const reader = new FileReader();
          reader.onload = (ev) => {
            const d = JSON.parse(ev.target.result);
            this.currentId = null; // Treat as new project initially
            document.getElementById("prop-name").value =
              d.name || "Imported Sector";
            document.getElementById("prop-creator").value = d.creator || "Anonymous";
            document.getElementById("prop-desc").value = d.description || "";
            setDifficulty(d.difficulty || 1);
            document.getElementById("prop-gravity").value = d.gravity || 27;
            document.getElementById("gravity-val").innerText = d.gravity || 27;
            document.getElementById("prop-rise").value = d.riseInterval || 0;
            const riseVal = d.riseInterval || 0;
            document.getElementById("rise-val").innerText =
              riseVal > 0 ? (60 / riseVal).toFixed(1) + " blk/min" : "Disabled";
            document.getElementById("prop-force-zoom").value = d.forceZoom || false;
            document.getElementById("prop-no-death-anim").value = d.disableDeathAnim || false;

            let musicId = d.music || null;
            if (musicId && musicId.includes(".")) {
              const found = MUSIC_LIBRARY.find((t) => t.file === musicId);
              if (found) musicId = found.id;
            }
            state.music = musicId;
            renderMusic();

            state.colors = d.colors || {};
            state.fakes = new Set(d.fakes || []);

            state.risingThrough = new Set(d.risingThrough || []);
            state.illusions = new Set(d.illusions || []);
            state.risingSpeeds = d.risingSpeeds || {};
            state.blockConfigs = d.blockConfigs || {};

            state.grid = d.plan.map((line) => line.split(""));
            state.height = state.grid.length;
            state.width = state.grid[0].length;
            document.getElementById("prop-w").value = state.width;
            document.getElementById("prop-h").value = state.height;
            render();
            history.push();
            autoAdjust();
            closeModal("start-modal");
            updateStatus("Project Imported");
          };
          reader.readAsText(file);
          input.value = "";
        },
        rename(id) {
          const p = JSON.parse(localStorage.getItem("boi_project_" + id));
          dialog.prompt(
            "Rename Project",
            "Enter new name:",
            p.name,
            (newName) => {
              if (newName && newName.trim() !== "") {
                p.name = newName.trim();
                localStorage.setItem("boi_project_" + id, JSON.stringify(p));
                this.renderList();
              }
            },
          );
        },
        save() {
          if (!this.currentId) this.currentId = Date.now().toString();
          const data = {
            id: this.currentId,
            name: document.getElementById("prop-name").value,
            creator: document.getElementById("prop-creator").value,
            description: document.getElementById("prop-desc").value,
            difficulty: parseInt(document.getElementById("prop-diff").value),
            gravity: parseInt(document.getElementById("prop-gravity").value),
            riseInterval: parseFloat(
              document.getElementById("prop-rise").value,
            ),
            forceZoom: document.getElementById("prop-force-zoom").value === 'true',
            disableDeathAnim: document.getElementById("prop-no-death-anim").value === 'true',
            music: state.music,
            colors: state.colors,
            fakes: Array.from(state.fakes),
            risingThrough: Array.from(state.risingThrough),
            illusions: Array.from(state.illusions),
            risingSpeeds: state.risingSpeeds,
            blockConfigs: state.blockConfigs,
            width: state.width,
            height: state.height,
            grid: state.grid,
            lastModified: Date.now(),
          };
          localStorage.setItem(
            "boi_project_" + this.currentId,
            JSON.stringify(data),
          );
          updateStatus("Project Saved");
          this.renderList();
        },
        saveAsTemplate() {
          templateSaver.open();
        },
        load(id) {
          try {
            const json = localStorage.getItem("boi_project_" + id);
            if (!json) throw new Error("Project not found");
            const data = JSON.parse(json);
            this.currentId = data.id;
            document.getElementById("prop-name").value = data.name;
            document.getElementById("prop-creator").value = data.creator || "Anonymous";
            document.getElementById("prop-desc").value = data.description || "";
            setDifficulty(data.difficulty || 1);
            document.getElementById("prop-gravity").value = data.gravity || 27;
            document.getElementById("gravity-val").innerText = data.gravity || 27;
            document.getElementById("prop-rise").value = data.riseInterval || 0;
            const riseVal = data.riseInterval || 0;
            document.getElementById("rise-val").innerText =
              riseVal > 0 ? (60 / riseVal).toFixed(1) + " blk/min" : "Disabled";
            document.getElementById("prop-force-zoom").value = data.forceZoom || false;
            document.getElementById("prop-no-death-anim").value = data.disableDeathAnim || false;

            state.music = data.music || null;
            renderMusic();
            state.width = data.width;
            state.height = data.height;
            state.grid = data.grid;
            state.colors = data.colors || {};
            state.fakes = new Set(data.fakes || []);
            state.risingThrough = new Set(data.risingThrough || []);
            state.illusions = new Set(data.illusions || []);
            state.risingSpeeds = data.risingSpeeds || {};
            state.blockConfigs = data.blockConfigs || {};
            document.getElementById("prop-w").value = state.width;
            document.getElementById("prop-h").value = state.height;
            render();
            history.stack = [];
            history.push();
            closeModal("start-modal");
            autoAdjust();
          } catch (e) {
            dialog.alert("Load Error", "Failed to load project: " + e.message);
            console.error(e);
          }
        },
        duplicate(id) {
          const p = JSON.parse(localStorage.getItem("boi_project_" + id));
          if (!p) return;
          const newId = Date.now().toString();
          p.id = newId;
          p.name = "Copy of " + p.name;
          p.lastModified = Date.now();
          localStorage.setItem("boi_project_" + newId, JSON.stringify(p));
          this.renderList();
          updateStatus("Project Duplicated");
        },
        delete(id) {
          dialog.confirm(
            "Delete Project",
            "Are you sure you want to delete this project?",
            () => {
              localStorage.removeItem("boi_project_" + id);
              this.renderList();
            },
          );
        },
        handleContext(action) {
          if (!this.contextId) return;
          if (action === "open") this.load(this.contextId);
          if (action === "rename") this.rename(this.contextId);
          if (action === "duplicate") this.duplicate(this.contextId);
          if (action === "delete") this.delete(this.contextId);
          document.getElementById("context-menu").classList.add("hidden");
        },
        renderList() {
          // Render Featured Templates in Main Menu (Limit to 3)
          const tplList = document.getElementById("menu-templates");
          if (tplList) {
            tplList.innerHTML = "";
            const featured = getTemplates().slice(0, 3);
            featured.forEach((t) => {
              const el = document.createElement("div");
              el.className =
                "p-3 bg-slate-900 border border-slate-800 rounded hover:border-blue-500 cursor-pointer group flex items-center gap-3";
              el.onclick = () => loadTemplate(t);
              el.innerHTML = `<div class="w-8 h-8 bg-slate-800 rounded flex items-center justify-center text-slate-600 group-hover:text-blue-500 group-hover:bg-blue-500/10 transition-colors"><svg width="16" height="16" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M4 5a1 1 0 011-1h14a1 1 0 011 1v2a1 1 0 01-1 1H5a1 1 0 01-1-1V5zM4 13a1 1 0 011-1h6a1 1 0 01-1 1v6a1 1 0 01-1 1H5a1 1 0 01-1-1v-6zM16 13a1 1 0 011-1h2a1 1 0 011 1v6a1 1 0 01-1 1h-2a1 1 0 01-1-1v-6z"/></svg></div><div><div class='font-bold text-slate-300 text-xs group-hover:text-blue-400'>${t.name}</div><div class='text-[9px] text-slate-500'>${t.category}</div></div>`;
              tplList.appendChild(el);
            });
          }

          const list = document.getElementById("project-list");
          if (!list) return;
          list.innerHTML = "";
          const projects = [];
          for (let i = 0; i < localStorage.length; i++) {
            const key = localStorage.key(i);
            if (key.startsWith("boi_project_")) {
              try {
                projects.push(JSON.parse(localStorage.getItem(key)));
              } catch (e) {
                console.error("Skipping corrupt project", key);
              }
            }
          }

          const sortMode =
            document.getElementById("project-sort")?.value || "date";
          if (sortMode === "date") {
            projects.sort((a, b) => b.lastModified - a.lastModified);
          } else {
            projects.sort((a, b) => a.name.localeCompare(b.name));
          }

          if (projects.length === 0) {
            list.innerHTML =
              '<div class="text-slate-500 text-xs text-center py-4">No saved projects found.</div>';
            return;
          }

          projects.forEach((p) => {
            const el = document.createElement("div");
            el.className =
              "flex items-center justify-between p-3 bg-slate-900 border border-slate-800 rounded hover:border-blue-500 group transition-all select-none";
            el.oncontextmenu = (e) => {
              e.preventDefault();
              projectManager.contextId = p.id;
              const menu = document.getElementById("context-menu");
              menu.classList.remove("hidden");
              menu.style.left = `${e.clientX}px`;
              menu.style.top = `${e.clientY}px`;
            };
            el.innerHTML = `
                        <div class="cursor-pointer flex-1" onclick="projectManager.load('${
                          p.id
                        }')">
                            <div class="font-bold text-slate-200 text-xs group-hover:text-blue-400">${
                              p.name
                            }</div>
                            <div class="text-[10px] text-slate-500">${new Date(
                              p.lastModified,
                            ).toLocaleDateString()} ${new Date(
                              p.lastModified,
                            ).toLocaleTimeString()}</div>
                        </div>
                        <div class="flex gap-1">
                            <button onclick="projectManager.rename('${
                              p.id
                            }')" class="text-slate-600 hover:text-blue-400 p-1" title="Rename"><svg width="14" height="14" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"/></svg></button>
                            <button onclick="projectManager.duplicate('${
                              p.id
                            }')" class="text-slate-600 hover:text-green-400 p-1" title="Duplicate"><svg width="14" height="14" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M8 7v8a2 2 0 002 2h6M8 7V5a2 2 0 012-2h4.586a1 1 0 01.707.293l4.414 4.414a1 1 0 01.293.707V15a2 2 0 01-2 2h-2M8 7H6a2 2 0 00-2 2v10a2 2 0 002 2h8a2 2 0 002-2v-2"/></svg></button>
                            <button onclick="projectManager.delete('${
                              p.id
                            }')" class="text-slate-600 hover:text-red-500 p-1" title="Delete"><svg width="14" height="14" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/></svg></button>
                        </div>
                    `;
            list.appendChild(el);
          });
        },
      };

      const exportManager = {
        settings: {
          style: "original",
          altCoin: false,
          ticks: 0,
          watermark: "",
          wmColor: "#ffffff",
          wmSize: 20,
          playerPos: null,
          bgColor: "#020617",
          showGrid: false,
          padding: 20,
          scale: 1,
          wmOpacity: 1,
          wmPosition: "bottom-right",
          showPlayer: true,
        },
        isOpen: false,

        open() {
          this.isOpen = true;
          document.getElementById("export-modal").classList.remove("hidden");

          // Init settings from UI
          this.settings.style = document.getElementById("exp-style").value;
          this.settings.altCoin =
            document.getElementById("exp-alt-coin").checked;
          this.settings.ticks = parseInt(
            document.getElementById("exp-ticks").value,
          );
          this.settings.watermark =
            document.getElementById("exp-watermark").value;
          // wmColor handled by picker
          this.settings.wmSize = parseInt(
            document.getElementById("exp-wm-size").value,
          );
          this.settings.showPlayer =
            document.getElementById("exp-show-player").checked;
          this.settings.showGrid = document.getElementById("exp-grid").checked;
          this.settings.padding = parseInt(
            document.getElementById("exp-padding").value,
          );
          this.settings.wmOpacity = parseFloat(
            document.getElementById("exp-wm-opacity").value,
          );
          this.settings.wmPosition =
            document.getElementById("exp-wm-position").value;

          // Sync grid checkbox with main editor if first open
          if (!this.initialized) {
            this.settings.showGrid =
              document.getElementById("opt-showgrid").checked;
            document.getElementById("exp-grid").checked =
              this.settings.showGrid;
            this.initialized = true;
          }

          this.findPlayerStart();
          this.setZoom(1);
          this.update();
          this.setupDrag();
          this.setScale(1);

          const canvas = document.getElementById("export-canvas");
          canvas.style.maxWidth = "100%";
          canvas.style.maxHeight = "100%";
          canvas.style.objectFit = "contain";
        },

        findPlayerStart() {
          for (let y = 0; y < state.height; y++) {
            for (let x = 0; x < state.width; x++) {
              if (state.grid[y][x] === "@") {
                this.settings.playerPos = { x, y };
                return;
              }
            }
          }
          this.settings.playerPos = { x: 1, y: 1 };
        },

        setScale(s) {
          this.settings.scale = s;
          [1, 2, 4].forEach((n) => {
            const btn = document.getElementById(`btn-scale-${n}`);
            if (n === s)
              btn.className =
                "py-1.5 bg-blue-600 text-white text-[10px] font-bold rounded border border-blue-500";
            else
              btn.className =
                "py-1.5 bg-slate-900 text-slate-400 hover:text-white text-[10px] font-bold rounded border border-slate-800";
          });
          // Update dimensions display
          this.update();
        },

        update() {
          if (!this.isOpen) return;
          this.settings.style = document.getElementById("exp-style").value;
          this.settings.altCoin =
            document.getElementById("exp-alt-coin").checked;
          this.settings.ticks = parseInt(
            document.getElementById("exp-ticks").value,
          );
          document.getElementById("exp-ticks-val").innerText =
            this.settings.ticks;
          this.settings.watermark =
            document.getElementById("exp-watermark").value;
          this.settings.wmSize = parseInt(
            document.getElementById("exp-wm-size").value,
          );
          this.settings.showPlayer =
            document.getElementById("exp-show-player").checked;
          this.settings.showGrid = document.getElementById("exp-grid").checked;
          this.settings.padding = parseInt(
            document.getElementById("exp-padding").value,
          );
          this.settings.wmOpacity = parseFloat(
            document.getElementById("exp-wm-opacity").value,
          );
          this.settings.wmPosition =
            document.getElementById("exp-wm-position").value;
          document.getElementById("exp-pad-val").innerText =
            this.settings.padding;
          document.getElementById("exp-ticks-val").innerText =
            this.settings.ticks;

          this.renderPreview();
        },

        checkWall(x, y) {
          const gx = Math.floor(x);
          const gy = Math.floor(y);
          if (gx < 0 || gx >= state.width || gy < 0) return true;
          if (gy >= state.height) return true;
          return state.grid[gy][gx] === "x";
        },

        setZoom(val) {
          const canvas = document.getElementById("export-canvas");
          canvas.style.width = "";
          canvas.style.height = "";
          canvas.style.objectFit = "";
        },

        renderPreview() {
          const canvas = document.getElementById("export-canvas");
          const ctx = canvas.getContext("2d");
          const cellSize = 24;
          const pad = this.settings.padding;

          canvas.width = state.width * cellSize + pad * 2;
          canvas.height = state.height * cellSize + pad * 2;

          const finalW = canvas.width * this.settings.scale;
          const finalH = canvas.height * this.settings.scale;
          document.getElementById("exp-dims").innerText =
            `${finalW} x ${finalH}`;

          const isModern = this.settings.style === "modern";

          // Background
          ctx.fillStyle = this.settings.bgColor;
          ctx.fillRect(0, 0, canvas.width, canvas.height);

          // Grid Lines
          if (this.settings.showGrid) {
            ctx.strokeStyle = "rgba(30, 41, 59, 0.5)";
            ctx.lineWidth = 0.5;
            ctx.beginPath();
            for (let x = 0; x <= state.width; x++) {
              ctx.moveTo(pad + x * cellSize, pad);
              ctx.lineTo(pad + x * cellSize, canvas.height - pad);
            }
            for (let y = 0; y <= state.height; y++) {
              ctx.moveTo(pad, pad + y * cellSize);
              ctx.lineTo(canvas.width - pad, pad + y * cellSize);
            }
            ctx.stroke();
          }

          // Prepare Simulation
          const actors = [];
          for (let y = 0; y < state.height; y++) {
            for (let x = 0; x < state.width; x++) {
              const char = state.grid[y][x];
              if ("=|vHV^".includes(char)) {
                actors.push({
                  type: char,
                  x: x,
                  y: y,
                  ox: x,
                  oy: y,
                  dx: char === "=" || char === "H" ? 1 : 0,
                  dy:
                    char === "|" || char === "V" || char === "v"
                      ? 1
                      : char === "^"
                        ? -1
                        : 0,
                });
              }
            }
          }

          // Run Simulation
          const speed = 0.1;
          const ticks = this.settings.ticks;
          const riseTime =
            parseFloat(document.getElementById("prop-rise").value) || 0;

          actors.forEach((a) => {
            if (a.type === "^") {
              if (riseTime > 0) {
                a.y -= (1 / riseTime) * (ticks * 0.05);
              }
            } else {
              for (let t = 0; t < ticks; t++) {
                let s = speed;
                if (a.type === "v") s = 0.15;

                let nx = a.x + a.dx * s;
                let ny = a.y + a.dy * s;

                if (a.type === "v") {
                  if (this.checkWall(nx, ny)) {
                    a.x = a.ox;
                    a.y = a.oy;
                  } else {
                    a.x = nx;
                    a.y = ny;
                  }
                } else {
                  if (this.checkWall(nx, ny)) {
                    a.dx *= -1;
                    a.dy *= -1;
                  } else {
                    a.x = nx;
                    a.y = ny;
                  }
                }
              }
            }
          });

          // Draw Function (Reusing logic from io.exportImage but adapted)
          const drawBlock = (char, x, y, h = 1, ox = x, oy = y) => {
            const px = pad + x * cellSize;
            const py = pad + y * cellSize;
            const cx = px + cellSize / 2;
            const cy = py + cellSize / 2;

            const customColor =
              state.colors[`${Math.round(ox)},${Math.round(oy)}`];

            
            if (customColor === 'invisible') {
              ctx.globalAlpha = 0.5;
            }
            
            if (char === "x") {
              let fill = isModern ? "#334155" : "#444444";
              let stroke = isModern ? "#1e293b" : "#333333";
              if (customColor) {
                fill = customColor;
                stroke = adjustColor(customColor, -20);
              }
              ctx.fillStyle = fill;
              ctx.fillRect(px, py, cellSize, cellSize);
              ctx.strokeStyle = stroke;
              ctx.lineWidth = isModern ? 1 : 3;
              const offset = isModern ? 0.5 : 1.5;
              const size = isModern ? cellSize - 1 : cellSize - 3;
              ctx.strokeRect(px + offset, py + offset, size, size);
            } else if (
              char === "!" ||
              char === "=" ||
              char === "|" ||
              char === "v"
            ) {
              ctx.fillStyle = isModern ? "#ef4444" : "#e55555";
              if (isModern) {
                ctx.beginPath();
                if (ctx.roundRect) ctx.roundRect(px, py, cellSize, cellSize, 3);
                else ctx.rect(px, py, cellSize, cellSize);
                ctx.fill();
              } else {
                ctx.fillRect(px, py, cellSize, cellSize);
              }
            } else if (char === "H" || char === "V") {
              ctx.fillStyle = isModern ? "#64748b" : "#777777";
              if (isModern) {
                ctx.beginPath();
                if (ctx.roundRect) ctx.roundRect(px, py, cellSize, cellSize, 4);
                else ctx.rect(px, py, cellSize, cellSize);
                ctx.fill();
                ctx.strokeStyle = "#475569";
                ctx.lineWidth = 1;
                ctx.stroke();
              } else {
                ctx.fillRect(px, py, cellSize, cellSize);
                ctx.strokeStyle = "#555555";
                ctx.lineWidth = 3;
                ctx.strokeRect(px + 1.5, py + 1.5, cellSize - 3, cellSize - 3);
              }
              ctx.fillStyle = "#ffffff";
              ctx.font = "bold 10px sans-serif";
              ctx.textAlign = "center";
              ctx.textBaseline = "middle";
              ctx.fillText(char === "H" ? "↔" : "↕", cx, cy);
            } else if (char === "^") {
              const heightPx = cellSize * h;
              ctx.fillStyle = isModern ? "#ef4444" : "#d32f2f";
              if (isModern) {
                ctx.fillRect(px, py, cellSize, heightPx);
                ctx.strokeStyle = "#b91c1c";
                ctx.lineWidth = 1;
                ctx.strokeRect(px + 0.5, py + 0.5, cellSize - 1, heightPx - 1);
              } else {
                ctx.fillRect(px, py, cellSize, heightPx);
                // Game style: border-top
                ctx.fillStyle = "#ff6b6b";
                ctx.fillRect(px, py, cellSize, 4);
                // Side borders simulation
                ctx.strokeStyle = "#b71c1c";
                ctx.lineWidth = 3;
                ctx.strokeRect(px + 1.5, py + 1.5, cellSize - 3, heightPx - 3);
              }
              ctx.fillStyle = "rgba(255,255,255,0.7)";
              ctx.font = "10px sans-serif";
              ctx.textAlign = "center";
              ctx.textBaseline = "middle";
              ctx.fillText("▲", px + cellSize / 2, py + cellSize / 2);
            } else if (char === "o") {
              ctx.fillStyle = isModern ? "#fbbf24" : "#e2e838";
              ctx.strokeStyle = isModern ? "#f59e0b" : "#c2c828";
              ctx.lineWidth = isModern ? 2 : 1;
              const scale = isModern ? 0.65 : 0.6;
              const r = (cellSize * scale) / 2;
              ctx.beginPath();
              ctx.arc(cx, cy, r, 0, Math.PI * 2);
              ctx.fill();
              ctx.stroke();
            } else if (char === "B") {
              if (this.settings.altCoin) {
                ctx.fillStyle = "#335699";
                ctx.strokeStyle = "#ffffff";
                ctx.lineWidth = 2;
                ctx.shadowColor = "#3333ff";
                ctx.shadowBlur = 8;
              } else {
                ctx.fillStyle = isModern ? "#3b82f6" : "#335699";
                ctx.strokeStyle = isModern ? "#2563eb" : "transparent";
                ctx.lineWidth = isModern ? 2 : 0;
                ctx.shadowBlur = 0;
              }
              const scale = isModern ? 0.7 : 0.65;
              const r = (cellSize * scale) / 2;
              ctx.beginPath();
              ctx.arc(cx, cy, r, 0, Math.PI * 2);
              ctx.fill();
              if (isModern || this.settings.altCoin) ctx.stroke();
              ctx.shadowBlur = 0;
            } else if (char === "@") {
              ctx.fillStyle = isModern ? "#10b981" : "#5599aa";
              const scale = isModern ? 0.85 : 0.8;
              const size = cellSize * scale;
              const offset = (cellSize - size) / 2;
              const r = isModern ? 6 : 4;
              ctx.beginPath();
              if (ctx.roundRect)
                ctx.roundRect(px + offset, py + offset, size, size, r);
              else ctx.rect(px + offset, py + offset, size, size);
              ctx.fill();
            }
          };

          // Draw Static
          for (let y = 0; y < state.height; y++) {
            for (let x = 0; x < state.width; x++) {
              const char = state.grid[y][x];
              if ("=|vHV^@".includes(char)) continue;
              if (char !== " ") drawBlock(char, x, y);
            }
          }

          // Draw Moving
          actors.forEach((a) => {
            let h = 1;
            if (a.type === "^") h = a.oy - a.y + 1;
            drawBlock(a.type, a.x, a.y, h, a.ox, a.oy);
          });

          // Draw Player
          if (this.settings.showPlayer && this.settings.playerPos) {
            const px = pad + this.settings.playerPos.x * cellSize;
            const py = pad + this.settings.playerPos.y * cellSize;
            ctx.fillStyle = "#335699";
            // Game player is 0.5 width, 1 height.
            // Centered horizontally in tile, aligned to bottom of tile.
            ctx.fillRect(px + cellSize * 0.25, py, cellSize * 0.5, cellSize);
          }

          // Watermark
          if (this.settings.watermark) {
            ctx.save();
            ctx.globalAlpha = this.settings.wmOpacity;
            ctx.font = `bold ${this.settings.wmSize}px sans-serif`;
            ctx.fillStyle = this.settings.wmColor;

            let wx, wy;

            switch (this.settings.wmPosition) {
              case "top-left":
                ctx.textAlign = "left";
                ctx.textBaseline = "top";
                wx = pad;
                wy = pad;
                break;
              case "top-right":
                ctx.textAlign = "right";
                ctx.textBaseline = "top";
                wx = canvas.width - pad;
                wy = pad;
                break;
              case "bottom-left":
                ctx.textAlign = "left";
                ctx.textBaseline = "bottom";
                wx = pad;
                wy = canvas.height - pad;
                break;
              case "bottom-right":
              default:
                ctx.textAlign = "right";
                ctx.textBaseline = "bottom";
                wx = canvas.width - pad;
                wy = canvas.height - pad;
                break;
            }

            ctx.fillText(this.settings.watermark, wx, wy);
            ctx.restore();
          }
        },

        setupDrag() {
          const canvas = document.getElementById("export-canvas");
          let isDragging = false;

          canvas.onmousedown = (e) => {
            isDragging = true;
            this.handleDrag(e);
          };

          window.onmousemove = (e) => {
            if (isDragging) this.handleDrag(e);
          };

          window.onmouseup = () => {
            isDragging = false;
          };
        },

        handleDrag(e) {
          const canvas = document.getElementById("export-canvas");
          const pad = this.settings.padding;
          const rect = canvas.getBoundingClientRect();
          const scaleX = canvas.width / rect.width;
          const scaleY = canvas.height / rect.height;
          const x = (e.clientX - rect.left) * scaleX;
          const y = (e.clientY - rect.top) * scaleY;
          const cellSize = 24;
          const gx = Math.round((x - pad) / cellSize - 0.5);
          const gy = Math.round((y - pad) / cellSize - 0.5);

          if (gx >= 0 && gx < state.width && gy >= 0 && gy < state.height) {
            this.settings.playerPos = { x: gx, y: gy };
            this.renderPreview();
          }
        },

        download() {
          const canvas = document.getElementById("export-canvas");

          // Handle Scaling
          let finalCanvas = canvas;
          if (this.settings.scale > 1) {
            finalCanvas = document.createElement("canvas");
            finalCanvas.width = canvas.width * this.settings.scale;
            finalCanvas.height = canvas.height * this.settings.scale;
            const ctx = finalCanvas.getContext("2d");
            ctx.imageSmoothingEnabled = false; // Pixel art style
            ctx.drawImage(canvas, 0, 0, finalCanvas.width, finalCanvas.height);
          }

          const link = document.createElement("a");
          link.download = `${document
            .getElementById("prop-name")
            .value.replace(/\s+/g, "_")}_export.png`;
          link.href = finalCanvas.toDataURL();
          link.click();
        },
      };

      const history = {
        stack: [],
        ptr: -1,
        push() {
          this.stack = this.stack.slice(0, this.ptr + 1);
          this.stack.push(
            JSON.stringify({
              grid: state.grid,
              width: state.width,
              height: state.height,
              music: state.music,
              fakes: Array.from(state.fakes),
              risingThrough: Array.from(state.risingThrough),
              illusions: Array.from(state.illusions),
              risingSpeeds: state.risingSpeeds,
              blockConfigs: state.blockConfigs,
            }),
          );
          if (this.stack.length > 50) this.stack.shift();
          else this.ptr++;
        },
        undo() {
          if (this.ptr > 0) {
            this.ptr--;
            const data = JSON.parse(this.stack[this.ptr]);
            state.grid = data.grid;
            state.width = data.width;
            state.height = data.height;
            state.music = data.music || null;
            state.fakes = new Set(data.fakes || []);
            state.risingThrough = new Set(data.risingThrough || []);
            state.illusions = new Set(data.illusions || []);
            state.risingSpeeds = data.risingSpeeds || {};
            state.blockConfigs = data.blockConfigs || {};
            renderMusic();
            render();
            updateStatus("Undo Matrix");
          }
        },
        redo() {
          if (this.ptr < this.stack.length - 1) {
            this.ptr++;
            const data = JSON.parse(this.stack[this.ptr]);
            state.grid = data.grid;
            state.width = data.width;
            state.height = data.height;
            state.music = data.music || null;
            state.fakes = new Set(data.fakes || []);
            state.risingThrough = new Set(data.risingThrough || []);
            state.illusions = new Set(data.illusions || []);
            state.risingSpeeds = data.risingSpeeds || {};
            state.blockConfigs = data.blockConfigs || {};
            renderMusic();
            render();
            updateStatus("Redo Matrix");
          }
        },
      };

      document
        .getElementById("import-file")
        ?.addEventListener("change", (e) => {
          const file = e.target.files[0];
          if (!file) return;
          const reader = new FileReader();
          reader.onload = (ev) => {
            const d = JSON.parse(ev.target.result);
            document.getElementById("prop-name").value =
              d.name || "Imported Sector";
            document.getElementById("prop-desc").value = d.description || "";
            setDifficulty(d.difficulty || 1);
            document.getElementById("prop-gravity").value = d.gravity || 27;
            document.getElementById("gravity-val").innerText = d.gravity || 27;
            document.getElementById("prop-rise").value = d.riseInterval || 0;
            document.getElementById("rise-val").innerText = d.riseInterval || 0;

            const riseVal = d.riseInterval || 0;
            document.getElementById("rise-val").innerText =
              riseVal > 0 ? (60 / riseVal).toFixed(1) + " blk/min" : "Disabled";

            // Fix music detection (map filename to ID if needed)
            let musicId = d.music || null;
            if (musicId && musicId.includes(".")) {
              const found = MUSIC_LIBRARY.find((t) => t.file === musicId);
              if (found) musicId = found.id;
            }
            state.music = musicId;

            renderMusic();
            state.colors = d.colors || {};
            state.illusions = new Set(d.illusions || []);
            state.fakes = new Set(d.fakes || []);

            state.grid = d.plan.map((line) => line.split(""));
            state.height = state.grid.length;
            state.width = state.grid[0].length;

            document.getElementById("prop-w").value = state.width;
            document.getElementById("prop-h").value = state.height;

            render();
            history.push();
            autoAdjust();
          };
          reader.readAsText(file);
          e.target.value = "";
        });

      const helpManager = {
        init() {
          // Create modal if not exists
          if (!document.getElementById("help-modal")) {
            const modal = document.createElement("div");
            modal.id = "help-modal";
            modal.className =
              "fixed inset-0 z-[400] hidden flex items-center justify-center p-6 bg-black/80 backdrop-blur-sm";
            modal.innerHTML = `
              <div class="bg-[#0f121a] border border-slate-800 w-full max-w-4xl h-[80vh] rounded-xl shadow-2xl flex overflow-hidden">
                <div class="w-64 bg-[#0a0c12] border-r border-slate-800 flex flex-col p-4">
                  <h2 class="text-lg font-bold text-white mb-6 px-2">Help Guide</h2>
                  <div class="space-y-1" id="help-nav"></div>
                </div>
                <div class="flex-1 bg-[#0f121a] flex flex-col">
                  <div class="p-4 border-b border-slate-800 flex justify-between items-center">
                    <h3 id="help-topic-title" class="text-sm font-bold text-blue-400 uppercase tracking-widest"></h3>
                    <button onclick="document.getElementById('help-modal').classList.add('hidden')" class="text-slate-500 hover:text-white p-1">
                      <svg width="20" height="20" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M6 18L18 6M6 6l12 12"/></svg>
                    </button>
                  </div>
                  <div id="help-content" class="flex-1 overflow-y-auto p-8 text-slate-300 text-sm leading-relaxed space-y-4"></div>
                </div>
              </div>
            `;
            document.body.appendChild(modal);
          }
        },
        topics: [
          {
            id: "basics",
            title: "Getting Started",
            content: `
              <p><strong>Block Architect Pro</strong> is the official level editor for Block Over It.</p>
              <p class="mt-4">The left sidebar is where you main tools reside. Select a block from the palette and click on the grid to place it. Different tools have different uses (see Left Sidebar Tools). The most common tool will be the pencil, which allows you to place blocks on the grid. You can also click and drag with this tool. On the right sidebar, which is expandable through a circle arrow button, are a variety of configuration tools for your level. The <strong>Main</strong> section allows you to change the name, description, difficulty, and more of your level. Other sections allow you to customize different things or have different functions. The <strong>Selection Tools</strong> section is the main way of using the select tool, and allows you to fill, delete, paint, and do more with the selected space (see Selection Tools).</p>
            `,
          },
          {
            id: "tools",
            title: "Left Sidebar Tools",
            content: `
              <p>Primary building tools:</p>
              <ul class="list-disc pl-5 space-y-2 mt-4 text-slate-400">
                <li><strong>Pencil (B):</strong> Places the selected block type. Click and drag to paint.</li>
                <li><strong>Fill (F):</strong> Floods an area with the selected block type. </li>
                <li><strong>Select (S):</strong> Click and drag to create a selection box. You can then Move, Copy, Paste, or Delete the selected area using keyboard shortcuts. You can do more with this with the <strong>Selection Tools</strong> in the right menu (see Selection Tools).</li>
                <li><strong>Eraser (E):</strong> Removes blocks. Equivalent to painting with "empty" space.</li>
              </ul>
            `,
          },
          {
            id: "minimap",
            title: "Using the Minimap",
            content: `
              <p>The minimap provides a bird's-eye view of your entire level.</p>
              <div class="bg-slate-900 p-4 rounded border border-slate-800 mt-4">
                <h4 class="font-bold text-white mb-2">Features:</h4>
                <ul class="list-disc pl-5 space-y-1 text-slate-400">
                  <li><strong>Navigation:</strong> Click anywhere on the minimap to instantly scroll the main viewport to that location.</li>
                  <li><strong>Viewport Indicator:</strong> The white rectangle shows exactly what is currently visible on your screen.</li>
                  <li><strong>Dragging:</strong> You can drag the minimap window around the screen by clicking and holding its header.</li>
                  <li><strong>Collapsing:</strong> Click the arrow icon in the header (or the map itself when collapsed) to shrink it into a small icon. This is useful for maximizing your workspace.</li>
                </ul>
              </div>
            `,
          },
          {
            id: "save",
            title: "Saving Projects",
            content: `
              <p>The editor automatically saves your projects to your browser's local storage.</p>
              <ul class="list-disc pl-5 space-y-2 mt-4 text-slate-400">
                <li><strong>Quick Save:</strong> Press <code>Ctrl+S</code> or click the "Save" button in the header to save changes.</li>
                <li><strong>Auto-Save:</strong> The editor does not auto-save to prevent overwriting work. Remember to press save every time you would like to save a change to localStorage.</li>
                <li><strong>Management:</strong> You can rename, duplicate, or delete projects from the main menu or by right-clicking them in the list.</li>
              </ul>
            `,
          },
          {
            id: "json",
            title: "Exporting Levels (JSON)",
            content: `
              <p>To share your level with others or back it up, use the <strong>Export</strong> button.</p>
              <p class="mt-2 text-slate-400">This downloads a <code>.json</code> file containing all level data. You can import this file back into the editor later using the "Import" button or on the main menu.</p>
            `,
          },
          {
            id: "difficulty",
            title: "Difficulty & Description",
            content: `
              <p>You can add info about your level for players in the Configuration panel.</p>
              <ul class="list-disc pl-5 space-y-2 mt-4 text-slate-400">
                <strong>Description:</strong> Write a brief hint or lore for your level. This appears in the level popup in-game.</li>
                <strong>Difficulty:</strong> Rate your level from 1 (Easy) to 5 (Extreme). This helps players know what to expect.</li>
              </ul>
            `,
          },
          {
            id: "image",
            title: "Image Export",
            content: `
              <p>The <strong>Image Export</strong> tool allows you to generate screenshots of your level for sharing.</p>
              <p class="mt-2 text-slate-400">A variety of tools are included with image export, allowing you to modify your image in many ways. To set a watermark, expand the <strong>Watermark</strong> section and enter text to set as a watermark. You can also use the extra configuration tools to modify your watermark's appearance. </p>
            `,
          },
          {
            id: "templates",
            title: "Templates",
            content: `
              <p>Templates are a way of having a base to start your level.</p>
              <p class="mt-2 text-slate-400">To access templates, expand the <strong>Structure Templates</strong> section in the right menu and select <strong> Browse Full Library </strong>. You will see all availible templates included with Block Architect Pro.
              <p class="mt-2 text-slate-400">You may also have your own custom templates. After you have created a level, click <strong>Template</strong> in the header to save the current level to your local template library. You can then select it when creating a new project. </p>
              <p class="mt-2 text-slate-400">To delete an already created template, go to the <strong>Structure Templates</strong> section in the right menu, select <strong>Browse Full Library</strong>, and hover over your custom template. A delete button will appear allowing you to delete it. </p>
              <p class="mt-2 text-slate-400">To replace an already existing template, open the template in a new file, make the changes to the template, and click the <strong>Template</strong> button in the header. Then, go to the <strong>Replace Existing</strong> tab in the popup that appears and select the template you would like to replace. After clicking <strong>Save Template</strong>, the changes should be saved onto that template.</p>
            `,
          },
          {
            id: "music",
            title: "Music System",
            content: `
              <p>You can assign a specific music track to your level using the music section.</p>
              <p class="mt-2 text-slate-400">Open the <strong>Music</strong> section in the right panel to browse available tracks. Click "Play" to preview a track, and "Select" to assign it to your level. When players play your level, this music will be in the background.</p>
            `,
          },
          {
            id: "shortcuts",
            title: "Keyboard Shortcuts",
            content: `
              <div class="grid grid-cols-2 gap-4">
                <div class="bg-slate-900 p-3 rounded border border-slate-800">
                  <div class="font-bold text-white mb-2">Tools & View</div>
                  <div class="flex justify-between text-xs py-1 border-b border-slate-800/50"><span>Pencil</span> <span class="font-mono text-blue-400">B</span></div>
                  <div class="flex justify-between text-xs py-1 border-b border-slate-800/50"><span>Eraser</span> <span class="font-mono text-blue-400">E</span></div>
                  <div class="flex justify-between text-xs py-1 border-b border-slate-800/50"><span>Select</span> <span class="font-mono text-blue-400">S</span></div>
                  <div class="flex justify-between text-xs py-1 border-b border-slate-800/50"><span>Fill</span> <span class="font-mono text-blue-400">F</span></div>
                  <div class="flex justify-between text-xs py-1 border-b border-slate-800/50"><span>Toggle Grid</span> <span class="font-mono text-blue-400">G</span></div>
                  <div class="flex justify-between text-xs py-1 border-b border-slate-800/50"><span>Collapse Minimap</span> <span class="font-mono text-blue-400">M</span></div>
                  <div class="flex justify-between text-xs py-1"><span>Hide Minimap</span> <span class="font-mono text-blue-400">Alt+M</span></div>
                </div>
                <div class="bg-slate-900 p-3 rounded border border-slate-800">
                  <div class="font-bold text-white mb-2">Actions</div>
                  <div class="flex justify-between text-xs py-1 border-b border-slate-800/50"><span>Quick Save</span> <span class="font-mono text-blue-400">Ctrl+S</span></div>
                  <div class="flex justify-between text-xs py-1 border-b border-slate-800/50"><span>Undo</span> <span class="font-mono text-blue-400">Ctrl+Z</span></div>
                  <div class="flex justify-between text-xs py-1 border-b border-slate-800/50"><span>Redo</span> <span class="font-mono text-blue-400">Ctrl+Y</span></div>
                  <div class="flex justify-between text-xs py-1 border-b border-slate-800/50"><span>Copy Selection</span> <span class="font-mono text-blue-400">Ctrl+C</span></div>
                  <div class="flex justify-between text-xs py-1 border-b border-slate-800/50"><span>Paste Selection</span> <span class="font-mono text-blue-400">Ctrl+V</span></div>
                  <div class="flex justify-between text-xs py-1 border-b border-slate-800/50"><span>Select All</span> <span class="font-mono text-blue-400">Ctrl+A</span></div>
                  <div class="flex justify-between text-xs py-1"><span>Delete</span> <span class="font-mono text-blue-400">Del</span></div>
                  <div class="flex justify-between text-xs py-1 border-t border-slate-800/50 mt-1 pt-1"><span>Zoom In/Out</span> <span class="font-mono text-blue-400">+/-</span></div>
                </div>
                <div class="bg-slate-900 p-3 rounded border border-slate-800 col-span-2">
                  <div class="font-bold text-white mb-2">Block Shortcuts (Shift + Key)</div>
                  <div class="grid grid-cols-4 gap-2 text-[10px] text-slate-400">
                    <div>X: Wall</div>
                    <div>1/L: Lava</div>
                    <div>2/P: Player</div>
                    <div>O/C: Coin</div>
                    <div>S: Spike</div>
                    <div>B: Wall</div>
                  </div>
                </div>
              </div>
            `,
          },
        ],
        open(topicId = "basics") {
          document.getElementById("help-modal").classList.remove("hidden");
          this.renderNav(topicId);
          this.renderContent(topicId);
        },
        renderNav(activeId) {
          const nav = document.getElementById("help-nav");
          nav.innerHTML = this.topics
            .map(
              (t) => `
            <button onclick="helpManager.renderNav('${t.id}'); helpManager.renderContent('${t.id}')" 
              class="w-full text-left px-4 py-2 rounded text-xs font-medium transition-colors ${t.id === activeId ? "bg-blue-600 text-white" : "text-slate-400 hover:bg-slate-800 hover:text-white"}">
              ${t.title}
            </button>
          `,
            )
            .join("");
        },
        renderContent(id) {
          const topic = this.topics.find((t) => t.id === id);
          if (topic) {
            document.getElementById("help-topic-title").innerText = topic.title;
            document.getElementById("help-content").innerHTML = topic.content;
          }
        },
      };

      const whatsNewManager = {
        versions: [
          {
            id: "1.2",
            v: "1.2",
            date: "Current",
            changes: [
              "Added new blocks to the editor: spikes",
              "Added the ability to add background music to your levels",
              "Added a help menu with various help guides",
              "Added Block Keyboard Shortcuts (Shift+Key) and expanded keyboard shortcuts",
              "Added painting blocks",
              "Added What's New Menu",
              "Improved image export with many new features to edit the image before exporting",
              "Added minimap",
              "Various other features and bug fixes",
            ],
          },
          {
            id: "1.1",
            v: "1.1",
            date: "Previous",
            changes: [
              "Redesigned the UI for a more professional look, and added a main menu",
              "Fixed various bugs",
              "Added countless new features, including a redesign featuring many new functions in the right sidebar",
              "Added the new blocks",
            ],
          },
          {
            id: "v8.0",
            v: "v8.0",
            date: "Base",
            changes: ["Initial release of a Block Over It level editor"],
          },
        ],
        open(activeId = "pro") {
          document.getElementById("help-modal").classList.remove("hidden");
          document.getElementById("help-topic-title").innerText =
            "Version History";
          this.renderNav(activeId);
          this.renderContent(activeId);
        },
        renderNav(activeId) {
          const nav = document.getElementById("help-nav");
          nav.innerHTML = this.versions
            .map(
              (v) => `
                <button onclick="whatsNewManager.renderNav('${v.id}'); whatsNewManager.renderContent('${v.id}')" 
                  class="w-full text-left px-4 py-2 rounded text-xs font-medium transition-colors ${v.id === activeId ? "bg-blue-600 text-white" : "text-slate-400 hover:bg-slate-800 hover:text-white"}">
                  ${v.v} <span class="opacity-50 ml-1 text-[10px]">${v.date}</span>
                </button>
            `,
            )
            .join("");
        },
        renderContent(id) {
          const v = this.versions.find((ver) => ver.id === id);
          if (!v) return;
          const content = document.getElementById("help-content");
          content.innerHTML = `
                <div class="mb-6">
                    <div class="flex justify-between items-baseline mb-4 border-b border-slate-800 pb-2">
                        <h4 class="text-xl font-bold text-white">${v.v}</h4>
                        <span class="text-xs text-slate-500 font-mono">${v.date}</span>
                    </div>
                    <ul class="list-disc pl-5 space-y-2 text-slate-400 text-sm">
                        ${v.changes.map((c) => `<li>${c}</li>`).join("")}
                    </ul>
                </div>
            `;
        },
      };

      init();
    </script>
  </body>
</html>
